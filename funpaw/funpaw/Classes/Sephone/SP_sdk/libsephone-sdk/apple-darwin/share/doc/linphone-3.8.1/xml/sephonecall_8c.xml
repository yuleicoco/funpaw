<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.12">
  <compounddef id="sephonecall_8c" kind="file" language="C++">
    <compoundname>sephonecall.c</compoundname>
    <includes refid="sephonecore_8h" local="yes">sephonecore.h</includes>
    <includes refid="sipsetup_8h" local="yes">sipsetup.h</includes>
    <includes refid="spconfig_8h" local="yes">spconfig.h</includes>
    <includes refid="private_8h" local="yes">private.h</includes>
    <includes local="no">ortp/event.h</includes>
    <includes local="no">ortp/b64.h</includes>
    <includes local="no">math.h</includes>
    <includes local="yes">bellesip_sal/sal_impl.h</includes>
    <includes local="yes">mediastreamer2/mediastream.h</includes>
    <includes local="yes">mediastreamer2/msvolume.h</includes>
    <includes local="yes">mediastreamer2/msequalizer.h</includes>
    <includes local="yes">mediastreamer2/msfileplayer.h</includes>
    <includes local="yes">mediastreamer2/msjpegwriter.h</includes>
    <includes local="yes">mediastreamer2/mseventqueue.h</includes>
    <includes local="yes">mediastreamer2/mssndcard.h</includes>
    <includes local="yes">mediastreamer2/stun.h</includes>
    <incdepgraph>
      <node id="191">
        <label>mediastreamer2/stun.h</label>
      </node>
      <node id="189">
        <label>mediastreamer2/mseventqueue.h</label>
      </node>
      <node id="183">
        <label>bellesip_sal/sal_impl.h</label>
      </node>
      <node id="190">
        <label>mediastreamer2/mssndcard.h</label>
      </node>
      <node id="179">
        <label>sephonecall.c</label>
        <link refid="sephonecall_8c"/>
        <childnode refid="180" relation="include">
        </childnode>
        <childnode refid="181" relation="include">
        </childnode>
        <childnode refid="182" relation="include">
        </childnode>
        <childnode refid="183" relation="include">
        </childnode>
        <childnode refid="184" relation="include">
        </childnode>
        <childnode refid="185" relation="include">
        </childnode>
        <childnode refid="186" relation="include">
        </childnode>
        <childnode refid="187" relation="include">
        </childnode>
        <childnode refid="188" relation="include">
        </childnode>
        <childnode refid="189" relation="include">
        </childnode>
        <childnode refid="190" relation="include">
        </childnode>
        <childnode refid="191" relation="include">
        </childnode>
      </node>
      <node id="187">
        <label>mediastreamer2/msfileplayer.h</label>
      </node>
      <node id="186">
        <label>mediastreamer2/msequalizer.h</label>
      </node>
      <node id="185">
        <label>mediastreamer2/msvolume.h</label>
      </node>
      <node id="180">
        <label>ortp/event.h</label>
      </node>
      <node id="182">
        <label>math.h</label>
      </node>
      <node id="188">
        <label>mediastreamer2/msjpegwriter.h</label>
      </node>
      <node id="184">
        <label>mediastreamer2/mediastream.h</label>
      </node>
      <node id="181">
        <label>ortp/b64.h</label>
      </node>
    </incdepgraph>
    <innerclass refid="struct__CodecConstraints" prot="public">_CodecConstraints</innerclass>
      <sectiondef kind="define">
      <memberdef kind="define" id="sephonecall_8c_1ace069dd77bea8fa2d6ad7c504af360ea" prot="public" static="no">
        <name>EC_STATE_MAX_LEN</name>
        <initializer>1048576</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="46" column="9" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="46" bodyend="-1"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="typedef">
      <memberdef kind="typedef" id="sephonecall_8c_1a3a1310df15452851d131258783fbefc5" prot="public" static="no">
        <type>struct _CodecConstraints</type>
        <definition>typedef struct _CodecConstraints CodecConstraints</definition>
        <argsstring></argsstring>
        <name>CodecConstraints</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="360" column="1"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="var">
      <memberdef kind="variable" id="sephonecall_8c_1a11ab8fbf6c3e7e7fd33ad15c0d1516fb" prot="public" static="yes" mutable="no">
        <type>const char</type>
        <definition>const char EC_STATE_STORE[]</definition>
        <argsstring>[]</argsstring>
        <name>EC_STATE_STORE</name>
        <initializer>= &quot;.sephone.ecstate&quot;</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="45" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="45" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="sephonecall_8c_1aa9dc277b972f3c68799988fa35f5915b" prot="public" static="yes" mutable="no">
        <type>int</type>
        <definition>int dtmf_tab[16]</definition>
        <argsstring>[16]</argsstring>
        <name>dtmf_tab</name>
        <initializer>={&apos;0&apos;,&apos;1&apos;,&apos;2&apos;,&apos;3&apos;,&apos;4&apos;,&apos;5&apos;,&apos;6&apos;,&apos;7&apos;,&apos;8&apos;,&apos;9&apos;,&apos;*&apos;,&apos;#&apos;,&apos;A&apos;,&apos;B&apos;,&apos;C&apos;,&apos;D&apos;}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2361" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2361" bodyend="-1"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="func">
      <memberdef kind="function" id="sephonecall_8c_1a7da7ee69330caff35ef14ae07ef94f4a" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_stats_uninit</definition>
        <argsstring>(SephoneCallStats *stats)</argsstring>
        <name>sephone_call_stats_uninit</name>
        <param>
          <type><ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="48" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3954" bodyend="3963"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a4df8089e7fb884b02cd1f01fc951ec6d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>static bool_t generate_b64_crypto_key</definition>
        <argsstring>(int key_length, char *key_out, size_t key_out_size)</argsstring>
        <name>generate_b64_crypto_key</name>
        <param>
          <type>int</type>
          <declname>key_length</declname>
        </param>
        <param>
          <type>char *</type>
          <declname>key_out</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>key_out_size</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="56" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="56" bodyend="85"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga43cafe9f8f58dc1e3552762d2879e6c1" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
        <definition>SephoneCore* sephone_call_get_core</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_core</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get the core that has created the specified call. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">call</parametername>
</parameternamelist>
<parameterdescription>
<para>SephoneCall object </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The SephoneCore object that has created the specified call. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="87" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="87" bodyend="89"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a829e80c63004db1073d4274db6c65397" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>const char* sephone_call_get_authentication_token</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_authentication_token</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="91" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="91" bodyend="93"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga8da6372d304b10ad52b72d095e2985ce" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>bool_t sephone_call_get_authentication_token_verified</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_authentication_token_verified</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns whether ZRTP authentication token is verified. If not, it must be verified by users as described in ZRTP procedure. Once done, the application must inform of the results with <ref refid="group__call__control_1ga949852a881edb1cf3e6ec05e58edea06" kindref="member">sephone_call_set_authentication_token_verified()</ref>. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para>the SephoneCall </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>TRUE if authentication token is verifed, false otherwise. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="103" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="103" bodyend="105"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a33a7d48e6c26c5587987d2af1207830c" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>static bool_t sephone_call_all_streams_encrypted</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_all_streams_encrypted</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="107" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="107" bodyend="123"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a0c19c13ac37782102f4499050599a8de" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>static bool_t sephone_call_all_streams_avpf_enabled</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_all_streams_avpf_enabled</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="125" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="125" bodyend="141"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a9d718be58683b40036b30e19208ab28e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint16_t</type>
        <definition>static uint16_t sephone_call_get_avpf_rr_interval</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_avpf_rr_interval</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="143" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="143" bodyend="159"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1af8c8a6aeda1ae826eb4d2ce0893b61c5" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void propagate_encryption_changed</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>propagate_encryption_changed</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="161" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="161" bodyend="175"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ad2c6694954eabc89f9b33fe63913882a" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_audiostream_encryption_changed</definition>
        <argsstring>(void *data, bool_t encrypted)</argsstring>
        <name>sephone_call_audiostream_encryption_changed</name>
        <param>
          <type>void *</type>
          <declname>data</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>encrypted</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="177" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="177" bodyend="203"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1abea747213d0d9e32d72f0420131d29c3" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_audiostream_auth_token_ready</definition>
        <argsstring>(void *data, const char *auth_token, bool_t verified)</argsstring>
        <name>sephone_call_audiostream_auth_token_ready</name>
        <param>
          <type>void *</type>
          <declname>data</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>auth_token</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>verified</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="206" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="206" bodyend="215"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga949852a881edb1cf3e6ec05e58edea06" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_set_authentication_token_verified</definition>
        <argsstring>(SephoneCall *call, bool_t verified)</argsstring>
        <name>sephone_call_set_authentication_token_verified</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>verified</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Set the result of ZRTP short code verification by user. If remote party also does the same, it will update the ZRTP cache so that user&apos;s verification will not be required for the two users. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para>the SephoneCall </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>verified</parametername>
</parameternamelist>
<parameterdescription>
<para>whether the ZRTP SAS is verified. </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="224" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="224" bodyend="238"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aa5d6ea4e775c5aa265338bac0dcd12f7" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int get_max_codec_sample_rate</definition>
        <argsstring>(const MSList *codecs)</argsstring>
        <name>get_max_codec_sample_rate</name>
        <param>
          <type>const MSList *</type>
          <declname>codecs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="240" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="240" bodyend="254"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a90fd736e68bcd1ccaf70554ed47ef88e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int find_payload_type_number</definition>
        <argsstring>(const MSList *assigned, const PayloadType *pt)</argsstring>
        <name>find_payload_type_number</name>
        <param>
          <type>const MSList *</type>
          <declname>assigned</declname>
        </param>
        <param>
          <type>const PayloadType *</type>
          <declname>pt</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="256" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="256" bodyend="272"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a970ea38abf1976793a507de71e6b74d5" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>bool_t is_payload_type_number_available</definition>
        <argsstring>(const MSList *l, int number, const PayloadType *ignore)</argsstring>
        <name>is_payload_type_number_available</name>
        <param>
          <type>const MSList *</type>
          <declname>l</declname>
        </param>
        <param>
          <type>int</type>
          <declname>number</declname>
        </param>
        <param>
          <type>const PayloadType *</type>
          <declname>ignore</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="274" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="274" bodyend="281"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1adf451bfd0b7cb6ef9b4cc8821e2052e1" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_core_assign_payload_type_numbers</definition>
        <argsstring>(SephoneCore *lc, MSList *codecs)</argsstring>
        <name>sephone_core_assign_payload_type_numbers</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>MSList *</type>
          <declname>codecs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="283" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="283" bodyend="313"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ab0e2a7b884e242b5066660ffb0503ce3" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>static bool_t has_telephone_event_at_rate</definition>
        <argsstring>(const MSList *tev, int rate)</argsstring>
        <name>has_telephone_event_at_rate</name>
        <param>
          <type>const MSList *</type>
          <declname>tev</declname>
        </param>
        <param>
          <type>int</type>
          <declname>rate</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="315" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="315" bodyend="322"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ae1366a64df6f04c31f8d42c976eb9653" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>MSList *</type>
        <definition>static MSList* create_telephone_events</definition>
        <argsstring>(SephoneCore *lc, const MSList *codecs)</argsstring>
        <name>create_telephone_events</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>const MSList *</type>
          <declname>codecs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="324" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="324" bodyend="344"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a85b7c7a0cbd871b802ad760b5cbd5580" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>MSList *</type>
        <definition>static MSList* create_special_payload_types</definition>
        <argsstring>(SephoneCore *lc, const MSList *codecs)</argsstring>
        <name>create_special_payload_types</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>const MSList *</type>
          <declname>codecs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="346" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="346" bodyend="354"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a8eaee2aa0f72a00bd9575fd2525453bf" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>MSList *</type>
        <definition>static MSList* make_codec_list</definition>
        <argsstring>(SephoneCore *lc, CodecConstraints *hints, SalStreamType stype, const MSList *codecs)</argsstring>
        <name>make_codec_list</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>CodecConstraints *</type>
          <declname>hints</declname>
        </param>
        <param>
          <type>SalStreamType</type>
          <declname>stype</declname>
        </param>
        <param>
          <type>const MSList *</type>
          <declname>codecs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="362" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="362" bodyend="400"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aea8ca37f0b48f79312fae89e89be9497" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void update_media_description_from_stun</definition>
        <argsstring>(SalMediaDescription *md, const StunCandidate *ac, const StunCandidate *vc)</argsstring>
        <name>update_media_description_from_stun</name>
        <param>
          <type>SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <param>
          <type>const StunCandidate *</type>
          <declname>ac</declname>
        </param>
        <param>
          <type>const StunCandidate *</type>
          <declname>vc</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="402" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="402" bodyend="418"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a8bed7a4e44969804494143a8f097bd8d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int setup_encryption_key</definition>
        <argsstring>(SalSrtpCryptoAlgo *crypto, MSCryptoSuite suite, unsigned int tag)</argsstring>
        <name>setup_encryption_key</name>
        <param>
          <type>SalSrtpCryptoAlgo *</type>
          <declname>crypto</declname>
        </param>
        <param>
          <type>MSCryptoSuite</type>
          <declname>suite</declname>
        </param>
        <param>
          <type>unsigned int</type>
          <declname>tag</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="420" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="420" bodyend="444"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a42ed504bb9e5f8034a3b9478dfd930cf" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void setup_dtls_keys</definition>
        <argsstring>(SephoneCall *call, SalMediaDescription *md)</argsstring>
        <name>setup_dtls_keys</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="446" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="446" bodyend="459"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a4d58843ad332fc338d50fd7d7bc0ccdf" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void setup_encryption_keys</definition>
        <argsstring>(SephoneCall *call, SalMediaDescription *md)</argsstring>
        <name>setup_encryption_keys</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="461" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="461" bodyend="484"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a48594e57ce119983984394b0cdbc43b3" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void setup_rtcp_fb</definition>
        <argsstring>(SephoneCall *call, SalMediaDescription *md)</argsstring>
        <name>setup_rtcp_fb</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="486" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="486" bodyend="507"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a00e9465d7689459994c9ff2f5d7ae0fc" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void setup_rtcp_xr</definition>
        <argsstring>(SephoneCall *call, SalMediaDescription *md)</argsstring>
        <name>setup_rtcp_xr</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="509" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="509" bodyend="532"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ac4b9ad7163971097c34004d722813817" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_increment_local_media_description</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_increment_local_media_description</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="534" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="534" bodyend="537"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a3bc35f14d4db9c6126846cf2e45050c9" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_update_local_media_description_from_ice_or_upnp</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_update_local_media_description_from_ice_or_upnp</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="539" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="539" bodyend="550"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a47cd2a7b927c47abe5a8e428bca335d9" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void transfer_already_assigned_payload_types</definition>
        <argsstring>(SalMediaDescription *old, SalMediaDescription *md)</argsstring>
        <name>transfer_already_assigned_payload_types</name>
        <param>
          <type>SalMediaDescription *</type>
          <declname>old</declname>
        </param>
        <param>
          <type>SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="552" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="552" bodyend="558"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a48631dc218997a255bfb168dd7872445" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>static const char* sephone_call_get_bind_ip_for_stream</definition>
        <argsstring>(SephoneCall *call, int stream_index)</argsstring>
        <name>sephone_call_get_bind_ip_for_stream</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="560" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="560" bodyend="570"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1af2c33131f679ed5efc461a536ae5ce87" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>static const char* sephone_call_get_public_ip_for_stream</definition>
        <argsstring>(SephoneCall *call, int stream_index)</argsstring>
        <name>sephone_call_get_public_ip_for_stream</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="572" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="572" bodyend="578"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a7bc39adbf52f055be8d73af4d6fa90a5" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_make_local_media_description</definition>
        <argsstring>(SephoneCore *lc, SephoneCall *call)</argsstring>
        <name>sephone_call_make_local_media_description</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="580" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="580" bodyend="582"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a8755e82398c3f6f211e06ece24deea79" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_make_local_media_description_with_params</definition>
        <argsstring>(SephoneCore *lc, SephoneCall *call, SephoneCallParams *params)</argsstring>
        <name>sephone_call_make_local_media_description_with_params</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref> *</type>
          <declname>params</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="584" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="584" bodyend="716"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1abad97c150ca93652f4f258ee1f4a89a5" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>SalMediaDescription *</type>
        <definition>SalMediaDescription* sephone_call_make_media_description</definition>
        <argsstring>(SephoneCore *lc, SephoneCall *call)</argsstring>
        <name>sephone_call_make_media_description</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="718" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="718" bodyend="720"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a2be3730a9218450cf55b4ce7bb5f4541" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>SalMediaDescription *</type>
        <definition>SalMediaDescription* sephone_call_make_media_description_with_params</definition>
        <argsstring>(SephoneCore *lc, SephoneCall *call, SephoneCallParams *params)</argsstring>
        <name>sephone_call_make_media_description_with_params</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref> *</type>
          <declname>params</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="722" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="722" bodyend="859"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ab080a5f34b044c2430877d11789c3be8" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int find_port_offset</definition>
        <argsstring>(SephoneCore *lc, int stream_index, int base_port)</argsstring>
        <name>find_port_offset</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <param>
          <type>int</type>
          <declname>base_port</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="861" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="861" bodyend="886"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a7554f385c40436e1998012778b0652c9" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int select_random_port</definition>
        <argsstring>(SephoneCore *lc, int stream_index, int min_port, int max_port)</argsstring>
        <name>select_random_port</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <param>
          <type>int</type>
          <declname>min_port</declname>
        </param>
        <param>
          <type>int</type>
          <declname>max_port</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="888" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="888" bodyend="913"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1abed260ba577cb5f31c2f511d1e00798a" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void port_config_set_random</definition>
        <argsstring>(SephoneCall *call, int stream_index)</argsstring>
        <name>port_config_set_random</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="915" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="915" bodyend="918"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ae8fc57afb0b664fed88e46d7ca5ed94e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void port_config_set</definition>
        <argsstring>(SephoneCall *call, int stream_index, int min_port, int max_port)</argsstring>
        <name>port_config_set</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <param>
          <type>int</type>
          <declname>min_port</declname>
        </param>
        <param>
          <type>int</type>
          <declname>max_port</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="920" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="920" bodyend="937"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a1bb0728159479db1afb299e08f5ca0f8" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_init_common</definition>
        <argsstring>(SephoneCall *call, SephoneAddress *from, SephoneAddress *to)</argsstring>
        <name>sephone_call_init_common</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
          <declname>from</declname>
        </param>
        <param>
          <type><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
          <declname>to</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="939" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="939" bodyend="978"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ab58731e8b6ae2d8052d407079c533f69" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_init_stats</definition>
        <argsstring>(SephoneCallStats *stats, int type)</argsstring>
        <name>sephone_call_init_stats</name>
        <param>
          <type><ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <param>
          <type>int</type>
          <declname>type</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="980" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="980" bodyend="990"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a8e9bbd139e165cdc0e0393372612bf2f" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void discover_mtu</definition>
        <argsstring>(SephoneCore *lc, const char *remote)</argsstring>
        <name>discover_mtu</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>remote</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="993" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="993" bodyend="1004"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1abfe2da6f7c65dac51fec55e27e601756" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_create_op</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_create_op</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1006" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1006" bodyend="1016"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a2153cb7bde20abbe38a8df319bdb1b4e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_outgoing_select_ip_version</definition>
        <argsstring>(SephoneCall *call, SephoneAddress *to, SephoneProxyConfig *cfg)</argsstring>
        <name>sephone_call_outgoing_select_ip_version</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
          <declname>to</declname>
        </param>
        <param>
          <type><ref refid="group__proxies_1ga6de67319de408cf5e0994375df31f431" kindref="member">SephoneProxyConfig</ref> *</type>
          <declname>cfg</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1026" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1026" bodyend="1035"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1acb061574f955678e293e96ae6eae527e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_get_local_ip</definition>
        <argsstring>(SephoneCall *call, const SephoneAddress *remote_addr)</argsstring>
        <name>sephone_call_get_local_ip</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>const <ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
          <declname>remote_addr</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Fill the local ip that routes to the internet according to the destination, or guess it by other special means (upnp). </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1040" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1040" bodyend="1085"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a4f5055d45ebb482852f9a91846b81ab8" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_destroy</definition>
        <argsstring>(SephoneCall *obj)</argsstring>
        <name>sephone_call_destroy</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>obj</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1087" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1499" bodyend="1569"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ab7ed8d908c09c371241fa11a69050c04" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>BELLE_SIP_DECLARE_NO_IMPLEMENTED_INTERFACES</definition>
        <argsstring>(SephoneCall)</argsstring>
        <name>BELLE_SIP_DECLARE_NO_IMPLEMENTED_INTERFACES</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref></type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1089" column="1"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aa29bfd924cf9b00577f2e4f7df3ebd30" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>BELLE_SIP_INSTANCIATE_VPTR</definition>
        <argsstring>(SephoneCall, belle_sip_object_t,(belle_sip_object_destroy_t) sephone_call_destroy, NULL, NULL, FALSE)</argsstring>
        <name>BELLE_SIP_INSTANCIATE_VPTR</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref></type>
        </param>
        <param>
          <type>belle_sip_object_t</type>
        </param>
        <param>
          <type>(belle_sip_object_destroy_t)</type>
          <declname>sephone_call_destroy</declname>
        </param>
        <param>
          <type>NULL</type>
        </param>
        <param>
          <type>NULL</type>
        </param>
        <param>
          <type>FALSE</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1091" column="1"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a5e680bdb63dca8845919812fc13f03d7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
        <definition>SephoneCall* sephone_call_new_outgoing</definition>
        <argsstring>(struct _SephoneCore *lc, SephoneAddress *from, SephoneAddress *to, const SephoneCallParams *params, SephoneProxyConfig *cfg)</argsstring>
        <name>sephone_call_new_outgoing</name>
        <param>
          <type>struct _SephoneCore *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
          <declname>from</declname>
        </param>
        <param>
          <type><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
          <declname>to</declname>
        </param>
        <param>
          <type>const <ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref> *</type>
          <declname>params</declname>
        </param>
        <param>
          <type><ref refid="group__proxies_1ga6de67319de408cf5e0994375df31f431" kindref="member">SephoneProxyConfig</ref> *</type>
          <declname>cfg</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1098" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1098" bodyend="1137"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a4455ed6616d23774ae8a6e824a2f8d95" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_incoming_select_ip_version</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_incoming_select_ip_version</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1139" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1139" bodyend="1143"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1abab2de7f0fad607abb2a923e6ac05254" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_set_compatible_incoming_call_parameters</definition>
        <argsstring>(SephoneCall *call, const SalMediaDescription *md)</argsstring>
        <name>sephone_call_set_compatible_incoming_call_parameters</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>const SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Fix call parameters on incoming call to eg. enable AVPF if the incoming call propose it and it is not enabled locally. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1148" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1148" bodyend="1177"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a09bee1a06c4b48ac4963931da29a03c4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
        <definition>SephoneCall* sephone_call_new_incoming</definition>
        <argsstring>(SephoneCore *lc, SephoneAddress *from, SephoneAddress *to, SalOp *op)</argsstring>
        <name>sephone_call_new_incoming</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
          <declname>from</declname>
        </param>
        <param>
          <type><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
          <declname>to</declname>
        </param>
        <param>
          <type>SalOp *</type>
          <declname>op</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1179" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1179" bodyend="1284"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1afdee51a1d15799c9c65812ad785c1688" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_free_media_resources</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_free_media_resources</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1292" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1292" bodyend="1301"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ac2c43d612a6bdc031f73107f3e7685dd" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_set_released</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_set_released</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1306" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1306" bodyend="1328"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a8b9c91c9fb7b8705023a87710b5d124b" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_set_terminated</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_set_terminated</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1336" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1336" bodyend="1356"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ae69d262981a4b706201019500560c4e7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_fix_call_parameters</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_fix_call_parameters</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1358" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1358" bodyend="1364"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aa29eab75c497a7933ee2f8dc11aef33b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>const char* sephone_call_state_to_string</definition>
        <argsstring>(SephoneCallState cs)</argsstring>
        <name>sephone_call_state_to_string</name>
        <param>
          <type><ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref></type>
          <declname>cs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1366" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1366" bodyend="1416"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a43e9df3a088d74ac37bbd134563c3a7a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_set_state</definition>
        <argsstring>(SephoneCall *call, SephoneCallState cstate, const char *message)</argsstring>
        <name>sephone_call_set_state</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref></type>
          <declname>cstate</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>message</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1418" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1418" bodyend="1497"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1gaeb7203d1f76af26a8ebb341d22ef2cb6" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
        <definition>SephoneCall * sephone_call_ref</definition>
        <argsstring>(SephoneCall *obj)</argsstring>
        <name>sephone_call_ref</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Acquire a reference to the call. An application that wishes to retain a pointer to call object must use this function to unsure the pointer remains valid. Once the application no more needs this pointer, it must call <ref refid="group__call__control_1ga7a9033711fde2bb76c63421e8fe032b1" kindref="member">sephone_call_unref()</ref>. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">call</parametername>
</parameternamelist>
<parameterdescription>
<para>The call. </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The same call. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1576" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1576" bodyend="1579"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga7a9033711fde2bb76c63421e8fe032b1" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_unref</definition>
        <argsstring>(SephoneCall *obj)</argsstring>
        <name>sephone_call_unref</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Release reference to the call. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">call</parametername>
</parameternamelist>
<parameterdescription>
<para>The call. </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1581" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1581" bodyend="1583"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga159594c7b670cdf27b62ec84cad3257c" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>unsigned int</type>
        <definition>static unsigned int sephone_call_get_n_active_streams</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_n_active_streams</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1585" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1585" bodyend="1589"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga3440e61504e058274ecc74dd435938e4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const <ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref> *</type>
        <definition>const SephoneCallParams* sephone_call_get_current_params</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_current_params</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns current parameters associated to the call. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1594" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1594" bodyend="1654"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1gaea5a52a499338f37b62061f081d533c4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const <ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref> *</type>
        <definition>const SephoneCallParams* sephone_call_get_remote_params</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_remote_params</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns call parameters proposed by remote.</para><para>This is useful when receiving an incoming call, to know whether the remote party supports video, encryption or whatever. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1662" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1662" bodyend="1695"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga66cefc222900f62e99760c645cd3c981" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const <ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
        <definition>const SephoneAddress* sephone_call_get_remote_address</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_remote_address</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the remote address associated to this call </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1701" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1701" bodyend="1703"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1gaf2510ee219d96ab8c195c913f1ad7d71" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>char *</type>
        <definition>char* sephone_call_get_remote_address_as_string</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_remote_address_as_string</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the remote address associated to this call as a string.</para><para>The result string must be freed by user using ms_free(). </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1710" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1710" bodyend="1712"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1gaac1aaba397249d9694e4b0479821408a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref></type>
        <definition>SephoneCallState sephone_call_get_state</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_state</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Retrieves the call&apos;s current state. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1717" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1717" bodyend="1719"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga05a9a4af07d6eb0d4c2f5467df42557c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__misc_1ga68a1eac99c3622808ca47ec379951ff0" kindref="member">SephoneReason</ref></type>
        <definition>SephoneReason sephone_call_get_reason</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_reason</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the reason for a call termination (either error or normal termination) </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1724" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1724" bodyend="1726"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga6eecdf1838abb2e204512e5c54eb2a56" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const <ref refid="group__misc_1ga5b61cd0e899fd19430169cb6247b81da" kindref="member">SephoneErrorInfo</ref> *</type>
        <definition>const SephoneErrorInfo* sephone_call_get_error_info</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_error_info</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns full details about call errors or termination reasons. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1731" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1731" bodyend="1735"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1gada54acb7429f17afed544dc14d740202" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void *</type>
        <definition>void * sephone_call_get_user_data</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_user_data</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get the user pointer associated with the SephoneCall</para><para><simplesect kind="return"><para>an opaque user pointer that can be retrieved at any time</para></simplesect>
Retrieve the user pointer associated with the call. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">call</parametername>
</parameternamelist>
<parameterdescription>
<para>The call. </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The user pointer associated with the call. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1743" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1743" bodyend="1746"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga38326923bc80ba8fb0403b3b00dd105a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_set_user_data</definition>
        <argsstring>(SephoneCall *call, void *user_pointer)</argsstring>
        <name>sephone_call_set_user_data</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>void *</type>
          <declname>user_pointer</declname>
          <defname>ud</defname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Set the user pointer associated with the SephoneCall</para><para>the user pointer is an opaque user pointer that can be retrieved at any time in the SephoneCall</para><para>Assign a user pointer to the call. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">cfg</parametername>
</parameternamelist>
<parameterdescription>
<para>The call. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">ud</parametername>
</parameternamelist>
<parameterdescription>
<para>The user pointer to associate with the call. </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1755" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1755" bodyend="1758"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga6ebbc0a3f76e768276a693bf759a9c4f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__logs_1ga971dacd835550830e6ced30185f11c46" kindref="member">SephoneCallLog</ref> *</type>
        <definition>SephoneCallLog* sephone_call_get_call_log</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_call_log</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the call log associated to this call. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1763" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1763" bodyend="1765"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga318b87ed813b31f7559e07837b202f83" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>const char* sephone_call_get_refer_to</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_refer_to</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the refer-to uri (if the call was transfered). </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1770" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1770" bodyend="1772"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga3c2b196bf068e3dbd90a19e8a43ba3b0" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
        <definition>SephoneCall* sephone_call_get_transferer_call</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_transferer_call</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the transferer if this call was started automatically as a result of an incoming transfer request. The call in which the transfer request was received is returned in this case. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1778" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1778" bodyend="1780"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga877535080193a1f3645075acf93ad579" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
        <definition>SephoneCall* sephone_call_get_transfer_target_call</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_transfer_target_call</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>When this call has received a transfer request, returns the new call that was automatically created as a result of the transfer. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1785" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1785" bodyend="1787"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga84b90d3b5f2d7d3a8ef31475d4ab266e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__logs_1ga4159f13b5c527bfc44d62e37d5ac3959" kindref="member">SephoneCallDir</ref></type>
        <definition>SephoneCallDir sephone_call_get_dir</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_dir</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns direction of the call (incoming or outgoing). </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1792" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1792" bodyend="1794"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga8af0365acbad2ebec8ba21e0aefd9cbf" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>const char* sephone_call_get_remote_user_agent</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_remote_user_agent</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the far end&apos;s user agent description string, if available. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1799" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1799" bodyend="1804"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1gafb536f72a9e414b0856521d19e2a8f31" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>const char* sephone_call_get_remote_contact</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_remote_contact</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the far end&apos;s sip contact as a string, if available. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1809" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1809" bodyend="1818"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga31dcbe25e78d99e2c54b6eafca0afebc" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>bool_t sephone_call_has_transfer_pending</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_has_transfer_pending</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns true if this calls has received a transfer that has not been executed yet. Pending transfers are executed when this call is being paused or closed, locally or by remote endpoint. If the call is already paused while receiving the transfer request, the transfer immediately occurs. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1829" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1829" bodyend="1831"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga9fe28bbe62f3a7bab33b500d5171e343" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int sephone_call_get_duration</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_duration</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns call&apos;s duration in seconds. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1836" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1836" bodyend="1839"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga2b5ec62f4275d908d7e789d97e4aa11e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
        <definition>SephoneCall* sephone_call_get_replaced_call</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_replaced_call</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the call object this call is replacing, if any. Call replacement can occur during call transfers. By default, the core automatically terminates the replaced call and accept the new one. This function allows the application to know whether a new incoming call is a one that replaces another one. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1847" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1847" bodyend="1853"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga089f70019e298e9d2e64946d3fec53ab" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_enable_camera</definition>
        <argsstring>(SephoneCall *call, bool_t enable)</argsstring>
        <name>sephone_call_enable_camera</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>enable</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Indicate whether camera input should be sent to remote end. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1858" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1858" bodyend="1872"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga9aee48c0a7d7c5212f9bcc4f42594340" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_send_vfu_request</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_send_vfu_request</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Request remote side to send us a Video Fast Update. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1877" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1877" bodyend="1890"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga411c9519d37f35171e3db9a19a28b7df" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int sephone_call_take_video_snapshot</definition>
        <argsstring>(SephoneCall *call, const char *file)</argsstring>
        <name>sephone_call_take_video_snapshot</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>file</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Take a photo of currently received video and write it into a jpeg file. Note that the snapshot is asynchronous, an application shall not assume that the file is created when the function returns. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para>a SephoneCall </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>file</parametername>
</parameternamelist>
<parameterdescription>
<para>a path where to write the jpeg content. </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 if successfull, -1 otherwise (typically if jpeg format is not supported). </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1900" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1900" bodyend="1908"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga7343e80448f9d7f576dd4bb6c7c1b70e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int sephone_call_take_preview_snapshot</definition>
        <argsstring>(SephoneCall *call, const char *file)</argsstring>
        <name>sephone_call_take_preview_snapshot</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>file</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Take a photo of currently captured video and write it into a jpeg file. Note that the snapshot is asynchronous, an application shall not assume that the file is created when the function returns. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para>a SephoneCall </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>file</parametername>
</parameternamelist>
<parameterdescription>
<para>a path where to write the jpeg content. </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 if successfull, -1 otherwise (typically if jpeg format is not supported). </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1917" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1917" bodyend="1926"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1gaca73b03ea492af18f18bdfd1c9d32c9b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>bool_t sephone_call_camera_enabled</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_camera_enabled</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns TRUE if camera pictures are allowed to be sent to the remote party. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1931" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1931" bodyend="1933"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1ga3f960bc57f08e85f611ccf4c9f232de5" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>const char* sephone_privacy_to_string</definition>
        <argsstring>(SephonePrivacy privacy)</argsstring>
        <name>sephone_privacy_to_string</name>
        <param>
          <type><ref refid="group__call__control_1ga130b3ffd1280230f30735e4ffc218706" kindref="member">SephonePrivacy</ref></type>
          <declname>privacy</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para><simplesect kind="return"><para>string value of SephonePrivacy enum </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="1940" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="1940" bodyend="1951"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a5c0d23c8284420e8403373b439b2b053" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_set_next_video_frame_decoded_callback</definition>
        <argsstring>(SephoneCall *call, SephoneCallCbFunc cb, void *user_data)</argsstring>
        <name>sephone_call_set_next_video_frame_decoded_callback</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>SephoneCallCbFunc</type>
          <declname>cb</declname>
        </param>
        <param>
          <type>void *</type>
          <declname>user_data</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2072" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2072" bodyend="2079"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aa2fd1d726dfee0072d3fb20cc581b33b" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void port_config_set_random_choosed</definition>
        <argsstring>(SephoneCall *call, int stream_index, RtpSession *session)</argsstring>
        <name>port_config_set_random_choosed</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <param>
          <type>RtpSession *</type>
          <declname>session</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2081" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2081" bodyend="2084"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ae7483cf5e21a50cb1f137ffd9c0de8c1" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void _sephone_call_prepare_ice_for_stream</definition>
        <argsstring>(SephoneCall *call, int stream_index, bool_t create_checklist)</argsstring>
        <name>_sephone_call_prepare_ice_for_stream</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>create_checklist</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2086" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2086" bodyend="2102"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a493d3d703c4d1b995ca891a00cfb97e9" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int sephone_call_prepare_ice</definition>
        <argsstring>(SephoneCall *call, bool_t incoming_offer)</argsstring>
        <name>sephone_call_prepare_ice</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>incoming_offer</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2104" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2104" bodyend="2140"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a2e105d405dfb1c8bcb81372958b4fa7f" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_join_multicast_group</definition>
        <argsstring>(SephoneCall *call, int stream_index, MediaStream *ms)</argsstring>
        <name>sephone_call_join_multicast_group</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <param>
          <type>MediaStream *</type>
          <declname>ms</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2143" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2143" bodyend="2147"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a32dbe2f7f80e8c37d6a96442f4e4b08b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_init_audio_stream</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_init_audio_stream</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2149" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2149" bodyend="2262"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a873479fae75f1095b280fe1f73315270" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_init_video_stream</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_init_video_stream</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2264" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2264" bodyend="2349"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ad501a47e1b92a8153dcf428229ebbd75" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_init_media_streams</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_init_media_streams</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2351" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2351" bodyend="2355"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a1f33e7644be6ca271bdcf826df88cf4a" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_core_umsg_received</definition>
        <argsstring>(SephoneCore *lc, const char *message)</argsstring>
        <name>sephone_core_umsg_received</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>message</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2357" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2357" bodyend="2359"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a5b466eb173cba366551dd855db023458" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_core_dtmf_received</definition>
        <argsstring>(SephoneCore *lc, int dtmf)</argsstring>
        <name>sephone_core_dtmf_received</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>int</type>
          <declname>dtmf</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2363" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2363" bodyend="2369"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a2158284efe71bf6a612b7c9c7f1090f4" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void parametrize_equalizer</definition>
        <argsstring>(SephoneCore *lc, AudioStream *st)</argsstring>
        <name>parametrize_equalizer</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>AudioStream *</type>
          <declname>st</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2371" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2371" bodyend="2391"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a58349d458c976825b5bb5acac3ac0ba3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void set_mic_gain_db</definition>
        <argsstring>(AudioStream *st, float gain)</argsstring>
        <name>set_mic_gain_db</name>
        <param>
          <type>AudioStream *</type>
          <declname>st</declname>
        </param>
        <param>
          <type>float</type>
          <declname>gain</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2393" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2393" bodyend="2395"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ad24c5225984867d4df9011fa1d0cc136" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void set_playback_gain_db</definition>
        <argsstring>(AudioStream *st, float gain)</argsstring>
        <name>set_playback_gain_db</name>
        <param>
          <type>AudioStream *</type>
          <declname>st</declname>
        </param>
        <param>
          <type>float</type>
          <declname>gain</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2397" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2397" bodyend="2401"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a120a8106140b973375fe571bb49fba46" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void _post_configure_audio_stream</definition>
        <argsstring>(AudioStream *st, SephoneCore *lc, bool_t muted)</argsstring>
        <name>_post_configure_audio_stream</name>
        <param>
          <type>AudioStream *</type>
          <declname>st</declname>
        </param>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>muted</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2404" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2404" bodyend="2482"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ae8c4098077cd96c70386093b449fa405" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void post_configure_audio_streams</definition>
        <argsstring>(SephoneCall *call, bool_t muted)</argsstring>
        <name>post_configure_audio_streams</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>muted</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2484" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2484" bodyend="2494"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a4fb4cd9b3bb292c3185cad737148f932" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int get_ideal_audio_bw</definition>
        <argsstring>(SephoneCall *call, const SalMediaDescription *md, const SalStreamDescription *desc)</argsstring>
        <name>get_ideal_audio_bw</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>const SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <param>
          <type>const SalStreamDescription *</type>
          <declname>desc</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2496" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2496" bodyend="2526"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aca4360e35fd963297e56673571efd8ae" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int get_video_bw</definition>
        <argsstring>(SephoneCall *call, const SalMediaDescription *md, const SalStreamDescription *desc)</argsstring>
        <name>get_video_bw</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>const SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <param>
          <type>const SalStreamDescription *</type>
          <declname>desc</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2528" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2528" bodyend="2540"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ab0cc783373d61ba867a592bbec4534b9" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>RtpProfile *</type>
        <definition>static RtpProfile* make_profile</definition>
        <argsstring>(SephoneCall *call, const SalMediaDescription *md, const SalStreamDescription *desc, int *used_pt)</argsstring>
        <name>make_profile</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>const SalMediaDescription *</type>
          <declname>md</declname>
        </param>
        <param>
          <type>const SalStreamDescription *</type>
          <declname>desc</declname>
        </param>
        <param>
          <type>int *</type>
          <declname>used_pt</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2542" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2542" bodyend="2598"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1acff0efb666192943fb91c62315b790af" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void setup_ring_player</definition>
        <argsstring>(SephoneCore *lc, SephoneCall *call)</argsstring>
        <name>setup_ring_player</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2601" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2601" bodyend="2605"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1af793d1c09923913791d1660867f3414c" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>static bool_t sephone_call_sound_resources_available</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_sound_resources_available</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2607" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2607" bodyend="2612"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1af45d05a2d4bdbb492c85ee84159243aa" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int find_crypto_index_from_tag</definition>
        <argsstring>(const SalSrtpCryptoAlgo crypto[], unsigned char tag)</argsstring>
        <name>find_crypto_index_from_tag</name>
        <param>
          <type>const SalSrtpCryptoAlgo</type>
          <declname>crypto</declname>
          <array>[]</array>
        </param>
        <param>
          <type>unsigned char</type>
          <declname>tag</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2614" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2614" bodyend="2622"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aeb3993e7197451cb6c1fa5e39b4b1d96" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void configure_rtp_session_for_rtcp_xr</definition>
        <argsstring>(SephoneCore *lc, SephoneCall *call, SalStreamType type)</argsstring>
        <name>configure_rtp_session_for_rtcp_xr</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>SalStreamType</type>
          <declname>type</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2624" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2624" bodyend="2657"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ad90b4822c9d247b1842c22ccb24bbf4d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void start_dtls</definition>
        <argsstring>(MSMediaStreamSessions *sessions, const SalStreamDescription *sd, const SalStreamDescription *remote)</argsstring>
        <name>start_dtls</name>
        <param>
          <type>MSMediaStreamSessions *</type>
          <declname>sessions</declname>
        </param>
        <param>
          <type>const SalStreamDescription *</type>
          <declname>sd</declname>
        </param>
        <param>
          <type>const SalStreamDescription *</type>
          <declname>remote</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2659" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2659" bodyend="2672"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ac1219560c42cf392f181b9d5c1e5cf8e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void start_dtls_on_all_streams</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>start_dtls_on_all_streams</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2674" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2674" bodyend="2693"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a139e8fb30508cae7a7fbc8cd20d98527" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void set_dtls_fingerprint</definition>
        <argsstring>(MSMediaStreamSessions *sessions, const SalStreamDescription *sd, const SalStreamDescription *remote)</argsstring>
        <name>set_dtls_fingerprint</name>
        <param>
          <type>MSMediaStreamSessions *</type>
          <declname>sessions</declname>
        </param>
        <param>
          <type>const SalStreamDescription *</type>
          <declname>sd</declname>
        </param>
        <param>
          <type>const SalStreamDescription *</type>
          <declname>remote</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2695" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2695" bodyend="2706"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1abdd8fe9613eafcdf78cd68d39e35182e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void set_dtls_fingerprint_on_all_streams</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>set_dtls_fingerprint_on_all_streams</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2708" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2708" bodyend="2728"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a66d7f8615958a7fcce2541a17d168da6" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_start_audio_stream</definition>
        <argsstring>(SephoneCall *call, bool_t muted, bool_t send_ringbacktone, bool_t use_arc)</argsstring>
        <name>sephone_call_start_audio_stream</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>muted</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>send_ringbacktone</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>use_arc</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2730" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2730" bodyend="2893"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a032025294c0ec55e92426657360a080d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_start_video_stream</definition>
        <argsstring>(SephoneCall *call, bool_t all_inputs_muted)</argsstring>
        <name>sephone_call_start_video_stream</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>all_inputs_muted</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="2895" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="2895" bodyend="3020"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1afe8b7bb41190d6df41dfa58a5ca9f114" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void setZrtpCryptoTypesParameters</definition>
        <argsstring>(MSZrtpParams *params, SephoneCore *lc)</argsstring>
        <name>setZrtpCryptoTypesParameters</name>
        <param>
          <type>MSZrtpParams *</type>
          <declname>params</declname>
        </param>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3022" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3022" bodyend="3075"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a9be20c076a334b12959a657e8b7d0a4d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_start_media_streams</definition>
        <argsstring>(SephoneCall *call, bool_t all_inputs_muted, bool_t send_ringbacktone)</argsstring>
        <name>sephone_call_start_media_streams</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>all_inputs_muted</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>send_ringbacktone</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3077" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3077" bodyend="3143"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1af26a2aa06ea0b3acae828fe776482cdf" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_stop_media_streams_for_ice_gathering</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_stop_media_streams_for_ice_gathering</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3145" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3145" bodyend="3153"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aee1115c7534c9f5eb59385a8121244e3" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>static bool_t update_stream_crypto_params</definition>
        <argsstring>(SephoneCall *call, const SalStreamDescription *local_st_desc, SalStreamDescription *old_stream, SalStreamDescription *new_stream, MediaStream *ms)</argsstring>
        <name>update_stream_crypto_params</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>const SalStreamDescription *</type>
          <declname>local_st_desc</declname>
        </param>
        <param>
          <type>SalStreamDescription *</type>
          <declname>old_stream</declname>
        </param>
        <param>
          <type>SalStreamDescription *</type>
          <declname>new_stream</declname>
        </param>
        <param>
          <type>MediaStream *</type>
          <declname>ms</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3155" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3155" bodyend="3168"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1afbd9cd9673b4b20456559f3929a7455c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_update_crypto_parameters</definition>
        <argsstring>(SephoneCall *call, SalMediaDescription *old_md, SalMediaDescription *new_md)</argsstring>
        <name>sephone_call_update_crypto_parameters</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>SalMediaDescription *</type>
          <declname>old_md</declname>
        </param>
        <param>
          <type>SalMediaDescription *</type>
          <declname>new_md</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3170" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3170" bodyend="3192"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1acc12988adf3a2e1cf3cf6f4f6edc5708" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_update_remote_session_id_and_ver</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_update_remote_session_id_and_ver</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3194" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3194" bodyend="3200"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ab349be436a120c9f930f194d7ece429d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_delete_ice_session</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_delete_ice_session</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3202" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3202" bodyend="3212"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ad21d2657e53e36bd48ca7755de716754" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_delete_upnp_session</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_delete_upnp_session</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3214" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3214" bodyend="3221"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1af0fcae2cdc83a5d2ab026a7be844066d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_log_fill_stats</definition>
        <argsstring>(SephoneCallLog *log, MediaStream *st)</argsstring>
        <name>sephone_call_log_fill_stats</name>
        <param>
          <type><ref refid="group__call__logs_1ga971dacd835550830e6ced30185f11c46" kindref="member">SephoneCallLog</ref> *</type>
          <declname>log</declname>
        </param>
        <param>
          <type>MediaStream *</type>
          <declname>st</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3223" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3223" bodyend="3230"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a117e327215676b7a97936747da063e51" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_stop_audio_stream</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_stop_audio_stream</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3232" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3232" bodyend="3259"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1af03d2c42b80c46b25a128a512f325491" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_call_stop_video_stream</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_stop_video_stream</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3261" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3261" bodyend="3277"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ae6a87633f528fa2dd0fefeac9bcc35dc" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void unset_rtp_profile</definition>
        <argsstring>(SephoneCall *call, int i)</argsstring>
        <name>unset_rtp_profile</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>i</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3279" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3279" bodyend="3282"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1acebb63ac0ad8cc5f806ac5a799c89694" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_stop_media_streams_ticker</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_stop_media_streams_ticker</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3284" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3284" bodyend="3291"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a0881029acb73af5cf4543375fcc26f1e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_stop_media_streams</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_stop_media_streams</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3293" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3293" bodyend="3316"/>
      </memberdef>
      <memberdef kind="function" id="group__media__parameters_1gac75a9bd832ae1af4475d0ab43bd7ba00" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_enable_echo_cancellation</definition>
        <argsstring>(SephoneCall *call, bool_t enable)</argsstring>
        <name>sephone_call_enable_echo_cancellation</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>val</declname>
          <defname>enable</defname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Enables or disable echo cancellation for this call <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para></para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>val</parametername>
</parameternamelist>
<parameterdescription>
<para></para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3318" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3318" bodyend="3323"/>
      </memberdef>
      <memberdef kind="function" id="group__media__parameters_1gaff93698b2522568eb01a3247605af621" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>bool_t sephone_call_echo_cancellation_enabled</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_echo_cancellation_enabled</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>lc</declname>
          <defname>call</defname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns TRUE if echo cancellation is enabled. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3325" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3325" bodyend="3333"/>
      </memberdef>
      <memberdef kind="function" id="group__media__parameters_1gadbed05f8e46b3b3a4e21365e1a7eeeb3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_enable_echo_limiter</definition>
        <argsstring>(SephoneCall *call, bool_t val)</argsstring>
        <name>sephone_call_enable_echo_limiter</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>val</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Enables or disable echo limiter for this call <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para></para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>val</parametername>
</parameternamelist>
<parameterdescription>
<para></para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3335" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3335" bodyend="3347"/>
      </memberdef>
      <memberdef kind="function" id="group__media__parameters_1gadf0ecfd5f34ad96a8c721a291fbe6b6a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>bool_t sephone_call_echo_limiter_enabled</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_echo_limiter_enabled</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns TRUE if echo limiter is enabled. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3349" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3349" bodyend="3355"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga8c9584250ee9cf8fc3455d9745a6f44d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_get_play_volume</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_play_volume</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the measured sound volume played locally (received from remote). It is expressed in dbm0. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3366" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3366" bodyend="3375"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga3cbfb0fe9e97b1defa6a752602ee9d38" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_get_record_volume</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_record_volume</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the measured sound volume recorded locally (sent to remote). It is expressed in dbm0. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3381" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3381" bodyend="3390"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga71ce4befa08f9c633bee39948a5432f1" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_get_current_quality</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_current_quality</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Obtain real-time quality rating of the call</para><para>Based on local RTP statistics and RTCP feedback, a quality rating is computed and updated during all the duration of the call. This function returns its value at the time of the function call. It is expected that the rating is updated at least every 5 seconds or so. The rating is a floating point number comprised between 0 and 5.</para><para>4-5 = good quality <linebreak/>
 3-4 = average quality <linebreak/>
 2-3 = poor quality <linebreak/>
 1-2 = very poor quality <linebreak/>
 0-1 = can&apos;t be worse, mostly unusable <linebreak/>
</para><para><simplesect kind="return"><para>The function returns -1 if no quality measurement is available, for example if no active audio stream exist. Otherwise it returns the quality rating. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3409" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3409" bodyend="3424"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga4a31fe4535dc6be79245f957dc39c205" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_get_average_quality</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_average_quality</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns call quality averaged over all the duration of the call.</para><para>See <ref refid="group__call__misc_1ga71ce4befa08f9c633bee39948a5432f1" kindref="member">sephone_call_get_current_quality()</ref> for more details about quality measurement. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3431" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3431" bodyend="3436"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga1979fb9abf7067611581c8652c9f487d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void update_local_stats</definition>
        <argsstring>(SephoneCallStats *stats, MediaStream *stream)</argsstring>
        <name>update_local_stats</name>
        <param>
          <type><ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <param>
          <type>MediaStream *</type>
          <declname>stream</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3438" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3438" bodyend="3444"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1gab1cb34cfb1213f0b4eac212dcd699153" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
        <definition>const SephoneCallStats* sephone_call_get_audio_stats</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_audio_stats</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Access last known statistics for audio stream, for a given call. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3449" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3449" bodyend="3455"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga20854944741052bcca9734614271968a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
        <definition>const SephoneCallStats* sephone_call_get_video_stats</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_video_stats</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Access last known statistics for video stream, for a given call. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3460" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3460" bodyend="3466"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga29de797d8e7f7136dadc24aba0b73fec" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>static bool_t ice_in_progress</definition>
        <argsstring>(SephoneCallStats *stats)</argsstring>
        <name>ice_in_progress</name>
        <param>
          <type><ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3468" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3468" bodyend="3470"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1gaf694bfd45a9dae9d3c6c08020a374c7b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>bool_t sephone_call_media_in_progress</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_media_in_progress</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Indicates whether an operation is in progress at the media side. It can a bad idea to initiate signaling operations (adding video, pausing the call, removing video, changing video parameters) while the media is busy in establishing the connection (typically ICE connectivity checks). It can result in failures generating loss of time in future operations in the call. Applications are invited to check this function after each call state change to decide whether certain operations are permitted or not. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para>the call </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>TRUE if media is busy in establishing the connection, FALSE otherwise. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3481" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3481" bodyend="3487"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga4b787d24f1e05e0bff2365c4a47e0352" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_stats_get_sender_loss_rate</definition>
        <argsstring>(const SephoneCallStats *stats)</argsstring>
        <name>sephone_call_stats_get_sender_loss_rate</name>
        <param>
          <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get the local loss rate since last report <simplesect kind="return"><para>The sender loss rate </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3493" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3493" bodyend="3508"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga008ba2a56aed340943fea60a8032a245" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_stats_get_receiver_loss_rate</definition>
        <argsstring>(const SephoneCallStats *stats)</argsstring>
        <name>sephone_call_stats_get_receiver_loss_rate</name>
        <param>
          <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Gets the remote reported loss rate since last report <simplesect kind="return"><para>The receiver loss rate </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3514" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3514" bodyend="3529"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1gaf2ee06344acd6a4ba2993fd41c8b9c52" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_stats_get_sender_interarrival_jitter</definition>
        <argsstring>(const SephoneCallStats *stats, SephoneCall *call)</argsstring>
        <name>sephone_call_stats_get_sender_interarrival_jitter</name>
        <param>
          <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Gets the local interarrival jitter <simplesect kind="return"><para>The interarrival jitter at last emitted sender report </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3535" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3535" bodyend="3561"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga8e3c36ede5ed6d6be0b6aa3fdfe84b1d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_stats_get_receiver_interarrival_jitter</definition>
        <argsstring>(const SephoneCallStats *stats, SephoneCall *call)</argsstring>
        <name>sephone_call_stats_get_receiver_interarrival_jitter</name>
        <param>
          <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Gets the remote reported interarrival jitter <simplesect kind="return"><para>The interarrival jitter at last received receiver report </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3567" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3567" bodyend="3593"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1gad099503cff9440055cab5cafdca098d0" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint64_t</type>
        <definition>uint64_t sephone_call_stats_get_late_packets_cumulative_number</definition>
        <argsstring>(const SephoneCallStats *stats, SephoneCall *call)</argsstring>
        <name>sephone_call_stats_get_late_packets_cumulative_number</name>
        <param>
          <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Gets the cumulative number of late packets <simplesect kind="return"><para>The cumulative number of late packets </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3599" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3599" bodyend="3612"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga23c6de3b426b485773195c7ea55c5b84" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_stats_get_download_bandwidth</definition>
        <argsstring>(const SephoneCallStats *stats)</argsstring>
        <name>sephone_call_stats_get_download_bandwidth</name>
        <param>
          <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get the bandwidth measurement of the received stream, expressed in kbit/s, including IP/UDP/RTP headers. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">stats</parametername>
</parameternamelist>
<parameterdescription>
<para>SephoneCallStats object </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The bandwidth measurement of the received stream in kbit/s. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3619" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3619" bodyend="3621"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1gae2755463428f50d9e4a393297205b847" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float sephone_call_stats_get_upload_bandwidth</definition>
        <argsstring>(const SephoneCallStats *stats)</argsstring>
        <name>sephone_call_stats_get_upload_bandwidth</name>
        <param>
          <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get the bandwidth measurement of the sent stream, expressed in kbit/s, including IP/UDP/RTP headers. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">stats</parametername>
</parameternamelist>
<parameterdescription>
<para>SephoneCallStats object </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The bandwidth measurement of the sent stream in kbit/s. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3628" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3628" bodyend="3630"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga2f9dacf093fb6befa87d8ecacaf5ff8a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__initializing_1ga532b825cacd9626b10dae44daa01e6cd" kindref="member">SephoneIceState</ref></type>
        <definition>SephoneIceState sephone_call_stats_get_ice_state</definition>
        <argsstring>(const SephoneCallStats *stats)</argsstring>
        <name>sephone_call_stats_get_ice_state</name>
        <param>
          <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get the state of ICE processing. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">stats</parametername>
</parameternamelist>
<parameterdescription>
<para>SephoneCallStats object </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The state of ICE processing. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3637" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3637" bodyend="3639"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1gaf02069935224979852714dd63caa8988" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__initializing_1gaa8e9e1a6c47e4489119f978b7f3ebc11" kindref="member">SephoneUpnpState</ref></type>
        <definition>SephoneUpnpState sephone_call_stats_get_upnp_state</definition>
        <argsstring>(const SephoneCallStats *stats)</argsstring>
        <name>sephone_call_stats_get_upnp_state</name>
        <param>
          <type>const <ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get the state of uPnP processing. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">stats</parametername>
</parameternamelist>
<parameterdescription>
<para>SephoneCallStats object </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The state of uPnP processing. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3646" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3646" bodyend="3648"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1gafe73207455c50945718abb84b3baf950" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_start_recording</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_start_recording</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Start call recording. The output file where audio is recorded must be previously specified with <ref refid="group__call__control_1ga885463eb825a75de4cc5c5835daf9e4f" kindref="member">sephone_call_params_set_record_file()</ref>. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3654" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3654" bodyend="3668"/>
      </memberdef>
      <memberdef kind="function" id="group__call__misc_1ga82c91bb0ba077758f818657a783de41d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_stop_recording</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_stop_recording</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Stop call recording. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3673" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3673" bodyend="3681"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a48387224628ed06c48bbaa8aab5d5425" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void report_bandwidth</definition>
        <argsstring>(SephoneCall *call, MediaStream *as, MediaStream *vs)</argsstring>
        <name>report_bandwidth</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>MediaStream *</type>
          <declname>as</declname>
        </param>
        <param>
          <type>MediaStream *</type>
          <declname>vs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
<para>&lt; Every seconds SephoneCallStats object has been updated</para><para>&lt; Every seconds SephoneCallStats object has been updated </para>        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3687" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3687" bodyend="3755"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a70fb818163ec67602ceda64b36f253f1" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sephone_core_disconnected</definition>
        <argsstring>(SephoneCore *lc, SephoneCall *call)</argsstring>
        <name>sephone_core_disconnected</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3757" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3757" bodyend="3770"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a33078e4c08b742b642432d1391deab36" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void change_ice_media_destinations</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>change_ice_media_destinations</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3772" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3772" bodyend="3798"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aa1b6ccf7ac68e47dc02121c3e44ebdb4" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void handle_ice_events</definition>
        <argsstring>(SephoneCall *call, OrtpEvent *ev)</argsstring>
        <name>handle_ice_events</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>OrtpEvent *</type>
          <declname>ev</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3800" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3800" bodyend="3927"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a45f34b8b54012ba278e0852c4621ac82" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_stats_fill</definition>
        <argsstring>(SephoneCallStats *stats, MediaStream *ms, OrtpEvent *ev)</argsstring>
        <name>sephone_call_stats_fill</name>
        <param>
          <type><ref refid="group__call__misc_1gaef3a920227867fd07330c3f2d8806e9f" kindref="member">SephoneCallStats</ref> *</type>
          <declname>stats</declname>
        </param>
        <param>
          <type>MediaStream *</type>
          <declname>ms</declname>
        </param>
        <param>
          <type>OrtpEvent *</type>
          <declname>ev</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
<para>&lt; received_rtcp field of SephoneCallStats object has been updated</para><para>&lt; sent_rtcp field of SephoneCallStats object has been updated </para>        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3931" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3931" bodyend="3952"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ab43bbb0b62ffd4dc28ee01e3779acb8e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_notify_stats_updated</definition>
        <argsstring>(SephoneCall *call, int stream_index)</argsstring>
        <name>sephone_call_notify_stats_updated</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
<para>&lt; received_rtcp field of SephoneCallStats object has been updated</para><para>&lt; sent_rtcp field of SephoneCallStats object has been updated </para>        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3965" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3965" bodyend="3979"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ac1cb5a4bc7848481f8eddaf7b2bc8107" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_handle_stream_events</definition>
        <argsstring>(SephoneCall *call, int stream_index)</argsstring>
        <name>sephone_call_handle_stream_events</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>int</type>
          <declname>stream_index</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="3981" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="3981" bodyend="4101"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1af4e07901cbbdc7366000b355bd0c3361" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_background_tasks</definition>
        <argsstring>(SephoneCall *call, bool_t one_second_elapsed)</argsstring>
        <name>sephone_call_background_tasks</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>bool_t</type>
          <declname>one_second_elapsed</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4103" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4103" bodyend="4143"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a3db8b00ea81c33e9c83a5899a0820268" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_log_completed</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_log_completed</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4145" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4145" bodyend="4172"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ab9beaa202520444dc9a27cfb167e2c20" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref></type>
        <definition>SephoneCallState sephone_call_get_transfer_state</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_transfer_state</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns the current transfer state, if a transfer has been initiated from this call. <simplesect kind="see"><para><ref refid="group__call__control_1ga304a9a398bc905749d8f63a62dca0d4e" kindref="member">sephone_core_transfer_call()</ref> , <ref refid="group__call__control_1ga14bc153716b1f9e7bf593386c9b8521b" kindref="member">sephone_core_transfer_call_to_another()</ref> </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4178" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4178" bodyend="4180"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a7393eec062ca259f99868c0d2ed97bca" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_set_transfer_state</definition>
        <argsstring>(SephoneCall *call, SephoneCallState state)</argsstring>
        <name>sephone_call_set_transfer_state</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref></type>
          <declname>state</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4182" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4182" bodyend="4191"/>
      </memberdef>
      <memberdef kind="function" id="group__call__control_1gae5b397daf3c42da3d67b41111cb17d7b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool_t</type>
        <definition>bool_t sephone_call_is_in_conference</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_is_in_conference</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Return TRUE if this call is currently part of a conference <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>TRUE if part of a conference.</para></simplesect>
<xrefsect id="deprecated_1_deprecated000038"><xreftitle>Deprecated</xreftitle><xrefdescription></xrefdescription></xrefsect></para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4193" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4193" bodyend="4195"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a5addf8d9ca10ae8919a63fa0b68be5cb" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_zoom_video</definition>
        <argsstring>(SephoneCall *call, float zoom_factor, float *cx, float *cy)</argsstring>
        <name>sephone_call_zoom_video</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>float</type>
          <declname>zoom_factor</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>cx</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>cy</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Perform a zoom of the video displayed during a call. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para>the call. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>zoom_factor</parametername>
</parameternamelist>
<parameterdescription>
<para>a floating point number describing the zoom factor. A value 1.0 corresponds to no zoom applied. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>cx</parametername>
</parameternamelist>
<parameterdescription>
<para>a floating point number pointing the horizontal center of the zoom to be applied. This value should be between 0.0 and 1.0. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>cy</parametername>
</parameternamelist>
<parameterdescription>
<para>a floating point number pointing the vertical center of the zoom to be applied. This value should be between 0.0 and 1.0.</para></parameterdescription>
</parameteritem>
</parameterlist>
cx and cy are updated in return in case their coordinates were too excentrated for the requested zoom factor. The zoom ensures that all the screen is fullfilled with the video. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4206" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4206" bodyend="4230"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a8587114903b22e20ada57eb9e792ff87" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref> *</type>
        <definition>static SephoneAddress* get_fixed_contact</definition>
        <argsstring>(SephoneCore *lc, SephoneCall *call, SephoneProxyConfig *dest_proxy)</argsstring>
        <name>get_fixed_contact</name>
        <param>
          <type><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref> *</type>
          <declname>lc</declname>
        </param>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type><ref refid="group__proxies_1ga6de67319de408cf5e0994375df31f431" kindref="member">SephoneProxyConfig</ref> *</type>
          <declname>dest_proxy</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4232" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4232" bodyend="4265"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a503c87929056495a50c540bdc51eec18" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_set_contact_op</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_set_contact_op</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4267" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4267" bodyend="4283"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1aaacf00ecd7825043b14a7817450e60e3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="group__call__control_1gaf8c8a5e36ff3047d29df670f36005a30" kindref="member">SephonePlayer</ref> *</type>
        <definition>SephonePlayer* sephone_call_get_player</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_get_player</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4285" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4285" bodyend="4289"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a26e060428b713062a0e46a8975997be7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_set_new_params</definition>
        <argsstring>(SephoneCall *call, const SephoneCallParams *params)</argsstring>
        <name>sephone_call_set_new_params</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>const <ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref> *</type>
          <declname>params</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4291" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4291" bodyend="4296"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1ace6a40ce20fa536edc9235e2afd5c8f5" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int send_dtmf_handler</definition>
        <argsstring>(void *data, unsigned int revents)</argsstring>
        <name>send_dtmf_handler</name>
        <param>
          <type>void *</type>
          <declname>data</declname>
        </param>
        <param>
          <type>unsigned int</type>
          <declname>revents</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4298" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4298" bodyend="4329"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a2eb01075dd38b6170d9e1fa59c26fa00" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int sephone_call_send_dtmf</definition>
        <argsstring>(SephoneCall *call, char dtmf)</argsstring>
        <name>sephone_call_send_dtmf</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>lc</declname>
          <defname>call</defname>
        </param>
        <param>
          <type>char</type>
          <declname>dtmf</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Send the specified dtmf.</para><para>The dtmf is automatically played to the user. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para>The SephoneCall object </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>dtmf</parametername>
</parameternamelist>
<parameterdescription>
<para>The dtmf name specified as a char, such as &apos;0&apos;, &apos;#&apos; etc... </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 if successful, -1 on error. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4330" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4330" bodyend="4339"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a395b635daf363d099fefd30ee79e7269" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int sephone_call_send_dtmfs</definition>
        <argsstring>(SephoneCall *call, char *dtmfs)</argsstring>
        <name>sephone_call_send_dtmfs</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>char *</type>
          <declname>dtmfs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Send a list of dtmf.</para><para>The dtmfs are automatically sent to remote, separated by some needed customizable delay. Sending is canceled if the call state changes to something not SephoneCallStreamsRunning. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para>The SephoneCall object </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>dtmfs</parametername>
</parameternamelist>
<parameterdescription>
<para>A dtmf sequence such as &apos;123#123123&apos; </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>-2 if there is already a DTMF sequence, -1 if call is not ready, 0 otherwise. </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4341" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4341" bodyend="4356"/>
      </memberdef>
      <memberdef kind="function" id="sephonecall_8c_1a18ff9153040d72b1ab7ad846880e4d56" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_cancel_dtmfs</definition>
        <argsstring>(SephoneCall *call)</argsstring>
        <name>sephone_call_cancel_dtmfs</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Stop current DTMF sequence sending.</para><para>Please note that some DTMF could be already sent, depending on when this function call is delayed from #sephone_call_send_dtmfs. This function will be automatically called if call state change to anything but SephoneCallStreamsRunning.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>call</parametername>
</parameternamelist>
<parameterdescription>
<para>The SephoneCall object </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4358" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4358" bodyend="4369"/>
      </memberdef>
      <memberdef kind="function" id="group__media__parameters_1gab30a6b7917180f3c59cb8b72d15a1a1c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>unsigned long</type>
        <definition>unsigned long sephone_call_get_native_video_window_id</definition>
        <argsstring>(const SephoneCall *call)</argsstring>
        <name>sephone_call_get_native_video_window_id</name>
        <param>
          <type>const <ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get the native window handle of the video window, casted as an unsigned long. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4371" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4371" bodyend="4383"/>
      </memberdef>
      <memberdef kind="function" id="group__media__parameters_1ga58335d34928eb7b997ae59abeb1ee280" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void sephone_call_set_native_video_window_id</definition>
        <argsstring>(SephoneCall *call, unsigned long id)</argsstring>
        <name>sephone_call_set_native_video_window_id</name>
        <param>
          <type><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref> *</type>
          <declname>call</declname>
        </param>
        <param>
          <type>unsigned long</type>
          <declname>id</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Set the native video window id where the video is to be displayed. For MacOS, Linux, Windows: if not set or 0 a window will be automatically created, unless the special id -1 is given. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" line="4385" column="1" bodyfile="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c" bodystart="4385" bodyend="4392"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="3"><highlight class="comment">sephonecall.c</highlight></codeline>
<codeline lineno="4"><highlight class="comment">Copyright<sp/>(C)<sp/>2010<sp/><sp/>Belledonne<sp/>Communications<sp/>SARL</highlight></codeline>
<codeline lineno="5"><highlight class="comment"><sp/>(simon.morlat@linphone.org)</highlight></codeline>
<codeline lineno="6"><highlight class="comment"></highlight></codeline>
<codeline lineno="7"><highlight class="comment">This<sp/>program<sp/>is<sp/>free<sp/>software;<sp/>you<sp/>can<sp/>redistribute<sp/>it<sp/>and/or</highlight></codeline>
<codeline lineno="8"><highlight class="comment">modify<sp/>it<sp/>under<sp/>the<sp/>terms<sp/>of<sp/>the<sp/>GNU<sp/>General<sp/>Public<sp/>License</highlight></codeline>
<codeline lineno="9"><highlight class="comment">as<sp/>published<sp/>by<sp/>the<sp/>Free<sp/>Software<sp/>Foundation;<sp/>either<sp/>version<sp/>2</highlight></codeline>
<codeline lineno="10"><highlight class="comment">of<sp/>the<sp/>License,<sp/>or<sp/>(at<sp/>your<sp/>option)<sp/>any<sp/>later<sp/>version.</highlight></codeline>
<codeline lineno="11"><highlight class="comment"></highlight></codeline>
<codeline lineno="12"><highlight class="comment">This<sp/>program<sp/>is<sp/>distributed<sp/>in<sp/>the<sp/>hope<sp/>that<sp/>it<sp/>will<sp/>be<sp/>useful,</highlight></codeline>
<codeline lineno="13"><highlight class="comment">but<sp/>WITHOUT<sp/>ANY<sp/>WARRANTY;<sp/>without<sp/>even<sp/>the<sp/>implied<sp/>warranty<sp/>of</highlight></codeline>
<codeline lineno="14"><highlight class="comment">MERCHANTABILITY<sp/>or<sp/>FITNESS<sp/>FOR<sp/>A<sp/>PARTICULAR<sp/>PURPOSE.<sp/><sp/>See<sp/>the</highlight></codeline>
<codeline lineno="15"><highlight class="comment">GNU<sp/>General<sp/>Public<sp/>License<sp/>for<sp/>more<sp/>details.</highlight></codeline>
<codeline lineno="16"><highlight class="comment"></highlight></codeline>
<codeline lineno="17"><highlight class="comment">You<sp/>should<sp/>have<sp/>received<sp/>a<sp/>copy<sp/>of<sp/>the<sp/>GNU<sp/>General<sp/>Public<sp/>License</highlight></codeline>
<codeline lineno="18"><highlight class="comment">along<sp/>with<sp/>this<sp/>program;<sp/>if<sp/>not,<sp/>write<sp/>to<sp/>the<sp/>Free<sp/>Software</highlight></codeline>
<codeline lineno="19"><highlight class="comment">Foundation,<sp/>Inc.,<sp/>59<sp/>Temple<sp/>Place<sp/>-<sp/>Suite<sp/>330,<sp/>Boston,<sp/>MA<sp/><sp/>02111-1307,<sp/>USA.</highlight></codeline>
<codeline lineno="20"><highlight class="comment">*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>WIN32</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;time.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="comment">//<sp/><inttypes.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>PRId64<sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;I64d&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;sephonecore.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;sipsetup.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;spconfig.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;private.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;ortp/event.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;ortp/b64.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;math.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;bellesip_sal/sal_impl.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;mediastreamer2/mediastream.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;mediastreamer2/msvolume.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;mediastreamer2/msequalizer.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;mediastreamer2/msfileplayer.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;mediastreamer2/msjpegwriter.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;mediastreamer2/mseventqueue.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;mediastreamer2/mssndcard.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;mediastreamer2/stun.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>EC_STATE_STORE[]<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;.sephone.ecstate&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>EC_STATE_MAX_LEN<sp/>1048576<sp/>//<sp/>1Mo</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="47"><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_stats_uninit(<ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats);</highlight></codeline>
<codeline lineno="49"><highlight class="normal"></highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal">MSWebCam<sp/>*get_nowebcam_device(){</highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ms_web_cam_manager_get_cam(ms_web_cam_manager_get(),</highlight><highlight class="stringliteral">&quot;StaticImage:<sp/>Static<sp/>picture&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="53"><highlight class="normal">}</highlight></codeline>
<codeline lineno="54"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"></highlight></codeline>
<codeline lineno="56"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>bool_t<sp/>generate_b64_crypto_key(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>key_length,<sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>key_out,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>key_out_size)<sp/>{</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>b64_size;</highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint8_t*<sp/>tmp<sp/>=<sp/>(uint8_t*)<sp/>ms_malloc0(key_length);</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_get_random_bytes(tmp,<sp/>key_length)==NULL)<sp/>{</highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>generate<sp/>random<sp/>key&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(tmp);</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="64"><highlight class="normal"></highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>b64_size<sp/>=<sp/>b64_encode((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*)tmp,<sp/>key_length,<sp/>NULL,<sp/>0);</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(b64_size<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>get<sp/>b64<sp/>result<sp/>size&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(tmp);</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(b64_size&gt;=key_out_size){</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Insufficient<sp/>room<sp/>for<sp/>writing<sp/>base64<sp/>SRTP<sp/>key&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(tmp);</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>b64_size=b64_encode((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*)tmp,<sp/>key_length,<sp/>key_out,<sp/>key_out_size);</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(b64_size<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>b64<sp/>encode<sp/>key&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(tmp);</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_out[b64_size]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(tmp);</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="85"><highlight class="normal">}</highlight></codeline>
<codeline lineno="86"><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*<ref refid="group__call__control_1ga43cafe9f8f58dc1e3552762d2879e6c1" kindref="member">sephone_call_get_core</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;core;</highlight></codeline>
<codeline lineno="89"><highlight class="normal">}</highlight></codeline>
<codeline lineno="90"><highlight class="normal"></highlight></codeline>
<codeline lineno="91"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>sephone_call_get_authentication_token(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;auth_token;</highlight></codeline>
<codeline lineno="93"><highlight class="normal">}</highlight></codeline>
<codeline lineno="94"><highlight class="normal"></highlight></codeline>
<codeline lineno="103"><highlight class="normal">bool_t<sp/><ref refid="group__call__control_1ga8da6372d304b10ad52b72d095e2985ce" kindref="member">sephone_call_get_authentication_token_verified</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;auth_token_verified;</highlight></codeline>
<codeline lineno="105"><highlight class="normal">}</highlight></codeline>
<codeline lineno="106"><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>bool_t<sp/>sephone_call_all_streams_encrypted(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>number_of_encrypted_stream<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>number_of_active_stream<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call)<sp/>{</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>media_stream_get_state((MediaStream<sp/>*)call-&gt;audiostream)<sp/>==<sp/>MSStreamStarted)<sp/>{</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>number_of_active_stream++;</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(media_stream_secured((MediaStream<sp/>*)call-&gt;audiostream))</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>number_of_encrypted_stream++;</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>media_stream_get_state((MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted)<sp/>{</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>number_of_active_stream++;</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(media_stream_secured((MediaStream<sp/>*)call-&gt;videostream))</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>number_of_encrypted_stream++;</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>number_of_active_stream&gt;0<sp/>&amp;&amp;<sp/>number_of_active_stream==number_of_encrypted_stream;</highlight></codeline>
<codeline lineno="123"><highlight class="normal">}</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>bool_t<sp/>sephone_call_all_streams_avpf_enabled(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nb_active_streams<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nb_avpf_enabled_streams<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call)<sp/>{</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>media_stream_get_state((MediaStream<sp/>*)call-&gt;audiostream)<sp/>==<sp/>MSStreamStarted)<sp/>{</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb_active_streams++;</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(media_stream_avpf_enabled((MediaStream<sp/>*)call-&gt;audiostream))</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb_avpf_enabled_streams++;</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>media_stream_get_state((MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted)<sp/>{</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb_active_streams++;</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(media_stream_avpf_enabled((MediaStream<sp/>*)call-&gt;videostream))</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb_avpf_enabled_streams++;</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>((nb_active_streams<sp/>&gt;<sp/>0)<sp/>&amp;&amp;<sp/>(nb_active_streams<sp/>==<sp/>nb_avpf_enabled_streams));</highlight></codeline>
<codeline lineno="141"><highlight class="normal">}</highlight></codeline>
<codeline lineno="142"><highlight class="normal"></highlight></codeline>
<codeline lineno="143"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint16_t<sp/>sephone_call_get_avpf_rr_interval(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint16_t<sp/>rr_interval<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint16_t<sp/>stream_rr_interval;</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call)<sp/>{</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>media_stream_get_state((MediaStream<sp/>*)call-&gt;audiostream)<sp/>==<sp/>MSStreamStarted)<sp/>{</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stream_rr_interval<sp/>=<sp/>media_stream_get_avpf_rr_interval((MediaStream<sp/>*)call-&gt;audiostream);</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stream_rr_interval<sp/>&gt;<sp/>rr_interval)<sp/>rr_interval<sp/>=<sp/>stream_rr_interval;</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>media_stream_get_state((MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted)<sp/>{</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stream_rr_interval<sp/>=<sp/>media_stream_get_avpf_rr_interval((MediaStream<sp/>*)call-&gt;videostream);</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stream_rr_interval<sp/>&gt;<sp/>rr_interval)<sp/>rr_interval<sp/>=<sp/>stream_rr_interval;</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rr_interval<sp/>=<sp/>5000;</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rr_interval;</highlight></codeline>
<codeline lineno="159"><highlight class="normal">}</highlight></codeline>
<codeline lineno="160"><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>propagate_encryption_changed(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sephone_call_all_streams_encrypted(call))<sp/>{</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Some<sp/>streams<sp/>are<sp/>not<sp/>encrypted&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;media_encryption=<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba04d462c1944b5e5d4dfed2154751df25" kindref="member">SephoneMediaEncryptionNone</ref>;</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_encryption_changed(call-&gt;core,<sp/>call,<sp/>FALSE,<sp/>call-&gt;auth_token);</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;auth_token)<sp/>{</highlight><highlight class="comment">/*<sp/>ZRTP<sp/>only<sp/>is<sp/>using<sp/>auth_token<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;media_encryption=<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba9f05e9f7fbb66350bfa788e2aa37c25f" kindref="member">SephoneMediaEncryptionZRTP</ref>;</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{<sp/></highlight><highlight class="comment">/*<sp/>otherwise<sp/>it<sp/>must<sp/>be<sp/>DTLS<sp/>as<sp/>SDES<sp/>doesn&apos;t<sp/>go<sp/>through<sp/>this<sp/>function<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;media_encryption=<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba05791a117352a31299e65410334a3f91" kindref="member">SephoneMediaEncryptionDTLS</ref>;</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;All<sp/>streams<sp/>are<sp/>encrypted<sp/>key<sp/>exchanged<sp/>using<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>call-&gt;current_params-&gt;media_encryption==<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba9f05e9f7fbb66350bfa788e2aa37c25f" kindref="member">SephoneMediaEncryptionZRTP</ref>?</highlight><highlight class="stringliteral">&quot;ZRTP&quot;</highlight><highlight class="normal">:call-&gt;current_params-&gt;media_encryption==<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba05791a117352a31299e65410334a3f91" kindref="member">SephoneMediaEncryptionDTLS</ref>?</highlight><highlight class="stringliteral">&quot;DTLS&quot;</highlight><highlight class="normal">:</highlight><highlight class="stringliteral">&quot;Unknown<sp/>mechanism&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_encryption_changed(call-&gt;core,<sp/>call,<sp/>TRUE,<sp/>call-&gt;auth_token);</highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="175"><highlight class="normal">}</highlight></codeline>
<codeline lineno="176"><highlight class="normal"></highlight></codeline>
<codeline lineno="177"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_audiostream_encryption_changed(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*data,<sp/>bool_t<sp/>encrypted)<sp/>{</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>status[255]={0};</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call;</highlight></codeline>
<codeline lineno="180"><highlight class="normal"></highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call<sp/>=<sp/>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*)data;</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(encrypted)<sp/>{</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;media_encryption==<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba9f05e9f7fbb66350bfa788e2aa37c25f" kindref="member">SephoneMediaEncryptionZRTP</ref>)<sp/>{<sp/></highlight><highlight class="comment">/*<sp/>if<sp/>encryption<sp/>is<sp/>DTLS,<sp/>no<sp/>status<sp/>to<sp/>be<sp/>displayed<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snprintf(status,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(status)-1,_(</highlight><highlight class="stringliteral">&quot;Authentication<sp/>token<sp/>is<sp/>%s&quot;</highlight><highlight class="normal">),call-&gt;auth_token);</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_display_status(call-&gt;core,<sp/>status);</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="188"><highlight class="normal"></highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>propagate_encryption_changed(call);</highlight></codeline>
<codeline lineno="190"><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enable<sp/>video<sp/>encryption</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params=<ref refid="group__call__control_1ga3440e61504e058274ecc74dd435938e4" kindref="member">sephone_call_get_current_params</ref>(call);</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;has_video)<sp/>{</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSZrtpParams<sp/>params;</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Trying<sp/>to<sp/>enable<sp/>encryption<sp/>on<sp/>video<sp/>stream&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.zid_file=NULL;<sp/></highlight><highlight class="comment">//unused</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_zrtp(call-&gt;videostream,call-&gt;audiostream,&amp;params);</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="202"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="203"><highlight class="normal">}</highlight></codeline>
<codeline lineno="204"><highlight class="normal"></highlight></codeline>
<codeline lineno="205"><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_audiostream_auth_token_ready(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*data,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>auth_token,<sp/>bool_t<sp/>verified)<sp/>{</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call=(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*)data;</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;auth_token<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(call-&gt;auth_token);</highlight></codeline>
<codeline lineno="210"><highlight class="normal"></highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;auth_token=ms_strdup(auth_token);</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;auth_token_verified=verified;</highlight></codeline>
<codeline lineno="213"><highlight class="normal"></highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Authentication<sp/>token<sp/>is<sp/>%s<sp/>(%s)&quot;</highlight><highlight class="normal">,<sp/>auth_token,<sp/>verified?</highlight><highlight class="stringliteral">&quot;verified&quot;</highlight><highlight class="normal">:</highlight><highlight class="stringliteral">&quot;unverified&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="215"><highlight class="normal">}</highlight></codeline>
<codeline lineno="216"><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1ga949852a881edb1cf3e6ec05e58edea06" kindref="member">sephone_call_set_authentication_token_verified</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>verified){</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream==NULL){</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;sephone_call_set_authentication_token_verified():<sp/>No<sp/>audio<sp/>stream&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream-&gt;ms.sessions.zrtp_context==NULL){</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;sephone_call_set_authentication_token_verified():<sp/>No<sp/>zrtp<sp/>context.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!call-&gt;auth_token_verified<sp/>&amp;&amp;<sp/>verified){</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_zrtp_sas_verified(call-&gt;audiostream-&gt;ms.sessions.zrtp_context);</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;auth_token_verified<sp/>&amp;&amp;<sp/>!verified){</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_zrtp_sas_reset_verified(call-&gt;audiostream-&gt;ms.sessions.zrtp_context);</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;auth_token_verified=verified;</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>propagate_encryption_changed(call);</highlight></codeline>
<codeline lineno="238"><highlight class="normal">}</highlight></codeline>
<codeline lineno="239"><highlight class="normal"></highlight></codeline>
<codeline lineno="240"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>get_max_codec_sample_rate(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*codecs){</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>max_sample_rate=0;</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*it;</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(it=codecs;it!=NULL;it=it-&gt;next){</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadType<sp/>*pt=(PayloadType*)it-&gt;data;</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>sample_rate;</highlight></codeline>
<codeline lineno="246"><highlight class="normal"></highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>strcasecmp(</highlight><highlight class="stringliteral">&quot;G722&quot;</highlight><highlight class="normal">,pt-&gt;mime_type)<sp/>==<sp/>0<sp/>){</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>G722<sp/>spec<sp/>says<sp/>8000<sp/>but<sp/>the<sp/>codec<sp/>actually<sp/>requires<sp/>16000<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sample_rate<sp/>=<sp/>16000;</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>sample_rate=pt-&gt;clock_rate;</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sample_rate&gt;max_sample_rate)<sp/>max_sample_rate=sample_rate;</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>max_sample_rate;</highlight></codeline>
<codeline lineno="254"><highlight class="normal">}</highlight></codeline>
<codeline lineno="255"><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>find_payload_type_number(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*assigned,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType<sp/>*pt){</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*elem;</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType<sp/>*candidate=NULL;</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(elem=assigned;elem!=NULL;elem=elem-&gt;next){</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType<sp/>*it=(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType*)elem-&gt;data;</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((strcasecmp(pt-&gt;mime_type,<sp/>payload_type_get_mime(it))<sp/>==<sp/>0)</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>(it-&gt;clock_rate==pt-&gt;clock_rate)</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>(it-&gt;channels==pt-&gt;channels<sp/>||<sp/>pt-&gt;channels&lt;=0))<sp/>{</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>candidate=it;</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((it-&gt;recv_fmtp!=NULL<sp/>&amp;&amp;<sp/>pt-&gt;recv_fmtp!=NULL<sp/>&amp;&amp;<sp/>strcasecmp(it-&gt;recv_fmtp,<sp/>pt-&gt;recv_fmtp)==0)</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>||<sp/>(it-&gt;recv_fmtp==NULL<sp/>&amp;&amp;<sp/>pt-&gt;recv_fmtp==NULL)){</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight><highlight class="comment">/*exact<sp/>match*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>candidate<sp/>?<sp/>payload_type_get_number(candidate)<sp/>:<sp/>-1;</highlight></codeline>
<codeline lineno="272"><highlight class="normal">}</highlight></codeline>
<codeline lineno="273"><highlight class="normal"></highlight></codeline>
<codeline lineno="274"><highlight class="normal">bool_t<sp/>is_payload_type_number_available(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*l,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>number,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType<sp/>*ignore){</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*elem;</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(elem=l;<sp/>elem!=NULL;<sp/>elem=elem-&gt;next){</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType<sp/>*pt=(PayloadType*)elem-&gt;data;</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(pt!=ignore<sp/>&amp;&amp;<sp/>payload_type_get_number(pt)==number)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="281"><highlight class="normal">}</highlight></codeline>
<codeline lineno="282"><highlight class="normal"></highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_core_assign_payload_type_numbers(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/>MSList<sp/>*codecs){</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*elem;</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>dyn_number=lc-&gt;codecs_conf.dyn_pt;</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(elem=codecs;<sp/>elem!=NULL;<sp/>elem=elem-&gt;next){</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadType<sp/>*pt=(PayloadType*)elem-&gt;data;</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>number=payload_type_get_number(pt);</highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*check<sp/>if<sp/>number<sp/>is<sp/>duplicated:<sp/>it<sp/>could<sp/>be<sp/>the<sp/>case<sp/>if<sp/>the<sp/>remote<sp/>forced<sp/>us<sp/>to<sp/>use<sp/>a<sp/>mapping<sp/>with<sp/>a<sp/>previous<sp/>offer*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(number!=-1<sp/>&amp;&amp;<sp/>!(pt-&gt;flags<sp/>&amp;<sp/>PAYLOAD_TYPE_FROZEN_NUMBER)){</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!is_payload_type_number_available(codecs,<sp/>number,<sp/>pt)){</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Reassigning<sp/>payload<sp/>type<sp/>%i<sp/>%s/%i<sp/>because<sp/>already<sp/>offered.&quot;</highlight><highlight class="normal">,<sp/>number,<sp/>pt-&gt;mime_type,<sp/>pt-&gt;clock_rate);</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>number=-1;<sp/></highlight><highlight class="comment">/*need<sp/>to<sp/>be<sp/>re-assigned*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="297"><highlight class="normal"></highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(number==-1){</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(dyn_number&lt;127){</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_payload_type_number_available(codecs,<sp/>dyn_number,<sp/>NULL)){</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_set_number(pt,<sp/>dyn_number);</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dyn_number++;</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dyn_number++;</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dyn_number==127){</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Too<sp/>many<sp/>payload<sp/>types<sp/>configured<sp/>!<sp/>codec<sp/>%s/%i<sp/>is<sp/>disabled.&quot;</highlight><highlight class="normal">,<sp/>pt-&gt;mime_type,<sp/>pt-&gt;clock_rate);</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_set_enable(pt,<sp/>FALSE);</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="313"><highlight class="normal">}</highlight></codeline>
<codeline lineno="314"><highlight class="normal"></highlight></codeline>
<codeline lineno="315"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>bool_t<sp/>has_telephone_event_at_rate(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*tev,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rate){</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*it;</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(it=tev;it!=NULL;it=it-&gt;next){</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType<sp/>*pt=(PayloadType*)it-&gt;data;</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(pt-&gt;clock_rate==rate)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="322"><highlight class="normal">}</highlight></codeline>
<codeline lineno="323"><highlight class="normal"></highlight></codeline>
<codeline lineno="324"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>MSList<sp/>*<sp/>create_telephone_events(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*codecs){</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*it;</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*ret=NULL;</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(it=codecs;it!=NULL;it=it-&gt;next){</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType<sp/>*pt=(PayloadType*)it-&gt;data;</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!has_telephone_event_at_rate(ret,pt-&gt;clock_rate)){</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadType<sp/>*tev=payload_type_clone(&amp;payload_type_telephone_event);</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tev-&gt;clock_rate=pt-&gt;clock_rate;</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*let<sp/>it<sp/>choose<sp/>the<sp/>number<sp/>dynamically<sp/>as<sp/>for<sp/>normal<sp/>codecs*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_set_number(tev,<sp/>-1);</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ret==NULL){</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*But<sp/>for<sp/>first<sp/>telephone-event,<sp/>prefer<sp/>the<sp/>number<sp/>that<sp/>was<sp/>configured<sp/>in<sp/>the<sp/>core*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_payload_type_number_available(codecs,<sp/>lc-&gt;codecs_conf.telephone_event_pt,<sp/>NULL)){</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_set_number(tev,<sp/>lc-&gt;codecs_conf.telephone_event_pt);</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=ms_list_append(ret,tev);</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ret;</highlight></codeline>
<codeline lineno="344"><highlight class="normal">}</highlight></codeline>
<codeline lineno="345"><highlight class="normal"></highlight></codeline>
<codeline lineno="346"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>MSList<sp/>*create_special_payload_types(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*codecs){</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*ret=create_telephone_events(lc,<sp/>codecs);</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sephone_core_generic_confort_noise_enabled(lc)){</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadType<sp/>*cn=payload_type_clone(&amp;payload_type_cn);</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_set_number(cn,<sp/>13);</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=ms_list_append(ret,<sp/>cn);</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ret;</highlight></codeline>
<codeline lineno="354"><highlight class="normal">}</highlight></codeline>
<codeline lineno="355"><highlight class="normal"></highlight></codeline>
<codeline lineno="356"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">_CodecConstraints{</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bandwidth_limit;</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>max_codecs;</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*previously_used;</highlight></codeline>
<codeline lineno="360"><highlight class="normal">}CodecConstraints;</highlight></codeline>
<codeline lineno="361"><highlight class="normal"></highlight></codeline>
<codeline lineno="362"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>MSList<sp/>*make_codec_list(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/>CodecConstraints<sp/>*<sp/>hints,<sp/>SalStreamType<sp/>stype,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*codecs){</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*l=NULL;</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*it;</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nb<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="366"><highlight class="normal"></highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(it=codecs;it!=NULL;it=it-&gt;next){</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadType<sp/>*pt=(PayloadType*)it-&gt;data;</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num;</highlight></codeline>
<codeline lineno="370"><highlight class="normal"></highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!(pt-&gt;flags<sp/>&amp;<sp/>PAYLOAD_TYPE_ENABLED))</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hints-&gt;bandwidth_limit&gt;0<sp/>&amp;&amp;<sp/>!sephone_core_is_payload_type_usable_for_bandwidth(lc,pt,hints-&gt;bandwidth_limit)){</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Codec<sp/>%s/%i<sp/>eliminated<sp/>because<sp/>of<sp/>audio<sp/>bandwidth<sp/>constraint<sp/>of<sp/>%i<sp/>kbit/s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt-&gt;mime_type,pt-&gt;clock_rate,hints-&gt;bandwidth_limit);</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sephone_core_check_payload_type_usability(lc,pt)){</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt=payload_type_clone(pt);</highlight></codeline>
<codeline lineno="382"><highlight class="normal"></highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*look<sp/>for<sp/>a<sp/>previously<sp/>assigned<sp/>number<sp/>for<sp/>this<sp/>codec*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>num=find_payload_type_number(hints-&gt;previously_used,<sp/>pt);</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(num!=-1){</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_set_number(pt,num);</highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_set_flag(pt,<sp/>PAYLOAD_TYPE_FROZEN_NUMBER);</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="389"><highlight class="normal"></highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>l=ms_list_append(l,<sp/>pt);</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb++;</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((hints-&gt;max_codecs<sp/>&gt;<sp/>0)<sp/>&amp;&amp;<sp/>(nb<sp/>&gt;=<sp/>hints-&gt;max_codecs))<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stype==SalAudio){</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*specials=create_special_payload_types(lc,l);</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>l=ms_list_concat(l,specials);</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_assign_payload_type_numbers(lc,<sp/>l);</highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>l;</highlight></codeline>
<codeline lineno="400"><highlight class="normal">}</highlight></codeline>
<codeline lineno="401"><highlight class="normal"></highlight></codeline>
<codeline lineno="402"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>update_media_description_from_stun(SalMediaDescription<sp/>*md,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>StunCandidate<sp/>*ac,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>StunCandidate<sp/>*vc){</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>md-&gt;nb_streams;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sal_stream_description_active(&amp;md-&gt;streams[i]))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((md-&gt;streams[i].type<sp/>==<sp/>SalAudio)<sp/>&amp;&amp;<sp/>(ac-&gt;port<sp/>!=<sp/>0))<sp/>{</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strcpy(md-&gt;streams[0].rtp_addr,ac-&gt;addr);</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].rtp_port=ac-&gt;port;</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((ac-&gt;addr[0]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>vc-&gt;addr[0]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>strcmp(ac-&gt;addr,vc-&gt;addr)==0)<sp/>||<sp/>sal_media_description_get_nb_active_streams(md)==1){</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strcpy(md-&gt;addr,ac-&gt;addr);</highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((md-&gt;streams[i].type<sp/>==<sp/>SalVideo)<sp/>&amp;&amp;<sp/>(vc-&gt;port<sp/>!=<sp/>0))<sp/>{</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strcpy(md-&gt;streams[1].rtp_addr,vc-&gt;addr);</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].rtp_port=vc-&gt;port;</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="418"><highlight class="normal">}</highlight></codeline>
<codeline lineno="419"><highlight class="normal"></highlight></codeline>
<codeline lineno="420"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>setup_encryption_key(SalSrtpCryptoAlgo<sp/>*crypto,<sp/>MSCryptoSuite<sp/>suite,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>tag){</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>keylen=0;</highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>crypto-&gt;tag=tag;</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>crypto-&gt;algo=suite;</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(suite){</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_128_SHA1_80:</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_128_SHA1_32:</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_128_NO_AUTH:</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_NO_CIPHER_SHA1_80:<sp/></highlight><highlight class="comment">/*not<sp/>sure<sp/>for<sp/>this<sp/>one*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>keylen=30;</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_256_SHA1_80:</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_256_SHA1_32:</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>keylen=46;</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_CRYPTO_SUITE_INVALID:</highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(keylen==0<sp/>||<sp/>!generate_b64_crypto_key(30,<sp/>crypto-&gt;master_key,<sp/>SAL_SRTP_KEY_SIZE)){</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>generate<sp/>SRTP<sp/>key.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>crypto-&gt;algo<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="444"><highlight class="normal">}</highlight></codeline>
<codeline lineno="445"><highlight class="normal"></highlight></codeline>
<codeline lineno="446"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>setup_dtls_keys(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>SalMediaDescription<sp/>*md){</highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(i=0;<sp/>i&lt;md-&gt;nb_streams;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sal_stream_description_active(&amp;md-&gt;streams[i]))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>if<sp/>media<sp/>encryption<sp/>is<sp/>set<sp/>to<sp/>DTLS<sp/>check<sp/>presence<sp/>of<sp/>fingerprint<sp/>in<sp/>the<sp/>call<sp/>which<sp/>shall<sp/>have<sp/>been<sp/>set<sp/>at<sp/>stream<sp/>init<sp/>but<sp/>it<sp/>may<sp/>have<sp/>failed<sp/>when<sp/>retrieving<sp/>certificate<sp/>resulting<sp/>in<sp/>no<sp/>fingerprint<sp/>present<sp/>and<sp/>then<sp/>DTLS<sp/>not<sp/>usable<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_stream_description_has_dtls(&amp;md-&gt;streams[i])<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[i].dtls_fingerprint,<sp/>call-&gt;dtls_certificate_fingerprint,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[i].dtls_fingerprint));<sp/></highlight><highlight class="comment">/*<sp/>get<sp/>the<sp/>self<sp/>fingerprint<sp/>from<sp/>call(it&apos;s<sp/>computed<sp/>at<sp/>stream<sp/>init)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].dtls_role<sp/>=<sp/>SalDtlsRoleUnset;<sp/></highlight><highlight class="comment">/*<sp/>if<sp/>we<sp/>are<sp/>offering,<sp/>SDP<sp/>will<sp/>have<sp/>actpass<sp/>setup<sp/>attribute<sp/>when<sp/>role<sp/>is<sp/>unset,<sp/>if<sp/>we<sp/>are<sp/>responding<sp/>the<sp/>result<sp/>mediadescription<sp/>will<sp/>be<sp/>set<sp/>to<sp/>SalDtlsRoleIsClient<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].dtls_fingerprint[0]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].dtls_role<sp/>=<sp/>SalDtlsRoleInvalid;</highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="459"><highlight class="normal">}</highlight></codeline>
<codeline lineno="460"><highlight class="normal"></highlight></codeline>
<codeline lineno="461"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>setup_encryption_keys(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>SalMediaDescription<sp/>*md){</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i,j;</highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*old_md=call-&gt;localdesc;</highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>keep_srtp_keys=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sip&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;keep_srtp_keys&quot;</highlight><highlight class="normal">,1);</highlight></codeline>
<codeline lineno="466"><highlight class="normal"></highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(i=0;<sp/>i&lt;md-&gt;nb_streams;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sal_stream_description_active(&amp;md-&gt;streams[i]))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_stream_description_has_srtp(&amp;md-&gt;streams[i])<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(keep_srtp_keys<sp/>&amp;&amp;<sp/>old_md<sp/>&amp;&amp;<sp/>(sal_stream_description_active(&amp;old_md-&gt;streams[i])<sp/>==<sp/>TRUE)<sp/>&amp;&amp;<sp/>(sal_stream_description_has_srtp(&amp;old_md-&gt;streams[i])<sp/>==<sp/>TRUE))<sp/>{</highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>j;</highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Keeping<sp/>same<sp/>crypto<sp/>keys.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(j=0;j&lt;SAL_CRYPTO_ALGO_MAX;++j){</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;md-&gt;streams[i].crypto[j],&amp;old_md-&gt;streams[i].crypto[j],</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(SalSrtpCryptoAlgo));</highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSCryptoSuite<sp/>*suites=sephone_core_get_srtp_crypto_suites(lc);</highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(j=0;suites!=NULL<sp/>&amp;&amp;<sp/>suites[j]!=MS_CRYPTO_SUITE_INVALID<sp/>&amp;&amp;<sp/>j&lt;SAL_CRYPTO_ALGO_MAX;++j){</highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_encryption_key(&amp;md-&gt;streams[i].crypto[j],suites[j],j+1);</highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="484"><highlight class="normal">}</highlight></codeline>
<codeline lineno="485"><highlight class="normal"></highlight></codeline>
<codeline lineno="486"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>setup_rtcp_fb(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>SalMediaDescription<sp/>*md)<sp/>{</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*pt_it;</highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadType<sp/>*pt;</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadTypeAvpfParams<sp/>avpf_params;</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="491"><highlight class="normal"></highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>md-&gt;nb_streams;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sal_stream_description_active(&amp;md-&gt;streams[i]))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(pt_it<sp/>=<sp/>md-&gt;streams[i].payloads;<sp/>pt_it<sp/>!=<sp/>NULL;<sp/>pt_it<sp/>=<sp/>pt_it-&gt;next)<sp/>{</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/>(PayloadType<sp/>*)pt_it-&gt;data;</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;params-&gt;avpf_enabled<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_set_flag(pt,<sp/>PAYLOAD_TYPE_RTCP_FEEDBACK_ENABLED);</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>avpf_params<sp/>=<sp/>payload_type_get_avpf_params(pt);</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>avpf_params.trr_interval<sp/>=<sp/>call-&gt;params-&gt;avpf_rr_interval;</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_unset_flag(pt,<sp/>PAYLOAD_TYPE_RTCP_FEEDBACK_ENABLED);</highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;avpf_params,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(avpf_params));</highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_set_avpf_params(pt,<sp/>avpf_params);</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="507"><highlight class="normal">}</highlight></codeline>
<codeline lineno="508"><highlight class="normal"></highlight></codeline>
<codeline lineno="509"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>setup_rtcp_xr(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>SalMediaDescription<sp/>*md)<sp/>{</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc<sp/>=<sp/>call-&gt;core;</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="512"><highlight class="normal"></highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;rtcp_xr.enabled<sp/>=<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;rtp&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;rtcp_xr_enabled&quot;</highlight><highlight class="normal">,<sp/>1);</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;rtcp_xr.enabled<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rcvr_rtt_mode<sp/>=<sp/><ref refid="group__misc_1ga5a32540697fb696aa4f306d9dbc844c5" kindref="member">sp_config_get_string</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;rtp&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;rtcp_xr_rcvr_rtt_mode&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;all&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcasecmp(rcvr_rtt_mode,<sp/></highlight><highlight class="stringliteral">&quot;all&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>md-&gt;rtcp_xr.rcvr_rtt_mode<sp/>=<sp/>OrtpRtcpXrRcvrRttAll;</highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcasecmp(rcvr_rtt_mode,<sp/></highlight><highlight class="stringliteral">&quot;sender&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>md-&gt;rtcp_xr.rcvr_rtt_mode<sp/>=<sp/>OrtpRtcpXrRcvrRttSender;</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>md-&gt;rtcp_xr.rcvr_rtt_mode<sp/>=<sp/>OrtpRtcpXrRcvrRttNone;</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;rtcp_xr.rcvr_rtt_mode<sp/>!=<sp/>OrtpRtcpXrRcvrRttNone)<sp/>{</highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;rtcp_xr.rcvr_rtt_max_size<sp/>=<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;rtp&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;rtcp_xr_rcvr_rtt_max_size&quot;</highlight><highlight class="normal">,<sp/>10000);</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;rtcp_xr.stat_summary_enabled<sp/>=<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;rtp&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;rtcp_xr_stat_summary_enabled&quot;</highlight><highlight class="normal">,<sp/>1);</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;rtcp_xr.stat_summary_enabled<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;rtcp_xr.stat_summary_flags<sp/>=<sp/>OrtpRtcpXrStatSummaryLoss<sp/>|<sp/>OrtpRtcpXrStatSummaryDup<sp/>|<sp/>OrtpRtcpXrStatSummaryJitt<sp/>|<sp/>OrtpRtcpXrStatSummaryTTL;</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;rtcp_xr.voip_metrics_enabled<sp/>=<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;rtp&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;rtcp_xr_voip_metrics_enabled&quot;</highlight><highlight class="normal">,<sp/>1);</highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>md-&gt;nb_streams;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sal_stream_description_active(&amp;md-&gt;streams[i]))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;md-&gt;streams[i].rtcp_xr,<sp/>&amp;md-&gt;rtcp_xr,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[i].rtcp_xr));</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="532"><highlight class="normal">}</highlight></codeline>
<codeline lineno="533"><highlight class="normal"></highlight></codeline>
<codeline lineno="534"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_increment_local_media_description(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*md=call-&gt;localdesc;</highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;session_ver++;</highlight></codeline>
<codeline lineno="537"><highlight class="normal">}</highlight></codeline>
<codeline lineno="538"><highlight class="normal"></highlight></codeline>
<codeline lineno="539"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_update_local_media_description_from_ice_or_upnp(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_update_local_media_description_from_ice(call-&gt;localdesc,<sp/>call-&gt;ice_session);</highlight></codeline>
<codeline lineno="542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_ice_state_in_call_stats(call);</highlight></codeline>
<codeline lineno="543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="544"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(call-&gt;upnp_session<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_local_media_description_from_upnp(call-&gt;localdesc,<sp/>call-&gt;upnp_session);</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_upnp_state_in_call_stats(call);</highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="549"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/><sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="550"><highlight class="normal">}</highlight></codeline>
<codeline lineno="551"><highlight class="normal"></highlight></codeline>
<codeline lineno="552"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>transfer_already_assigned_payload_types(SalMediaDescription<sp/>*old,<sp/>SalMediaDescription<sp/>*md){</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(i=0;i&lt;old-&gt;nb_streams;++i){</highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].already_assigned_payloads=old-&gt;streams[i].already_assigned_payloads;</highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>old-&gt;streams[i].already_assigned_payloads=NULL;</highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="558"><highlight class="normal">}</highlight></codeline>
<codeline lineno="559"><highlight class="normal"></highlight></codeline>
<codeline lineno="560"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*sephone_call_get_bind_ip_for_stream(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index){</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*bind_ip<sp/>=<sp/><ref refid="group__misc_1ga5a32540697fb696aa4f306d9dbc844c5" kindref="member">sp_config_get_string</ref>(call-&gt;core-&gt;config,</highlight><highlight class="stringliteral">&quot;rtp&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;bind_address&quot;</highlight><highlight class="normal">,call-&gt;af==AF_INET6<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;::0&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;0.0.0.0&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="562"><highlight class="normal"></highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stream_index&lt;2<sp/>&amp;&amp;<sp/>call-&gt;media_ports[stream_index].multicast_ip[0]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">){</highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dir==<ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4afaf6213246f0c942cf50424e37382862" kindref="member">SephoneCallOutgoing</ref>){</highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*as<sp/>multicast<sp/>sender,<sp/>we<sp/>must<sp/>decide<sp/>a<sp/>local<sp/>interface<sp/>to<sp/>use<sp/>to<sp/>send<sp/>multicast,<sp/>and<sp/>bind<sp/>to<sp/>it*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bind_ip=call-&gt;media_localip;</highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>bind_ip;</highlight></codeline>
<codeline lineno="570"><highlight class="normal">}</highlight></codeline>
<codeline lineno="571"><highlight class="normal"></highlight></codeline>
<codeline lineno="572"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*sephone_call_get_public_ip_for_stream(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index){</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*public_ip=call-&gt;media_localip;</highlight></codeline>
<codeline lineno="574"><highlight class="normal"></highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stream_index&lt;2<sp/>&amp;&amp;<sp/>call-&gt;media_ports[stream_index].multicast_ip[0]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>public_ip=call-&gt;media_ports[stream_index].multicast_ip;</highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>public_ip;</highlight></codeline>
<codeline lineno="578"><highlight class="normal">}</highlight></codeline>
<codeline lineno="579"><highlight class="normal"></highlight></codeline>
<codeline lineno="580"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_make_local_media_description(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_make_local_media_description_with_params(lc,<sp/>call,<sp/>call-&gt;params);</highlight></codeline>
<codeline lineno="582"><highlight class="normal">}</highlight></codeline>
<codeline lineno="583"><highlight class="normal"></highlight></codeline>
<codeline lineno="584"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_make_local_media_description_with_params(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params)<sp/>{</highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*l;</highlight></codeline>
<codeline lineno="586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*old_md=call-&gt;localdesc;</highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nb_active_streams<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*me;</highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*md=sal_media_description_new();</highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*addr;</highlight></codeline>
<codeline lineno="592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*subject;</highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CodecConstraints<sp/>codec_hints={0};</highlight></codeline>
<codeline lineno="594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="595"><highlight class="normal"></highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*multicast<sp/>is<sp/>only<sp/>set<sp/>in<sp/>case<sp/>of<sp/>outgoing<sp/>call*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dir<sp/>==<sp/><ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4afaf6213246f0c942cf50424e37382862" kindref="member">SephoneCallOutgoing</ref><sp/>&amp;&amp;<sp/><ref refid="group__media__parameters_1ga8a524ab025c1dc7c385b361233d822f4" kindref="member">sephone_core_audio_multicast_enabled</ref>(lc))<sp/>{</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].ttl=<ref refid="group__media__parameters_1gaa3895d4c058b6d80d573e565cc97f600" kindref="member">sephone_core_get_audio_multicast_ttl</ref>(lc);</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].multicast_role<sp/>=<sp/>SalMulticastSender;</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="601"><highlight class="normal"></highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dir<sp/>==<sp/><ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4afaf6213246f0c942cf50424e37382862" kindref="member">SephoneCallOutgoing</ref><sp/>&amp;&amp;<sp/><ref refid="group__media__parameters_1ga4eb75e367e69f94e0f07ba100479832a" kindref="member">sephone_core_video_multicast_enabled</ref>(lc))<sp/>{</highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].ttl=<ref refid="group__media__parameters_1ga72f79f57d50d5386549a527259dc5a47" kindref="member">sephone_core_get_video_multicast_ttl</ref>(lc);</highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].multicast_role<sp/>=<sp/>SalMulticastSender;</highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="606"><highlight class="normal"></highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>subject=<ref refid="group__call__control_1ga964fd0986cb1da50e838e826f066af0c" kindref="member">sephone_call_params_get_session_name</ref>(params);</highlight></codeline>
<codeline lineno="608"><highlight class="normal"></highlight></codeline>
<codeline lineno="609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_adapt_to_network(lc,call-&gt;ping_time,params);</highlight></codeline>
<codeline lineno="610"><highlight class="normal"></highlight></codeline>
<codeline lineno="611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dest_proxy)</highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>me=<ref refid="group__proxies_1ga4858956a94384d8234b0f36195304399" kindref="member">sephone_proxy_config_get_identity</ref>(call-&gt;dest_proxy);</highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>me=<ref refid="group__proxies_1ga7e085ebc050004f40c6ced0b81f2038c" kindref="member">sephone_core_get_identity</ref>(lc);</highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>addr=<ref refid="group__sephone__address_1ga96400e0c163c83900928f01aa13df7a6" kindref="member">sephone_address_new</ref>(me);</highlight></codeline>
<codeline lineno="616"><highlight class="normal"></highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;session_id=(old_md<sp/>?<sp/>old_md-&gt;session_id<sp/>:<sp/>(rand()<sp/>&amp;<sp/>0xfff));</highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;session_ver=(old_md<sp/>?<sp/>(old_md-&gt;session_ver+1)<sp/>:<sp/>(rand()<sp/>&amp;<sp/>0xfff));</highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;nb_streams=(call-&gt;biggestdesc<sp/>?<sp/>call-&gt;biggestdesc-&gt;nb_streams<sp/>:<sp/>1);</highlight></codeline>
<codeline lineno="620"><highlight class="normal"></highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;addr,call-&gt;media_localip,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;addr));</highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__sephone__address_1ga34708bb9f6730b528a9241a093a2eeea" kindref="member">sephone_address_get_username</ref>(addr))<sp/></highlight><highlight class="comment">/*might<sp/>be<sp/>null<sp/>in<sp/>case<sp/>of<sp/>identity<sp/>without<sp/>userinfo*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;username,<ref refid="group__sephone__address_1ga34708bb9f6730b528a9241a093a2eeea" kindref="member">sephone_address_get_username</ref>(addr),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;username));</highlight></codeline>
<codeline lineno="624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(subject)<sp/>strncpy(md-&gt;name,subject,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;name));</highlight></codeline>
<codeline lineno="625"><highlight class="normal"></highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;down_bw)</highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;bandwidth=params-&gt;down_bw;</highlight></codeline>
<codeline lineno="628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>md-&gt;bandwidth=<ref refid="group__media__parameters_1gade2cedda727f11643a05c42233d7a9cd" kindref="member">sephone_core_get_download_bandwidth</ref>(lc);</highlight></codeline>
<codeline lineno="629"><highlight class="normal"></highlight></codeline>
<codeline lineno="630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*set<sp/>audio<sp/>capabilities<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[0].rtp_addr,sephone_call_get_public_ip_for_stream(call,0),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[0].rtp_addr));</highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[0].rtcp_addr,sephone_call_get_public_ip_for_stream(call,0),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[0].rtcp_addr));</highlight></codeline>
<codeline lineno="633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[0].name,</highlight><highlight class="stringliteral">&quot;Audio&quot;</highlight><highlight class="normal">,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[0].name)-1);</highlight></codeline>
<codeline lineno="634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].rtp_port=call-&gt;media_ports[0].rtp_port;</highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].rtcp_port=call-&gt;media_ports[0].rtcp_port;</highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].proto=get_proto_from_call_params(params);</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].dir=get_audio_dir_from_call_params(params);</highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].type=SalAudio;</highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;down_ptime)</highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].ptime=params-&gt;down_ptime;</highlight></codeline>
<codeline lineno="641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].ptime=<ref refid="group__media__parameters_1ga2b364b5cc5317c18b3848465c92ce4d1" kindref="member">sephone_core_get_download_ptime</ref>(lc);</highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.bandwidth_limit=params-&gt;audio_bw;</highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.max_codecs=-1;</highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.previously_used=old_md<sp/>?<sp/>old_md-&gt;streams[0].already_assigned_payloads<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>l=make_codec_list(lc,<sp/>&amp;codec_hints,<sp/>SalAudio,<sp/>lc-&gt;codecs_conf.audio_codecs);</highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].max_rate=get_max_codec_sample_rate(l);</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].payloads=l;</highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ms.sessions.rtp_session)<sp/>{</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>me<sp/>=<sp/><ref refid="group__sephone__address_1ga1b480f99787494378d9683dbc31dc177" kindref="member">sephone_address_as_string_uri_only</ref>(call-&gt;me);</highlight></codeline>
<codeline lineno="651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].rtp_ssrc=rtp_session_get_send_ssrc(call-&gt;audiostream-&gt;ms.sessions.rtp_session);</highlight></codeline>
<codeline lineno="652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[0].rtcp_cname,me,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[0].rtcp_cname));</highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(me);</highlight></codeline>
<codeline lineno="654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Cannot<sp/>get<sp/>audio<sp/>local<sp/>ssrc<sp/>for<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal">,call);</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb_active_streams++;</highlight></codeline>
<codeline lineno="658"><highlight class="normal"></highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;has_video<sp/>&amp;&amp;<sp/>(!params-&gt;internal_call_update<sp/>||<sp/>!call-&gt;current_params-&gt;video_declined)){</highlight></codeline>
<codeline lineno="660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[1].rtp_addr,sephone_call_get_public_ip_for_stream(call,1),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[1].rtp_addr));</highlight></codeline>
<codeline lineno="661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[1].rtcp_addr,sephone_call_get_public_ip_for_stream(call,1),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[1].rtcp_addr));</highlight></codeline>
<codeline lineno="662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[1].name,</highlight><highlight class="stringliteral">&quot;Video&quot;</highlight><highlight class="normal">,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[1].name)-1);</highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].rtp_port=call-&gt;media_ports[1].rtp_port;</highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].rtcp_port=call-&gt;media_ports[1].rtcp_port;</highlight></codeline>
<codeline lineno="665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].proto=md-&gt;streams[0].proto;</highlight></codeline>
<codeline lineno="666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].dir=get_video_dir_from_call_params(params);</highlight></codeline>
<codeline lineno="667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].type=SalVideo;</highlight></codeline>
<codeline lineno="668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.bandwidth_limit=0;</highlight></codeline>
<codeline lineno="669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.max_codecs=-1;</highlight></codeline>
<codeline lineno="670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.previously_used=old_md<sp/>?<sp/>old_md-&gt;streams[1].already_assigned_payloads<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>l=make_codec_list(lc,<sp/>&amp;codec_hints,<sp/>SalVideo,<sp/>lc-&gt;codecs_conf.video_codecs);</highlight></codeline>
<codeline lineno="672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].payloads=l;</highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;ms.sessions.rtp_session)<sp/>{</highlight></codeline>
<codeline lineno="674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>me<sp/>=<sp/><ref refid="group__sephone__address_1ga1b480f99787494378d9683dbc31dc177" kindref="member">sephone_address_as_string_uri_only</ref>(call-&gt;me);</highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].rtp_ssrc=rtp_session_get_send_ssrc(call-&gt;videostream-&gt;ms.sessions.rtp_session);</highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[1].rtcp_cname,me,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[1].rtcp_cname));</highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(me);</highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Cannot<sp/>get<sp/>video<sp/>local<sp/>ssrc<sp/>for<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal">,call);</highlight></codeline>
<codeline lineno="681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb_active_streams++;</highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Don&apos;t<sp/>put<sp/>video<sp/>stream<sp/>on<sp/>local<sp/>offer<sp/>for<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal">,call);</highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="685"><highlight class="normal"></highlight></codeline>
<codeline lineno="686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;nb_streams<sp/>&lt;<sp/>nb_active_streams)</highlight></codeline>
<codeline lineno="687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;nb_streams<sp/>=<sp/>nb_active_streams;</highlight></codeline>
<codeline lineno="688"><highlight class="normal"></highlight></codeline>
<codeline lineno="689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Deactivate<sp/>inactive<sp/>streams.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>nb_active_streams;<sp/>i<sp/>&lt;<sp/>md-&gt;nb_streams;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].rtp_port<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].rtcp_port<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].proto<sp/>=<sp/>call-&gt;biggestdesc-&gt;streams[i].proto;</highlight></codeline>
<codeline lineno="694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].type<sp/>=<sp/>call-&gt;biggestdesc-&gt;streams[i].type;</highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].dir<sp/>=<sp/>SalStreamInactive;</highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.bandwidth_limit=0;</highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.max_codecs=1;</highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.previously_used=NULL;</highlight></codeline>
<codeline lineno="699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>l<sp/>=<sp/>make_codec_list(lc,<sp/>&amp;codec_hints,<sp/>SalVideo,<sp/>lc-&gt;codecs_conf.video_codecs);</highlight></codeline>
<codeline lineno="700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].payloads<sp/>=<sp/>l;</highlight></codeline>
<codeline lineno="701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_encryption_keys(call,md);</highlight></codeline>
<codeline lineno="703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_dtls_keys(call,md);</highlight></codeline>
<codeline lineno="704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_rtcp_fb(call,<sp/>md);</highlight></codeline>
<codeline lineno="705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_rtcp_xr(call,<sp/>md);</highlight></codeline>
<codeline lineno="706"><highlight class="normal"></highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_media_description_from_stun(md,&amp;call-&gt;ac,&amp;call-&gt;vc);</highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;localdesc=md;</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_update_local_media_description_from_ice_or_upnp(call);</highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga3fe5d8eb9c373045efe9ae9e15458459" kindref="member">sephone_address_destroy</ref>(addr);</highlight></codeline>
<codeline lineno="711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(old_md){</highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transfer_already_assigned_payload_types(old_md,md);</highlight></codeline>
<codeline lineno="713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;localdesc_changed=sal_media_description_equals(md,old_md);</highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_media_description_unref(old_md);</highlight></codeline>
<codeline lineno="715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="716"><highlight class="normal">}</highlight></codeline>
<codeline lineno="717"><highlight class="normal"></highlight></codeline>
<codeline lineno="718"><highlight class="normal">SalMediaDescription<sp/>*sephone_call_make_media_description(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>sephone_call_make_media_description_with_params(lc,<sp/>call,<sp/>call-&gt;params);</highlight></codeline>
<codeline lineno="720"><highlight class="normal">}</highlight></codeline>
<codeline lineno="721"><highlight class="normal"></highlight></codeline>
<codeline lineno="722"><highlight class="normal">SalMediaDescription<sp/>*sephone_call_make_media_description_with_params(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params)<sp/>{</highlight></codeline>
<codeline lineno="723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*l;</highlight></codeline>
<codeline lineno="724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*old_md=call-&gt;localdesc;</highlight></codeline>
<codeline lineno="725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nb_active_streams<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*me;</highlight></codeline>
<codeline lineno="728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*md=sal_media_description_new();</highlight></codeline>
<codeline lineno="729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*addr;</highlight></codeline>
<codeline lineno="730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*subject;</highlight></codeline>
<codeline lineno="731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CodecConstraints<sp/>codec_hints={0};</highlight></codeline>
<codeline lineno="732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="733"><highlight class="normal"></highlight></codeline>
<codeline lineno="734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*multicast<sp/>is<sp/>only<sp/>set<sp/>in<sp/>case<sp/>of<sp/>outgoing<sp/>call*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dir<sp/>==<sp/><ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4afaf6213246f0c942cf50424e37382862" kindref="member">SephoneCallOutgoing</ref><sp/>&amp;&amp;<sp/><ref refid="group__media__parameters_1ga8a524ab025c1dc7c385b361233d822f4" kindref="member">sephone_core_audio_multicast_enabled</ref>(lc))<sp/>{</highlight></codeline>
<codeline lineno="736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].ttl=<ref refid="group__media__parameters_1gaa3895d4c058b6d80d573e565cc97f600" kindref="member">sephone_core_get_audio_multicast_ttl</ref>(lc);</highlight></codeline>
<codeline lineno="737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].multicast_role<sp/>=<sp/>SalMulticastSender;</highlight></codeline>
<codeline lineno="738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="739"><highlight class="normal"></highlight></codeline>
<codeline lineno="740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dir<sp/>==<sp/><ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4afaf6213246f0c942cf50424e37382862" kindref="member">SephoneCallOutgoing</ref><sp/>&amp;&amp;<sp/><ref refid="group__media__parameters_1ga4eb75e367e69f94e0f07ba100479832a" kindref="member">sephone_core_video_multicast_enabled</ref>(lc))<sp/>{</highlight></codeline>
<codeline lineno="741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].ttl=<ref refid="group__media__parameters_1ga72f79f57d50d5386549a527259dc5a47" kindref="member">sephone_core_get_video_multicast_ttl</ref>(lc);</highlight></codeline>
<codeline lineno="742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].multicast_role<sp/>=<sp/>SalMulticastSender;</highlight></codeline>
<codeline lineno="743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="744"><highlight class="normal"></highlight></codeline>
<codeline lineno="745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>subject=<ref refid="group__call__control_1ga964fd0986cb1da50e838e826f066af0c" kindref="member">sephone_call_params_get_session_name</ref>(params);</highlight></codeline>
<codeline lineno="746"><highlight class="normal"></highlight></codeline>
<codeline lineno="747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_adapt_to_network(lc,call-&gt;ping_time,params);</highlight></codeline>
<codeline lineno="748"><highlight class="normal"></highlight></codeline>
<codeline lineno="749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dest_proxy)</highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>me=<ref refid="group__proxies_1ga4858956a94384d8234b0f36195304399" kindref="member">sephone_proxy_config_get_identity</ref>(call-&gt;dest_proxy);</highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>me=<ref refid="group__proxies_1ga7e085ebc050004f40c6ced0b81f2038c" kindref="member">sephone_core_get_identity</ref>(lc);</highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>addr=<ref refid="group__sephone__address_1ga96400e0c163c83900928f01aa13df7a6" kindref="member">sephone_address_new</ref>(me);</highlight></codeline>
<codeline lineno="754"><highlight class="normal"></highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;session_id=(old_md<sp/>?<sp/>old_md-&gt;session_id<sp/>:<sp/>(rand()<sp/>&amp;<sp/>0xfff));</highlight></codeline>
<codeline lineno="756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;session_ver=(old_md<sp/>?<sp/>(old_md-&gt;session_ver+1)<sp/>:<sp/>(rand()<sp/>&amp;<sp/>0xfff));</highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;nb_streams=(call-&gt;biggestdesc<sp/>?<sp/>call-&gt;biggestdesc-&gt;nb_streams<sp/>:<sp/>1);</highlight></codeline>
<codeline lineno="758"><highlight class="normal"></highlight></codeline>
<codeline lineno="759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;addr,call-&gt;media_localip,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;addr));</highlight></codeline>
<codeline lineno="760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__sephone__address_1ga34708bb9f6730b528a9241a093a2eeea" kindref="member">sephone_address_get_username</ref>(addr))<sp/></highlight><highlight class="comment">/*might<sp/>be<sp/>null<sp/>in<sp/>case<sp/>of<sp/>identity<sp/>without<sp/>userinfo*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;username,<ref refid="group__sephone__address_1ga34708bb9f6730b528a9241a093a2eeea" kindref="member">sephone_address_get_username</ref>(addr),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;username));</highlight></codeline>
<codeline lineno="762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(subject)<sp/>strncpy(md-&gt;name,subject,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;name));</highlight></codeline>
<codeline lineno="763"><highlight class="normal"></highlight></codeline>
<codeline lineno="764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;down_bw)</highlight></codeline>
<codeline lineno="765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;bandwidth=params-&gt;down_bw;</highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>md-&gt;bandwidth=<ref refid="group__media__parameters_1gade2cedda727f11643a05c42233d7a9cd" kindref="member">sephone_core_get_download_bandwidth</ref>(lc);</highlight></codeline>
<codeline lineno="767"><highlight class="normal"></highlight></codeline>
<codeline lineno="768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*set<sp/>audio<sp/>capabilities<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[0].rtp_addr,sephone_call_get_public_ip_for_stream(call,0),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[0].rtp_addr));</highlight></codeline>
<codeline lineno="770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[0].rtcp_addr,sephone_call_get_public_ip_for_stream(call,0),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[0].rtcp_addr));</highlight></codeline>
<codeline lineno="771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[0].name,</highlight><highlight class="stringliteral">&quot;Audio&quot;</highlight><highlight class="normal">,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[0].name)-1);</highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].rtp_port=call-&gt;media_ports[0].rtp_port;</highlight></codeline>
<codeline lineno="773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].rtcp_port=call-&gt;media_ports[0].rtcp_port;</highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].proto=get_proto_from_call_params(params);</highlight></codeline>
<codeline lineno="775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].dir=get_audio_dir_from_call_params(params);</highlight></codeline>
<codeline lineno="776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].type=SalAudio;</highlight></codeline>
<codeline lineno="777"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;down_ptime)</highlight></codeline>
<codeline lineno="778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].ptime=params-&gt;down_ptime;</highlight></codeline>
<codeline lineno="779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].ptime=<ref refid="group__media__parameters_1ga2b364b5cc5317c18b3848465c92ce4d1" kindref="member">sephone_core_get_download_ptime</ref>(lc);</highlight></codeline>
<codeline lineno="781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.bandwidth_limit=params-&gt;audio_bw;</highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.max_codecs=-1;</highlight></codeline>
<codeline lineno="783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.previously_used=old_md<sp/>?<sp/>old_md-&gt;streams[0].already_assigned_payloads<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>l=make_codec_list(lc,<sp/>&amp;codec_hints,<sp/>SalAudio,<sp/>lc-&gt;codecs_conf.audio_codecs);</highlight></codeline>
<codeline lineno="785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].max_rate=get_max_codec_sample_rate(l);</highlight></codeline>
<codeline lineno="786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].payloads=l;</highlight></codeline>
<codeline lineno="787"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ms.sessions.rtp_session)<sp/>{</highlight></codeline>
<codeline lineno="788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>me<sp/>=<sp/><ref refid="group__sephone__address_1ga1b480f99787494378d9683dbc31dc177" kindref="member">sephone_address_as_string_uri_only</ref>(call-&gt;me);</highlight></codeline>
<codeline lineno="789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[0].rtp_ssrc=rtp_session_get_send_ssrc(call-&gt;audiostream-&gt;ms.sessions.rtp_session);</highlight></codeline>
<codeline lineno="790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[0].rtcp_cname,me,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[0].rtcp_cname));</highlight></codeline>
<codeline lineno="791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(me);</highlight></codeline>
<codeline lineno="792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="794"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Cannot<sp/>get<sp/>audio<sp/>local<sp/>ssrc<sp/>for<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal">,call);</highlight></codeline>
<codeline lineno="795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb_active_streams++;</highlight></codeline>
<codeline lineno="796"><highlight class="normal"></highlight></codeline>
<codeline lineno="797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;has_video<sp/>&amp;&amp;<sp/>(!params-&gt;internal_call_update<sp/>||<sp/>!call-&gt;current_params-&gt;video_declined)){</highlight></codeline>
<codeline lineno="798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[1].rtp_addr,sephone_call_get_public_ip_for_stream(call,1),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[1].rtp_addr));</highlight></codeline>
<codeline lineno="799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[1].rtcp_addr,sephone_call_get_public_ip_for_stream(call,1),</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[1].rtcp_addr));</highlight></codeline>
<codeline lineno="800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[1].name,</highlight><highlight class="stringliteral">&quot;Video&quot;</highlight><highlight class="normal">,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[1].name)-1);</highlight></codeline>
<codeline lineno="801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].rtp_port=call-&gt;media_ports[1].rtp_port;</highlight></codeline>
<codeline lineno="802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].rtcp_port=call-&gt;media_ports[1].rtcp_port;</highlight></codeline>
<codeline lineno="803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].proto=md-&gt;streams[0].proto;</highlight></codeline>
<codeline lineno="804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].dir=get_video_dir_from_call_params(params);</highlight></codeline>
<codeline lineno="805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].type=SalVideo;</highlight></codeline>
<codeline lineno="806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.bandwidth_limit=0;</highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.max_codecs=-1;</highlight></codeline>
<codeline lineno="808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.previously_used=old_md<sp/>?<sp/>old_md-&gt;streams[1].already_assigned_payloads<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>l=make_codec_list(lc,<sp/>&amp;codec_hints,<sp/>SalVideo,<sp/>lc-&gt;codecs_conf.video_codecs);</highlight></codeline>
<codeline lineno="810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].payloads=l;</highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;ms.sessions.rtp_session)<sp/>{</highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>me<sp/>=<sp/><ref refid="group__sephone__address_1ga1b480f99787494378d9683dbc31dc177" kindref="member">sephone_address_as_string_uri_only</ref>(call-&gt;me);</highlight></codeline>
<codeline lineno="813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[1].rtp_ssrc=rtp_session_get_send_ssrc(call-&gt;videostream-&gt;ms.sessions.rtp_session);</highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(md-&gt;streams[1].rtcp_cname,me,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(md-&gt;streams[1].rtcp_cname));</highlight></codeline>
<codeline lineno="815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(me);</highlight></codeline>
<codeline lineno="816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Cannot<sp/>get<sp/>video<sp/>local<sp/>ssrc<sp/>for<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal">,call);</highlight></codeline>
<codeline lineno="819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nb_active_streams++;</highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Don&apos;t<sp/>put<sp/>video<sp/>stream<sp/>on<sp/>local<sp/>offer<sp/>for<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal">,call);</highlight></codeline>
<codeline lineno="822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="823"><highlight class="normal"></highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;nb_streams<sp/>&lt;<sp/>nb_active_streams)</highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;nb_streams<sp/>=<sp/>nb_active_streams;</highlight></codeline>
<codeline lineno="826"><highlight class="normal"></highlight></codeline>
<codeline lineno="827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Deactivate<sp/>inactive<sp/>streams.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>nb_active_streams;<sp/>i<sp/>&lt;<sp/>md-&gt;nb_streams;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].rtp_port<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].rtcp_port<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].proto<sp/>=<sp/>call-&gt;biggestdesc-&gt;streams[i].proto;</highlight></codeline>
<codeline lineno="832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].type<sp/>=<sp/>call-&gt;biggestdesc-&gt;streams[i].type;</highlight></codeline>
<codeline lineno="833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].dir<sp/>=<sp/>SalStreamInactive;</highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.bandwidth_limit=0;</highlight></codeline>
<codeline lineno="835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.max_codecs=1;</highlight></codeline>
<codeline lineno="836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>codec_hints.previously_used=NULL;</highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>l<sp/>=<sp/>make_codec_list(lc,<sp/>&amp;codec_hints,<sp/>SalVideo,<sp/>lc-&gt;codecs_conf.video_codecs);</highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md-&gt;streams[i].payloads<sp/>=<sp/>l;</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_encryption_keys(call,md);</highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_dtls_keys(call,md);</highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_rtcp_fb(call,<sp/>md);</highlight></codeline>
<codeline lineno="843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_rtcp_xr(call,<sp/>md);</highlight></codeline>
<codeline lineno="844"><highlight class="normal"></highlight></codeline>
<codeline lineno="845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_media_description_from_stun(md,&amp;call-&gt;ac,&amp;call-&gt;vc);</highlight></codeline>
<codeline lineno="846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_update_local_media_description_from_ice(md,<sp/>call-&gt;ice_session);</highlight></codeline>
<codeline lineno="848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="849"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(call-&gt;upnp_session<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_local_media_description_from_upnp(md,<sp/>call-&gt;upnp_session);</highlight></codeline>
<codeline lineno="852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="853"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/><sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga3fe5d8eb9c373045efe9ae9e15458459" kindref="member">sephone_address_destroy</ref>(addr);</highlight></codeline>
<codeline lineno="855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(old_md){</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transfer_already_assigned_payload_types(old_md,md);</highlight></codeline>
<codeline lineno="857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>md;</highlight></codeline>
<codeline lineno="859"><highlight class="normal">}</highlight></codeline>
<codeline lineno="860"><highlight class="normal"></highlight></codeline>
<codeline lineno="861"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>find_port_offset(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>base_port){</highlight></codeline>
<codeline lineno="862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>offset;</highlight></codeline>
<codeline lineno="863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*elem;</highlight></codeline>
<codeline lineno="864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>tried_port;</highlight></codeline>
<codeline lineno="865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>existing_port;</highlight></codeline>
<codeline lineno="866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>already_used=FALSE;</highlight></codeline>
<codeline lineno="867"><highlight class="normal"></highlight></codeline>
<codeline lineno="868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(offset=0;offset&lt;100;offset+=2){</highlight></codeline>
<codeline lineno="869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tried_port=base_port+offset;</highlight></codeline>
<codeline lineno="870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>already_used=FALSE;</highlight></codeline>
<codeline lineno="871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(elem=lc-&gt;calls;elem!=NULL;elem=elem-&gt;next){</highlight></codeline>
<codeline lineno="872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call=(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>*)elem-&gt;data;</highlight></codeline>
<codeline lineno="873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>existing_port=call-&gt;media_ports[stream_index].rtp_port;</highlight></codeline>
<codeline lineno="874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(existing_port==tried_port)<sp/>{</highlight></codeline>
<codeline lineno="875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>already_used=TRUE;</highlight></codeline>
<codeline lineno="876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!already_used)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(offset==100){</highlight></codeline>
<codeline lineno="882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>find<sp/>any<sp/>free<sp/>port<sp/>!&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>offset;</highlight></codeline>
<codeline lineno="886"><highlight class="normal">}</highlight></codeline>
<codeline lineno="887"><highlight class="normal"></highlight></codeline>
<codeline lineno="888"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>select_random_port(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>min_port,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>max_port)<sp/>{</highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*elem;</highlight></codeline>
<codeline lineno="890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nb_tries;</highlight></codeline>
<codeline lineno="891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>tried_port<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>existing_port<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>already_used<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="894"><highlight class="normal"></highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tried_port<sp/>=<sp/>(rand()<sp/>%<sp/>(max_port<sp/>-<sp/>min_port)<sp/>+<sp/>min_port)<sp/>&amp;<sp/>~0x1;</highlight></codeline>
<codeline lineno="896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tried_port<sp/>&lt;<sp/>min_port)<sp/>tried_port<sp/>=<sp/>min_port<sp/>+<sp/>2;</highlight></codeline>
<codeline lineno="897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(nb_tries<sp/>=<sp/>0;<sp/>nb_tries<sp/>&lt;<sp/>100;<sp/>nb_tries++)<sp/>{</highlight></codeline>
<codeline lineno="898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(elem<sp/>=<sp/>lc-&gt;calls;<sp/>elem<sp/>!=<sp/>NULL;<sp/>elem<sp/>=<sp/>elem-&gt;next)<sp/>{</highlight></codeline>
<codeline lineno="899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call<sp/>=<sp/>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*)elem-&gt;data;</highlight></codeline>
<codeline lineno="900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>existing_port=call-&gt;media_ports[stream_index].rtp_port;</highlight></codeline>
<codeline lineno="901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(existing_port<sp/>==<sp/>tried_port)<sp/>{</highlight></codeline>
<codeline lineno="902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>already_used<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!already_used)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nb_tries<sp/>==<sp/>100)<sp/>{</highlight></codeline>
<codeline lineno="909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>find<sp/>any<sp/>free<sp/>port!&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>tried_port;</highlight></codeline>
<codeline lineno="913"><highlight class="normal">}</highlight></codeline>
<codeline lineno="914"><highlight class="normal"></highlight></codeline>
<codeline lineno="915"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>port_config_set_random(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index){</highlight></codeline>
<codeline lineno="916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[stream_index].rtp_port=-1;</highlight></codeline>
<codeline lineno="917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[stream_index].rtcp_port=-1;</highlight></codeline>
<codeline lineno="918"><highlight class="normal">}</highlight></codeline>
<codeline lineno="919"><highlight class="normal"></highlight></codeline>
<codeline lineno="920"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>port_config_set(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>min_port,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>max_port){</highlight></codeline>
<codeline lineno="921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>port_offset;</highlight></codeline>
<codeline lineno="922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(min_port&gt;0<sp/>&amp;&amp;<sp/>max_port&gt;0){</highlight></codeline>
<codeline lineno="923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(min_port<sp/>==<sp/>max_port)<sp/>{</highlight></codeline>
<codeline lineno="924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Used<sp/>fixed<sp/>RTP<sp/>audio<sp/>port.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>port_offset=find_port_offset(call-&gt;core,<sp/>stream_index,<sp/>min_port);</highlight></codeline>
<codeline lineno="926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(port_offset==-1)<sp/>{</highlight></codeline>
<codeline lineno="927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>port_config_set_random(call,<sp/>stream_index);</highlight></codeline>
<codeline lineno="928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[stream_index].rtp_port=min_port+port_offset;</highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Select<sp/>random<sp/>RTP<sp/>audio<sp/>port<sp/>in<sp/>the<sp/>specified<sp/>range.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[stream_index].rtp_port<sp/>=<sp/>select_random_port(call-&gt;core,<sp/>stream_index,<sp/>min_port,<sp/>max_port);</highlight></codeline>
<codeline lineno="934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[stream_index].rtcp_port=call-&gt;media_ports[stream_index].rtp_port+1;</highlight></codeline>
<codeline lineno="936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>port_config_set_random(call,stream_index);</highlight></codeline>
<codeline lineno="937"><highlight class="normal">}</highlight></codeline>
<codeline lineno="938"><highlight class="normal"></highlight></codeline>
<codeline lineno="939"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_init_common(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*from,<sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*to){</highlight></codeline>
<codeline lineno="940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>min_port,<sp/>max_port;</highlight></codeline>
<codeline lineno="941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;New<sp/>SephoneCall<sp/>[%p]<sp/>initialized<sp/>(SephoneCore<sp/>version:<sp/>%s)&quot;</highlight><highlight class="normal">,call,<ref refid="group__misc_1gaa88bd79d873927f1cc75dd64fa7d4e00" kindref="member">sephone_core_get_version</ref>());</highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;state=<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba3b67f93ffe1944fd21d018bbc369efd8" kindref="member">SephoneCallIdle</ref>;</highlight></codeline>
<codeline lineno="943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;transfer_state<sp/>=<sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba3b67f93ffe1944fd21d018bbc369efd8" kindref="member">SephoneCallIdle</ref>;</highlight></codeline>
<codeline lineno="944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;log=sephone_call_log_new(call-&gt;dir,<sp/>from,<sp/>to);</highlight></codeline>
<codeline lineno="945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;camera_enabled=TRUE;</highlight></codeline>
<codeline lineno="946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params<sp/>=<sp/>sephone_call_params_new();</highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;media_encryption=<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba04d462c1944b5e5d4dfed2154751df25" kindref="member">SephoneMediaEncryptionNone</ref>;</highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtls_certificate_fingerprint<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dir<sp/>==<sp/><ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4a0051dbbd4dd65b7d2a6acc96b334878c" kindref="member">SephoneCallIncoming</ref>)</highlight></codeline>
<codeline lineno="950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;me=to;</highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;me=from;</highlight></codeline>
<codeline lineno="953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="954"><highlight class="normal"></highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga8a3e8b96103387e4c85cc5116246fd2a" kindref="member">sephone_address_ref</ref>(call-&gt;me);</highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__network__parameters_1ga7f71dadd98dedca308b94a23cad596bc" kindref="member">sephone_core_get_audio_port_range</ref>(call-&gt;core,<sp/>&amp;min_port,<sp/>&amp;max_port);</highlight></codeline>
<codeline lineno="957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>port_config_set(call,0,min_port,max_port);</highlight></codeline>
<codeline lineno="958"><highlight class="normal"></highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__network__parameters_1gac97805519e82ebc95a8ab9e863db3883" kindref="member">sephone_core_get_video_port_range</ref>(call-&gt;core,<sp/>&amp;min_port,<sp/>&amp;max_port);</highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>port_config_set(call,1,min_port,max_port);</highlight></codeline>
<codeline lineno="961"><highlight class="normal"></highlight></codeline>
<codeline lineno="962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dir==<ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4afaf6213246f0c942cf50424e37382862" kindref="member">SephoneCallOutgoing</ref>){</highlight></codeline>
<codeline lineno="963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/><ref refid="group__media__parameters_1ga8a524ab025c1dc7c385b361233d822f4" kindref="member">sephone_core_audio_multicast_enabled</ref>(call-&gt;core)){</highlight></codeline>
<codeline lineno="964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;media_ports[0].multicast_ip,</highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__media__parameters_1ga8aadf1392c4b6b8f5487684c8f34f79b" kindref="member">sephone_core_get_audio_multicast_addr</ref>(call-&gt;core),<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(call-&gt;media_ports[0].multicast_ip));</highlight></codeline>
<codeline lineno="966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<sp/><ref refid="group__media__parameters_1ga4eb75e367e69f94e0f07ba100479832a" kindref="member">sephone_core_video_multicast_enabled</ref>(call-&gt;core)){</highlight></codeline>
<codeline lineno="968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;media_ports[1].multicast_ip,</highlight></codeline>
<codeline lineno="969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__media__parameters_1ga67fd2f00afd417ed79111fa8c7455e60" kindref="member">sephone_core_get_video_multicast_addr</ref>(call-&gt;core),<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(call-&gt;media_ports[1].multicast_ip));</highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="972"><highlight class="normal"></highlight></codeline>
<codeline lineno="973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_init_stats(&amp;call-&gt;stats[SEPHONE_CALL_STATS_AUDIO],<sp/>SEPHONE_CALL_STATS_AUDIO);</highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_init_stats(&amp;call-&gt;stats[SEPHONE_CALL_STATS_VIDEO],<sp/>SEPHONE_CALL_STATS_VIDEO);</highlight></codeline>
<codeline lineno="975"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;cam<sp/>=<sp/>call-&gt;core-&gt;video_conf.device;</highlight></codeline>
<codeline lineno="977"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="978"><highlight class="normal">}</highlight></codeline>
<codeline lineno="979"><highlight class="normal"></highlight></codeline>
<codeline lineno="980"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_init_stats(<ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>type)<sp/>{</highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1aa5c5d770646b5b1c32fad81932d0a986" kindref="member">type</ref><sp/>=<sp/>type;</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a22f16194b979cca4dce9179873818f54" kindref="member">ice_state</ref><sp/>=<sp/><ref refid="group__initializing_1gga37b5342342456e28960d4b9780354202a781154163579149dbe257718dbdb46d9" kindref="member">SephoneIceStateNotActivated</ref>;</highlight></codeline>
<codeline lineno="985"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a677ecfae9c3544c0a1fb50bcb18646c8" kindref="member">upnp_state</ref><sp/>=<sp/><ref refid="group__initializing_1gga7ef68f48d783d6faaeed4c8cb60cc181a39342d9152ae2569ba6f6df10d3dbe1b" kindref="member">SephoneUpnpStateIdle</ref>;</highlight></codeline>
<codeline lineno="987"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a677ecfae9c3544c0a1fb50bcb18646c8" kindref="member">upnp_state</ref><sp/>=<sp/><ref refid="group__initializing_1gga7ef68f48d783d6faaeed4c8cb60cc181aee30cc8b65fe9e43d6f3ba45c71360e3" kindref="member">SephoneUpnpStateNotAvailable</ref>;</highlight></codeline>
<codeline lineno="989"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="990"><highlight class="normal">}</highlight></codeline>
<codeline lineno="991"><highlight class="normal"></highlight></codeline>
<codeline lineno="992"><highlight class="normal"></highlight></codeline>
<codeline lineno="993"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>discover_mtu(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*remote){</highlight></codeline>
<codeline lineno="994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>mtu;</highlight></codeline>
<codeline lineno="995"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;net_conf.mtu==0<sp/>){</highlight></codeline>
<codeline lineno="996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*attempt<sp/>to<sp/>discover<sp/>mtu*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mtu=ms_discover_mtu(remote);</highlight></codeline>
<codeline lineno="998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mtu&gt;0){</highlight></codeline>
<codeline lineno="999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_set_mtu(mtu);</highlight></codeline>
<codeline lineno="1000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Discovered<sp/>mtu<sp/>is<sp/>%i,<sp/>RTP<sp/>payload<sp/>max<sp/>size<sp/>is<sp/>%i&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mtu,<sp/>ms_get_payload_max_size());</highlight></codeline>
<codeline lineno="1002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1004"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1005"><highlight class="normal"></highlight></codeline>
<codeline lineno="1006"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_create_op(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;op)<sp/>sal_op_release(call-&gt;op);</highlight></codeline>
<codeline lineno="1008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;op=sal_op_new(call-&gt;core-&gt;sal);</highlight></codeline>
<codeline lineno="1009"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_set_user_pointer(call-&gt;op,call);</highlight></codeline>
<codeline lineno="1010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;referer)</highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_call_set_referer(call-&gt;op,call-&gt;params-&gt;referer-&gt;op);</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_configure_op(call-&gt;core,call-&gt;op,call-&gt;log-&gt;to,call-&gt;params-&gt;custom_headers,FALSE);</highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;privacy<sp/>!=<sp/><ref refid="group__call__control_1gga38f04c02ef42854ee9f3d34206f5d5cda885f3c27efe7c769b5b056fc82f82f12" kindref="member">SephonePrivacyDefault</ref>)</highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_set_privacy(call-&gt;op,(SalPrivacyMask)call-&gt;params-&gt;privacy);</highlight></codeline>
<codeline lineno="1015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*else<sp/>privacy<sp/>might<sp/>be<sp/>set<sp/>by<sp/>proxy<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1016"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1017"><highlight class="normal"></highlight></codeline>
<codeline lineno="1018"><highlight class="normal"></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="1019"><highlight class="comment"><sp/>*<sp/>Choose<sp/>IP<sp/>version<sp/>we<sp/>are<sp/>going<sp/>to<sp/>use<sp/>for<sp/>RTP<sp/>socket.</highlight></codeline>
<codeline lineno="1020"><highlight class="comment"><sp/>*<sp/>The<sp/>algorithm<sp/>is<sp/>as<sp/>follows:</highlight></codeline>
<codeline lineno="1021"><highlight class="comment"><sp/>*<sp/>-<sp/>if<sp/>ipv6<sp/>is<sp/>disabled<sp/>at<sp/>the<sp/>core<sp/>level,<sp/>it<sp/>is<sp/>always<sp/>AF_INET</highlight></codeline>
<codeline lineno="1022"><highlight class="comment"><sp/>*<sp/>-<sp/>Otherwise,<sp/>if<sp/>the<sp/>destination<sp/>address<sp/>for<sp/>the<sp/>call<sp/>is<sp/>an<sp/>IPv6<sp/>address,<sp/>use<sp/>IPv6.</highlight></codeline>
<codeline lineno="1023"><highlight class="comment"><sp/>*<sp/>-<sp/>Otherwise,<sp/>if<sp/>the<sp/>call<sp/>is<sp/>done<sp/>through<sp/>a<sp/>known<sp/>proxy<sp/>config,<sp/>then<sp/>use<sp/>the<sp/>information<sp/>obtained<sp/>during<sp/>REGISTER</highlight></codeline>
<codeline lineno="1024"><highlight class="comment"><sp/>*<sp/>to<sp/>know<sp/>if<sp/>IPv6<sp/>is<sp/>supported<sp/>by<sp/>the<sp/>server.</highlight></codeline>
<codeline lineno="1025"><highlight class="comment">**/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1026"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_outgoing_select_ip_version(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*to,<sp/><ref refid="group__proxies_1ga6de67319de408cf5e0994375df31f431" kindref="member">SephoneProxyConfig</ref><sp/>*cfg){</highlight></codeline>
<codeline lineno="1027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__network__parameters_1ga5dfa701046fff9f072c2327ba7ddccae" kindref="member">sephone_core_ipv6_enabled</ref>(call-&gt;core)){</highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;af=AF_INET;</highlight></codeline>
<codeline lineno="1029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_address_is_ipv6((SalAddress*)to)){</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;af=AF_INET6;</highlight></codeline>
<codeline lineno="1031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg<sp/>&amp;&amp;<sp/>cfg-&gt;op){</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;af=sal_op_is_ipv6(cfg-&gt;op)<sp/>?<sp/>AF_INET6<sp/>:<sp/>AF_INET;</highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>call-&gt;af=AF_INET;</highlight></codeline>
<codeline lineno="1035"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1036"><highlight class="normal"></highlight></codeline>
<codeline lineno="1040"><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_get_local_ip(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*remote_addr){</highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*ip;</highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>af<sp/>=<sp/>call-&gt;af;</highlight></codeline>
<codeline lineno="1043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*dest<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dest_proxy<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">addrinfo<sp/>hints;</highlight></codeline>
<codeline lineno="1046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">addrinfo<sp/>*res<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>err;</highlight></codeline>
<codeline lineno="1048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*domain<sp/>=<sp/><ref refid="group__sephone__address_1gabecdcca12a29869ee350448a8de21257" kindref="member">sephone_address_get_domain</ref>(remote_addr);</highlight></codeline>
<codeline lineno="1049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;hints,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(hints));</highlight></codeline>
<codeline lineno="1050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hints.ai_family<sp/>=<sp/>AF_UNSPEC;</highlight></codeline>
<codeline lineno="1051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hints.ai_socktype<sp/>=<sp/>SOCK_DGRAM;</highlight></codeline>
<codeline lineno="1052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hints.ai_flags<sp/>=<sp/>AI_NUMERICHOST;</highlight></codeline>
<codeline lineno="1053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>err<sp/>=<sp/>getaddrinfo(domain,<sp/>NULL,<sp/>&amp;hints,<sp/>&amp;res);</highlight></codeline>
<codeline lineno="1054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(err<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dest<sp/>=<sp/>domain;</highlight></codeline>
<codeline lineno="1056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>NULL)<sp/>freeaddrinfo(res);</highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__network__parameters_1ga2ba2ed66104f0adbc83b6cd55ebb0fde" kindref="member">sephone_core_get_firewall_policy</ref>(call-&gt;core)==<ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a846b5c5ddba91b7f9d919402f574c020" kindref="member">SephonePolicyUseNatAddress</ref></highlight></codeline>
<codeline lineno="1060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>(ip=sephone_core_get_nat_address_resolved(call-&gt;core))!=NULL){</highlight></codeline>
<codeline lineno="1061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;media_localip,ip,SEPHONE_IPADDR_SIZE);</highlight></codeline>
<codeline lineno="1062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;sig_localip,ip,SEPHONE_IPADDR_SIZE);</highlight></codeline>
<codeline lineno="1063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1065"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;core-&gt;upnp<sp/>!=<sp/>NULL<sp/>&amp;&amp;<sp/><ref refid="group__network__parameters_1ga2ba2ed66104f0adbc83b6cd55ebb0fde" kindref="member">sephone_core_get_firewall_policy</ref>(call-&gt;core)==<ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1aeb9b0fa1682098c731096dbe806b0c8f" kindref="member">SephonePolicyUseUpnp</ref><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_upnp_context_get_state(call-&gt;core-&gt;upnp)<sp/>==<sp/><ref refid="group__initializing_1gga7ef68f48d783d6faaeed4c8cb60cc181ab59f711c7924ef8d39a9ad33bf5e2e03" kindref="member">SephoneUpnpStateOk</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ip<sp/>=<sp/>sephone_upnp_context_get_external_ipaddress(call-&gt;core-&gt;upnp);</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;media_localip,ip,SEPHONE_IPADDR_SIZE);</highlight></codeline>
<codeline lineno="1070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;sig_localip,ip,SEPHONE_IPADDR_SIZE);</highlight></codeline>
<codeline lineno="1071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*first<sp/>nominal<sp/>use<sp/>case*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1075"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_get_local_ip(call-&gt;core,<sp/>af,<sp/>dest,<sp/>call-&gt;media_localip);</highlight></codeline>
<codeline lineno="1076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;sig_localip,call-&gt;media_localip,SEPHONE_IPADDR_SIZE);</highlight></codeline>
<codeline lineno="1077"><highlight class="normal"></highlight></codeline>
<codeline lineno="1078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*next,<sp/>sometime,<sp/>override<sp/>from<sp/>config*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((ip=<ref refid="group__misc_1ga5a32540697fb696aa4f306d9dbc844c5" kindref="member">sp_config_get_string</ref>(call-&gt;core-&gt;config,</highlight><highlight class="stringliteral">&quot;rtp&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;bind_address&quot;</highlight><highlight class="normal">,NULL)))</highlight></codeline>
<codeline lineno="1080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;media_localip,ip,SEPHONE_IPADDR_SIZE);</highlight></codeline>
<codeline lineno="1081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((ip=<ref refid="group__misc_1ga5a32540697fb696aa4f306d9dbc844c5" kindref="member">sp_config_get_string</ref>(call-&gt;core-&gt;config,</highlight><highlight class="stringliteral">&quot;sip&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;bind_address&quot;</highlight><highlight class="normal">,NULL)))</highlight></codeline>
<codeline lineno="1082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;sig_localip,ip,SEPHONE_IPADDR_SIZE);</highlight></codeline>
<codeline lineno="1083"><highlight class="normal"></highlight></codeline>
<codeline lineno="1084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1085"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1086"><highlight class="normal"></highlight></codeline>
<codeline lineno="1087"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_destroy(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*obj);</highlight></codeline>
<codeline lineno="1088"><highlight class="normal"></highlight></codeline>
<codeline lineno="1089"><highlight class="normal">BELLE_SIP_DECLARE_NO_IMPLEMENTED_INTERFACES(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>);</highlight></codeline>
<codeline lineno="1090"><highlight class="normal"></highlight></codeline>
<codeline lineno="1091"><highlight class="normal">BELLE_SIP_INSTANCIATE_VPTR(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>,<sp/>belle_sip_object_t,</highlight></codeline>
<codeline lineno="1092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(belle_sip_object_destroy_t)sephone_call_destroy,</highlight></codeline>
<codeline lineno="1093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>NULL,<sp/></highlight><highlight class="comment">//<sp/>clone</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>NULL,<sp/></highlight><highlight class="comment">//<sp/>marshal</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>FALSE</highlight></codeline>
<codeline lineno="1096"><highlight class="normal">);</highlight></codeline>
<codeline lineno="1097"><highlight class="normal"></highlight></codeline>
<codeline lineno="1098"><highlight class="normal"><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*<sp/>sephone_call_new_outgoing(</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>_SephoneCore<sp/>*lc,<sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*from,<sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*to,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params,<sp/><ref refid="group__proxies_1ga6de67319de408cf5e0994375df31f431" kindref="member">SephoneProxyConfig</ref><sp/>*cfg){</highlight></codeline>
<codeline lineno="1099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call<sp/>=<sp/>belle_sip_object_new(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>);</highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__network__parameters_1ga296fc01afedb8747fe98bd5bc7bb2fc1" kindref="member">SephoneFirewallPolicy</ref><sp/>fpol;</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="1102"><highlight class="normal"></highlight></codeline>
<codeline lineno="1103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dir=<ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4afaf6213246f0c942cf50424e37382862" kindref="member">SephoneCallOutgoing</ref>;</highlight></codeline>
<codeline lineno="1104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;core=lc;</highlight></codeline>
<codeline lineno="1105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_outgoing_select_ip_version(call,to,cfg);</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_get_local_ip(call,<sp/>to);</highlight></codeline>
<codeline lineno="1107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_init_common(call,from,to);</highlight></codeline>
<codeline lineno="1108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params<sp/>=<sp/><ref refid="group__call__control_1ga8f3f8f15b6e812d03bf416e09576910a" kindref="member">sephone_call_params_copy</ref>(params);</highlight></codeline>
<codeline lineno="1109"><highlight class="normal"></highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fpol<sp/>=<sp/><ref refid="group__network__parameters_1ga2ba2ed66104f0adbc83b6cd55ebb0fde" kindref="member">sephone_core_get_firewall_policy</ref>(call-&gt;core);</highlight></codeline>
<codeline lineno="1111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Use<sp/>firewall<sp/>policy<sp/>%d&quot;</highlight><highlight class="normal">,<sp/>fpol);</highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fpol<sp/>==<sp/><ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a4f5a7f79bf45f888288ab1e36b50a9ec" kindref="member">SephonePolicyUseIce</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_debug(</highlight><highlight class="stringliteral">&quot;Create<sp/>ice<sp/>session<sp/>for<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal">,<sp/>call);</highlight></codeline>
<codeline lineno="1114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ice_session<sp/>=<sp/>ice_session_new();</highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*for<sp/>backward<sp/>compatibility<sp/>purposes,<sp/>shall<sp/>be<sp/>enabled<sp/>by<sp/>default<sp/>in<sp/>futur*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_enable_message_integrity_check(call-&gt;ice_session,<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;net&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;ice_session_enable_message_integrity_check&quot;</highlight><highlight class="normal">,0));</highlight></codeline>
<codeline lineno="1117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_set_role(call-&gt;ice_session,<sp/>IR_Controlling);</highlight></codeline>
<codeline lineno="1118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fpol<sp/>==<sp/><ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a00e2080969ce48e7dfb66eaa61cad53d" kindref="member">SephonePolicyUseStun</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ping_time=sephone_core_run_stun_tests(call-&gt;core,call);</highlight></codeline>
<codeline lineno="1121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1122"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fpol<sp/>==<sp/><ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1aeb9b0fa1682098c731096dbe806b0c8f" kindref="member">SephonePolicyUseUpnp</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!lc-&gt;rtp_conf.disable_upnp)<sp/>{</highlight></codeline>
<codeline lineno="1125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;upnp_session<sp/>=<sp/>sephone_upnp_session_new(call);</highlight></codeline>
<codeline lineno="1126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1128"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1129"><highlight class="normal"></highlight></codeline>
<codeline lineno="1130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>discover_mtu(lc,<ref refid="group__sephone__address_1gabecdcca12a29869ee350448a8de21257" kindref="member">sephone_address_get_domain</ref><sp/>(to));</highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;referer){</highlight></codeline>
<codeline lineno="1132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;referer=<ref refid="group__call__control_1gaeb7203d1f76af26a8ebb341d22ef2cb6" kindref="member">sephone_call_ref</ref>(params-&gt;referer);</highlight></codeline>
<codeline lineno="1133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dest_proxy=cfg;</highlight></codeline>
<codeline lineno="1135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_create_op(call);</highlight></codeline>
<codeline lineno="1136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call;</highlight></codeline>
<codeline lineno="1137"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1138"><highlight class="normal"></highlight></codeline>
<codeline lineno="1139"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_incoming_select_ip_version(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__network__parameters_1ga5dfa701046fff9f072c2327ba7ddccae" kindref="member">sephone_core_ipv6_enabled</ref>(call-&gt;core)){</highlight></codeline>
<codeline lineno="1141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;af=sal_op_is_ipv6(call-&gt;op)<sp/>?<sp/>AF_INET6<sp/>:<sp/>AF_INET;</highlight></codeline>
<codeline lineno="1142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>call-&gt;af=AF_INET;</highlight></codeline>
<codeline lineno="1143"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1144"><highlight class="normal"></highlight></codeline>
<codeline lineno="1148"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_set_compatible_incoming_call_parameters(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalMediaDescription<sp/>*md)<sp/>{</highlight></codeline>
<codeline lineno="1149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="1150"><highlight class="normal"></highlight></codeline>
<codeline lineno="1151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Handle<sp/>AVPF,<sp/>SRTP<sp/>and<sp/>DTLS.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params-&gt;avpf_enabled<sp/>=<sp/>sal_media_description_has_avpf(md);</highlight></codeline>
<codeline lineno="1153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;avpf_enabled<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="1154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dest_proxy<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="1155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params-&gt;avpf_rr_interval<sp/>=<sp/><ref refid="group__proxies_1gabefaa88fce22014d9de3ccc679ae7e11" kindref="member">sephone_proxy_config_get_avpf_rr_interval</ref>(call-&gt;dest_proxy)<sp/>*<sp/>1000;</highlight></codeline>
<codeline lineno="1156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params-&gt;avpf_rr_interval<sp/>=<sp/><ref refid="group__media__parameters_1ga896c7325aca9ea7f34e3d0115d522722" kindref="member">sephone_core_get_avpf_rr_interval</ref>(call-&gt;core)*1000;</highlight></codeline>
<codeline lineno="1158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((sal_media_description_has_dtls(md)<sp/>==<sp/>TRUE)<sp/>&amp;&amp;<sp/>(media_stream_dtls_supported()<sp/>==<sp/>TRUE))<sp/>{</highlight></codeline>
<codeline lineno="1161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params-&gt;media_encryption<sp/>=<sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba05791a117352a31299e65410334a3f91" kindref="member">SephoneMediaEncryptionDTLS</ref>;</highlight></codeline>
<codeline lineno="1162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((sal_media_description_has_srtp(md)<sp/>==<sp/>TRUE)<sp/>&amp;&amp;<sp/>(ms_srtp_supported()<sp/>==<sp/>TRUE))<sp/>{</highlight></codeline>
<codeline lineno="1163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params-&gt;media_encryption<sp/>=<sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba3e6e0aa653408fda1d63962ebbc0e351" kindref="member">SephoneMediaEncryptionSRTP</ref>;</highlight></codeline>
<codeline lineno="1164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;media_encryption<sp/>!=<sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba9f05e9f7fbb66350bfa788e2aa37c25f" kindref="member">SephoneMediaEncryptionZRTP</ref>){</highlight></codeline>
<codeline lineno="1165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params-&gt;media_encryption<sp/>=<sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba04d462c1944b5e5d4dfed2154751df25" kindref="member">SephoneMediaEncryptionNone</ref>;</highlight></codeline>
<codeline lineno="1166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1167"><highlight class="normal"></highlight></codeline>
<codeline lineno="1168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>set<sp/>both<sp/>local<sp/>audio<sp/>&amp;<sp/>video<sp/>multicast<sp/>ip<sp/>address<sp/>if<sp/>any*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i=0;i&lt;2;++i){</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;streams[i].rtp_addr[i]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>ms_is_multicast(md-&gt;streams[i].rtp_addr))<sp/>{</highlight></codeline>
<codeline lineno="1171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strncpy(call-&gt;media_ports[i].multicast_ip,md-&gt;streams[i].rtp_addr,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(call-&gt;media_ports[i].multicast_ip));</highlight></codeline>
<codeline lineno="1172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Disabling<sp/>rtcp<sp/>on<sp/>call<sp/>[%p],<sp/>stream<sp/>[%i]<sp/>because<sp/>of<sp/>multicast&quot;</highlight><highlight class="normal">,call,i);</highlight></codeline>
<codeline lineno="1173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[i].mcast_rtp_port=md-&gt;streams[i].rtp_port;</highlight></codeline>
<codeline lineno="1174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[i].mcast_rtcp_port=0;</highlight></codeline>
<codeline lineno="1175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1177"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1178"><highlight class="normal"></highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*<sp/>sephone_call_new_incoming(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*from,<sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*to,<sp/>SalOp<sp/>*op){</highlight></codeline>
<codeline lineno="1180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call<sp/>=<sp/>belle_sip_object_new(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>);</highlight></codeline>
<codeline lineno="1181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalMediaDescription<sp/>*md;</highlight></codeline>
<codeline lineno="1182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__network__parameters_1ga296fc01afedb8747fe98bd5bc7bb2fc1" kindref="member">SephoneFirewallPolicy</ref><sp/>fpol;</highlight></codeline>
<codeline lineno="1183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="1184"><highlight class="normal"></highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dir=<ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4a0051dbbd4dd65b7d2a6acc96b334878c" kindref="member">SephoneCallIncoming</ref>;</highlight></codeline>
<codeline lineno="1186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_set_user_pointer(op,call);</highlight></codeline>
<codeline lineno="1187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;op=op;</highlight></codeline>
<codeline lineno="1188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;core=lc;</highlight></codeline>
<codeline lineno="1189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_incoming_select_ip_version(call);</highlight></codeline>
<codeline lineno="1190"><highlight class="normal"></highlight></codeline>
<codeline lineno="1191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_cnx_ip_to_0000_if_sendonly_enable(op,<ref refid="group__misc_1gaa25b7f27c7c6e854842d220823e9a157" kindref="member">sp_config_get_default_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sip&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;cnx_ip_to_0000_if_sendonly_enabled&quot;</highlight><highlight class="normal">,0));</highlight></codeline>
<codeline lineno="1192"><highlight class="normal"></highlight></codeline>
<codeline lineno="1193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;sip_conf.ping_with_options){</highlight></codeline>
<codeline lineno="1194"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;upnp<sp/>!=<sp/>NULL<sp/>&amp;&amp;<sp/><ref refid="group__network__parameters_1ga2ba2ed66104f0adbc83b6cd55ebb0fde" kindref="member">sephone_core_get_firewall_policy</ref>(lc)==<ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1aeb9b0fa1682098c731096dbe806b0c8f" kindref="member">SephonePolicyUseUpnp</ref><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_upnp_context_get_state(lc-&gt;upnp)<sp/>==<sp/><ref refid="group__initializing_1gga7ef68f48d783d6faaeed4c8cb60cc181ab59f711c7924ef8d39a9ad33bf5e2e03" kindref="member">SephoneUpnpStateOk</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1197"><highlight class="normal"></highlight><highlight class="preprocessor">#else<sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1199"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*the<sp/>following<sp/>sends<sp/>an<sp/>option<sp/>request<sp/>back<sp/>to<sp/>the<sp/>caller<sp/>so<sp/>that</highlight></codeline>
<codeline lineno="1201"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>we<sp/>get<sp/>a<sp/>chance<sp/>to<sp/>discover<sp/>our<sp/>nat&apos;d<sp/>address<sp/>before<sp/>answering.*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ping_op=sal_op_new(lc-&gt;sal);</highlight></codeline>
<codeline lineno="1203"><highlight class="normal"></highlight></codeline>
<codeline lineno="1204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_configure_op(lc,<sp/>call-&gt;ping_op,<sp/>from,<sp/>NULL,<sp/>FALSE);</highlight></codeline>
<codeline lineno="1205"><highlight class="normal"></highlight></codeline>
<codeline lineno="1206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_set_route(call-&gt;ping_op,sal_op_get_network_origin(op));</highlight></codeline>
<codeline lineno="1207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_set_user_pointer(call-&gt;ping_op,call);</highlight></codeline>
<codeline lineno="1208"><highlight class="normal"></highlight></codeline>
<codeline lineno="1209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_ping(call-&gt;ping_op,sal_op_get_from(call-&gt;ping_op),<sp/>sal_op_get_to(call-&gt;ping_op));</highlight></codeline>
<codeline lineno="1210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1212"><highlight class="normal"></highlight></codeline>
<codeline lineno="1213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga02500100d80fe80561d87367c445e599" kindref="member">sephone_address_clean</ref>(from);</highlight></codeline>
<codeline lineno="1214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_get_local_ip(call,<sp/>from);</highlight></codeline>
<codeline lineno="1215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_init_common(call,<sp/>from,<sp/>to);</highlight></codeline>
<codeline lineno="1216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params<sp/>=<sp/>sephone_call_params_new();</highlight></codeline>
<codeline lineno="1217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;log-&gt;call_id=ms_strdup(sal_op_get_call_id(op));<sp/></highlight><highlight class="comment">/*must<sp/>be<sp/>known<sp/>at<sp/>that<sp/>time*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dest_proxy<sp/>=<sp/>sephone_core_lookup_known_proxy(call-&gt;core,<sp/>to);</highlight></codeline>
<codeline lineno="1219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_init_default_params(lc,<sp/>call-&gt;params);</highlight></codeline>
<codeline lineno="1220"><highlight class="normal"></highlight></codeline>
<codeline lineno="1221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="1222"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>Initialize<sp/>call<sp/>parameters<sp/>according<sp/>to<sp/>incoming<sp/>call<sp/>parameters.<sp/>This<sp/>is<sp/>to<sp/>avoid<sp/>to<sp/>ask<sp/>later<sp/>(during<sp/>reINVITEs)<sp/>for<sp/>features<sp/>that<sp/>the<sp/>remote</highlight></codeline>
<codeline lineno="1223"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>end<sp/>apparently<sp/>does<sp/>not<sp/>support.<sp/>This<sp/>features<sp/>are:<sp/>privacy,<sp/>video</highlight></codeline>
<codeline lineno="1224"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*set<sp/>privacy*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;privacy=(SephonePrivacyMask)sal_op_get_privacy(call-&gt;op);</highlight></codeline>
<codeline lineno="1227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*set<sp/>video<sp/>support<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md=sal_call_get_remote_media_description(op);</highlight></codeline>
<codeline lineno="1229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params-&gt;has_video<sp/>=<sp/><ref refid="group__media__parameters_1ga092e40c6c49897fdc5269d461e2c02e1" kindref="member">sephone_core_video_enabled</ref>(lc)<sp/>&amp;&amp;<sp/>lc-&gt;video_policy.automatically_accept;</highlight></codeline>
<codeline lineno="1230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md)<sp/>{</highlight></codeline>
<codeline lineno="1231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>is<sp/>licit<sp/>to<sp/>receive<sp/>an<sp/>INVITE<sp/>without<sp/>SDP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>this<sp/>case<sp/>WE<sp/>chose<sp/>the<sp/>media<sp/>parameters<sp/>according<sp/>to<sp/>policy.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_set_compatible_incoming_call_parameters(call,<sp/>md);</highlight></codeline>
<codeline lineno="1234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fpol=<ref refid="group__network__parameters_1ga2ba2ed66104f0adbc83b6cd55ebb0fde" kindref="member">sephone_core_get_firewall_policy</ref>(call-&gt;core);</highlight></codeline>
<codeline lineno="1236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Use<sp/>firewall<sp/>policy<sp/>%d&quot;</highlight><highlight class="normal">,<sp/>fpol);</highlight></codeline>
<codeline lineno="1237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*create<sp/>the<sp/>ice<sp/>session<sp/>now<sp/>if<sp/>ICE<sp/>is<sp/>required*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fpol==<ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a4f5a7f79bf45f888288ab1e36b50a9ec" kindref="member">SephonePolicyUseIce</ref>){</highlight></codeline>
<codeline lineno="1239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md){</highlight></codeline>
<codeline lineno="1240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_debug(</highlight><highlight class="stringliteral">&quot;Create<sp/>ice<sp/>session<sp/>for<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal">,<sp/>call);</highlight></codeline>
<codeline lineno="1241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ice_session<sp/>=<sp/>ice_session_new();</highlight></codeline>
<codeline lineno="1242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*for<sp/>backward<sp/>compatibility<sp/>purposes,<sp/>shall<sp/>be<sp/>enabled<sp/>by<sp/>default<sp/>in<sp/>futur*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_enable_message_integrity_check(call-&gt;ice_session,<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;net&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;ice_session_enable_message_integrity_check&quot;</highlight><highlight class="normal">,0));</highlight></codeline>
<codeline lineno="1244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_set_role(call-&gt;ice_session,<sp/>IR_Controlled);</highlight></codeline>
<codeline lineno="1245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fpol=<ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a6e7bcb0bebba673fb315c3f7b926673a" kindref="member">SephonePolicyNoFirewall</ref>;</highlight></codeline>
<codeline lineno="1247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;ICE<sp/>not<sp/>supported<sp/>for<sp/>incoming<sp/>INVITE<sp/>without<sp/>SDP.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fpol==<ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a00e2080969ce48e7dfb66eaa61cad53d" kindref="member">SephonePolicyUseStun</ref>){</highlight></codeline>
<codeline lineno="1250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ping_time=sephone_core_run_stun_tests(call-&gt;core,call);</highlight></codeline>
<codeline lineno="1251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1252"><highlight class="normal"></highlight></codeline>
<codeline lineno="1253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*reserve<sp/>the<sp/>sockets<sp/>immediately*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_init_media_streams(call);</highlight></codeline>
<codeline lineno="1255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(fpol)<sp/>{</highlight></codeline>
<codeline lineno="1256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a4f5a7f79bf45f888288ab1e36b50a9ec" kindref="member">SephonePolicyUseIce</ref>:</highlight></codeline>
<codeline lineno="1257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_prepare_ice(call,TRUE);</highlight></codeline>
<codeline lineno="1258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//@<sp/>xr<sp/>2015-7-14<sp/>sephone_call_init_media_streams()rtp</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Bind<sp/>socket<sp/>to<sp/>0.0.0.0:7076<sp/>failed:<sp/>Address<sp/>already<sp/>in<sp/>use</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1261"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephonePolicyUseStun:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1262"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ping_time=sephone_core_run_stun_tests(call-&gt;core,call);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1263"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>No<sp/>break<sp/>to<sp/>also<sp/>destroy<sp/>ice<sp/>session<sp/>in<sp/>this<sp/>case.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1264"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1aeb9b0fa1682098c731096dbe806b0c8f" kindref="member">SephonePolicyUseUpnp</ref>:</highlight></codeline>
<codeline lineno="1266"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!lc-&gt;rtp_conf.disable_upnp)<sp/>{</highlight></codeline>
<codeline lineno="1268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;upnp_session<sp/>=<sp/>sephone_upnp_session_new(call);</highlight></codeline>
<codeline lineno="1269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;upnp_session<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="1270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sephone_core_update_upnp_from_remote_media_description(call,<sp/>sal_call_get_remote_media_description(op))&lt;0)<sp/>{</highlight></codeline>
<codeline lineno="1271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>uPnP<sp/>port<sp/>mappings<sp/>failed,<sp/>proceed<sp/>with<sp/>the<sp/>call<sp/>anyway.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_delete_upnp_session(call);</highlight></codeline>
<codeline lineno="1273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1276"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1281"><highlight class="normal"></highlight></codeline>
<codeline lineno="1282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>discover_mtu(lc,<ref refid="group__sephone__address_1gabecdcca12a29869ee350448a8de21257" kindref="member">sephone_address_get_domain</ref>(from));</highlight></codeline>
<codeline lineno="1283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call;</highlight></codeline>
<codeline lineno="1284"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1285"><highlight class="normal"></highlight></codeline>
<codeline lineno="1286"><highlight class="normal"></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="1287"><highlight class="comment"><sp/>*<sp/>Frees<sp/>the<sp/>media<sp/>resources<sp/>of<sp/>the<sp/>call.</highlight></codeline>
<codeline lineno="1288"><highlight class="comment"><sp/>*<sp/>This<sp/>has<sp/>to<sp/>be<sp/>done<sp/>at<sp/>the<sp/>earliest,<sp/>unlike<sp/>signaling<sp/>resources<sp/>that<sp/>sometimes<sp/>need<sp/>to<sp/>be<sp/>kept<sp/>a<sp/>bit<sp/>more<sp/>longer.</highlight></codeline>
<codeline lineno="1289"><highlight class="comment"><sp/>*<sp/>It<sp/>is<sp/>called<sp/>by<sp/>sephone_call_set_terminated()<sp/>(for<sp/>termination<sp/>of<sp/>calls<sp/>signaled<sp/>to<sp/>the<sp/>application),<sp/>or<sp/>directly<sp/>by<sp/>the<sp/>destructor<sp/>of<sp/>SephoneCall</highlight></codeline>
<codeline lineno="1290"><highlight class="comment"><sp/>*<sp/>(_sephone_call_destroy)<sp/>if<sp/>the<sp/>call<sp/>was<sp/>never<sp/>notified<sp/>to<sp/>the<sp/>application.</highlight></codeline>
<codeline lineno="1291"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1292"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_free_media_resources(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="1294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_media_streams(call);</highlight></codeline>
<codeline lineno="1295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_media_stream_sessions_uninit(&amp;call-&gt;sessions[0]);</highlight></codeline>
<codeline lineno="1296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_media_stream_sessions_uninit(&amp;call-&gt;sessions[1]);</highlight></codeline>
<codeline lineno="1297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_delete_upnp_session(call);</highlight></codeline>
<codeline lineno="1298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_delete_ice_session(call);</highlight></codeline>
<codeline lineno="1299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stats_uninit(&amp;call-&gt;stats[0]);</highlight></codeline>
<codeline lineno="1300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stats_uninit(&amp;call-&gt;stats[1]);</highlight></codeline>
<codeline lineno="1301"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1302"><highlight class="normal"></highlight></codeline>
<codeline lineno="1303"><highlight class="normal"></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="1304"><highlight class="comment"><sp/>*<sp/>Called<sp/>internally<sp/>when<sp/>reaching<sp/>the<sp/>Released<sp/>state,<sp/>to<sp/>perform<sp/>cleanups<sp/>to<sp/>break<sp/>circular<sp/>references.</highlight></codeline>
<codeline lineno="1305"><highlight class="comment">**/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1306"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_set_released(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="1308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;op!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="1309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*transfer<sp/>the<sp/>last<sp/>error<sp/>so<sp/>that<sp/>it<sp/>can<sp/>be<sp/>obtained<sp/>even<sp/>in<sp/>Released<sp/>state*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;non_op_error.reason==SalReasonNone){</highlight></codeline>
<codeline lineno="1311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalErrorInfo<sp/>*ei=sal_op_get_error_info(call-&gt;op);</highlight></codeline>
<codeline lineno="1312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_error_info_set(&amp;call-&gt;non_op_error,ei-&gt;reason,ei-&gt;protocol_code,ei-&gt;status_string,ei-&gt;warnings);</highlight></codeline>
<codeline lineno="1313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>so<sp/>that<sp/>we<sp/>cannot<sp/>have<sp/>anymore<sp/>upcalls<sp/>for<sp/>SAL<sp/>concerning<sp/>this<sp/>call*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_release(call-&gt;op);</highlight></codeline>
<codeline lineno="1316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;op=NULL;</highlight></codeline>
<codeline lineno="1317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*it<sp/>is<sp/>necessary<sp/>to<sp/>reset<sp/>pointers<sp/>to<sp/>other<sp/>call<sp/>to<sp/>prevent<sp/>circular<sp/>references<sp/>that<sp/>would<sp/>result<sp/>in<sp/>memory<sp/>never<sp/>freed.*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;referer){</highlight></codeline>
<codeline lineno="1320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1ga7a9033711fde2bb76c63421e8fe032b1" kindref="member">sephone_call_unref</ref>(call-&gt;referer);</highlight></codeline>
<codeline lineno="1321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;referer=NULL;</highlight></codeline>
<codeline lineno="1322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;transfer_target){</highlight></codeline>
<codeline lineno="1324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1ga7a9033711fde2bb76c63421e8fe032b1" kindref="member">sephone_call_unref</ref>(call-&gt;transfer_target);</highlight></codeline>
<codeline lineno="1325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;transfer_target=NULL;</highlight></codeline>
<codeline lineno="1326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1ga7a9033711fde2bb76c63421e8fe032b1" kindref="member">sephone_call_unref</ref>(call);</highlight></codeline>
<codeline lineno="1328"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1329"><highlight class="normal"></highlight></codeline>
<codeline lineno="1330"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>this<sp/>function<sp/>is<sp/>called<sp/>internally<sp/>to<sp/>get<sp/>rid<sp/>of<sp/>a<sp/>call<sp/>that<sp/>was<sp/>notified<sp/>to<sp/>the<sp/>application,<sp/>because<sp/>it<sp/>reached<sp/>the<sp/>end<sp/>or<sp/>error<sp/>state.</highlight></codeline>
<codeline lineno="1331"><highlight class="comment"><sp/>It<sp/>performs<sp/>the<sp/>following<sp/>tasks:</highlight></codeline>
<codeline lineno="1332"><highlight class="comment"><sp/>-<sp/>remove<sp/>the<sp/>call<sp/>from<sp/>the<sp/>internal<sp/>list<sp/>of<sp/>calls</highlight></codeline>
<codeline lineno="1333"><highlight class="comment"><sp/>-<sp/>update<sp/>the<sp/>call<sp/>logs<sp/>accordingly</highlight></codeline>
<codeline lineno="1334"><highlight class="comment">*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1335"><highlight class="normal"></highlight></codeline>
<codeline lineno="1336"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_set_terminated(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="1338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="1339"><highlight class="normal"></highlight></codeline>
<codeline lineno="1340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_free_media_resources(call);</highlight></codeline>
<codeline lineno="1341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_log_completed(call);</highlight></codeline>
<codeline lineno="1342"><highlight class="normal"></highlight></codeline>
<codeline lineno="1343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call<sp/>==<sp/>lc-&gt;current_call){</highlight></codeline>
<codeline lineno="1344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Resetting<sp/>the<sp/>current<sp/>call&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;current_call=NULL;</highlight></codeline>
<codeline lineno="1346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1347"><highlight class="normal"></highlight></codeline>
<codeline lineno="1348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sephone_core_del_call(lc,call)<sp/>!=<sp/>0){</highlight></codeline>
<codeline lineno="1349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>remove<sp/>the<sp/>call<sp/>from<sp/>the<sp/>list<sp/>!!!&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_conference_check_uninit(lc);</highlight></codeline>
<codeline lineno="1352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;ringing_beep){</highlight></codeline>
<codeline lineno="1353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__media__parameters_1ga55676bf6827854e8afb6476d0a4b6682" kindref="member">sephone_core_stop_dtmf</ref>(lc);</highlight></codeline>
<codeline lineno="1354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ringing_beep=FALSE;</highlight></codeline>
<codeline lineno="1355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1356"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1357"><highlight class="normal"></highlight></codeline>
<codeline lineno="1358"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_fix_call_parameters(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_call_is_offerer(call-&gt;op))<sp/>{</highlight></codeline>
<codeline lineno="1360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*get<sp/>remote<sp/>params*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref>*<sp/>rcp<sp/>=<sp/><ref refid="group__call__control_1gaea5a52a499338f37b62061f081d533c4" kindref="member">sephone_call_get_remote_params</ref>(call);</highlight></codeline>
<codeline lineno="1362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;video_declined<sp/>=<sp/>call-&gt;params-&gt;has_video<sp/>&amp;&amp;<sp/>!rcp-&gt;has_video;</highlight></codeline>
<codeline lineno="1363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1364"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1365"><highlight class="normal"></highlight></codeline>
<codeline lineno="1366"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*sephone_call_state_to_string(<ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref><sp/>cs){</highlight></codeline>
<codeline lineno="1367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(cs){</highlight></codeline>
<codeline lineno="1368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba3b67f93ffe1944fd21d018bbc369efd8" kindref="member">SephoneCallIdle</ref>:</highlight></codeline>
<codeline lineno="1369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallIdle&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba63b15c2574a5724da57cf0e377cd4c91" kindref="member">SephoneCallIncomingReceived</ref>:</highlight></codeline>
<codeline lineno="1371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallIncomingReceived&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba575309df965824fcf53c5b7e488ab8a9" kindref="member">SephoneCallOutgoingInit</ref>:</highlight></codeline>
<codeline lineno="1373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallOutgoingInit&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3baa16b36798a522f77579879be517d5ef7" kindref="member">SephoneCallOutgoingProgress</ref>:</highlight></codeline>
<codeline lineno="1375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallOutgoingProgress&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba61d15f7e9d1d616ac8d92f37f8924080" kindref="member">SephoneCallOutgoingRinging</ref>:</highlight></codeline>
<codeline lineno="1377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallOutgoingRinging&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bac9f834703e7fc0a5bec2c86d18f56e1e" kindref="member">SephoneCallOutgoingEarlyMedia</ref>:</highlight></codeline>
<codeline lineno="1379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallOutgoingEarlyMedia&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba51a6c2fb79fe61a7bade9de0d5389913" kindref="member">SephoneCallConnected</ref>:</highlight></codeline>
<codeline lineno="1381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallConnected&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref>:</highlight></codeline>
<codeline lineno="1383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallStreamsRunning&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba66caef311f7a20ebc9e42ac8180ea002" kindref="member">SephoneCallPausing</ref>:</highlight></codeline>
<codeline lineno="1385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallPausing&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba6f1e7b0f913ec60c5402ff67dc7e4903" kindref="member">SephoneCallPaused</ref>:</highlight></codeline>
<codeline lineno="1387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallPaused&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba7a7a1a9d9091fa568c84b58fae402ca4" kindref="member">SephoneCallResuming</ref>:</highlight></codeline>
<codeline lineno="1389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallResuming&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba3e3071461b80ce58550a84df0ef6a39c" kindref="member">SephoneCallRefered</ref>:</highlight></codeline>
<codeline lineno="1391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallRefered&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3baa694422725a956b802634a537f9cbdb9" kindref="member">SephoneCallError</ref>:</highlight></codeline>
<codeline lineno="1393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallError&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba267bd03db682af973f6577434590e6d5" kindref="member">SephoneCallEnd</ref>:</highlight></codeline>
<codeline lineno="1395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallEnd&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba52fb438226d381d630ca5ff5447d740e" kindref="member">SephoneCallPausedByRemote</ref>:</highlight></codeline>
<codeline lineno="1397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallPausedByRemote&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bad0ba6055a04fc211f82413ecae9672ab" kindref="member">SephoneCallUpdatedByRemote</ref>:</highlight></codeline>
<codeline lineno="1399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallUpdatedByRemote&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba83ca7112a1058f9a7bfd8a59c5b22e74" kindref="member">SephoneCallIncomingEarlyMedia</ref>:</highlight></codeline>
<codeline lineno="1401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallIncomingEarlyMedia&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bac7b639e36102e8947d2fa2933db7359e" kindref="member">SephoneCallUpdating</ref>:</highlight></codeline>
<codeline lineno="1403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallUpdating&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3baf2803894caa751f54ef3a2d608034db7" kindref="member">SephoneCallReleased</ref>:</highlight></codeline>
<codeline lineno="1405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallReleased&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SephoneCallEarlyUpdatedByRemote:</highlight></codeline>
<codeline lineno="1407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallEarlyUpdatedByRemote&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SephoneCallEarlyUpdating:</highlight></codeline>
<codeline lineno="1409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallEarlyUpdating&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SephoneCallFirstImageDecoded:</highlight></codeline>
<codeline lineno="1411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallFirstImageDecoded&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SephoneCallVideoDecodingError:</highlight></codeline>
<codeline lineno="1413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephoneCallVideoDecodingError&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;undefined<sp/>state&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1416"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1417"><highlight class="normal"></highlight></codeline>
<codeline lineno="1418"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_set_state(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/><ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref><sp/>cstate,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*message){</highlight></codeline>
<codeline lineno="1419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="1420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="1421"><highlight class="normal"></highlight></codeline>
<codeline lineno="1422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;state!=cstate){</highlight></codeline>
<codeline lineno="1423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;prevstate=call-&gt;state;</highlight></codeline>
<codeline lineno="1424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;state==<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba267bd03db682af973f6577434590e6d5" kindref="member">SephoneCallEnd</ref><sp/>||<sp/>call-&gt;state==<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3baa694422725a956b802634a537f9cbdb9" kindref="member">SephoneCallError</ref>){</highlight></codeline>
<codeline lineno="1425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cstate!=<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3baf2803894caa751f54ef3a2d608034db7" kindref="member">SephoneCallReleased</ref>){</highlight></codeline>
<codeline lineno="1426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Spurious<sp/>call<sp/>state<sp/>change<sp/>from<sp/>%s<sp/>to<sp/>%s,<sp/>ignored.&quot;</highlight><highlight class="normal"><sp/>,sephone_call_state_to_string(call-&gt;state)</highlight></codeline>
<codeline lineno="1427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sephone_call_state_to_string(cstate));</highlight></codeline>
<codeline lineno="1428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Call<sp/>%p:<sp/>moving<sp/>from<sp/>state<sp/>%s<sp/>to<sp/>%s&quot;</highlight><highlight class="normal">,call</highlight></codeline>
<codeline lineno="1432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sephone_call_state_to_string(call-&gt;state)</highlight></codeline>
<codeline lineno="1433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sephone_call_state_to_string(cstate));</highlight></codeline>
<codeline lineno="1434"><highlight class="normal"></highlight></codeline>
<codeline lineno="1435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cstate!=<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba3e3071461b80ce58550a84df0ef6a39c" kindref="member">SephoneCallRefered</ref>){</highlight></codeline>
<codeline lineno="1436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*SephoneCallRefered<sp/>is<sp/>rather<sp/>an<sp/>event,<sp/>not<sp/>a<sp/>state.</highlight></codeline>
<codeline lineno="1437"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Indeed<sp/>it<sp/>does<sp/>not<sp/>change<sp/>the<sp/>state<sp/>of<sp/>the<sp/>call<sp/>(still<sp/>paused<sp/>or<sp/>running)*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;state=cstate;</highlight></codeline>
<codeline lineno="1439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1440"><highlight class="normal"></highlight></codeline>
<codeline lineno="1441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(cstate)<sp/>{</highlight></codeline>
<codeline lineno="1442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba575309df965824fcf53c5b7e488ab8a9" kindref="member">SephoneCallOutgoingInit</ref>:</highlight></codeline>
<codeline lineno="1443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba63b15c2574a5724da57cf0e377cd4c91" kindref="member">SephoneCallIncomingReceived</ref>:</highlight></codeline>
<codeline lineno="1444"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>ANDROID</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Call<sp/>[%p]<sp/>acquires<sp/>both<sp/>wifi<sp/>and<sp/>multicast<sp/>lock&quot;</highlight><highlight class="normal">,call);</highlight></codeline>
<codeline lineno="1446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_wifi_lock_acquire(call-&gt;core);</highlight></codeline>
<codeline lineno="1447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_multicast_lock_acquire(call-&gt;core);<sp/></highlight><highlight class="comment">/*does<sp/>no<sp/>affect<sp/>battery<sp/>more<sp/>than<sp/>regular<sp/>rtp<sp/>traffic*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1448"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba267bd03db682af973f6577434590e6d5" kindref="member">SephoneCallEnd</ref>:</highlight></codeline>
<codeline lineno="1451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3baa694422725a956b802634a537f9cbdb9" kindref="member">SephoneCallError</ref>:</highlight></codeline>
<codeline lineno="1452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(call-&gt;non_op_error.reason){</highlight></codeline>
<codeline lineno="1453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SalReasonDeclined:</highlight></codeline>
<codeline lineno="1454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;log-&gt;status=<ref refid="group__call__logs_1ggab3a24983dbb17007538702063fc99605a1fa0e8c15df07be70b825de69e23496b" kindref="member">SephoneCallDeclined</ref>;</highlight></codeline>
<codeline lineno="1455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SalReasonRequestTimeout:</highlight></codeline>
<codeline lineno="1457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;log-&gt;status=<ref refid="group__call__logs_1ggab3a24983dbb17007538702063fc99605a055cfc069041ea4b9d954b8fcbbaa798" kindref="member">SephoneCallMissed</ref>;</highlight></codeline>
<codeline lineno="1458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_set_terminated(call);</highlight></codeline>
<codeline lineno="1463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba51a6c2fb79fe61a7bade9de0d5389913" kindref="member">SephoneCallConnected</ref>:</highlight></codeline>
<codeline lineno="1465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;log-&gt;status=<ref refid="group__call__logs_1ggab3a24983dbb17007538702063fc99605a8b16b4a49187a15cfdef7d12abfc8238" kindref="member">SephoneCallSuccess</ref>;</highlight></codeline>
<codeline lineno="1466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;log-&gt;connected_date_time=time(NULL);</highlight></codeline>
<codeline lineno="1467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3baf2803894caa751f54ef3a2d608034db7" kindref="member">SephoneCallReleased</ref>:</highlight></codeline>
<codeline lineno="1469"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>ANDROID</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Call<sp/>[%p]<sp/>releases<sp/>wifi/multicast<sp/>lock&quot;</highlight><highlight class="normal">,call);</highlight></codeline>
<codeline lineno="1471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_wifi_lock_release(call-&gt;core);</highlight></codeline>
<codeline lineno="1472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_multicast_lock_release(call-&gt;core);</highlight></codeline>
<codeline lineno="1473"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref>:</highlight></codeline>
<codeline lineno="1476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;prevstate<sp/>==<sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bac7b639e36102e8947d2fa2933db7359e" kindref="member">SephoneCallUpdating</ref><sp/>||<sp/>call-&gt;prevstate<sp/>==<sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bad0ba6055a04fc211f82413ecae9672ab" kindref="member">SephoneCallUpdatedByRemote</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_display_status(lc,_(</highlight><highlight class="stringliteral">&quot;Call<sp/>parameters<sp/>were<sp/>successfully<sp/>modified.&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="1478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="1481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1483"><highlight class="normal"></highlight></codeline>
<codeline lineno="1484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(cstate!=<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dtmfs_timer!=NULL){</highlight></codeline>
<codeline lineno="1486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*cancelling<sp/>DTMF<sp/>sequence,<sp/>if<sp/>any*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_cancel_dtmfs(call);</highlight></codeline>
<codeline lineno="1488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_state_changed(lc,call,cstate,message);</highlight></codeline>
<codeline lineno="1491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_reporting_call_state_updated(call);</highlight></codeline>
<codeline lineno="1492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cstate==<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3baf2803894caa751f54ef3a2d608034db7" kindref="member">SephoneCallReleased</ref>)<sp/>{</highlight><highlight class="comment">/*shall<sp/>be<sp/>performed<sp/>after<sp/><sp/>app<sp/>notification*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_set_released(call);</highlight></codeline>
<codeline lineno="1494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_soundcard_hint_check(lc);</highlight></codeline>
<codeline lineno="1496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1497"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1498"><highlight class="normal"></highlight></codeline>
<codeline lineno="1499"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_destroy(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*obj){</highlight></codeline>
<codeline lineno="1500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Call<sp/>[%p]<sp/>freed.&quot;</highlight><highlight class="normal">,obj);</highlight></codeline>
<codeline lineno="1501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;audiostream<sp/>||<sp/>obj-&gt;videostream){</highlight></codeline>
<codeline lineno="1502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_free_media_resources(obj);</highlight></codeline>
<codeline lineno="1503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;op!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="1505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_release(obj-&gt;op);</highlight></codeline>
<codeline lineno="1506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;op=NULL;</highlight></codeline>
<codeline lineno="1507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;biggestdesc!=NULL){</highlight></codeline>
<codeline lineno="1509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_media_description_unref(obj-&gt;biggestdesc);</highlight></codeline>
<codeline lineno="1510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;biggestdesc=NULL;</highlight></codeline>
<codeline lineno="1511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;resultdesc!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="1513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_media_description_unref(obj-&gt;resultdesc);</highlight></codeline>
<codeline lineno="1514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;resultdesc=NULL;</highlight></codeline>
<codeline lineno="1515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;localdesc!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="1517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_media_description_unref(obj-&gt;localdesc);</highlight></codeline>
<codeline lineno="1518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;localdesc=NULL;</highlight></codeline>
<codeline lineno="1519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;ping_op)<sp/>{</highlight></codeline>
<codeline lineno="1521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_release(obj-&gt;ping_op);</highlight></codeline>
<codeline lineno="1522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;ping_op=NULL;</highlight></codeline>
<codeline lineno="1523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;refer_to){</highlight></codeline>
<codeline lineno="1525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(obj-&gt;refer_to);</highlight></codeline>
<codeline lineno="1526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;refer_to=NULL;</highlight></codeline>
<codeline lineno="1527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;referer){</highlight></codeline>
<codeline lineno="1529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1ga7a9033711fde2bb76c63421e8fe032b1" kindref="member">sephone_call_unref</ref>(obj-&gt;referer);</highlight></codeline>
<codeline lineno="1530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;referer=NULL;</highlight></codeline>
<codeline lineno="1531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;transfer_target){</highlight></codeline>
<codeline lineno="1533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1ga7a9033711fde2bb76c63421e8fe032b1" kindref="member">sephone_call_unref</ref>(obj-&gt;transfer_target);</highlight></codeline>
<codeline lineno="1534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;transfer_target=NULL;</highlight></codeline>
<codeline lineno="1535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;log)<sp/>{</highlight></codeline>
<codeline lineno="1537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__logs_1ga0d9a7e7e2acc07acf85e2aac5874b26e" kindref="member">sephone_call_log_unref</ref>(obj-&gt;log);</highlight></codeline>
<codeline lineno="1538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;log=NULL;</highlight></codeline>
<codeline lineno="1539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;auth_token)<sp/>{</highlight></codeline>
<codeline lineno="1541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(obj-&gt;auth_token);</highlight></codeline>
<codeline lineno="1542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;auth_token=NULL;</highlight></codeline>
<codeline lineno="1543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;dtls_certificate_fingerprint)<sp/>{</highlight></codeline>
<codeline lineno="1545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(obj-&gt;dtls_certificate_fingerprint);</highlight></codeline>
<codeline lineno="1546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;dtls_certificate_fingerprint=NULL;</highlight></codeline>
<codeline lineno="1547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;dtmfs_timer)<sp/>{</highlight></codeline>
<codeline lineno="1549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_cancel_dtmfs(obj);</highlight></codeline>
<codeline lineno="1550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;params){</highlight></codeline>
<codeline lineno="1552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gae7c8fa8ba8eee61e979e87727004457d" kindref="member">sephone_call_params_unref</ref>(obj-&gt;params);</highlight></codeline>
<codeline lineno="1553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;params=NULL;</highlight></codeline>
<codeline lineno="1554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;current_params){</highlight></codeline>
<codeline lineno="1556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gae7c8fa8ba8eee61e979e87727004457d" kindref="member">sephone_call_params_unref</ref>(obj-&gt;current_params);</highlight></codeline>
<codeline lineno="1557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;current_params=NULL;</highlight></codeline>
<codeline lineno="1558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;remote_params<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="1560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gae7c8fa8ba8eee61e979e87727004457d" kindref="member">sephone_call_params_unref</ref>(obj-&gt;remote_params);</highlight></codeline>
<codeline lineno="1561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;remote_params=NULL;</highlight></codeline>
<codeline lineno="1562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj-&gt;me)<sp/>{</highlight></codeline>
<codeline lineno="1564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1gac00d05a6314b7b98bec41261f1e18a9f" kindref="member">sephone_address_unref</ref>(obj-&gt;me);</highlight></codeline>
<codeline lineno="1565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj-&gt;me<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1567"><highlight class="normal"></highlight></codeline>
<codeline lineno="1568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_error_info_reset(&amp;obj-&gt;non_op_error);</highlight></codeline>
<codeline lineno="1569"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1570"><highlight class="normal"></highlight></codeline>
<codeline lineno="1576"><highlight class="normal"><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*<sp/><ref refid="group__call__control_1gaeb7203d1f76af26a8ebb341d22ef2cb6" kindref="member">sephone_call_ref</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*obj){</highlight></codeline>
<codeline lineno="1577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_object_ref(obj);</highlight></codeline>
<codeline lineno="1578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>obj;</highlight></codeline>
<codeline lineno="1579"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1580"><highlight class="normal"></highlight></codeline>
<codeline lineno="1581"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1ga7a9033711fde2bb76c63421e8fe032b1" kindref="member">sephone_call_unref</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*obj){</highlight></codeline>
<codeline lineno="1582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_object_unref(obj);</highlight></codeline>
<codeline lineno="1583"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1584"><highlight class="normal"></highlight></codeline>
<codeline lineno="1585"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>sephone_call_get_n_active_streams(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="1586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*md<sp/>=<sp/>sal_call_get_remote_media_description(call-&gt;op);</highlight></codeline>
<codeline lineno="1587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!md)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>sal_media_description_nb_active_streams_of_type(md,<sp/>SalAudio)<sp/>+<sp/>sal_media_description_nb_active_streams_of_type(md,<sp/>SalVideo);</highlight></codeline>
<codeline lineno="1589"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1590"><highlight class="normal"></highlight></codeline>
<codeline lineno="1594"><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*<sp/><ref refid="group__call__control_1ga3440e61504e058274ecc74dd435938e4" kindref="member">sephone_call_get_current_params</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*md=call-&gt;resultdesc;</highlight></codeline>
<codeline lineno="1596"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>VideoStream<sp/>*vstream;</highlight></codeline>
<codeline lineno="1598"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MS_VIDEO_SIZE_ASSIGN(call-&gt;current_params-&gt;sent_vsize,<sp/>UNKNOWN);</highlight></codeline>
<codeline lineno="1600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MS_VIDEO_SIZE_ASSIGN(call-&gt;current_params-&gt;recv_vsize,<sp/>UNKNOWN);</highlight></codeline>
<codeline lineno="1601"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vstream<sp/>=<sp/>call-&gt;videostream;</highlight></codeline>
<codeline lineno="1603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vstream<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="1604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;sent_vsize<sp/>=<sp/>video_stream_get_sent_video_size(vstream);</highlight></codeline>
<codeline lineno="1605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;recv_vsize<sp/>=<sp/>video_stream_get_received_video_size(vstream);</highlight></codeline>
<codeline lineno="1606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;sent_fps<sp/>=<sp/>video_stream_get_sent_framerate(vstream);</highlight></codeline>
<codeline lineno="1607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;received_fps<sp/>=<sp/>video_stream_get_received_framerate(vstream);</highlight></codeline>
<codeline lineno="1608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1609"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1610"><highlight class="normal"></highlight></codeline>
<codeline lineno="1611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>REVISITED</highlight></codeline>
<codeline lineno="1612"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>Previous<sp/>code<sp/>was<sp/>buggy.</highlight></codeline>
<codeline lineno="1613"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>Relying<sp/>on<sp/>the<sp/>mediastream&apos;s<sp/>state<sp/>(added<sp/>by<sp/>jehan:<sp/>only)<sp/>to<sp/>know<sp/>the<sp/>current<sp/>encryption<sp/>is<sp/>unreliable.</highlight></codeline>
<codeline lineno="1614"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>For<sp/>(added<sp/>by<sp/>jehan:<sp/>both<sp/>DTLS<sp/>and)<sp/>ZRTP<sp/>it<sp/>is<sp/>though<sp/>necessary.</highlight></codeline>
<codeline lineno="1615"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>But<sp/>for<sp/>all<sp/>others<sp/>the<sp/>current_params-&gt;media_encryption<sp/>state<sp/>should<sp/>reflect<sp/>(added<sp/>by<sp/>jehan:<sp/>both)<sp/>what<sp/>is<sp/>agreed<sp/>by<sp/>the<sp/>offer/answer</highlight></codeline>
<codeline lineno="1616"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>mechanism<sp/><sp/>(added<sp/>by<sp/>jehan:<sp/>and<sp/>encryption<sp/>status<sp/>from<sp/>media<sp/>which<sp/>is<sp/>much<sp/>stronger<sp/>than<sp/>only<sp/>result<sp/>of<sp/>offer/answer<sp/>)</highlight></codeline>
<codeline lineno="1617"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>Typically<sp/>there<sp/>can<sp/>be<sp/>inactive<sp/>streams<sp/>for<sp/>which<sp/>the<sp/>media<sp/>layer<sp/>has<sp/>no<sp/>idea<sp/>of<sp/>whether<sp/>they<sp/>are<sp/>encrypted<sp/>or<sp/>not.</highlight></codeline>
<codeline lineno="1618"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;media_encryption)<sp/>{</highlight></codeline>
<codeline lineno="1620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba9f05e9f7fbb66350bfa788e2aa37c25f" kindref="member">SephoneMediaEncryptionZRTP</ref>:</highlight></codeline>
<codeline lineno="1621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sephone_call_all_streams_encrypted(call)<sp/>&amp;&amp;<sp/>sephone_call_get_authentication_token(call))<sp/>{</highlight></codeline>
<codeline lineno="1622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;media_encryption=<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba9f05e9f7fbb66350bfa788e2aa37c25f" kindref="member">SephoneMediaEncryptionZRTP</ref>;</highlight></codeline>
<codeline lineno="1623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;media_encryption=<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba04d462c1944b5e5d4dfed2154751df25" kindref="member">SephoneMediaEncryptionNone</ref>;</highlight></codeline>
<codeline lineno="1625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba05791a117352a31299e65410334a3f91" kindref="member">SephoneMediaEncryptionDTLS</ref>:</highlight></codeline>
<codeline lineno="1628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba3e6e0aa653408fda1d63962ebbc0e351" kindref="member">SephoneMediaEncryptionSRTP</ref>:</highlight></codeline>
<codeline lineno="1629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sephone_call_get_n_active_streams(call)==0<sp/>||<sp/>sephone_call_all_streams_encrypted(call))<sp/>{</highlight></codeline>
<codeline lineno="1630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;media_encryption<sp/>=<sp/>call-&gt;params-&gt;media_encryption;</highlight></codeline>
<codeline lineno="1631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;media_encryption=<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba04d462c1944b5e5d4dfed2154751df25" kindref="member">SephoneMediaEncryptionNone</ref>;</highlight></codeline>
<codeline lineno="1633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba04d462c1944b5e5d4dfed2154751df25" kindref="member">SephoneMediaEncryptionNone</ref>:</highlight></codeline>
<codeline lineno="1636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;media_encryption=<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba04d462c1944b5e5d4dfed2154751df25" kindref="member">SephoneMediaEncryptionNone</ref>;</highlight></codeline>
<codeline lineno="1637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1639"><highlight class="normal"></highlight></codeline>
<codeline lineno="1640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;avpf_enabled<sp/>=<sp/>sephone_call_all_streams_avpf_enabled(call);</highlight></codeline>
<codeline lineno="1641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;current_params-&gt;avpf_enabled<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="1642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;avpf_rr_interval<sp/>=<sp/>sephone_call_get_avpf_rr_interval(call);</highlight></codeline>
<codeline lineno="1643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;avpf_rr_interval<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md){</highlight></codeline>
<codeline lineno="1647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalStreamDescription<sp/>*sd=sal_media_description_find_best_stream(md,SalAudio);</highlight></codeline>
<codeline lineno="1648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;audio_dir=sd<sp/>?<sp/>media_direction_from_sal_stream_dir(sd-&gt;dir)<sp/>:<sp/>SephoneMediaDirectionInactive;</highlight></codeline>
<codeline lineno="1649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sd=sal_media_description_find_best_stream(md,SalVideo);</highlight></codeline>
<codeline lineno="1650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;video_dir=sd<sp/>?<sp/>media_direction_from_sal_stream_dir(sd-&gt;dir)<sp/>:<sp/>SephoneMediaDirectionInactive;</highlight></codeline>
<codeline lineno="1651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1652"><highlight class="normal"></highlight></codeline>
<codeline lineno="1653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;current_params;</highlight></codeline>
<codeline lineno="1654"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1655"><highlight class="normal"></highlight></codeline>
<codeline lineno="1662"><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*<sp/><ref refid="group__call__control_1gaea5a52a499338f37b62061f081d533c4" kindref="member">sephone_call_get_remote_params</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;op){</highlight></codeline>
<codeline lineno="1664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*cp;</highlight></codeline>
<codeline lineno="1665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*md;</highlight></codeline>
<codeline lineno="1666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;remote_params<sp/>!=<sp/>NULL)<sp/><ref refid="group__call__control_1gae7c8fa8ba8eee61e979e87727004457d" kindref="member">sephone_call_params_unref</ref>(call-&gt;remote_params);</highlight></codeline>
<codeline lineno="1667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cp<sp/>=<sp/>call-&gt;remote_params<sp/>=<sp/>sephone_call_params_new();</highlight></codeline>
<codeline lineno="1668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>md=sal_call_get_remote_media_description(call-&gt;op);</highlight></codeline>
<codeline lineno="1669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md)<sp/>{</highlight></codeline>
<codeline lineno="1670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalStreamDescription<sp/>*sd;</highlight></codeline>
<codeline lineno="1671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="1672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nb_audio_streams<sp/>=<sp/>sal_media_description_nb_active_streams_of_type(md,<sp/>SalAudio);</highlight></codeline>
<codeline lineno="1673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nb_video_streams<sp/>=<sp/>sal_media_description_nb_active_streams_of_type(md,<sp/>SalVideo);</highlight></codeline>
<codeline lineno="1674"><highlight class="normal"></highlight></codeline>
<codeline lineno="1675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>nb_video_streams;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="1676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sd<sp/>=<sp/>sal_media_description_get_active_stream_of_type(md,<sp/>SalVideo,<sp/>i);</highlight></codeline>
<codeline lineno="1677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_stream_description_active(sd)<sp/>==<sp/>TRUE)<sp/>cp-&gt;has_video<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="1678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_stream_description_has_srtp(sd)<sp/>==<sp/>TRUE)<sp/>cp-&gt;media_encryption<sp/>=<sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba3e6e0aa653408fda1d63962ebbc0e351" kindref="member">SephoneMediaEncryptionSRTP</ref>;</highlight></codeline>
<codeline lineno="1679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>nb_audio_streams;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="1681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sd<sp/>=<sp/>sal_media_description_get_active_stream_of_type(md,<sp/>SalAudio,<sp/>i);</highlight></codeline>
<codeline lineno="1682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_stream_description_has_srtp(sd)<sp/>==<sp/>TRUE)<sp/>cp-&gt;media_encryption<sp/>=<sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba3e6e0aa653408fda1d63962ebbc0e351" kindref="member">SephoneMediaEncryptionSRTP</ref>;</highlight></codeline>
<codeline lineno="1683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!cp-&gt;has_video){</highlight></codeline>
<codeline lineno="1685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;bandwidth&gt;0<sp/>&amp;&amp;<sp/>md-&gt;bandwidth&lt;=sephone_core_get_edge_bw(call-&gt;core)){</highlight></codeline>
<codeline lineno="1686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cp-&gt;low_bandwidth=TRUE;</highlight></codeline>
<codeline lineno="1687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;name[0]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/><ref refid="group__call__control_1ga311c5a9fdda1e6bcceb2365e72cc92a8" kindref="member">sephone_call_params_set_session_name</ref>(cp,md-&gt;name);</highlight></codeline>
<codeline lineno="1690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cp-&gt;custom_headers=sal_custom_header_clone((SalCustomHeader*)sal_op_get_recv_custom_header(call-&gt;op));</highlight></codeline>
<codeline lineno="1692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>cp;</highlight></codeline>
<codeline lineno="1693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="1695"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1696"><highlight class="normal"></highlight></codeline>
<codeline lineno="1701"><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*<sp/><ref refid="group__call__control_1ga66cefc222900f62e99760c645cd3c981" kindref="member">sephone_call_get_remote_address</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;dir==<ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4a0051dbbd4dd65b7d2a6acc96b334878c" kindref="member">SephoneCallIncoming</ref><sp/>?<sp/>call-&gt;log-&gt;from<sp/>:<sp/>call-&gt;log-&gt;to;</highlight></codeline>
<codeline lineno="1703"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1704"><highlight class="normal"></highlight></codeline>
<codeline lineno="1710"><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="group__call__control_1gaf2510ee219d96ab8c195c913f1ad7d71" kindref="member">sephone_call_get_remote_address_as_string</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="group__sephone__address_1gaaaff8fab60951d670b48afe2ea015e5f" kindref="member">sephone_address_as_string</ref>(<ref refid="group__call__control_1ga66cefc222900f62e99760c645cd3c981" kindref="member">sephone_call_get_remote_address</ref>(call));</highlight></codeline>
<codeline lineno="1712"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1713"><highlight class="normal"></highlight></codeline>
<codeline lineno="1717"><highlight class="normal"><ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref><sp/><ref refid="group__call__control_1gaac1aaba397249d9694e4b0479821408a" kindref="member">sephone_call_get_state</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;state;</highlight></codeline>
<codeline lineno="1719"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1720"><highlight class="normal"></highlight></codeline>
<codeline lineno="1724"><highlight class="normal"><ref refid="group__misc_1ga68a1eac99c3622808ca47ec379951ff0" kindref="member">SephoneReason</ref><sp/><ref refid="group__call__control_1ga05a9a4af07d6eb0d4c2f5467df42557c" kindref="member">sephone_call_get_reason</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="group__misc_1ga0de3d7db0b3a1305298d5c39f33270c1" kindref="member">sephone_error_info_get_reason</ref>(<ref refid="group__call__control_1ga6eecdf1838abb2e204512e5c54eb2a56" kindref="member">sephone_call_get_error_info</ref>(call));</highlight></codeline>
<codeline lineno="1726"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1727"><highlight class="normal"></highlight></codeline>
<codeline lineno="1731"><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__misc_1ga5b61cd0e899fd19430169cb6247b81da" kindref="member">SephoneErrorInfo</ref><sp/>*<ref refid="group__call__control_1ga6eecdf1838abb2e204512e5c54eb2a56" kindref="member">sephone_call_get_error_info</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;non_op_error.reason!=SalReasonNone){</highlight></codeline>
<codeline lineno="1733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__misc_1ga5b61cd0e899fd19430169cb6247b81da" kindref="member">SephoneErrorInfo</ref>*)&amp;call-&gt;non_op_error;</highlight></codeline>
<codeline lineno="1734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>sephone_error_info_from_sal_op(call-&gt;op);</highlight></codeline>
<codeline lineno="1735"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1736"><highlight class="normal"></highlight></codeline>
<codeline lineno="1743"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*<ref refid="group__call__control_1gada54acb7429f17afed544dc14d740202" kindref="member">sephone_call_get_user_data</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)</highlight></codeline>
<codeline lineno="1744"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;user_data;</highlight></codeline>
<codeline lineno="1746"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1747"><highlight class="normal"></highlight></codeline>
<codeline lineno="1755"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1ga38326923bc80ba8fb0403b3b00dd105a" kindref="member">sephone_call_set_user_data</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*user_pointer)</highlight></codeline>
<codeline lineno="1756"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;user_data<sp/>=<sp/>user_pointer;</highlight></codeline>
<codeline lineno="1758"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1759"><highlight class="normal"></highlight></codeline>
<codeline lineno="1763"><highlight class="normal"><ref refid="group__call__logs_1ga971dacd835550830e6ced30185f11c46" kindref="member">SephoneCallLog</ref><sp/>*<ref refid="group__call__control_1ga6ebbc0a3f76e768276a693bf759a9c4f" kindref="member">sephone_call_get_call_log</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;log;</highlight></codeline>
<codeline lineno="1765"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1766"><highlight class="normal"></highlight></codeline>
<codeline lineno="1770"><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="group__call__control_1ga318b87ed813b31f7559e07837b202f83" kindref="member">sephone_call_get_refer_to</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;refer_to;</highlight></codeline>
<codeline lineno="1772"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1773"><highlight class="normal"></highlight></codeline>
<codeline lineno="1778"><highlight class="normal"><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*<ref refid="group__call__control_1ga3c2b196bf068e3dbd90a19e8a43ba3b0" kindref="member">sephone_call_get_transferer_call</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;referer;</highlight></codeline>
<codeline lineno="1780"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1781"><highlight class="normal"></highlight></codeline>
<codeline lineno="1785"><highlight class="normal"><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*<ref refid="group__call__control_1ga877535080193a1f3645075acf93ad579" kindref="member">sephone_call_get_transfer_target_call</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;transfer_target;</highlight></codeline>
<codeline lineno="1787"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1788"><highlight class="normal"></highlight></codeline>
<codeline lineno="1792"><highlight class="normal"><ref refid="group__call__logs_1ga4159f13b5c527bfc44d62e37d5ac3959" kindref="member">SephoneCallDir</ref><sp/><ref refid="group__call__control_1ga84b90d3b5f2d7d3a8ef31475d4ab266e" kindref="member">sephone_call_get_dir</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;log-&gt;dir;</highlight></codeline>
<codeline lineno="1794"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1795"><highlight class="normal"></highlight></codeline>
<codeline lineno="1799"><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="group__call__control_1ga8af0365acbad2ebec8ba21e0aefd9cbf" kindref="member">sephone_call_get_remote_user_agent</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;op){</highlight></codeline>
<codeline lineno="1801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>sal_op_get_remote_ua<sp/>(call-&gt;op);</highlight></codeline>
<codeline lineno="1802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="1804"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1805"><highlight class="normal"></highlight></codeline>
<codeline lineno="1809"><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="group__call__control_1gafb536f72a9e414b0856521d19e2a8f31" kindref="member">sephone_call_get_remote_contact</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref>*<sp/>lcp<sp/>=<sp/><ref refid="group__call__control_1gaea5a52a499338f37b62061f081d533c4" kindref="member">sephone_call_get_remote_params</ref>(call);</highlight></codeline>
<codeline lineno="1811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>lcp<sp/>){</highlight></codeline>
<codeline lineno="1812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we&apos;re<sp/>not<sp/>using<sp/>sal_op_get_remote_contact()<sp/>here<sp/>because<sp/>the<sp/>returned<sp/>value<sp/>is<sp/>stripped<sp/>from</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>params<sp/>that<sp/>we<sp/>need,<sp/>like<sp/>the<sp/>instanceid.<sp/>Getting<sp/>it<sp/>from<sp/>the<sp/>headers<sp/>will<sp/>make<sp/>sure<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>get<sp/>everything</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gab3416a4e3f395ca0ceca05e0da54e7e0" kindref="member">sephone_call_params_get_custom_header</ref>(lcp,<sp/></highlight><highlight class="stringliteral">&quot;Contact&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="1818"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1819"><highlight class="normal"></highlight></codeline>
<codeline lineno="1820"><highlight class="normal"></highlight></codeline>
<codeline lineno="1829"><highlight class="normal">bool_t<sp/><ref refid="group__call__control_1ga31dcbe25e78d99e2c54b6eafca0afebc" kindref="member">sephone_call_has_transfer_pending</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;refer_pending;</highlight></codeline>
<codeline lineno="1831"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1832"><highlight class="normal"></highlight></codeline>
<codeline lineno="1836"><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1ga9fe28bbe62f3a7bab33b500d5171e343" kindref="member">sephone_call_get_duration</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;log-&gt;connected_date_time==0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>time(NULL)-call-&gt;log-&gt;connected_date_time;</highlight></codeline>
<codeline lineno="1839"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1840"><highlight class="normal"></highlight></codeline>
<codeline lineno="1847"><highlight class="normal"><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*<ref refid="group__call__control_1ga2b5ec62f4275d908d7e789d97e4aa11e" kindref="member">sephone_call_get_replaced_call</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalOp<sp/>*op=sal_call_get_replaces(call-&gt;op);</highlight></codeline>
<codeline lineno="1849"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(op){</highlight></codeline>
<codeline lineno="1850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>*)sal_op_get_user_pointer(op);</highlight></codeline>
<codeline lineno="1851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="1853"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1854"><highlight class="normal"></highlight></codeline>
<codeline lineno="1858"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1ga089f70019e298e9d2e64946d3fec53ab" kindref="member">sephone_call_enable_camera</ref><sp/>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>enable){</highlight></codeline>
<codeline lineno="1859"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;camera_enabled=enable;</highlight></codeline>
<codeline lineno="1861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((call-&gt;state==<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref><sp/>||<sp/>call-&gt;state==<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bac9f834703e7fc0a5bec2c86d18f56e1e" kindref="member">SephoneCallOutgoingEarlyMedia</ref><sp/>||<sp/>call-&gt;state==<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba83ca7112a1058f9a7bfd8a59c5b22e74" kindref="member">SephoneCallIncomingEarlyMedia</ref>)</highlight></codeline>
<codeline lineno="1862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>call-&gt;videostream!=NULL<sp/>&amp;&amp;<sp/>video_stream_started(call-&gt;videostream)<sp/>){</highlight></codeline>
<codeline lineno="1863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(video_stream_get_camera(call-&gt;videostream)<sp/>!=<sp/>sephone_call_get_video_device(call))<sp/>{</highlight></codeline>
<codeline lineno="1864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*cur_cam,<sp/>*new_cam;</highlight></codeline>
<codeline lineno="1865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cur_cam<sp/>=<sp/>video_stream_get_camera(call-&gt;videostream)<sp/>?<sp/>ms_web_cam_get_name(video_stream_get_camera(call-&gt;videostream))<sp/>:<sp/></highlight><highlight class="stringliteral">&quot;NULL&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_cam<sp/>=<sp/>sephone_call_get_video_device(call)<sp/>?<sp/>ms_web_cam_get_name(sephone_call_get_video_device(call))<sp/>:<sp/></highlight><highlight class="stringliteral">&quot;NULL&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Switching<sp/>video<sp/>cam<sp/>from<sp/>[%s]<sp/>to<sp/>[%s]<sp/>on<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal"><sp/>,<sp/>cur_cam,<sp/>new_cam,<sp/>call);</highlight></codeline>
<codeline lineno="1868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_change_camera(call-&gt;videostream,<sp/>sephone_call_get_video_device(call));</highlight></codeline>
<codeline lineno="1869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1871"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1872"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1873"><highlight class="normal"></highlight></codeline>
<codeline lineno="1877"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1ga9aee48c0a7d7c5212f9bcc4f42594340" kindref="member">sephone_call_send_vfu_request</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="1878"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*current_params<sp/>=<sp/><ref refid="group__call__control_1ga3440e61504e058274ecc74dd435938e4" kindref="member">sephone_call_get_current_params</ref>(call);</highlight></codeline>
<codeline lineno="1880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(current_params-&gt;avpf_enabled<sp/>&amp;&amp;<sp/>call-&gt;videostream<sp/>&amp;&amp;<sp/>media_stream_get_state((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted)<sp/>{</highlight></codeline>
<codeline lineno="1881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Request<sp/>Full<sp/>Intra<sp/>Request<sp/>on<sp/>call<sp/>[%p]&quot;</highlight><highlight class="normal">,<sp/>call);</highlight></codeline>
<codeline lineno="1882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_send_fir(call-&gt;videostream);</highlight></codeline>
<codeline lineno="1883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;core-&gt;sip_conf.vfu_with_info)<sp/>{</highlight></codeline>
<codeline lineno="1884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref><sp/>==<sp/><ref refid="group__call__control_1gaac1aaba397249d9694e4b0479821408a" kindref="member">sephone_call_get_state</ref>(call))</highlight></codeline>
<codeline lineno="1885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_call_send_vfu_request(call-&gt;op);</highlight></codeline>
<codeline lineno="1886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;vfu<sp/>request<sp/>using<sp/>sip<sp/>disabled<sp/>from<sp/>config<sp/>[sip,vfu_with_info]&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1889"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1890"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1891"><highlight class="normal"></highlight></codeline>
<codeline lineno="1892"><highlight class="normal"></highlight></codeline>
<codeline lineno="1900"><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1ga411c9519d37f35171e3db9a19a28b7df" kindref="member">sephone_call_take_video_snapshot</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*file){</highlight></codeline>
<codeline lineno="1901"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream!=NULL<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;jpegwriter!=NULL){</highlight></codeline>
<codeline lineno="1903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ms_filter_call_method(call-&gt;videostream-&gt;jpegwriter,MS_JPEG_WRITER_TAKE_SNAPSHOT,(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">*)file);</highlight></codeline>
<codeline lineno="1904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Cannot<sp/>take<sp/>snapshot:<sp/>no<sp/>currently<sp/>running<sp/>video<sp/>stream<sp/>on<sp/>this<sp/>call.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1906"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1908"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1909"><highlight class="normal"></highlight></codeline>
<codeline lineno="1917"><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1ga7343e80448f9d7f576dd4bb6c7c1b70e" kindref="member">sephone_call_take_preview_snapshot</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*file){</highlight></codeline>
<codeline lineno="1918"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream!=NULL<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;local_jpegwriter!=NULL){</highlight></codeline>
<codeline lineno="1920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ms_filter_call_method(call-&gt;videostream-&gt;local_jpegwriter,MS_JPEG_WRITER_TAKE_SNAPSHOT,(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">*)file);</highlight></codeline>
<codeline lineno="1921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Cannot<sp/>take<sp/>local<sp/>snapshot:<sp/>no<sp/>currently<sp/>running<sp/>video<sp/>stream<sp/>on<sp/>this<sp/>call.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1924"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1926"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1927"><highlight class="normal"></highlight></codeline>
<codeline lineno="1931"><highlight class="normal">bool_t<sp/><ref refid="group__call__control_1gaca73b03ea492af18f18bdfd1c9d32c9b" kindref="member">sephone_call_camera_enabled</ref><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="1932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;camera_enabled;</highlight></codeline>
<codeline lineno="1933"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1934"><highlight class="normal"></highlight></codeline>
<codeline lineno="1935"><highlight class="normal"></highlight></codeline>
<codeline lineno="1940"><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/><ref refid="group__call__control_1ga3f960bc57f08e85f611ccf4c9f232de5" kindref="member">sephone_privacy_to_string</ref>(<ref refid="group__call__control_1ga130b3ffd1280230f30735e4ffc218706" kindref="member">SephonePrivacy</ref><sp/>privacy)<sp/>{</highlight></codeline>
<codeline lineno="1941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(privacy)<sp/>{</highlight></codeline>
<codeline lineno="1942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga38f04c02ef42854ee9f3d34206f5d5cda885f3c27efe7c769b5b056fc82f82f12" kindref="member">SephonePrivacyDefault</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephonePrivacyDefault&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga38f04c02ef42854ee9f3d34206f5d5cda7f4af0a5269dfb78df789a16a89be3ce" kindref="member">SephonePrivacyUser</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephonePrivacyUser&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga38f04c02ef42854ee9f3d34206f5d5cda841383cfad599208a5e7bd0a14628162" kindref="member">SephonePrivacyHeader</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephonePrivacyHeader&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga38f04c02ef42854ee9f3d34206f5d5cda83133997dfd2fdbc273ba36154affb0f" kindref="member">SephonePrivacySession</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephonePrivacySession&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga38f04c02ef42854ee9f3d34206f5d5cdaef250be616630badcb07847f83337423" kindref="member">SephonePrivacyId</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephonePrivacyId&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga38f04c02ef42854ee9f3d34206f5d5cdacbe9112d3fe524c32d77673a103d76f6" kindref="member">SephonePrivacyNone</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephonePrivacyNone&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga38f04c02ef42854ee9f3d34206f5d5cda660a1f732a77fc3264ff74b893d70dd8" kindref="member">SephonePrivacyCritical</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;SephonePrivacyCritical&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;Unknown<sp/>privacy<sp/>mode&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1951"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1952"><highlight class="normal"></highlight></codeline>
<codeline lineno="1957"><highlight class="preprocessor">#ifdef<sp/>TEST_EXT_RENDERER</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1958"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>rendercb(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*data,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSPicture<sp/>*local,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSPicture<sp/>*remote){</highlight></codeline>
<codeline lineno="1959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;rendercb,<sp/>local<sp/>buffer=%p,<sp/>remote<sp/>buffer=%p&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>local<sp/>?<sp/>local-&gt;planes[0]<sp/>:<sp/>NULL,<sp/>remote?<sp/>remote-&gt;planes[0]<sp/>:<sp/>NULL);</highlight></codeline>
<codeline lineno="1961"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1962"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1963"><highlight class="normal"></highlight></codeline>
<codeline lineno="1964"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1965"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>video_stream_update_bitrate_limit(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>*<sp/>call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bitrate)<sp/>{</highlight></codeline>
<codeline lineno="1966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref>*<sp/>lc<sp/>=<sp/>call-&gt;core;</highlight></codeline>
<codeline lineno="1967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>VideoStream*<sp/>stream<sp/>=<sp/>call-&gt;videostream;</highlight></codeline>
<codeline lineno="1968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSVideoConfiguration<sp/>*vconf_list<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSVideoConfiguration<sp/>vconf;</highlight></codeline>
<codeline lineno="1970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSVideoSize<sp/>vsize<sp/>=<sp/>{0,0};</highlight></codeline>
<codeline lineno="1971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>widely<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="1972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>aspect;</highlight></codeline>
<codeline lineno="1973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadType<sp/>*pt;</highlight></codeline>
<codeline lineno="1974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpProfile<sp/>*profile;</highlight></codeline>
<codeline lineno="1975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>payload;</highlight></codeline>
<codeline lineno="1976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="1977"><highlight class="normal"></highlight></codeline>
<codeline lineno="1978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stream<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="1979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(stream-&gt;ms.encoder,<sp/>MS_VIDEO_ENCODER_GET_CONFIGURATION_LIST,<sp/>&amp;vconf_list);</highlight></codeline>
<codeline lineno="1982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vconf_list<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="1983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(stream-&gt;ms.encoder,<sp/>MS_FILTER_GET_VIDEO_SIZE,<sp/>&amp;vsize);</highlight></codeline>
<codeline lineno="1987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vsize.width<sp/>&lt;<sp/>vsize.height)<sp/>{</highlight></codeline>
<codeline lineno="1988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>aspect=(vsize.width*1.0)/vsize.height;</highlight></codeline>
<codeline lineno="1989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>aspect=(vsize.height*1.0)/vsize.width;</highlight></codeline>
<codeline lineno="1991"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1992"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(aspect<sp/>&lt;<sp/>0.6)<sp/>{</highlight></codeline>
<codeline lineno="1993"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>widely<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="1994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1995"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vconf<sp/>=<sp/>ms_video_find_best_configuration_for_bitrate_aspect(vconf_list,<sp/>bitrate,<sp/>widely);</highlight></codeline>
<codeline lineno="1997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(vconf.vsize.width&gt;vconf.vsize.height)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vsize.width<sp/>&lt;<sp/>vsize.height)<sp/>{</highlight></codeline>
<codeline lineno="1999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>t<sp/>=<sp/>vsize.width;</highlight></codeline>
<codeline lineno="2000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vsize.width<sp/>=<sp/>vsize.height;</highlight></codeline>
<codeline lineno="2001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vsize.height<sp/>=<sp/>t;</highlight></codeline>
<codeline lineno="2002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vconf.vsize.width<sp/>==<sp/>vsize.width)<sp/>{</highlight></codeline>
<codeline lineno="2005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2007"><highlight class="normal"></highlight></codeline>
<codeline lineno="2008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_vsize_decreased(stream);</highlight></codeline>
<codeline lineno="2009"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//@<sp/>xr<sp/>2016/4/30<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__media__parameters_1gac8e1e946a21f0010ea976c9c19afbb82" kindref="member">sephone_core_set_preferred_video_size</ref>(lc,<sp/>vconf.vsize);</highlight></codeline>
<codeline lineno="2012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>profile<sp/>=<sp/>rtp_session_get_profile(stream-&gt;ms.sessions.rtp_session);</highlight></codeline>
<codeline lineno="2013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload<sp/>=<sp/>rtp_session_get_send_payload_type(stream-&gt;ms.sessions.rtp_session);</highlight></codeline>
<codeline lineno="2014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/>rtp_profile_get_payload(profile,<sp/>payload);</highlight></codeline>
<codeline lineno="2015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt-&gt;normal_bitrate<sp/>=<sp/>bitrate;<sp/></highlight><highlight class="comment">//<sp/>pt <sp/><sp/><sp/>ms_message(&quot;Switch<sp/>vsize<sp/>of<sp/>video<sp/>encoder<sp/>to<sp/>%dx%d<sp/>at<sp/>%i<sp/>bits/s<sp/>for<sp/>stream<sp/>[%p]&quot;,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vconf.vsize.width,<sp/>vconf.vsize.height,<sp/>bitrate,<sp/>stream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_call(lc,<sp/>call,<sp/>NULL);
}

static<sp/>void<sp/>video_stream_event_cb(void<sp/>*user_pointer,<sp/>const<sp/>MSFilter<sp/>*f,<sp/>const<sp/>unsigned<sp/>int<sp/>event_id,<sp/>const<sp/>void<sp/>*args){
<sp/><sp/>SephoneCall*<sp/>call<sp/>=<sp/>(SephoneCall*)<sp/>user_pointer;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SephoneCore*<sp/>lc<sp/>=<sp/>call-&gt;core;
<sp/><sp/>switch<sp/>(event_id)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_VIDEO_DECODER_DECODING_ERRORS:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;MS_VIDEO_DECODER_DECODING_ERRORS&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//@<sp/>xr<sp/>2016/4/26<sp/>51
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>(video_stream_is_decoding_error_to_be_reported(call-&gt;videostream,<sp/>1000)<sp/>==<sp/>TRUE))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_decoding_error_reported(call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_send_vfu_request(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;state<sp/>==<sp/>SephoneCallStreamsRunning)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_state_changed(lc,<sp/>call,<sp/>SephoneCallVideoDecodingError,<sp/>&quot;Decoding<sp/>error&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_VIDEO_DECODER_RECOVERED_FROM_ERRORS:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;MS_VIDEO_DECODER_RECOVERED_FROM_ERRORS&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_decoding_error_recovered(call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;state<sp/>==<sp/>SephoneCallStreamsRunning)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_state_changed(lc,<sp/>call,<sp/>SephoneCallVideoDecodingError,<sp/>&quot;Recovered<sp/>from<sp/>error&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_VIDEO_DECODER_FIRST_IMAGE_DECODED:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;First<sp/>video<sp/>frame<sp/>decoded<sp/>successfully&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;nextVideoFrameDecoded._func<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;nextVideoFrameDecoded._func(call,<sp/>call-&gt;nextVideoFrameDecoded._user_data);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;state<sp/>==<sp/>SephoneCallStreamsRunning)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_state_changed(lc,<sp/>call,<sp/>SephoneCallFirstImageDecoded,<sp/>&quot;First<sp/>video<sp/>frame<sp/>decoded&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_VIDEO_DECODER_SEND_PLI:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_VIDEO_DECODER_SEND_SLI:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_VIDEO_DECODER_SEND_RPSI:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>Handled<sp/>internally<sp/>by<sp/>mediastreamer2.<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_VIDEO_ENCODER_NOTIFY_DECREASE_VSIZE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;MS_VIDEO_ENCODER_NOTIFY_DECREASE_VSIZE&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>new_bw<sp/>=<sp/>*((int<sp/>*)args);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>auto_decide_vsize<sp/>=<sp/>sp_config_get_int(lc-&gt;config,<sp/>&quot;video&quot;,<sp/>&quot;auto_decide_vsize&quot;,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(auto_decide_vsize<sp/>&amp;&amp;<sp/>(video_stream_is_vsize_decreased(call-&gt;videostream,<sp/>5000)<sp/>==<sp/>TRUE))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_update_bitrate_limit(call,<sp/>new_bw);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>default:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;Unhandled<sp/>event<sp/>%i&quot;,<sp/>event_id);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
}
#endif

void<sp/>sephone_call_set_next_video_frame_decoded_callback(SephoneCall<sp/>*call,<sp/>SephoneCallCbFunc<sp/>cb,<sp/>void*<sp/>user_data)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;nextVideoFrameDecoded._func<sp/>=<sp/>cb;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;nextVideoFrameDecoded._user_data<sp/>=<sp/>user_data;
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;ms.decoder)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method_noarg(call-&gt;videostream-&gt;ms.decoder,<sp/>MS_VIDEO_DECODER_RESET_FIRST_IMAGE_NOTIFICATION);
#endif
}

static<sp/>void<sp/>port_config_set_random_choosed(SephoneCall<sp/>*call,<sp/>int<sp/>stream_index,<sp/>RtpSession<sp/>*session){
<sp/><sp/><sp/>call-&gt;media_ports[stream_index].rtp_port=rtp_session_get_local_port(session);
<sp/><sp/>call-&gt;media_ports[stream_index].rtcp_port=rtp_session_get_local_rtcp_port(session);
}

void<sp/>_sephone_call_prepare_ice_for_stream(SephoneCall<sp/>*call,<sp/>int<sp/>stream_index,<sp/>bool_t<sp/>create_checklist){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MediaStream<sp/>*ms=stream_index<sp/>==<sp/>0<sp/>?<sp/>(MediaStream*)call-&gt;audiostream<sp/>:<sp/>(MediaStream*)call-&gt;videostream;
<sp/>if<sp/>(/*(sephone_core_get_firewall_policy(call-&gt;core)<sp/>==<sp/>SephonePolicyUseIce)<sp/>&amp;&amp;*/<sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>IceCheckList<sp/>*cl;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_pktinfo(ms-&gt;sessions.rtp_session,<sp/>TRUE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cl=ice_session_check_list(call-&gt;ice_session,<sp/>stream_index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(cl<sp/>==<sp/>NULL<sp/>&amp;&amp;<sp/>create_checklist)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cl=ice_check_list_new();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_add_check_list(call-&gt;ice_session,<sp/>cl,<sp/>stream_index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Created<sp/>new<sp/>ICE<sp/>check<sp/>list<sp/>for<sp/>stream<sp/>%i<sp/>[%p]&quot;,stream_index,ms);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(cl){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms-&gt;ice_check_list<sp/>=<sp/>cl;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_check_list_set_rtp_session(ms-&gt;ice_check_list,<sp/>ms-&gt;sessions.rtp_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
}

int<sp/>sephone_call_prepare_ice(SephoneCall<sp/>*call,<sp/>bool_t<sp/>incoming_offer){
<sp/><sp/><sp/>SalMediaDescription<sp/>*remote<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/>bool_t<sp/>has_video=FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SephoneFirewallPolicy<sp/>fpol=sephone_core_get_firewall_policy(call-&gt;core);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();

<sp/><sp/><sp/><sp/>//@<sp/>xr<sp/>2016/12/28<sp/>upnpice
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((fpol<sp/>==<sp/>SephonePolicyUseIce<sp/>||<sp/>fpol<sp/>==<sp/>SephonePolicyUseUpnp)<sp/>&amp;&amp;<sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(incoming_offer){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remote=sal_call_get_remote_media_description(call-&gt;op);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>has_video=sephone_core_video_enabled(call-&gt;core)<sp/>&amp;&amp;<sp/>sephone_core_media_description_contains_video_stream(remote);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>has_video=call-&gt;params-&gt;has_video;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_sephone_call_prepare_ice_for_stream(call,0,TRUE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(has_video)<sp/>_sephone_call_prepare_ice_for_stream(call,1,TRUE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*start<sp/>ICE<sp/>gathering*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(incoming_offer)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_update_ice_from_remote_media_description(call,remote,FALSE);<sp/>/*this<sp/>may<sp/>delete<sp/>the<sp/>ice<sp/>session*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;ice_session<sp/>&amp;&amp;<sp/>!ice_session_candidates_gathered(call-&gt;ice_session)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream-&gt;ms.state==MSStreamInitialized)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_prepare_sound(call-&gt;audiostream,<sp/>NULL,<sp/>NULL);
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(has_video<sp/>&amp;&amp;<sp/>call-&gt;videostream<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;ms.state==MSStreamInitialized)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_prepare_video(call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
#endif
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sephone_core_gather_ice_candidates(call-&gt;core,call)&lt;0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>Ice<sp/>candidates<sp/>gathering<sp/>failed,<sp/>proceed<sp/>with<sp/>the<sp/>call<sp/>anyway.<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_delete_ice_session(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_media_streams_for_ice_gathering(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>-1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>1;/*gathering<sp/>in<sp/>progress,<sp/>wait*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0;
}

/*eventually<sp/>join<sp/>to<sp/>a<sp/>multicast<sp/>group<sp/>if<sp/>told<sp/>to<sp/>do<sp/>so*/
static<sp/>void<sp/>sephone_call_join_multicast_group(SephoneCall<sp/>*call,<sp/>int<sp/>stream_index,<sp/>MediaStream<sp/>*ms){
<sp/><sp/><sp/><sp/>if<sp/>(call-&gt;media_ports[stream_index].multicast_ip[stream_index]!=&apos;\0&apos;<sp/>&amp;&amp;<sp/>call-&gt;media_ports[stream_index].mcast_rtp_port!=0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_join_multicast_group(ms,<sp/>call-&gt;media_ports[stream_index].multicast_ip);
<sp/><sp/><sp/>}
}

void<sp/>sephone_call_init_audio_stream(SephoneCall<sp/>*call){
<sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;
<sp/><sp/><sp/><sp/>AudioStream<sp/>*audiostream;
<sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*location;
<sp/><sp/>int<sp/>dscp;
<sp/><sp/><sp/><sp/><sp/><sp/>char<sp/>rtcp_tool[128]={0};
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>char*<sp/>cname;
<sp/><sp/><sp/>ms_func();

<sp/><sp/><sp/><sp/>snprintf(rtcp_tool,sizeof(rtcp_tool)-1,&quot;%s-%s&quot;,sephone_core_get_user_agent_name(),sephone_core_get_user_agent_version());

<sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>!=<sp/>NULL)<sp/>return;
<sp/>if<sp/>(call-&gt;sessions[0].rtp_session==NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream=audiostream=audio_stream_new2(sephone_call_get_bind_ip_for_stream(call,0),
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[0].mcast_rtp_port<sp/>?<sp/>call-&gt;media_ports[0].mcast_rtp_port<sp/>:<sp/>call-&gt;media_ports[0].rtp_port,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[0].mcast_rtcp_port<sp/>?<sp/>call-&gt;media_ports[0].mcast_rtcp_port<sp/>:<sp/>call-&gt;media_ports[0].rtcp_port);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_join_multicast_group(call,<sp/>0,<sp/>&amp;audiostream-&gt;ms);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_enable_network_simulation(call-&gt;audiostream-&gt;ms.sessions.rtp_session,<sp/>&amp;lc-&gt;net_conf.netsim_params);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cname<sp/>=<sp/>sephone_address_as_string_uri_only(call-&gt;me);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_rtcp_information(call-&gt;audiostream,<sp/>cname,<sp/>rtcp_tool);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(cname);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_symmetric_rtp(audiostream-&gt;ms.sessions.rtp_session,sephone_core_symmetric_rtp_enabled(lc));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;params-&gt;media_encryption==SephoneMediaEncryptionDTLS)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSDtlsSrtpParams<sp/>params;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>char<sp/>*certificate,<sp/>*key;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;params,0,sizeof(MSDtlsSrtpParams));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>TODO<sp/>:<sp/>search<sp/>for<sp/>a<sp/>certificate<sp/>with<sp/>CNAME=sip<sp/>uri(retrieved<sp/>from<sp/>variable<sp/>me)<sp/>or<sp/>default<sp/>:<sp/>sephone-dtls-default-identity<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>This<sp/>will<sp/>parse<sp/>the<sp/>directory<sp/>to<sp/>find<sp/>a<sp/>matching<sp/>fingerprint<sp/>or<sp/>generate<sp/>it<sp/>if<sp/>not<sp/>found<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>returned<sp/>string<sp/>must<sp/>be<sp/>freed<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_certificates_chain_parse_directory(&amp;certificate,<sp/>&amp;key,<sp/>&amp;call-&gt;dtls_certificate_fingerprint,<sp/>lc-&gt;user_certificates_path,<sp/>&quot;sephone-dtls-default-identity&quot;,<sp/>SAL_CERTIFICATE_RAW_FORMAT_PEM,<sp/>TRUE,<sp/>TRUE);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(key!=<sp/>NULL<sp/>&amp;&amp;<sp/>certificate!=NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.pem_certificate<sp/>=<sp/>(char<sp/>*)certificate;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.pem_pkey<sp/>=<sp/>(char<sp/>*)key;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.role<sp/>=<sp/>MSDtlsSrtpRoleUnset;<sp/>/*<sp/>default<sp/>is<sp/>unset,<sp/>then<sp/>check<sp/>if<sp/>we<sp/>have<sp/>a<sp/>result<sp/>SalMediaDescription<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_dtls(call-&gt;audiostream,&amp;params);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(certificate);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(key);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(&quot;Unable<sp/>to<sp/>retrieve<sp/>or<sp/>generate<sp/>DTLS<sp/>certificate<sp/>and<sp/>key<sp/>-<sp/>DTLS<sp/>disabled&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>TODO<sp/>:<sp/>check<sp/>if<sp/>encryption<sp/>forced,<sp/>if<sp/>yes,<sp/>stop<sp/>call<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}else{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream=audio_stream_new_with_sessions(&amp;call-&gt;sessions[0]);
<sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>audiostream=call-&gt;audiostream;
<sp/>if<sp/>(call-&gt;media_ports[0].rtp_port==-1){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>port_config_set_random_choosed(call,0,audiostream-&gt;ms.sessions.rtp_session);
<sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>dscp=sephone_core_get_audio_dscp(lc);
<sp/><sp/>if<sp/>(dscp!=-1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_dscp(audiostream,dscp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sephone_core_echo_limiter_enabled(lc)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*type=sp_config_get_string(lc-&gt;config,&quot;sound&quot;,&quot;el_type&quot;,&quot;mic&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;echo<sp/>limiter<sp/>enabled&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(strcasecmp(type,&quot;mic&quot;)==0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(audiostream,ELControlMic);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(strcasecmp(type,&quot;full&quot;)==0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(audiostream,ELControlFull);
<sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;echo<sp/>limiter<sp/>disabled&quot;);
<sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>/*<sp/>equalizer<sp/>location<sp/>in<sp/>the<sp/>graph:<sp/>&apos;mic&apos;<sp/>=<sp/>in<sp/>input<sp/>graph,<sp/>otherwise<sp/>in<sp/>output<sp/>graph.
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Any<sp/>other<sp/>value<sp/>than<sp/>mic<sp/>will<sp/>default<sp/>to<sp/>output<sp/>graph<sp/>for<sp/>compatibility<sp/>*/
<sp/><sp/><sp/><sp/><sp/>location<sp/>=<sp/>sp_config_get_string(lc-&gt;config,&quot;sound&quot;,&quot;eq_location&quot;,&quot;hp&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audiostream-&gt;eq_loc<sp/>=<sp/>(strcasecmp(location,&quot;mic&quot;)<sp/>==<sp/>0)<sp/>?<sp/>MSEqualizerMic<sp/>:<sp/>MSEqualizerHP;
<sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Equalizer<sp/>location:<sp/>%s&quot;,<sp/>location);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_gain_control(audiostream,TRUE);
<sp/><sp/><sp/><sp/>if<sp/>(sephone_core_echo_cancellation_enabled(lc)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>len,delay,framesize;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>len=sp_config_get_int(lc-&gt;config,&quot;sound&quot;,&quot;ec_tail_len&quot;,0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>delay=sp_config_get_int(lc-&gt;config,&quot;sound&quot;,&quot;ec_delay&quot;,0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>framesize=sp_config_get_int(lc-&gt;config,&quot;sound&quot;,&quot;ec_framesize&quot;,0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_echo_canceller_params(audiostream,len,delay,framesize);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(audiostream-&gt;ec)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>char<sp/>*statestr=ms_malloc0(EC_STATE_MAX_LEN);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sp_config_read_relative_file(lc-&gt;config,<sp/>EC_STATE_STORE,<sp/>statestr,<sp/>EC_STATE_MAX_LEN)<sp/>==<sp/>0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(audiostream-&gt;ec,<sp/>MS_ECHO_CANCELLER_SET_STATE_STRING,<sp/>statestr);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(statestr);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_automatic_gain_control(audiostream,sephone_core_agc_enabled(lc));
<sp/><sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>enabled=sp_config_get_int(lc-&gt;config,&quot;sound&quot;,&quot;noisegate&quot;,0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>stream-&gt;volsend
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_noise_gate(audiostream,enabled);
<sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>audio_stream_set_features(audiostream,sephone_core_get_audio_features(lc));

<sp/><sp/><sp/>if<sp/>(lc-&gt;rtptf){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpTransport<sp/>*meta_rtp;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpTransport<sp/>*meta_rtcp;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_get_transports(audiostream-&gt;ms.sessions.rtp_session,&amp;meta_rtp,&amp;meta_rtcp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(meta_rtp_transport_get_endpoint(meta_rtp)<sp/>==<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>meta_rtp_transport_set_endpoint(meta_rtp,lc-&gt;rtptf-&gt;audio_rtp_func(lc-&gt;rtptf-&gt;audio_rtp_func_data,<sp/>call-&gt;media_ports[0].rtp_port));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(meta_rtp_transport_get_endpoint(meta_rtcp)<sp/>==<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>meta_rtp_transport_set_endpoint(meta_rtcp,lc-&gt;rtptf-&gt;audio_rtcp_func(lc-&gt;rtptf-&gt;audio_rtcp_func_data,<sp/>call-&gt;media_ports[0].rtcp_port));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream_app_evq<sp/>=<sp/>ortp_ev_queue_new();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_register_event_queue(audiostream-&gt;ms.sessions.rtp_session,call-&gt;audiostream_app_evq);

<sp/><sp/><sp/><sp/><sp/>if<sp/>(sephone_core_get_firewall_policy(lc)<sp/>==<sp/>SephonePolicyUseIce)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_sephone_call_prepare_ice_for_stream(call,0,FALSE);
<sp/><sp/><sp/><sp/>}
}

void<sp/>sephone_call_init_video_stream(SephoneCall<sp/>*call){
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;
<sp/><sp/><sp/><sp/>char*<sp/>cname;
<sp/><sp/><sp/>char<sp/>rtcp_tool[128];
<sp/><sp/><sp/>snprintf(rtcp_tool,sizeof(rtcp_tool)-1,&quot;%s-%s&quot;,sephone_core_get_user_agent_name(),sephone_core_get_user_agent_version());
<sp/><sp/><sp/><sp/><sp/><sp/>ms_func();

<sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>==<sp/>NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>video_recv_buf_size=sp_config_get_int(lc-&gt;config,&quot;video&quot;,&quot;recv_buf_size&quot;,0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>dscp=sephone_core_get_video_dscp(lc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*display_filter=sephone_core_get_video_display_filter(lc);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;sessions[1].rtp_session==NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream=video_stream_new2(sephone_call_get_bind_ip_for_stream(call,1),
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[1].mcast_rtp_port&gt;0<sp/>?<sp/><sp/>call-&gt;media_ports[1].mcast_rtp_port<sp/>:<sp/>call-&gt;media_ports[1].rtp_port,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[1].mcast_rtcp_port&gt;0<sp/>?<sp/>call-&gt;media_ports[1].mcast_rtcp_port<sp/>:<sp/>call-&gt;media_ports[1].rtcp_port);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_join_multicast_group(call,<sp/>1,<sp/>&amp;call-&gt;videostream-&gt;ms);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_enable_network_simulation(call-&gt;videostream-&gt;ms.sessions.rtp_session,<sp/>&amp;lc-&gt;net_conf.netsim_params);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cname<sp/>=<sp/>sephone_address_as_string_uri_only(call-&gt;me);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_rtcp_information(call-&gt;videostream,<sp/>cname,<sp/>rtcp_tool);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(cname);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_symmetric_rtp(call-&gt;videostream-&gt;ms.sessions.rtp_session,sephone_core_symmetric_rtp_enabled(lc));

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;params-&gt;media_encryption==SephoneMediaEncryptionDTLS)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSDtlsSrtpParams<sp/>params;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>char<sp/>*certificate,<sp/>*key;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;params,0,sizeof(MSDtlsSrtpParams));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>TODO<sp/>:<sp/>search<sp/>for<sp/>a<sp/>certificate<sp/>with<sp/>CNAME=sip<sp/>uri(retrieved<sp/>from<sp/>variable<sp/>me)<sp/>or<sp/>default<sp/>:<sp/>sephone-dtls-default-identity<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>This<sp/>will<sp/>parse<sp/>the<sp/>directory<sp/>to<sp/>find<sp/>a<sp/>matching<sp/>fingerprint<sp/>or<sp/>generate<sp/>it<sp/>if<sp/>not<sp/>found<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>returned<sp/>string<sp/>must<sp/>be<sp/>freed<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_certificates_chain_parse_directory(&amp;certificate,<sp/>&amp;key,<sp/>&amp;call-&gt;dtls_certificate_fingerprint,<sp/>lc-&gt;user_certificates_path,<sp/>&quot;sephone-dtls-default-identity&quot;,<sp/>SAL_CERTIFICATE_RAW_FORMAT_PEM,<sp/>TRUE,<sp/>TRUE);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(key!=<sp/>NULL<sp/>&amp;&amp;<sp/>certificate!=NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.pem_certificate<sp/>=<sp/>(char<sp/>*)certificate;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.pem_pkey<sp/>=<sp/>(char<sp/>*)key;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.role<sp/>=<sp/>MSDtlsSrtpRoleUnset;<sp/>/*<sp/>default<sp/>is<sp/>unset,<sp/>then<sp/>check<sp/>if<sp/>we<sp/>have<sp/>a<sp/>result<sp/>SalMediaDescription<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_dtls(call-&gt;videostream,&amp;params);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(certificate);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(key);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(&quot;Unable<sp/>to<sp/>retrieve<sp/>or<sp/>generate<sp/>DTLS<sp/>certificate<sp/>and<sp/>key<sp/>-<sp/>DTLS<sp/>disabled&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>TODO<sp/>:<sp/>check<sp/>if<sp/>encryption<sp/>forced,<sp/>if<sp/>yes,<sp/>stop<sp/>call<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream=video_stream_new_with_sessions(&amp;call-&gt;sessions[1]);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;media_ports[1].rtp_port==-1){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>port_config_set_random_choosed(call,1,call-&gt;videostream-&gt;ms.sessions.rtp_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(dscp!=-1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_dscp(call-&gt;videostream,dscp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_display_filter_auto_rotate(call-&gt;videostream,<sp/>sp_config_get_int(lc-&gt;config,&quot;video&quot;,&quot;display_filter_auto_rotate&quot;,0));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(video_recv_buf_size&gt;0)<sp/>rtp_session_set_recv_buf_size(call-&gt;videostream-&gt;ms.sessions.rtp_session,video_recv_buf_size);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(display_filter<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_display_filter_name(call-&gt;videostream,display_filter);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_event_callback(call-&gt;videostream,video_stream_event_cb,<sp/>call);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(lc-&gt;rtptf){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpTransport<sp/>*meta_rtp;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpTransport<sp/>*meta_rtcp;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_get_transports(call-&gt;videostream-&gt;ms.sessions.rtp_session,&amp;meta_rtp,&amp;meta_rtcp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(meta_rtp_transport_get_endpoint(meta_rtp)<sp/>==<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>meta_rtp_transport_set_endpoint(meta_rtp,lc-&gt;rtptf-&gt;video_rtp_func(lc-&gt;rtptf-&gt;video_rtp_func_data,<sp/>call-&gt;media_ports[1].rtp_port));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(meta_rtp_transport_get_endpoint(meta_rtcp)<sp/>==<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>meta_rtp_transport_set_endpoint(meta_rtcp,lc-&gt;rtptf-&gt;video_rtcp_func(lc-&gt;rtptf-&gt;video_rtcp_func_data,<sp/>call-&gt;media_ports[1].rtcp_port));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream_app_evq<sp/>=<sp/>ortp_ev_queue_new();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_register_event_queue(call-&gt;videostream-&gt;ms.sessions.rtp_session,call-&gt;videostream_app_evq);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sephone_core_get_firewall_policy(lc)<sp/>==<sp/>SephonePolicyUseIce)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_sephone_call_prepare_ice_for_stream(call,1,FALSE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
#ifdef<sp/>TEST_EXT_RENDERER
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_render_callback(call-&gt;videostream,rendercb,NULL);
#endif
<sp/><sp/><sp/><sp/><sp/><sp/>}
#else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream=NULL;
#endif
}

void<sp/>sephone_call_init_media_streams(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/>ms_func();
<sp/><sp/><sp/><sp/><sp/>sephone_call_init_audio_stream(call);
<sp/><sp/>sephone_call_init_video_stream(call);
}

static<sp/>void<sp/>sephone_core_umsg_received(SephoneCore<sp/>*lc,<sp/>const<sp/>char<sp/>*message){
<sp/>sephone_core_notify_umsg_received(lc,<sp/>sephone_core_get_current_call(lc),<sp/>message);
}

static<sp/>int<sp/>dtmf_tab[16]={&apos;0&apos;,&apos;1&apos;,&apos;2&apos;,&apos;3&apos;,&apos;4&apos;,&apos;5&apos;,&apos;6&apos;,&apos;7&apos;,&apos;8&apos;,&apos;9&apos;,&apos;*&apos;,&apos;#&apos;,&apos;A&apos;,&apos;B&apos;,&apos;C&apos;,&apos;D&apos;};

static<sp/>void<sp/>sephone_core_dtmf_received(SephoneCore<sp/>*lc,<sp/>int<sp/>dtmf){
<sp/><sp/><sp/>if<sp/>(dtmf&lt;0<sp/>||<sp/>dtmf&gt;15){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;Bad<sp/>dtmf<sp/>value<sp/>%i&quot;,dtmf);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_dtmf_received(lc,<sp/>sephone_core_get_current_call(lc),<sp/>dtmf_tab[dtmf]);
}

static<sp/>void<sp/>parametrize_equalizer(SephoneCore<sp/>*lc,<sp/>AudioStream<sp/>*st){
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(st-&gt;equalizer){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSFilter<sp/>*f=st-&gt;equalizer;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>enabled=sp_config_get_int(lc-&gt;config,&quot;sound&quot;,&quot;eq_active&quot;,0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*gains=sp_config_get_string(lc-&gt;config,&quot;sound&quot;,&quot;eq_gains&quot;,NULL);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_EQUALIZER_SET_ACTIVE,&amp;enabled);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(enabled){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(gains){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>bytes;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSEqualizerGain<sp/>g;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sscanf(gains,&quot;%f:%f:%f<sp/>%n&quot;,&amp;g.frequency,&amp;g.gain,&amp;g.width,&amp;bytes)==3){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Read<sp/>equalizer<sp/>gains:<sp/>%f(~%f)<sp/>--&gt;<sp/>%f&quot;,g.frequency,g.width,g.gain);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_EQUALIZER_SET_GAIN,&amp;g);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gains+=bytes;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}while(1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
}

void<sp/>set_mic_gain_db(AudioStream<sp/>*st,<sp/>float<sp/>gain){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_mic_gain_db(st,<sp/>gain);
}

void<sp/>set_playback_gain_db(AudioStream<sp/>*st,<sp/>float<sp/>gain){
<sp/><sp/><sp/><sp/><sp/>if<sp/>(st-&gt;volrecv){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,MS_VOLUME_SET_DB_GAIN,&amp;gain);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>ms_warning(&quot;Could<sp/>not<sp/>apply<sp/>playback<sp/>gain:<sp/>gain<sp/>control<sp/>wasn&apos;t<sp/>activated.&quot;);
}

/*This<sp/>function<sp/>is<sp/>not<sp/>static<sp/>because<sp/>used<sp/>internally<sp/>in<sp/>linphone-daemon<sp/>project*/
void<sp/>_post_configure_audio_stream(AudioStream<sp/>*st,<sp/>SephoneCore<sp/>*lc,<sp/>bool_t<sp/>muted){
<sp/><sp/><sp/><sp/>float<sp/>mic_gain=lc-&gt;sound_conf.soft_mic_lev;
<sp/><sp/><sp/><sp/>float<sp/>thres<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>recv_gain;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>ng_thres=sp_config_get_float(lc-&gt;config,&quot;sound&quot;,&quot;ng_thres&quot;,0);<sp/>//<sp/>0.05
<sp/>float<sp/>ng_floorgain=sp_config_get_float(lc-&gt;config,&quot;sound&quot;,&quot;ng_floorgain&quot;,0.005);<sp/>//<sp/>0
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>mic_ng_thres;
<sp/><sp/><sp/><sp/>int<sp/>ng_sustain;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>dc_removal;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>speed;
<sp/><sp/><sp/>float<sp/>downspeed;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>force;
<sp/><sp/><sp/>int<sp/>sustain;
<sp/><sp/><sp/>float<sp/>transmit_thres;
<sp/><sp/>MSFilter<sp/>*f=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>floorgain;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>spk_agc;
<sp/><sp/><sp/>ms_func();

<sp/><sp/><sp/><sp/>if<sp/>(!muted)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_mic_gain_db(st,mic_gain);
<sp/><sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_mic_gain(st,0);

<sp/><sp/><sp/><sp/><sp/><sp/>recv_gain<sp/>=<sp/>lc-&gt;sound_conf.soft_play_lev;
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(recv_gain<sp/>!=<sp/>0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_playback_gain_db(st,recv_gain);
<sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>if<sp/>(st-&gt;volsend){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Configure<sp/>volume<sp/>[%p]<sp/>volsend<sp/>echolimiter&quot;,<sp/>st-&gt;volsend-&gt;data);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mic_ng_thres=sp_config_get_float(lc-&gt;config,&quot;sound&quot;,&quot;mic_ng_thres&quot;,-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ng_sustain=sp_config_get_int(lc-&gt;config,&quot;sound&quot;,&quot;ng_sustain&quot;,-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dc_removal=sp_config_get_int(lc-&gt;config,&quot;sound&quot;,&quot;dc_removal&quot;,0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>speed=sp_config_get_float(lc-&gt;config,&quot;sound&quot;,&quot;el_speed&quot;,-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>downspeed=sp_config_get_float(lc-&gt;config,&quot;sound&quot;,&quot;el_downspeed&quot;,-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>force=sp_config_get_float(lc-&gt;config,&quot;sound&quot;,&quot;el_force&quot;,-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>thres=sp_config_get_float(lc-&gt;config,&quot;sound&quot;,&quot;el_thres&quot;,-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sustain=sp_config_get_int(lc-&gt;config,&quot;sound&quot;,&quot;el_sustain&quot;,-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transmit_thres=sp_config_get_float(lc-&gt;config,&quot;sound&quot;,&quot;el_transmit_thres&quot;,-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f=st-&gt;volsend;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(speed&lt;0)<sp/>speed=0.4;<sp/>//<sp/>0.03
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(downspeed&lt;0)<sp/>downspeed=0.4;<sp/>//<sp/>0.05
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(force&lt;0)<sp/>force=4.0;<sp/>//<sp/>25
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_REMOVE_DC,&amp;dc_removal);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_SPEED,&amp;speed);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_DOWNSPEED,&amp;downspeed);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_FORCE,&amp;force);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(thres!=-1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_THRESHOLD,&amp;thres);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sustain!=-1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_SUSTAIN,&amp;sustain);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(transmit_thres!=-1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_TRANSMIT_THRESHOLD,&amp;transmit_thres);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ng_sustain<sp/>!=<sp/>-1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_SET_NOISE_GATE_SUSTAIN,&amp;ng_sustain);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>mic_ng_thresng_thres
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(mic_ng_thres&gt;0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_SET_NOISE_GATE_THRESHOLD,&amp;mic_ng_thres);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_SET_NOISE_GATE_THRESHOLD,&amp;ng_thres);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_SET_NOISE_GATE_FLOORGAIN,&amp;ng_floorgain);
<sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(st-&gt;volrecv){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Configure<sp/>volume<sp/>[%p]<sp/>volrecv<sp/>speaker&quot;,<sp/>st-&gt;volrecv-&gt;data);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>parameters<sp/>for<sp/>a<sp/>limited<sp/>noise-gate<sp/>effect,<sp/>using<sp/>echo<sp/>limiter<sp/>threshold<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>floorgain<sp/>=<sp/>1/pow(10,(mic_gain)/10);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(floorgain<sp/>&gt;<sp/>1)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>floorgain<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spk_agc=sp_config_get_int(lc-&gt;config,&quot;sound&quot;,&quot;speaker_agc_enabled&quot;,0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,<sp/>MS_VOLUME_ENABLE_AGC,<sp/>&amp;spk_agc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,MS_VOLUME_SET_NOISE_GATE_THRESHOLD,&amp;ng_thres);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,MS_VOLUME_SET_NOISE_GATE_FLOORGAIN,&amp;floorgain);
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>parametrize_equalizer(lc,st);
}

static<sp/>void<sp/>post_configure_audio_streams(SephoneCall<sp/>*call,<sp/>bool_t<sp/>muted){
<sp/><sp/><sp/><sp/>AudioStream<sp/>*st=call-&gt;audiostream;
<sp/><sp/><sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;
<sp/><sp/><sp/><sp/>ms_func();
<sp/><sp/><sp/><sp/><sp/>_post_configure_audio_stream(st,lc,muted);
<sp/><sp/><sp/><sp/><sp/>if<sp/>(sephone_core_dtmf_received_has_listener(lc)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_play_received_dtmfs(call-&gt;audiostream,FALSE);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;record_active)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_start_recording(call);
}

static<sp/>int<sp/>get_ideal_audio_bw(SephoneCall<sp/>*call,<sp/>const<sp/>SalMediaDescription<sp/>*md,<sp/>const<sp/>SalStreamDescription<sp/>*desc){
<sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>remote_bw=0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>upload_bw;
<sp/>int<sp/>total_upload_bw=sephone_core_get_upload_bandwidth(call-&gt;core);
<sp/><sp/><sp/><sp/><sp/>const<sp/>SephoneCallParams<sp/>*params=call-&gt;params;
<sp/><sp/>bool_t<sp/>will_use_video=sephone_core_media_description_contains_video_stream(md);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>forced=FALSE;

<sp/><sp/>if<sp/>(desc-&gt;bandwidth&gt;0)<sp/>remote_bw=desc-&gt;bandwidth;
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(md-&gt;bandwidth&gt;0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*case<sp/>where<sp/>b=AS<sp/>is<sp/>given<sp/>globally,<sp/>not<sp/>per<sp/>stream*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remote_bw=md-&gt;bandwidth;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(params-&gt;up_bw&gt;0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>forced=TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=params-&gt;up_bw;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>upload_bw=total_upload_bw;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=get_min_bandwidth(upload_bw,remote_bw);
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!will_use_video<sp/>||<sp/>forced)<sp/>return<sp/>upload_bw;

<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(bandwidth_is_greater(upload_bw,512)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=100;
<sp/>}else<sp/>if<sp/>(bandwidth_is_greater(upload_bw,256)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=64;
<sp/><sp/>}else<sp/>if<sp/>(bandwidth_is_greater(upload_bw,128)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=40;
<sp/><sp/>}else<sp/>if<sp/>(bandwidth_is_greater(upload_bw,0)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=24;
<sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>upload_bw;
}

static<sp/>int<sp/>get_video_bw(SephoneCall<sp/>*call,<sp/>const<sp/>SalMediaDescription<sp/>*md,<sp/>const<sp/>SalStreamDescription<sp/>*desc){
<sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>remote_bw=0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>bw;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(desc-&gt;bandwidth&gt;0)<sp/>remote_bw=desc-&gt;bandwidth;
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(md-&gt;bandwidth&gt;0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*case<sp/>where<sp/>b=AS<sp/>is<sp/>given<sp/>globally,<sp/>not<sp/>per<sp/>stream*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remote_bw=get_remaining_bandwidth_for_video(md-&gt;bandwidth,call-&gt;audio_bw);
<sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remote_bw<sp/>=<sp/>sp_config_get_int(call-&gt;core-&gt;config,<sp/>&quot;net&quot;,<sp/>&quot;default_max_bandwidth&quot;,<sp/>1500);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>bw=get_min_bandwidth(get_remaining_bandwidth_for_video(sephone_core_get_upload_bandwidth(call-&gt;core),call-&gt;audio_bw),remote_bw);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>bw;
}

static<sp/>RtpProfile<sp/>*make_profile(SephoneCall<sp/>*call,<sp/>const<sp/>SalMediaDescription<sp/>*md,<sp/>const<sp/>SalStreamDescription<sp/>*desc,<sp/>int<sp/>*used_pt){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>bw=0;
<sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>MSList<sp/>*elem;
<sp/><sp/><sp/><sp/>RtpProfile<sp/>*prof=rtp_profile_new(&quot;Call<sp/>profile&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>first=TRUE;
<sp/><sp/><sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;
<sp/><sp/><sp/><sp/>int<sp/>up_ptime=0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>SephoneCallParams<sp/>*params=call-&gt;params;

<sp/>*used_pt=-1;

<sp/><sp/>if<sp/>(desc-&gt;type==SalAudio)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bw=get_ideal_audio_bw(call,md,desc);
<sp/><sp/><sp/>else<sp/>if<sp/>(desc-&gt;type==SalVideo)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bw=get_video_bw(call,md,desc);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(elem=desc-&gt;payloads;elem!=NULL;elem=elem-&gt;next){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadType<sp/>*pt=(PayloadType*)elem-&gt;data;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>number;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>make<sp/>a<sp/>copy<sp/>of<sp/>the<sp/>payload<sp/>type,<sp/>so<sp/>that<sp/>we<sp/>left<sp/>the<sp/>ones<sp/>from<sp/>the<sp/>SalStreamDescription<sp/>unchanged.
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>If<sp/>the<sp/>SalStreamDescription<sp/>is<sp/>freed,<sp/>this<sp/>will<sp/>have<sp/>no<sp/>impact<sp/>on<sp/>the<sp/>running<sp/>streams*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt=payload_type_clone(pt);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((pt-&gt;flags<sp/>&amp;<sp/>PAYLOAD_TYPE_FLAG_CAN_SEND)<sp/>&amp;&amp;<sp/>first)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*first<sp/>codec<sp/>in<sp/>list<sp/>is<sp/>the<sp/>selected<sp/>one*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(desc-&gt;type==SalAudio){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*this<sp/>will<sp/>update<sp/>call-&gt;audio_bw*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_allocated_audio_bandwidth_in_call(call,pt,bw);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bw=call-&gt;audio_bw;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(params-&gt;up_ptime)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>up_ptime=params-&gt;up_ptime;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>up_ptime=sephone_core_get_upload_ptime(lc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*used_pt=payload_type_get_number(pt);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>first=FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(pt-&gt;flags<sp/>&amp;<sp/>PAYLOAD_TYPE_BITRATE_OVERRIDE){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Payload<sp/>type<sp/>[%s/%i]<sp/>has<sp/>explicit<sp/>bitrate<sp/>[%i]<sp/>kbit/s&quot;,<sp/>pt-&gt;mime_type,<sp/>pt-&gt;clock_rate,<sp/>pt-&gt;normal_bitrate/1000);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt-&gt;normal_bitrate=get_min_bandwidth(pt-&gt;normal_bitrate,bw*1000);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>pt-&gt;normal_bitrate=bw*1000;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(desc-&gt;ptime&gt;0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>up_ptime=desc-&gt;ptime;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(up_ptime&gt;0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>char<sp/>tmp[40];
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snprintf(tmp,sizeof(tmp),&quot;ptime=%i&quot;,up_ptime);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_append_send_fmtp(pt,tmp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>number=payload_type_get_number(pt);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(rtp_profile_get_payload(prof,number)!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;A<sp/>payload<sp/>type<sp/>with<sp/>number<sp/>%i<sp/>already<sp/>exists<sp/>in<sp/>profile<sp/>!&quot;,number);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_profile_set_payload(prof,number,pt);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>prof;
}


static<sp/>void<sp/>setup_ring_player(SephoneCore<sp/>*lc,<sp/>SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/>int<sp/>pause_time=3000;
<sp/><sp/><sp/>audio_stream_play(call-&gt;audiostream,lc-&gt;sound_conf.ringback_tone);
<sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;soundread,MS_FILE_PLAYER_LOOP,&amp;pause_time);
}

static<sp/>bool_t<sp/>sephone_call_sound_resources_available(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;
<sp/><sp/><sp/><sp/>SephoneCall<sp/>*current=sephone_core_get_current_call(lc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>!sephone_core_is_in_conference(lc)<sp/>&amp;&amp;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(current==NULL<sp/>||<sp/>current==call);
}

static<sp/>int<sp/>find_crypto_index_from_tag(const<sp/>SalSrtpCryptoAlgo<sp/>crypto[],unsigned<sp/>char<sp/>tag)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>i;
<sp/>for(i=0;<sp/>i&lt;SAL_CRYPTO_ALGO_MAX;<sp/>i++)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(crypto[i].tag<sp/>==<sp/>tag)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>i;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>-1;
}

static<sp/>void<sp/>configure_rtp_session_for_rtcp_xr(SephoneCore<sp/>*lc,<sp/>SephoneCall<sp/>*call,<sp/>SalStreamType<sp/>type)<sp/>{
<sp/><sp/>RtpSession<sp/>*session;
<sp/><sp/><sp/>const<sp/>OrtpRtcpXrConfiguration<sp/>*localconfig;
<sp/><sp/><sp/><sp/>const<sp/>OrtpRtcpXrConfiguration<sp/>*remoteconfig;
<sp/><sp/><sp/>OrtpRtcpXrConfiguration<sp/>currentconfig;
<sp/>const<sp/>SalStreamDescription<sp/>*localstream;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>SalStreamDescription<sp/>*remotestream;
<sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*remotedesc<sp/>=<sp/>sal_call_get_remote_media_description(call-&gt;op);

<sp/><sp/><sp/><sp/>if<sp/>(!remotedesc)<sp/>return;

<sp/><sp/><sp/><sp/><sp/><sp/>localstream<sp/>=<sp/>sal_media_description_find_best_stream(call-&gt;localdesc,<sp/>type);
<sp/><sp/><sp/>if<sp/>(!localstream)<sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/>localconfig<sp/>=<sp/>&amp;localstream-&gt;rtcp_xr;
<sp/><sp/><sp/>remotestream<sp/>=<sp/>sal_media_description_find_best_stream(remotedesc,<sp/>type);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!remotestream)<sp/>return;
<sp/><sp/><sp/><sp/><sp/>remoteconfig<sp/>=<sp/>&amp;remotestream-&gt;rtcp_xr;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(localstream-&gt;dir<sp/>==<sp/>SalStreamInactive)<sp/>return;
<sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(localstream-&gt;dir<sp/>==<sp/>SalStreamRecvOnly)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>Use<sp/>local<sp/>config<sp/>for<sp/>unilateral<sp/>parameters<sp/>and<sp/>remote<sp/>config<sp/>for<sp/>collaborative<sp/>parameters.<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;currentconfig,<sp/>localconfig,<sp/>sizeof(currentconfig));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>currentconfig.rcvr_rtt_mode<sp/>=<sp/>remoteconfig-&gt;rcvr_rtt_mode;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>currentconfig.rcvr_rtt_max_size<sp/>=<sp/>remoteconfig-&gt;rcvr_rtt_max_size;
<sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;currentconfig,<sp/>remoteconfig,<sp/>sizeof(currentconfig));
<sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(type<sp/>==<sp/>SalAudio)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>session<sp/>=<sp/>call-&gt;audiostream-&gt;ms.sessions.rtp_session;
<sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>session<sp/>=<sp/>call-&gt;videostream-&gt;ms.sessions.rtp_session;
<sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_configure_rtcp_xr(session,<sp/>&amp;currentconfig);
}

void<sp/>static<sp/>start_dtls(<sp/>MSMediaStreamSessions<sp/>*sessions,<sp/><sp/>const<sp/>SalStreamDescription<sp/>*sd,const<sp/>SalStreamDescription<sp/>*remote)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sal_stream_description_has_dtls(sd)<sp/>==<sp/>TRUE)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*DTLS*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalDtlsRole<sp/>salRole<sp/>=<sp/>sd-&gt;dtls_role;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(salRole!=SalDtlsRoleInvalid)<sp/>{<sp/>/*<sp/>if<sp/>DTLS<sp/>is<sp/>available<sp/>at<sp/>both<sp/>end<sp/>points<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>give<sp/>the<sp/>peer<sp/>certificate<sp/>fingerprint<sp/>to<sp/>dtls<sp/>context<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_dtls_srtp_set_peer_fingerprint(sessions-&gt;dtls_context,<sp/>remote-&gt;dtls_fingerprint);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_dtls_srtp_set_role(sessions-&gt;dtls_context,<sp/>(salRole<sp/>==<sp/>SalDtlsRoleIsClient)?MSDtlsSrtpRoleIsClient:MSDtlsSrtpRoleIsServer);<sp/>/*<sp/>set<sp/>the<sp/>role<sp/>to<sp/>client<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_dtls_srtp_start(sessions-&gt;dtls_context);<sp/><sp/>/*<sp/>then<sp/>start<sp/>the<sp/>engine,<sp/>it<sp/>will<sp/>send<sp/>the<sp/>DTLS<sp/>client<sp/>Hello<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;unable<sp/>to<sp/>start<sp/>DTLS<sp/>engine<sp/>on<sp/>stream<sp/>session<sp/>[%p],<sp/>Dtls<sp/>role<sp/>in<sp/>resulting<sp/>media<sp/>description<sp/>is<sp/>invalid&quot;,sessions);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
}

void<sp/>static<sp/>start_dtls_on_all_streams(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*remote_desc<sp/>=<sp/>sal_call_get_remote_media_description(call-&gt;op);
<sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*result_desc<sp/>=<sp/>sal_call_get_final_media_description(call-&gt;op);
<sp/><sp/><sp/><sp/><sp/>if(<sp/>remote_desc<sp/>==<sp/>NULL<sp/>||<sp/>result_desc<sp/>==<sp/>NULL<sp/>){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>this<sp/>can<sp/>happen<sp/>in<sp/>some<sp/>tricky<sp/>cases<sp/>(early-media<sp/>without<sp/>SDP<sp/>in<sp/>the<sp/>200).<sp/>In<sp/>that<sp/>case,<sp/>simply<sp/>skip<sp/>DTLS<sp/>code<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>(media_stream_get_state((const<sp/>MediaStream<sp/>*)call-&gt;audiostream)<sp/>==<sp/>MSStreamStarted))/*dtls<sp/>must<sp/>start<sp/>at<sp/>the<sp/>end<sp/>of<sp/>ice*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_dtls(&amp;call-&gt;audiostream-&gt;ms.sessions
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(result_desc,SalAudio)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(remote_desc,SalAudio));
#if<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>(media_stream_get_state((const<sp/>MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted))/*dtls<sp/>must<sp/>start<sp/>at<sp/>the<sp/>end<sp/>of<sp/>ice*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_dtls(&amp;call-&gt;videostream-&gt;ms.sessions
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(result_desc,SalVideo)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(remote_desc,SalVideo));
#endif
<sp/>return;
}

void<sp/>static<sp/>set_dtls_fingerprint(<sp/>MSMediaStreamSessions<sp/>*sessions,<sp/><sp/>const<sp/>SalStreamDescription<sp/>*sd,const<sp/>SalStreamDescription<sp/>*remote)<sp/>{
<sp/><sp/><sp/><sp/>if<sp/>(sal_stream_description_has_dtls(sd)<sp/>==<sp/>TRUE)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*DTLS*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalDtlsRole<sp/>salRole<sp/>=<sp/>sd-&gt;dtls_role;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(salRole!=SalDtlsRoleInvalid)<sp/>{<sp/>/*<sp/>if<sp/>DTLS<sp/>is<sp/>available<sp/>at<sp/>both<sp/>end<sp/>points<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>give<sp/>the<sp/>peer<sp/>certificate<sp/>fingerprint<sp/>to<sp/>dtls<sp/>context<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_dtls_srtp_set_peer_fingerprint(sessions-&gt;dtls_context,<sp/>remote-&gt;dtls_fingerprint);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;unable<sp/>to<sp/>start<sp/>DTLS<sp/>engine<sp/>on<sp/>stream<sp/>session<sp/>[%p],<sp/>Dtls<sp/>role<sp/>in<sp/>resulting<sp/>media<sp/>description<sp/>is<sp/>invalid&quot;,sessions);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
}

void<sp/>static<sp/>set_dtls_fingerprint_on_all_streams(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*remote_desc<sp/>=<sp/>sal_call_get_remote_media_description(call-&gt;op);
<sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*result_desc<sp/>=<sp/>sal_call_get_final_media_description(call-&gt;op);

<sp/><sp/><sp/><sp/>if(<sp/>remote_desc<sp/>==<sp/>NULL<sp/>||<sp/>result_desc<sp/>==<sp/>NULL<sp/>){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>this<sp/>can<sp/>happen<sp/>in<sp/>some<sp/>tricky<sp/>cases<sp/>(early-media<sp/>without<sp/>SDP<sp/>in<sp/>the<sp/>200).<sp/>In<sp/>that<sp/>case,<sp/>simply<sp/>skip<sp/>DTLS<sp/>code<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>(media_stream_get_state((const<sp/>MediaStream<sp/>*)call-&gt;audiostream)<sp/>==<sp/>MSStreamStarted))/*dtls<sp/>must<sp/>start<sp/>at<sp/>the<sp/>end<sp/>of<sp/>ice*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_dtls_fingerprint(&amp;call-&gt;audiostream-&gt;ms.sessions
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(result_desc,SalAudio)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(remote_desc,SalAudio));
#if<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>(media_stream_get_state((const<sp/>MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted))/*dtls<sp/>must<sp/>start<sp/>at<sp/>the<sp/>end<sp/>of<sp/>ice*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_dtls_fingerprint(&amp;call-&gt;videostream-&gt;ms.sessions
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(result_desc,SalVideo)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(remote_desc,SalVideo));
#endif
<sp/>return;
}

static<sp/>void<sp/>sephone_call_start_audio_stream(SephoneCall<sp/>*call,<sp/>bool_t<sp/>muted,<sp/>bool_t<sp/>send_ringbacktone,<sp/>bool_t<sp/>use_arc){
<sp/><sp/><sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;
<sp/><sp/><sp/><sp/>SpConfig*<sp/>conf;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>used_pt=-1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>char<sp/>rtcp_tool[128]={0};
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>SalStreamDescription<sp/>*stream;
<sp/><sp/><sp/><sp/>MSSndCard<sp/>*playcard;
<sp/><sp/><sp/>MSSndCard<sp/>*captcard;
<sp/><sp/><sp/>bool_t<sp/>use_ec;
<sp/>bool_t<sp/>mute;
<sp/><sp/><sp/>const<sp/>char<sp/>*playfile;
<sp/><sp/>const<sp/>char<sp/>*recfile;
<sp/><sp/><sp/>const<sp/>SalStreamDescription<sp/>*local_st_desc;
<sp/><sp/><sp/><sp/><sp/>int<sp/>crypto_idx;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSStunMsg<sp/>smsg;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();

<sp/><sp/><sp/><sp/>snprintf(rtcp_tool,sizeof(rtcp_tool)-1,&quot;%s-%s&quot;,sephone_core_get_user_agent_name(),sephone_core_get_user_agent_version());
<sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;smsg,<sp/>0,<sp/>sizeof(smsg));

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>stream<sp/>=<sp/>sal_media_description_find_best_stream(call-&gt;resultdesc,<sp/>SalAudio);
<sp/><sp/><sp/>if<sp/>(stream<sp/>&amp;&amp;<sp/>stream-&gt;dir!=SalStreamInactive<sp/>&amp;&amp;<sp/>stream-&gt;rtp_port!=0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*rtp_addr=stream-&gt;rtp_addr[0]!=&apos;\0&apos;<sp/>?<sp/>stream-&gt;rtp_addr<sp/>:<sp/>call-&gt;resultdesc-&gt;addr;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>is_multicast=ms_is_multicast(rtp_addr);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard=lc-&gt;sound_conf.ssd_card<sp/>?
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;sound_conf.ssd_card<sp/>:<sp/>lc-&gt;sound_conf.play_sndcard;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=lc-&gt;sound_conf.capt_sndcard;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playfile=lc-&gt;play_file;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recfile=lc-&gt;rec_file;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audio_profile=make_profile(call,call-&gt;resultdesc,stream,&amp;used_pt);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(used_pt!=-1){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;audio_codec<sp/>=<sp/>rtp_profile_get_payload(call-&gt;audio_profile,<sp/>used_pt);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(playcard==NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;No<sp/>card<sp/>defined<sp/>for<sp/>playback<sp/>!&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(captcard==NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;No<sp/>card<sp/>defined<sp/>for<sp/>capture<sp/>!&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*Replace<sp/>soundcard<sp/>filters<sp/>by<sp/>inactive<sp/>file<sp/>players<sp/>or<sp/>recorders
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>when<sp/>placed<sp/>in<sp/>recvonly<sp/>or<sp/>sendonly<sp/>mode*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(stream-&gt;rtp_port==0
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>||<sp/>stream-&gt;dir==SalStreamRecvOnly
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>||<sp/>(stream-&gt;multicast_role<sp/>==<sp/>SalMulticastReceiver<sp/>&amp;&amp;<sp/>is_multicast)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playfile=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>if<sp/>(stream-&gt;dir==SalStreamSendOnly){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recfile=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*And<sp/>we<sp/>will<sp/>eventually<sp/>play<sp/>&quot;playfile&quot;<sp/>if<sp/>set<sp/>by<sp/>the<sp/>user*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*playfile=NULL;*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(send_ringbacktone){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>conf<sp/>=<sp/>sephone_core_get_config(lc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playfile=NULL;/*<sp/>it<sp/>is<sp/>setup<sp/>later*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(<sp/>conf<sp/>&amp;&amp;<sp/>sp_config_get_int(conf,&quot;sound&quot;,&quot;send_ringback_without_playback&quot;,<sp/>0)<sp/>==<sp/>1){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recfile<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*if<sp/>playfile<sp/>are<sp/>supplied<sp/>don&apos;t<sp/>use<sp/>soundcards*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(lc-&gt;use_files)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;params-&gt;in_conference){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>first<sp/>create<sp/>the<sp/>graph<sp/>without<sp/>soundcard<sp/>resources*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=playcard=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!sephone_call_sound_resources_available(call)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Sound<sp/>resources<sp/>are<sp/>used<sp/>by<sp/>another<sp/>call,<sp/>not<sp/>using<sp/>soundcard.&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=playcard=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_ec=captcard==NULL<sp/>?<sp/>FALSE<sp/>:<sp/>sephone_core_echo_cancellation_enabled(lc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(playcard<sp/>&amp;&amp;<sp/><sp/>stream-&gt;max_rate&gt;0)<sp/>ms_snd_card_set_preferred_sample_rate(playcard,<sp/>stream-&gt;max_rate);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(captcard<sp/>&amp;&amp;<sp/><sp/>stream-&gt;max_rate&gt;0)<sp/>ms_snd_card_set_preferred_sample_rate(captcard,<sp/>stream-&gt;max_rate);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_adaptive_bitrate_control(call-&gt;audiostream,use_arc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_adaptive_bitrate_algorithm(&amp;call-&gt;audiostream-&gt;ms,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_qos_analyzer_algorithm_from_string(sephone_core_get_adaptive_rate_algorithm(lc)));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_adaptive_jittcomp(call-&gt;audiostream,<sp/>sephone_core_audio_adaptive_jittcomp_enabled(lc));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!call-&gt;params-&gt;in_conference<sp/>&amp;&amp;<sp/>call-&gt;params-&gt;record_file){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_mixed_record_open(call-&gt;audiostream,call-&gt;params-&gt;record_file);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;record_file=ms_strdup(call-&gt;params-&gt;record_file);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>valid<sp/>local<sp/>tags<sp/>are<sp/>&gt;<sp/>0<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sal_stream_description_has_srtp(stream)<sp/>==<sp/>TRUE)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>local_st_desc=sal_media_description_find_stream(call-&gt;localdesc,stream-&gt;proto,SalAudio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>crypto_idx<sp/>=<sp/>find_crypto_index_from_tag(local_st_desc-&gt;crypto,<sp/>stream-&gt;crypto_local_tag);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(crypto_idx<sp/>&gt;=<sp/>0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_recv_key_b64(&amp;(call-&gt;audiostream-&gt;ms.sessions),stream-&gt;crypto[0].algo,stream-&gt;crypto[0].master_key);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_send_key_b64(&amp;(call-&gt;audiostream-&gt;ms.sessions),stream-&gt;crypto[0].algo,local_st_desc-&gt;crypto[crypto_idx].master_key);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;Failed<sp/>to<sp/>find<sp/>local<sp/>crypto<sp/>algo<sp/>with<sp/>tag:<sp/>%d&quot;,<sp/>stream-&gt;crypto_local_tag);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>configure_rtp_session_for_rtcp_xr(lc,<sp/>call,<sp/>SalAudio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(is_multicast)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_multicast_ttl(call-&gt;audiostream-&gt;ms.sessions.rtp_session,stream-&gt;ttl);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>sdpbelle_sip
/*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((call-&gt;localdesc-&gt;ice_pwd[0]<sp/>!=<sp/>&apos;\0&apos;)<sp/>&amp;&amp;<sp/>(call-&gt;localdesc-&gt;ice_ufrag[0]<sp/>!=<sp/>&apos;\0&apos;))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_message_t<sp/>*ice_msg<sp/>=<sp/>sal_create_sdp_from_desc(call-&gt;localdesc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*body;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_msg<sp/>==<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;Create<sp/>sdp<sp/>for<sp/>audio<sp/>failed&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>body<sp/>=<sp/>belle_sip_message_get_body(ice_msg);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smsg.type<sp/>=<sp/>STUN_SMSG_SIP_SDP;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smsg.sequence<sp/>=<sp/>TRUE;<sp/>//<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smsg.msg_buf<sp/>=<sp/>ms_strdup(body);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_object_unref(ice_msg);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while<sp/>(FALSE);*/

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_start_full(
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audio_profile,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_addr,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stream-&gt;rtp_port,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stream-&gt;rtcp_addr[0]!=&apos;\0&apos;<sp/>?<sp/>stream-&gt;rtcp_addr<sp/>:<sp/>call-&gt;resultdesc-&gt;addr,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(sephone_core_rtcp_enabled(lc)<sp/>&amp;&amp;<sp/>!is_multicast)<sp/>?<sp/>(stream-&gt;rtcp_port<sp/>?<sp/>stream-&gt;rtcp_port<sp/>:<sp/>stream-&gt;rtp_port+1)<sp/>:<sp/>0,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>used_pt,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_get_audio_jittcomp(lc),
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playfile,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recfile,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_ec,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>NULL<sp/>//<sp/>&amp;smsg
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>post_configure_audio_streams(call,<sp/>muted<sp/>&amp;&amp;<sp/>!send_ringbacktone);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(smsg.msg_buf<sp/>!=<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free((char*)smsg.msg_buf);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smsg.msg_buf<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_session_encryption_mandatory_enable(&amp;call-&gt;audiostream-&gt;ms.sessions,sephone_core_is_media_encryption_mandatory(call-&gt;core));

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(stream-&gt;dir==SalStreamSendOnly<sp/>&amp;&amp;<sp/>playfile!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>pause_time=500;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;soundread,MS_FILE_PLAYER_LOOP,&amp;pause_time);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(send_ringbacktone){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_ring_player(lc,call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;params-&gt;in_conference){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*transform<sp/>the<sp/>graph<sp/>to<sp/>connect<sp/>it<sp/>to<sp/>the<sp/>conference<sp/>filter<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mute=stream-&gt;dir==SalStreamRecvOnly;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_add_to_conf(call,<sp/>mute);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;in_conference=call-&gt;params-&gt;in_conference;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;low_bandwidth=call-&gt;params-&gt;low_bandwidth;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>ms_warning(&quot;No<sp/>audio<sp/>stream<sp/>accepted<sp/>?&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
}

static<sp/>void<sp/>sephone_call_start_video_stream(SephoneCall<sp/>*call,<sp/>bool_t<sp/>all_inputs_muted){
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;
<sp/><sp/><sp/><sp/>int<sp/>used_pt=-1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>SalStreamDescription<sp/>*vstream;
<sp/><sp/><sp/>MSFilter*<sp/>source<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>reused_preview<sp/>=<sp/>FALSE;
<sp/>ms_func();

<sp/><sp/><sp/><sp/>/*<sp/>shutdown<sp/>preview<sp/>*/
<sp/>if<sp/>(lc-&gt;previewstream!=NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(<sp/>lc-&gt;video_conf.reuse_preview_source<sp/>==<sp/>FALSE)<sp/>video_preview_stop(lc-&gt;previewstream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>source<sp/>=<sp/>video_preview_stop_reuse_source(lc-&gt;previewstream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;previewstream=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>vstream<sp/>=<sp/>sal_media_description_find_best_stream(call-&gt;resultdesc,<sp/>SalVideo);
<sp/><sp/>if<sp/>(vstream!=NULL<sp/>&amp;&amp;<sp/>vstream-&gt;dir!=SalStreamInactive<sp/>&amp;&amp;<sp/>vstream-&gt;rtp_port!=0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*rtp_addr=vstream-&gt;rtp_addr[0]!=&apos;\0&apos;<sp/>?<sp/>vstream-&gt;rtp_addr<sp/>:<sp/>call-&gt;resultdesc-&gt;addr;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*rtcp_addr=vstream-&gt;rtcp_addr[0]!=&apos;\0&apos;<sp/>?<sp/>vstream-&gt;rtcp_addr<sp/>:<sp/>call-&gt;resultdesc-&gt;addr;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>SalStreamDescription<sp/>*local_st_desc=sal_media_description_find_stream(call-&gt;localdesc,vstream-&gt;proto,SalVideo);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>is_multicast=ms_is_multicast(rtp_addr);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_profile=make_profile(call,call-&gt;resultdesc,vstream,&amp;used_pt);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(used_pt!=-1){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>VideoStreamDir<sp/>dir=VideoStreamSendRecv;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>is_inactive=FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSWebCam<sp/>*cam;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;video_codec<sp/>=<sp/>rtp_profile_get_payload(call-&gt;video_profile,<sp/>used_pt);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;has_video=TRUE;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_adaptive_bitrate_control(call-&gt;videostream,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_adaptive_rate_control_enabled(lc));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_adaptive_bitrate_algorithm(&amp;call-&gt;videostream-&gt;ms,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_qos_analyzer_algorithm_from_string(sephone_core_get_adaptive_rate_algorithm(lc)));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_adaptive_jittcomp(call-&gt;videostream,<sp/>sephone_core_video_adaptive_jittcomp_enabled(lc));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(lc-&gt;video_conf.preview_vsize.width!=0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_preview_size(call-&gt;videostream,lc-&gt;video_conf.preview_vsize);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_fps(call-&gt;videostream,sephone_core_get_preferred_framerate(lc));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_sent_video_size(call-&gt;videostream,sephone_core_get_preferred_video_size(lc));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_self_view(call-&gt;videostream,lc-&gt;video_conf.selfview);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;video_window_id<sp/>!=<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_native_window_id(call-&gt;videostream,call-&gt;video_window_id);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(lc-&gt;video_window_id!=0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_native_window_id(call-&gt;videostream,lc-&gt;video_window_id);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(lc-&gt;preview_window_id!=0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_native_preview_window_id<sp/>(call-&gt;videostream,lc-&gt;preview_window_id);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_use_preview_video_window<sp/>(call-&gt;videostream,lc-&gt;use_preview_window);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(is_multicast){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(vstream-&gt;multicast_role<sp/>==<sp/>SalMulticastReceiver)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamRecvOnly;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamSendOnly;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>(vstream-&gt;dir==SalStreamSendOnly<sp/>&amp;&amp;<sp/>lc-&gt;video_conf.capture<sp/>){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamSendOnly;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>if<sp/>(vstream-&gt;dir==SalStreamRecvOnly<sp/>&amp;&amp;<sp/>lc-&gt;video_conf.display<sp/>){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamRecvOnly;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>if<sp/>(vstream-&gt;dir==SalStreamSendRecv){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(lc-&gt;video_conf.display<sp/>&amp;&amp;<sp/>lc-&gt;video_conf.capture)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamSendRecv;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(lc-&gt;video_conf.display)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamRecvOnly;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamSendOnly;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;video<sp/>stream<sp/>is<sp/>inactive.&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*either<sp/>inactive<sp/>or<sp/>incompatible<sp/>with<sp/>local<sp/>capabilities*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>is_inactive=TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(all_inputs_muted){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cam=get_nowebcam_device();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cam<sp/>=<sp/>sephone_call_get_video_device(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!is_inactive){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sal_stream_description_has_srtp(vstream)<sp/>==<sp/>TRUE)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>crypto_idx<sp/>=<sp/>find_crypto_index_from_tag(local_st_desc-&gt;crypto,<sp/>vstream-&gt;crypto_local_tag);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(crypto_idx<sp/>&gt;=<sp/>0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_recv_key_b64(&amp;(call-&gt;videostream-&gt;ms.sessions),vstream-&gt;crypto[0].algo,vstream-&gt;crypto[0].master_key);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_send_key_b64(&amp;(call-&gt;videostream-&gt;ms.sessions),vstream-&gt;crypto[0].algo,local_st_desc-&gt;crypto[crypto_idx].master_key);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>configure_rtp_session_for_rtcp_xr(lc,<sp/>call,<sp/>SalVideo);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;log-&gt;video_enabled<sp/>=<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;video<sp/>stream<sp/>direction:%d&quot;,<sp/>dir);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_direction<sp/>(call-&gt;videostream,<sp/>dir);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;%s<sp/>lc<sp/>rotation:%d&quot;,<sp/>__FUNCTION__,<sp/>lc-&gt;device_rotation);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_device_rotation(call-&gt;videostream,<sp/>lc-&gt;device_rotation);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_mirror(call-&gt;videostream,<sp/>sp_config_get_int(lc-&gt;config,<sp/>&quot;video&quot;,<sp/>&quot;mirror&quot;,<sp/>0));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_freeze_on_error(call-&gt;videostream,<sp/>sp_config_get_int(lc-&gt;config,<sp/>&quot;video&quot;,<sp/>&quot;freeze_on_error&quot;,<sp/>0));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_dynamic_framerate_control(call-&gt;videostream,<sp/>sp_config_get_int(lc-&gt;config,<sp/>&quot;video&quot;,<sp/>&quot;dynamic_framerate_control&quot;,<sp/>0));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_record_set_video_source(call-&gt;videostream,<sp/>sp_config_get_int(lc-&gt;config,<sp/>&quot;video&quot;,<sp/>&quot;record_local&quot;,<sp/>0));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(is_multicast)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_multicast_ttl(call-&gt;videostream-&gt;ms.sessions.rtp_session,vstream-&gt;ttl);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(<sp/>lc-&gt;video_conf.reuse_preview_source<sp/>&amp;&amp;<sp/>source<sp/>){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;video_stream_start_with_source<sp/>kept:<sp/>%p&quot;,<sp/>source);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_start_with_source(call-&gt;videostream,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_profile,<sp/>rtp_addr,<sp/>vstream-&gt;rtp_port,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtcp_addr,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_rtcp_enabled(lc)<sp/>?<sp/>(vstream-&gt;rtcp_port<sp/>?<sp/>vstream-&gt;rtcp_port<sp/>:<sp/>vstream-&gt;rtp_port+1)<sp/>:<sp/>0,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>used_pt,<sp/>sephone_core_get_video_jittcomp(lc),<sp/>cam,<sp/>source,<sp/>NULL);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reused_preview<sp/>=<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_start(call-&gt;videostream,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_profile,<sp/>rtp_addr,<sp/>vstream-&gt;rtp_port,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtcp_addr,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(sephone_core_rtcp_enabled(lc)<sp/>&amp;&amp;<sp/>!is_multicast)<sp/><sp/>?<sp/>(vstream-&gt;rtcp_port<sp/>?<sp/>vstream-&gt;rtcp_port<sp/>:<sp/>vstream-&gt;rtp_port+1)<sp/>:<sp/>0,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>used_pt,<sp/>sephone_core_get_video_jittcomp(lc),<sp/>cam,<sp/>NULL);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_session_encryption_mandatory_enable(&amp;call-&gt;videostream-&gt;ms.sessions,sephone_core_is_media_encryption_mandatory(call-&gt;core));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>ms_warning(&quot;No<sp/>video<sp/>stream<sp/>accepted.&quot;);
<sp/>}else{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;No<sp/>valid<sp/>video<sp/>stream<sp/>defined.&quot;);
<sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if(<sp/>reused_preview<sp/>==<sp/>FALSE<sp/>&amp;&amp;<sp/>source<sp/>!=<sp/>NULL<sp/>){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>destroy<sp/>not-reused<sp/>source<sp/>filter<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;Video<sp/>preview<sp/>(%p)<sp/>not<sp/>reused:<sp/>destroying<sp/>it.&quot;,<sp/>source);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_destroy(source);
<sp/><sp/><sp/><sp/><sp/>}
#endif
}

static<sp/>void<sp/>setZrtpCryptoTypesParameters(MSZrtpParams<sp/>*params,<sp/>SephoneCore<sp/>*lc)
{
<sp/><sp/>int<sp/>i;
<sp/>const<sp/>MSCryptoSuite<sp/>*srtp_suites;
<sp/><sp/><sp/><sp/><sp/><sp/>MsZrtpCryptoTypesCount<sp/>ciphersCount,<sp/>authTagsCount;

<sp/><sp/><sp/>if<sp/>(params<sp/>==<sp/>NULL)<sp/>return;
<sp/><sp/><sp/><sp/>if<sp/>(lc<sp/>==<sp/>NULL)<sp/>return;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>srtp_suites<sp/>=<sp/>sephone_core_get_srtp_crypto_suites(lc);
<sp/>if<sp/>(srtp_suites!=NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(i=0;<sp/>srtp_suites[i]!=MS_CRYPTO_SUITE_INVALID<sp/>&amp;&amp;<sp/>i&lt;SAL_CRYPTO_ALGO_MAX<sp/>&amp;&amp;<sp/>i&lt;MS_MAX_ZRTP_CRYPTO_TYPES;<sp/>++i){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch<sp/>(srtp_suites[i])<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_AES_128_SHA1_32:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS32;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_AES_128_NO_AUTH:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_NO_CIPHER_SHA1_80:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS80;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_AES_128_SHA1_80:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS80;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_AES_256_SHA1_80:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES3;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS80;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_AES_256_SHA1_32:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES3;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS80;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>MS_CRYPTO_SUITE_INVALID:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>/*<sp/>sephone_core_get_srtp_crypto_suites<sp/>is<sp/>used<sp/>to<sp/>determine<sp/>sensible<sp/>defaults;<sp/>here<sp/>each<sp/>can<sp/>be<sp/>overridden<sp/>*/
<sp/><sp/>ciphersCount<sp/>=<sp/>sephone_core_get_zrtp_cipher_suites(lc,<sp/>params-&gt;ciphers);<sp/>/*<sp/>if<sp/>not<sp/>present<sp/>in<sp/>config<sp/>file,<sp/>params-&gt;ciphers<sp/>is<sp/>not<sp/>modified<sp/>*/
<sp/><sp/>if<sp/>(ciphersCount!=0)<sp/>{<sp/>/*<sp/>use<sp/>zrtp_cipher_suites<sp/>config<sp/>only<sp/>when<sp/>present,<sp/>keep<sp/>config<sp/>from<sp/>srtp_crypto_suite<sp/>otherwise<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphersCount<sp/>=<sp/>ciphersCount;
<sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;hashesCount<sp/>=<sp/>sephone_core_get_zrtp_hash_suites(lc,<sp/>params-&gt;hashes);
<sp/><sp/><sp/>authTagsCount<sp/>=<sp/>sephone_core_get_zrtp_auth_suites(lc,<sp/>params-&gt;authTags);<sp/>/*<sp/>if<sp/>not<sp/>present<sp/>in<sp/>config<sp/>file,<sp/>params-&gt;authTags<sp/>is<sp/>not<sp/>modified<sp/>*/
<sp/>if<sp/>(authTagsCount!=0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTagsCount<sp/>=<sp/>authTagsCount;<sp/>/*<sp/>use<sp/>zrtp_auth_suites<sp/>config<sp/>only<sp/>when<sp/>present,<sp/>keep<sp/>config<sp/>from<sp/>srtp_crypto_suite<sp/>otherwise<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;sasTypesCount<sp/>=<sp/>sephone_core_get_zrtp_sas_suites(lc,<sp/>params-&gt;sasTypes);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;keyAgreementsCount<sp/>=<sp/>sephone_core_get_zrtp_key_agreement_suites(lc,<sp/>params-&gt;keyAgreements);
}

void<sp/>sephone_call_start_media_streams(SephoneCall<sp/>*call,<sp/>bool_t<sp/>all_inputs_muted,<sp/>bool_t<sp/>send_ringbacktone){
<sp/><sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;
<sp/><sp/><sp/><sp/>bool_t<sp/>use_arc=sephone_core_adaptive_rate_control_enabled(lc);
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/>const<sp/>SalStreamDescription<sp/>*vstream=sal_media_description_find_best_stream(call-&gt;resultdesc,SalVideo);
#endif
<sp/><sp/>ms_func();

<sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;audio_codec<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;video_codec<sp/>=<sp/>NULL;

<sp/><sp/><sp/><sp/><sp/>if<sp/>((call-&gt;audiostream<sp/>==<sp/>NULL)<sp/>&amp;&amp;<sp/>(call-&gt;videostream<sp/>==<sp/>NULL))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_fatal(&quot;start_media_stream()<sp/>called<sp/>without<sp/>prior<sp/>init<sp/>!&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
#if<sp/>defined(VIDEO_ENABLED)
<sp/><sp/><sp/>if<sp/>(vstream!=NULL<sp/>&amp;&amp;<sp/>vstream-&gt;dir!=SalStreamInactive<sp/>&amp;&amp;<sp/>vstream-&gt;payloads!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*when<sp/>video<sp/>is<sp/>used,<sp/>do<sp/>not<sp/>make<sp/>adaptive<sp/>rate<sp/>control<sp/>on<sp/>audio,<sp/>it<sp/>is<sp/>stupid.*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_arc=FALSE;
<sp/>}
#endif
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;sephone_call_start_media_streams()<sp/>call=[%p]<sp/>local<sp/>upload_bandwidth=[%i]<sp/>kbit/s;<sp/>local<sp/>download_bandwidth=[%i]<sp/>kbit/s&quot;,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call,<sp/>sephone_core_get_upload_bandwidth(lc),sephone_core_get_download_bandwidth(lc));

<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream!=NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_start_audio_stream(call,all_inputs_muted||call-&gt;audio_muted,send_ringbacktone,use_arc);
<sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;DTLS<sp/>no<sp/>audio<sp/>stream!&quot;);
<sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;has_video=FALSE;
<sp/>if<sp/>(call-&gt;videostream!=NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream)<sp/>audio_stream_link_video(call-&gt;audiostream,call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_start_video_stream(call,all_inputs_muted);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>call-&gt;all_muted=all_inputs_muted;
<sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;playing_ringbacktone=send_ringbacktone;
<sp/><sp/>call-&gt;up_bw=sephone_core_get_upload_bandwidth(lc);

<sp/><sp/><sp/><sp/>/*might<sp/>be<sp/>moved<sp/>in<sp/>audio/video<sp/>stream_start*/
<sp/>if<sp/>(call-&gt;params-&gt;media_encryption==SephoneMediaEncryptionZRTP)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSZrtpParams<sp/>params;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;params,0,sizeof(MSZrtpParams));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*call-&gt;current_params.media_encryption<sp/>will<sp/>be<sp/>set<sp/>later<sp/>when<sp/>zrtp<sp/>is<sp/>activated*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.zid_file=lc-&gt;zrtp_secrets_cache;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.uri=<sp/>sephone_address_as_string_uri_only((call-&gt;dir==SephoneCallIncoming)<sp/>?<sp/>call-&gt;log-&gt;from<sp/>:<sp/>call-&gt;log-&gt;to);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setZrtpCryptoTypesParameters(&amp;params,call-&gt;core);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_zrtp(call-&gt;audiostream,&amp;params);
#if<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(media_stream_secured((MediaStream<sp/>*)call-&gt;audiostream)<sp/>&amp;&amp;<sp/>media_stream_get_state((MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*audio<sp/>stream<sp/>is<sp/>already<sp/>encrypted<sp/>and<sp/>video<sp/>stream<sp/>is<sp/>active*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;params,0,sizeof(MSZrtpParams));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_zrtp(call-&gt;videostream,call-&gt;audiostream,&amp;params);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
#endif
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>set_dtls_fingerprint_on_all_streams(call);

<sp/><sp/><sp/><sp/>if<sp/>((call-&gt;ice_session<sp/>!=<sp/>NULL)<sp/>&amp;&amp;<sp/>(ice_session_state(call-&gt;ice_session)<sp/>!=<sp/>IS_Completed))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_start_connectivity_checks(call-&gt;ice_session);
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*should<sp/>not<sp/>start<sp/>dtls<sp/>until<sp/>ice<sp/>is<sp/>completed*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_dtls_on_all_streams(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

}

void<sp/>sephone_call_stop_media_streams_for_ice_gathering(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();
<sp/><sp/><sp/><sp/><sp/>if(call-&gt;audiostream<sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ms.state==MSStreamPreparing)<sp/>audio_stream_unprepare_sound(call-&gt;audiostream);
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/>if<sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;ms.state==MSStreamPreparing)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_unprepare_video(call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
#endif
}

static<sp/>bool_t<sp/>update_stream_crypto_params(SephoneCall<sp/>*call,<sp/>const<sp/>SalStreamDescription<sp/>*local_st_desc,<sp/>SalStreamDescription<sp/>*old_stream,<sp/>SalStreamDescription<sp/>*new_stream,<sp/>MediaStream<sp/>*ms){
<sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>crypto_idx<sp/>=<sp/>find_crypto_index_from_tag(local_st_desc-&gt;crypto,<sp/>new_stream-&gt;crypto_local_tag);
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(crypto_idx<sp/>&gt;=<sp/>0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;localdesc_changed<sp/>&amp;<sp/>SAL_MEDIA_DESCRIPTION_CRYPTO_KEYS_CHANGED)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_send_key_b64(&amp;(ms-&gt;sessions),new_stream-&gt;crypto[0].algo,local_st_desc-&gt;crypto[crypto_idx].master_key);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(strcmp(old_stream-&gt;crypto[0].master_key,new_stream-&gt;crypto[0].master_key)!=0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_recv_key_b64(&amp;(ms-&gt;sessions),new_stream-&gt;crypto[0].algo,new_stream-&gt;crypto[0].master_key);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>TRUE;
<sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;Failed<sp/>to<sp/>find<sp/>local<sp/>crypto<sp/>algo<sp/>with<sp/>tag:<sp/>%d&quot;,<sp/>new_stream-&gt;crypto_local_tag);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>FALSE;
}

void<sp/>sephone_call_update_crypto_parameters(SephoneCall<sp/>*call,<sp/>SalMediaDescription<sp/>*old_md,<sp/>SalMediaDescription<sp/>*new_md)<sp/>{
<sp/><sp/><sp/><sp/><sp/>SalStreamDescription<sp/>*old_stream;
<sp/><sp/><sp/><sp/><sp/><sp/>SalStreamDescription<sp/>*new_stream;
<sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>SalStreamDescription<sp/>*local_st_desc;

<sp/><sp/><sp/><sp/>local_st_desc<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(call-&gt;localdesc,<sp/>SalAudio);
<sp/><sp/><sp/>old_stream<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(old_md,<sp/>SalAudio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_stream<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(new_md,<sp/>SalAudio);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>local_st_desc<sp/>&amp;&amp;<sp/>old_stream<sp/>&amp;&amp;<sp/>new_stream<sp/>&amp;&amp;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_stream_crypto_params(call,local_st_desc,old_stream,new_stream,&amp;call-&gt;audiostream-&gt;ms)){
<sp/>}

<sp/><sp/><sp/><sp/><sp/>start_dtls_on_all_streams(call);

#ifdef<sp/>VIDEO_ENABLED
<sp/>local_st_desc<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(call-&gt;localdesc,<sp/>SalVideo);
<sp/><sp/><sp/>old_stream<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(old_md,<sp/>SalVideo);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_stream<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(new_md,<sp/>SalVideo);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>local_st_desc<sp/>&amp;&amp;<sp/>old_stream<sp/>&amp;&amp;<sp/>new_stream<sp/>&amp;&amp;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_stream_crypto_params(call,local_st_desc,old_stream,new_stream,&amp;call-&gt;videostream-&gt;ms)){
<sp/>}
#endif
}

void<sp/>sephone_call_update_remote_session_id_and_ver(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*remote_desc<sp/>=<sp/>sal_call_get_remote_media_description(call-&gt;op);
<sp/><sp/><sp/><sp/>if<sp/>(remote_desc)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;remote_session_id<sp/>=<sp/>remote_desc-&gt;session_id;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;remote_session_ver<sp/>=<sp/>remote_desc-&gt;session_ver;
<sp/><sp/><sp/>}
}

void<sp/>sephone_call_delete_ice_session(SephoneCall<sp/>*call){
<sp/><sp/>if<sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_debug(&quot;Delete<sp/>ice<sp/>session<sp/>for<sp/>audio<sp/>[%p]<sp/>video<sp/>[%p]&quot;,<sp/>call-&gt;audiostream,<sp/>call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_destroy(call-&gt;ice_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ice_session<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>!=<sp/>NULL)<sp/>call-&gt;audiostream-&gt;ms.ice_check_list<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>!=<sp/>NULL)<sp/>call-&gt;videostream-&gt;ms.ice_check_list<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].ice_state<sp/>=<sp/>SephoneIceStateNotActivated;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].ice_state<sp/>=<sp/>SephoneIceStateNotActivated;
<sp/>}
}

void<sp/>sephone_call_delete_upnp_session(SephoneCall<sp/>*call){
#ifdef<sp/>BUILD_UPNP
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(call-&gt;upnp_session!=NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_upnp_session_destroy(call-&gt;upnp_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;upnp_session=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
#endif<sp/>//BUILD_UPNP
}

static<sp/>void<sp/>sephone_call_log_fill_stats(SephoneCallLog<sp/>*log,<sp/>MediaStream<sp/>*st){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>quality=media_stream_get_average_quality_rating(st);
<sp/><sp/><sp/><sp/><sp/>if<sp/>(quality&gt;=0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(log-&gt;quality!=-1){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log-&gt;quality*=quality/5.0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}else<sp/>log-&gt;quality=quality;
<sp/><sp/><sp/><sp/>}
}

static<sp/>void<sp/>sephone_call_stop_audio_stream(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/>ms_func();
<sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream!=NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_reporting_update_media_info(call,<sp/>SEPHONE_CALL_STATS_AUDIO);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_reclaim_sessions(&amp;call-&gt;audiostream-&gt;ms,&amp;call-&gt;sessions[0]);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream-&gt;ec){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*state_str=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;ec,MS_ECHO_CANCELLER_GET_STATE_STRING,&amp;state_str);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(state_str){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Writing<sp/>echo<sp/>canceler<sp/>state,<sp/>%i<sp/>bytes&quot;,(int)strlen(state_str));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sp_config_write_relative_file(call-&gt;core-&gt;config,<sp/>EC_STATE_STORE,<sp/>state_str);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_get_local_rtp_stats(call-&gt;audiostream,&amp;call-&gt;log-&gt;local_stats);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_log_fill_stats<sp/>(call-&gt;log,(MediaStream*)call-&gt;audiostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;endpoint){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_remove_from_conf(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_stop(call-&gt;audiostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_unregister_event_queue(call-&gt;sessions[0].rtp_session,<sp/>call-&gt;audiostream_app_evq);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_ev_queue_flush(call-&gt;audiostream_app_evq);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_ev_queue_destroy(call-&gt;audiostream_app_evq);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream_app_evq=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;audio_codec<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/>}
}

static<sp/>void<sp/>sephone_call_stop_video_stream(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/>ms_func();
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_reporting_update_media_info(call,<sp/>SEPHONE_CALL_STATS_VIDEO);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_reclaim_sessions(&amp;call-&gt;videostream-&gt;ms,&amp;call-&gt;sessions[1]);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_log_fill_stats(call-&gt;log,(MediaStream*)call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_stop(call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_unregister_event_queue(call-&gt;sessions[1].rtp_session,<sp/>call-&gt;videostream_app_evq);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_ev_queue_flush(call-&gt;videostream_app_evq);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_ev_queue_destroy(call-&gt;videostream_app_evq);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream_app_evq=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;video_codec<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/>}
#endif
}

static<sp/>void<sp/>unset_rtp_profile(SephoneCall<sp/>*call,<sp/>int<sp/>i){
<sp/><sp/><sp/>if<sp/>(call-&gt;sessions[i].rtp_session)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_profile(call-&gt;sessions[i].rtp_session,&amp;av_profile);
}

void<sp/>sephone_call_stop_media_streams_ticker(SephoneCall<sp/>*call){
<sp/>if<sp/>(call-&gt;audiostream)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_stop_ticker(&amp;(call-&gt;audiostream-&gt;ms));
<sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_stop_ticker(&amp;(call-&gt;videostream-&gt;ms));
<sp/><sp/><sp/><sp/>}
}

void<sp/>sephone_call_stop_media_streams(SephoneCall<sp/>*call){
<sp/><sp/>ms_func();
<sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>||<sp/>call-&gt;videostream)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>call-&gt;videostream)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_unlink_video(call-&gt;audiostream,<sp/>call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_audio_stream(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_video_stream(call);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;core-&gt;msevq<sp/>!=<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_event_queue_skip(call-&gt;core-&gt;msevq);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audio_profile){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_profile_destroy(call-&gt;audio_profile);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audio_profile=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unset_rtp_profile(call,0);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;video_profile){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_profile_destroy(call-&gt;video_profile);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_profile=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unset_rtp_profile(call,1);
<sp/><sp/><sp/><sp/><sp/>}
}

void<sp/>sephone_call_enable_echo_cancellation(SephoneCall<sp/>*call,<sp/>bool_t<sp/>enable)<sp/>{
<sp/><sp/><sp/><sp/>if<sp/>(call!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ec){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>bypass_mode<sp/>=<sp/>!enable;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;ec,MS_ECHO_CANCELLER_SET_BYPASS_MODE,&amp;bypass_mode);
<sp/><sp/><sp/>}
}

bool_t<sp/>sephone_call_echo_cancellation_enabled(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ec){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>val;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;ec,MS_ECHO_CANCELLER_GET_BYPASS_MODE,&amp;val);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>!val;
<sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sephone_core_echo_cancellation_enabled(call-&gt;core);
<sp/><sp/><sp/><sp/><sp/>}
}

void<sp/>sephone_call_enable_echo_limiter(SephoneCall<sp/>*call,<sp/>bool_t<sp/>val){
<sp/><sp/><sp/><sp/><sp/>if<sp/>(call!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL<sp/>)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(val)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*type=sp_config_get_string(call-&gt;core-&gt;config,&quot;sound&quot;,&quot;el_type&quot;,&quot;mic&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(strcasecmp(type,&quot;mic&quot;)==0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(call-&gt;audiostream,ELControlMic);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(strcasecmp(type,&quot;full&quot;)==0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(call-&gt;audiostream,ELControlFull);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(call-&gt;audiostream,ELInactive);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
}

bool_t<sp/>sephone_call_echo_limiter_enabled(const<sp/>SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL<sp/>){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>call-&gt;audiostream-&gt;el_type<sp/>!=ELInactive<sp/>;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>sephone_core_echo_limiter_enabled(call-&gt;core);
<sp/><sp/>}
}

/**
<sp/>*<sp/>@addtogroup<sp/>call_misc
<sp/>*<sp/>@{
**/

/**
<sp/>*<sp/>Returns<sp/>the<sp/>measured<sp/>sound<sp/>volume<sp/>played<sp/>locally<sp/>(received<sp/>from<sp/>remote).
<sp/>*<sp/>It<sp/>is<sp/>expressed<sp/>in<sp/>dbm0.
**/
float<sp/>sephone_call_get_play_volume(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/>AudioStream<sp/>*st=call-&gt;audiostream;
<sp/><sp/><sp/><sp/><sp/>if<sp/>(st<sp/>&amp;&amp;<sp/>st-&gt;volrecv){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>vol=0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,MS_VOLUME_GET,&amp;vol);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>vol;

<sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>SEPHONE_VOLUME_DB_LOWEST;
}

/**
<sp/>*<sp/>Returns<sp/>the<sp/>measured<sp/>sound<sp/>volume<sp/>recorded<sp/>locally<sp/>(sent<sp/>to<sp/>remote).
<sp/>*<sp/>It<sp/>is<sp/>expressed<sp/>in<sp/>dbm0.
**/
float<sp/>sephone_call_get_record_volume(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>AudioStream<sp/>*st=call-&gt;audiostream;
<sp/><sp/><sp/><sp/><sp/>if<sp/>(st<sp/>&amp;&amp;<sp/>st-&gt;volsend<sp/>&amp;&amp;<sp/>!call-&gt;audio_muted<sp/>&amp;&amp;<sp/>call-&gt;state==SephoneCallStreamsRunning){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>vol=0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_GET,&amp;vol);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>vol;

<sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>SEPHONE_VOLUME_DB_LOWEST;
}

/**
<sp/>*<sp/>Obtain<sp/>real-time<sp/>quality<sp/>rating<sp/>of<sp/>the<sp/>call
<sp/>*
<sp/>*<sp/>Based<sp/>on<sp/>local<sp/>RTP<sp/>statistics<sp/>and<sp/>RTCP<sp/>feedback,<sp/>a<sp/>quality<sp/>rating<sp/>is<sp/>computed<sp/>and<sp/>updated
<sp/>*<sp/>during<sp/>all<sp/>the<sp/>duration<sp/>of<sp/>the<sp/>call.<sp/>This<sp/>function<sp/>returns<sp/>its<sp/>value<sp/>at<sp/>the<sp/>time<sp/>of<sp/>the<sp/>function<sp/>call.
<sp/>*<sp/>It<sp/>is<sp/>expected<sp/>that<sp/>the<sp/>rating<sp/>is<sp/>updated<sp/>at<sp/>least<sp/>every<sp/>5<sp/>seconds<sp/>or<sp/>so.
<sp/>*<sp/>The<sp/>rating<sp/>is<sp/>a<sp/>floating<sp/>point<sp/>number<sp/>comprised<sp/>between<sp/>0<sp/>and<sp/>5.
<sp/>*
<sp/>*<sp/>4-5<sp/>=<sp/>good<sp/>quality<sp/>&lt;br&gt;
<sp/>*<sp/>3-4<sp/>=<sp/>average<sp/>quality<sp/>&lt;br&gt;
<sp/>*<sp/>2-3<sp/>=<sp/>poor<sp/>quality<sp/>&lt;br&gt;
<sp/>*<sp/>1-2<sp/>=<sp/>very<sp/>poor<sp/>quality<sp/>&lt;br&gt;
<sp/>*<sp/>0-1<sp/>=<sp/>can&apos;t<sp/>be<sp/>worse,<sp/>mostly<sp/>unusable<sp/>&lt;br&gt;
<sp/>*
<sp/>*<sp/>@return<sp/>The<sp/>function<sp/>returns<sp/>-1<sp/>if<sp/>no<sp/>quality<sp/>measurement<sp/>is<sp/>available,<sp/>for<sp/>example<sp/>if<sp/>no
<sp/>*<sp/>active<sp/>audio<sp/>stream<sp/>exist.<sp/>Otherwise<sp/>it<sp/>returns<sp/>the<sp/>quality<sp/>rating.
**/
float<sp/>sephone_call_get_current_quality(SephoneCall<sp/>*call){
<sp/><sp/><sp/>float<sp/>audio_rating=-1;
<sp/>float<sp/>video_rating=-1;
<sp/>float<sp/>result;
<sp/><sp/>if<sp/>(call-&gt;audiostream){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_rating=media_stream_get_quality_rating((MediaStream*)call-&gt;audiostream)/5.0;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_rating=media_stream_get_quality_rating((MediaStream*)call-&gt;videostream)/5.0;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(audio_rating&lt;0<sp/>&amp;&amp;<sp/>video_rating&lt;0)<sp/>result=-1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(audio_rating&lt;0)<sp/>result=video_rating*5.0;
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(video_rating&lt;0)<sp/>result=audio_rating*5.0;
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>result=audio_rating*video_rating*5.0;
<sp/><sp/><sp/><sp/><sp/>return<sp/>result;
}

/**
<sp/>*<sp/>Returns<sp/>call<sp/>quality<sp/>averaged<sp/>over<sp/>all<sp/>the<sp/>duration<sp/>of<sp/>the<sp/>call.
<sp/>*
<sp/>*<sp/>See<sp/>sephone_call_get_current_quality()<sp/>for<sp/>more<sp/>details<sp/>about<sp/>quality<sp/>measurement.
**/
float<sp/>sephone_call_get_average_quality(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>audio_stream_get_average_quality_rating(call-&gt;audiostream);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>-1;
}

static<sp/>void<sp/>update_local_stats(SephoneCallStats<sp/>*stats,<sp/>MediaStream<sp/>*stream){
<sp/><sp/><sp/><sp/>const<sp/>MSQualityIndicator<sp/>*qi=media_stream_get_quality_indicator(stream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(qi)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;local_late_rate=ms_quality_indicator_get_local_late_rate(qi);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;local_loss_rate=ms_quality_indicator_get_local_loss_rate(qi);
<sp/><sp/><sp/>}
}

/**
<sp/>*<sp/>Access<sp/>last<sp/>known<sp/>statistics<sp/>for<sp/>audio<sp/>stream,<sp/>for<sp/>a<sp/>given<sp/>call.
**/
const<sp/>SephoneCallStats<sp/>*sephone_call_get_audio_stats(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/><sp/>SephoneCallStats<sp/>*stats=&amp;call-&gt;stats[SEPHONE_CALL_STATS_AUDIO];
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_local_stats(stats,(MediaStream*)call-&gt;audiostream);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>stats;
}

/**
<sp/>*<sp/>Access<sp/>last<sp/>known<sp/>statistics<sp/>for<sp/>video<sp/>stream,<sp/>for<sp/>a<sp/>given<sp/>call.
**/
const<sp/>SephoneCallStats<sp/>*sephone_call_get_video_stats(SephoneCall<sp/>*call)<sp/>{
<sp/>SephoneCallStats<sp/>*stats=&amp;call-&gt;stats[SEPHONE_CALL_STATS_VIDEO];
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_local_stats(stats,(MediaStream*)call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>stats;
}

static<sp/>bool_t<sp/>ice_in_progress(SephoneCallStats<sp/>*stats){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>stats-&gt;ice_state==SephoneIceStateInProgress;
}

/**
<sp/>*<sp/>Indicates<sp/>whether<sp/>an<sp/>operation<sp/>is<sp/>in<sp/>progress<sp/>at<sp/>the<sp/>media<sp/>side.
<sp/>*<sp/>It<sp/>can<sp/>a<sp/>bad<sp/>idea<sp/>to<sp/>initiate<sp/>signaling<sp/>operations<sp/>(adding<sp/>video,<sp/>pausing<sp/>the<sp/>call,<sp/>removing<sp/>video,<sp/>changing<sp/>video<sp/>parameters)<sp/>while
<sp/>*<sp/>the<sp/>media<sp/>is<sp/>busy<sp/>in<sp/>establishing<sp/>the<sp/>connection<sp/>(typically<sp/>ICE<sp/>connectivity<sp/>checks).<sp/>It<sp/>can<sp/>result<sp/>in<sp/>failures<sp/>generating<sp/>loss<sp/>of<sp/>time
<sp/>*<sp/>in<sp/>future<sp/>operations<sp/>in<sp/>the<sp/>call.
<sp/>*<sp/>Applications<sp/>are<sp/>invited<sp/>to<sp/>check<sp/>this<sp/>function<sp/>after<sp/>each<sp/>call<sp/>state<sp/>change<sp/>to<sp/>decide<sp/>whether<sp/>certain<sp/>operations<sp/>are<sp/>permitted<sp/>or<sp/>not.
<sp/>*<sp/>@param<sp/>call<sp/>the<sp/>call
<sp/>*<sp/>@return<sp/>TRUE<sp/>if<sp/>media<sp/>is<sp/>busy<sp/>in<sp/>establishing<sp/>the<sp/>connection,<sp/>FALSE<sp/>otherwise.
**/
bool_t<sp/>sephone_call_media_in_progress(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>ret=FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_in_progress(&amp;call-&gt;stats[SEPHONE_CALL_STATS_AUDIO])<sp/>||<sp/>ice_in_progress(&amp;call-&gt;stats[SEPHONE_CALL_STATS_VIDEO]))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/>/*TODO:<sp/>could<sp/>check<sp/>zrtp<sp/>state,<sp/>upnp<sp/>state*/
<sp/><sp/><sp/>return<sp/>ret;
}

/**
<sp/>*<sp/>Get<sp/>the<sp/>local<sp/>loss<sp/>rate<sp/>since<sp/>last<sp/>report
<sp/>*<sp/>@return<sp/>The<sp/>sender<sp/>loss<sp/>rate
**/
float<sp/>sephone_call_stats_get_sender_loss_rate(const<sp/>SephoneCallStats<sp/>*stats)<sp/>{
<sp/><sp/><sp/><sp/><sp/>const<sp/>report_block_t<sp/>*srb<sp/>=<sp/>NULL;

<sp/><sp/><sp/><sp/><sp/>if<sp/>(!stats<sp/>||<sp/>!stats-&gt;sent_rtcp)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>/*<sp/>Perform<sp/>msgpullup()<sp/>to<sp/>prevent<sp/>crashes<sp/>in<sp/>rtcp_is_SR()<sp/>or<sp/>rtcp_is_RR()<sp/>if<sp/>the<sp/>RTCP<sp/>packet<sp/>is<sp/>composed<sp/>of<sp/>several<sp/>mblk_t<sp/>structure<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;sent_rtcp-&gt;b_cont<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msgpullup(stats-&gt;sent_rtcp,<sp/>-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(rtcp_is_SR(stats-&gt;sent_rtcp))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>srb<sp/>=<sp/>rtcp_SR_get_report_block(stats-&gt;sent_rtcp,<sp/>0);
<sp/><sp/><sp/>else<sp/>if<sp/>(rtcp_is_RR(stats-&gt;sent_rtcp))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>srb<sp/>=<sp/>rtcp_RR_get_report_block(stats-&gt;sent_rtcp,<sp/>0);
<sp/><sp/><sp/>if<sp/>(!srb)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>return<sp/>100.0<sp/>*<sp/>report_block_get_fraction_lost(srb)<sp/>/<sp/>256.0;
}

/**
<sp/>*<sp/>Gets<sp/>the<sp/>remote<sp/>reported<sp/>loss<sp/>rate<sp/>since<sp/>last<sp/>report
<sp/>*<sp/>@return<sp/>The<sp/>receiver<sp/>loss<sp/>rate
**/
float<sp/>sephone_call_stats_get_receiver_loss_rate(const<sp/>SephoneCallStats<sp/>*stats)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>report_block_t<sp/>*rrb<sp/>=<sp/>NULL;

<sp/><sp/><sp/><sp/><sp/>if<sp/>(!stats<sp/>||<sp/>!stats-&gt;received_rtcp)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>/*<sp/>Perform<sp/>msgpullup()<sp/>to<sp/>prevent<sp/>crashes<sp/>in<sp/>rtcp_is_SR()<sp/>or<sp/>rtcp_is_RR()<sp/>if<sp/>the<sp/>RTCP<sp/>packet<sp/>is<sp/>composed<sp/>of<sp/>several<sp/>mblk_t<sp/>structure<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;received_rtcp-&gt;b_cont<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msgpullup(stats-&gt;received_rtcp,<sp/>-1);
<sp/><sp/><sp/>if<sp/>(rtcp_is_RR(stats-&gt;received_rtcp))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rrb<sp/>=<sp/>rtcp_RR_get_report_block(stats-&gt;received_rtcp,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(rtcp_is_SR(stats-&gt;received_rtcp))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rrb<sp/>=<sp/>rtcp_SR_get_report_block(stats-&gt;received_rtcp,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!rrb)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>return<sp/>100.0<sp/>*<sp/>report_block_get_fraction_lost(rrb)<sp/>/<sp/>256.0;
}

/**
<sp/>*<sp/>Gets<sp/>the<sp/>local<sp/>interarrival<sp/>jitter
<sp/>*<sp/>@return<sp/>The<sp/>interarrival<sp/>jitter<sp/>at<sp/>last<sp/>emitted<sp/>sender<sp/>report
**/
float<sp/>sephone_call_stats_get_sender_interarrival_jitter(const<sp/>SephoneCallStats<sp/>*stats,<sp/>SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>SephoneCallParams<sp/>*params;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>PayloadType<sp/>*pt;
<sp/>const<sp/>report_block_t<sp/>*srb<sp/>=<sp/>NULL;

<sp/><sp/><sp/><sp/><sp/>if<sp/>(!stats<sp/>||<sp/>!call<sp/>||<sp/>!stats-&gt;sent_rtcp)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>params<sp/>=<sp/>sephone_call_get_current_params(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!params)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>/*<sp/>Perform<sp/>msgpullup()<sp/>to<sp/>prevent<sp/>crashes<sp/>in<sp/>rtcp_is_SR()<sp/>or<sp/>rtcp_is_RR()<sp/>if<sp/>the<sp/>RTCP<sp/>packet<sp/>is<sp/>composed<sp/>of<sp/>several<sp/>mblk_t<sp/>structure<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;sent_rtcp-&gt;b_cont<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msgpullup(stats-&gt;sent_rtcp,<sp/>-1);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(rtcp_is_SR(stats-&gt;sent_rtcp))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>srb<sp/>=<sp/>rtcp_SR_get_report_block(stats-&gt;sent_rtcp,<sp/>0);
<sp/><sp/><sp/>else<sp/>if<sp/>(rtcp_is_RR(stats-&gt;sent_rtcp))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>srb<sp/>=<sp/>rtcp_RR_get_report_block(stats-&gt;sent_rtcp,<sp/>0);
<sp/><sp/><sp/>if<sp/>(!srb)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;type<sp/>==<sp/>SEPHONE_CALL_STATS_AUDIO)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/>sephone_call_params_get_used_audio_codec(params);
<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/>sephone_call_params_get_used_video_codec(params);
<sp/>if<sp/>(!pt<sp/>||<sp/>(pt-&gt;clock_rate<sp/>==<sp/>0))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>return<sp/>(float)report_block_get_interarrival_jitter(srb)<sp/>/<sp/>(float)pt-&gt;clock_rate;
}

/**
<sp/>*<sp/>Gets<sp/>the<sp/>remote<sp/>reported<sp/>interarrival<sp/>jitter
<sp/>*<sp/>@return<sp/>The<sp/>interarrival<sp/>jitter<sp/>at<sp/>last<sp/>received<sp/>receiver<sp/>report
**/
float<sp/>sephone_call_stats_get_receiver_interarrival_jitter(const<sp/>SephoneCallStats<sp/>*stats,<sp/>SephoneCall<sp/>*call)<sp/>{
<sp/><sp/>const<sp/>SephoneCallParams<sp/>*params;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>PayloadType<sp/>*pt;
<sp/>const<sp/>report_block_t<sp/>*rrb<sp/>=<sp/>NULL;

<sp/><sp/><sp/><sp/><sp/>if<sp/>(!stats<sp/>||<sp/>!call<sp/>||<sp/>!stats-&gt;received_rtcp)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>params<sp/>=<sp/>sephone_call_get_current_params(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!params)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>/*<sp/>Perform<sp/>msgpullup()<sp/>to<sp/>prevent<sp/>crashes<sp/>in<sp/>rtcp_is_SR()<sp/>or<sp/>rtcp_is_RR()<sp/>if<sp/>the<sp/>RTCP<sp/>packet<sp/>is<sp/>composed<sp/>of<sp/>several<sp/>mblk_t<sp/>structure<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;received_rtcp-&gt;b_cont<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msgpullup(stats-&gt;received_rtcp,<sp/>-1);
<sp/><sp/><sp/>if<sp/>(rtcp_is_SR(stats-&gt;received_rtcp))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rrb<sp/>=<sp/>rtcp_SR_get_report_block(stats-&gt;received_rtcp,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(rtcp_is_RR(stats-&gt;received_rtcp))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rrb<sp/>=<sp/>rtcp_RR_get_report_block(stats-&gt;received_rtcp,<sp/>0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!rrb)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;type<sp/>==<sp/>SEPHONE_CALL_STATS_AUDIO)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/>sephone_call_params_get_used_audio_codec(params);
<sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/>sephone_call_params_get_used_video_codec(params);
<sp/>if<sp/>(!pt<sp/>||<sp/>(pt-&gt;clock_rate<sp/>==<sp/>0))
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0.0;
<sp/><sp/><sp/><sp/>return<sp/>(float)report_block_get_interarrival_jitter(rrb)<sp/>/<sp/>(float)pt-&gt;clock_rate;
}

/**
<sp/>*<sp/>Gets<sp/>the<sp/>cumulative<sp/>number<sp/>of<sp/>late<sp/>packets
<sp/>*<sp/>@return<sp/>The<sp/>cumulative<sp/>number<sp/>of<sp/>late<sp/>packets
**/
uint64_t<sp/>sephone_call_stats_get_late_packets_cumulative_number(const<sp/>SephoneCallStats<sp/>*stats,<sp/>SephoneCall<sp/>*call)<sp/>{
<sp/><sp/>rtp_stats_t<sp/>rtp_stats;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!stats<sp/>||<sp/>!call)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;rtp_stats,<sp/>0,<sp/>sizeof(rtp_stats));
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;type<sp/>==<sp/>SEPHONE_CALL_STATS_AUDIO<sp/>&amp;&amp;<sp/>call-&gt;audiostream<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_get_local_rtp_stats(call-&gt;audiostream,<sp/>&amp;rtp_stats);
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/>else<sp/>if<sp/>(call-&gt;videostream<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_get_local_rtp_stats(call-&gt;videostream,<sp/>&amp;rtp_stats);
#endif
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>rtp_stats.outoftime;
}

/**
<sp/>*<sp/>Get<sp/>the<sp/>bandwidth<sp/>measurement<sp/>of<sp/>the<sp/>received<sp/>stream,<sp/>expressed<sp/>in<sp/>kbit/s,<sp/>including<sp/>IP/UDP/RTP<sp/>headers.
<sp/>*<sp/>@param[in]<sp/>stats<sp/>SephoneCallStats<sp/>object
<sp/>*<sp/>@return<sp/>The<sp/>bandwidth<sp/>measurement<sp/>of<sp/>the<sp/>received<sp/>stream<sp/>in<sp/>kbit/s.
<sp/>*/
float<sp/>sephone_call_stats_get_download_bandwidth(const<sp/>SephoneCallStats<sp/>*stats)<sp/>{
<sp/>return<sp/>stats-&gt;download_bandwidth;
}

/**
<sp/>*<sp/>Get<sp/>the<sp/>bandwidth<sp/>measurement<sp/>of<sp/>the<sp/>sent<sp/>stream,<sp/>expressed<sp/>in<sp/>kbit/s,<sp/>including<sp/>IP/UDP/RTP<sp/>headers.
<sp/>*<sp/>@param[in]<sp/>stats<sp/>SephoneCallStats<sp/>object
<sp/>*<sp/>@return<sp/>The<sp/>bandwidth<sp/>measurement<sp/>of<sp/>the<sp/>sent<sp/>stream<sp/>in<sp/>kbit/s.
<sp/>*/
float<sp/>sephone_call_stats_get_upload_bandwidth(const<sp/>SephoneCallStats<sp/>*stats)<sp/>{
<sp/><sp/><sp/><sp/><sp/>return<sp/>stats-&gt;upload_bandwidth;
}

/**
<sp/>*<sp/>Get<sp/>the<sp/>state<sp/>of<sp/>ICE<sp/>processing.
<sp/>*<sp/>@param[in]<sp/>stats<sp/>SephoneCallStats<sp/>object
<sp/>*<sp/>@return<sp/>The<sp/>state<sp/>of<sp/>ICE<sp/>processing.
<sp/>*/
SephoneIceState<sp/>sephone_call_stats_get_ice_state(const<sp/>SephoneCallStats<sp/>*stats)<sp/>{
<sp/><sp/><sp/>return<sp/>stats-&gt;ice_state;
}

/**
<sp/>*<sp/>Get<sp/>the<sp/>state<sp/>of<sp/>uPnP<sp/>processing.
<sp/>*<sp/>@param[in]<sp/>stats<sp/>SephoneCallStats<sp/>object
<sp/>*<sp/>@return<sp/>The<sp/>state<sp/>of<sp/>uPnP<sp/>processing.
<sp/>*/
SephoneUpnpState<sp/>sephone_call_stats_get_upnp_state(const<sp/>SephoneCallStats<sp/>*stats)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>stats-&gt;upnp_state;
}

/**
<sp/>*<sp/>Start<sp/>call<sp/>recording.
<sp/>*<sp/>The<sp/>output<sp/>file<sp/>where<sp/>audio<sp/>is<sp/>recorded<sp/>must<sp/>be<sp/>previously<sp/>specified<sp/>with<sp/>sephone_call_params_set_record_file().
**/
void<sp/>sephone_call_start_recording(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!call-&gt;params-&gt;record_file){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(&quot;sephone_call_start_recording():<sp/>no<sp/>output<sp/>file<sp/>specified.<sp/>Use<sp/>sephone_call_params_set_record_file().&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>.wav/.mkv
<sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>!call-&gt;params-&gt;in_conference){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_mixed_record_start(call-&gt;audiostream);
<sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>.h264
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>!call-&gt;params-&gt;in_conference){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_record_start(call-&gt;videostream,<sp/>call-&gt;params-&gt;record_file);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;record_active=TRUE;
}

/**
<sp/>*<sp/>Stop<sp/>call<sp/>recording.
**/
void<sp/>sephone_call_stop_recording(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>!call-&gt;params-&gt;in_conference){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_mixed_record_stop(call-&gt;audiostream);
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>!call-&gt;params-&gt;in_conference){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_record_stop(call-&gt;videostream);
<sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;record_active=FALSE;
}

/**
<sp/>*<sp/>@}
**/

static<sp/>void<sp/>report_bandwidth(SephoneCall<sp/>*call,<sp/>MediaStream<sp/>*as,<sp/>MediaStream<sp/>*vs){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>as_active<sp/>=<sp/>as<sp/>?<sp/>(media_stream_get_state(as)<sp/>==<sp/>MSStreamStarted)<sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>vs_active<sp/>=<sp/>vs<sp/>?<sp/>(media_stream_get_state(vs)<sp/>==<sp/>MSStreamStarted)<sp/>:<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>rtp_stats_t<sp/>*as_stats<sp/>=<sp/>as_active<sp/>?<sp/>rtp_session_get_stats(as-&gt;sessions.rtp_session)<sp/>:<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>rtp_stats_t<sp/>*vs_stats<sp/>=<sp/>vs_active<sp/>?<sp/>rtp_session_get_stats(vs-&gt;sessions.rtp_session)<sp/>:<sp/>NULL;

<sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_sent=(as_active)<sp/>?<sp/>as_stats-&gt;packet_sent<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_recv=(as_active)<sp/>?<sp/>as_stats-&gt;packet_recv<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].download_bandwidth=(as_active)<sp/>?<sp/>(media_stream_get_down_bw(as)*1e-3)<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].upload_bandwidth=(as_active)<sp/>?<sp/>(media_stream_get_up_bw(as)*1e-3)<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_download_bandwidth=(as_active)<sp/>?<sp/>(media_stream_get_rtcp_down_bw(as)*1e-3)<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_upload_bandwidth=(as_active)<sp/>?<sp/>(media_stream_get_rtcp_up_bw(as)*1e-3)<sp/>:<sp/>0;
<sp/><sp/>if<sp/>(as_active)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].updated|=SEPHONE_CALL_STATS_PERIODICAL_UPDATE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_stats_updated(call-&gt;core,<sp/>call,<sp/>&amp;call-&gt;stats[SEPHONE_CALL_STATS_AUDIO]);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].updated=0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_sent=(vs_active)<sp/>?<sp/>vs_stats-&gt;packet_sent<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_recv=(vs_active)<sp/>?<sp/>vs_stats-&gt;packet_recv<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].download_bandwidth=(vs_active)<sp/>?<sp/>(media_stream_get_down_bw(vs)*1e-3)<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].upload_bandwidth=(vs_active)<sp/>?<sp/>(media_stream_get_up_bw(vs)*1e-3)<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_download_bandwidth=(vs_active)<sp/>?<sp/>(media_stream_get_rtcp_down_bw(vs)*1e-3)<sp/>:<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_upload_bandwidth=(vs_active)<sp/>?<sp/>(media_stream_get_rtcp_up_bw(vs)*1e-3)<sp/>:<sp/>0;
<sp/><sp/>if<sp/>(vs_active)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].updated|=SEPHONE_CALL_STATS_PERIODICAL_UPDATE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_stats_updated(call-&gt;core,<sp/>call,<sp/>&amp;call-&gt;stats[SEPHONE_CALL_STATS_VIDEO]);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].updated=0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

#ifdef<sp/>_WIN32
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(<sp/><sp/><sp/><sp/><sp/>&quot;Bandwidth<sp/>usage<sp/>for<sp/>call<sp/>[%p]:\r\n&quot;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;\tRTP<sp/><sp/>audio=[r=%8&quot;PRId64&quot;,s=%8&quot;PRId64&quot;],<sp/>video=[r=%8&quot;PRId64&quot;,s=%8&quot;PRId64&quot;]<sp/>packets\r\n&quot;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;\tRTP<sp/><sp/>audio=[d=%8.1f,u=%8.1f],<sp/>video=[d=%8.1f,u=%8.1f]<sp/>kbits/sec&quot;,
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;\tRTCP<sp/>audio=[d=%8.1f,u=%8.1f],<sp/>video=[d=%8.1f,u=%8.1f]<sp/>kbits/sec&quot;,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_recv,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_sent,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_recv,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_sent,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].download_bandwidth,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].upload_bandwidth,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].download_bandwidth,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].upload_bandwidth
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_download_bandwidth,
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_upload_bandwidth,
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_download_bandwidth,
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_upload_bandwidth
<sp/><sp/><sp/><sp/>);
#else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(<sp/><sp/><sp/><sp/><sp/>&quot;Bandwidth<sp/>usage<sp/>for<sp/>call<sp/>[%p]:\n&quot;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;\tRTP<sp/><sp/>audio=[r=%8&quot;PRId64&quot;,s=%8&quot;PRId64&quot;],<sp/>video=[r=%8&quot;PRId64&quot;,s=%8&quot;PRId64&quot;]<sp/>packets\n&quot;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;\tRTP<sp/><sp/>audio=[d=%8.1f,u=%8.1f],<sp/>video=[d=%8.1f,u=%8.1f]<sp/>kbits/sec&quot;,
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;\tRTCP<sp/>audio=[d=%8.1f,u=%8.1f],<sp/>video=[d=%8.1f,u=%8.1f]<sp/>kbits/sec&quot;,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_recv,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_sent,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_recv,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_sent,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].download_bandwidth,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].upload_bandwidth,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].download_bandwidth,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].upload_bandwidth
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_download_bandwidth,
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_upload_bandwidth,
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_download_bandwidth,
//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_upload_bandwidth
<sp/><sp/><sp/><sp/>);
#endif
}

static<sp/>void<sp/>sephone_core_disconnected(SephoneCore<sp/>*lc,<sp/>SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>char<sp/>temp[256]={0};
<sp/><sp/><sp/><sp/>char<sp/>*from=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();

<sp/><sp/><sp/><sp/>from<sp/>=<sp/>sephone_call_get_remote_address_as_string(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snprintf(temp,sizeof(temp)-1,&quot;Remote<sp/>end<sp/>%s<sp/>seems<sp/>to<sp/>have<sp/>disconnected,<sp/>the<sp/>call<sp/>is<sp/>going<sp/>to<sp/>be<sp/>closed.&quot;,from<sp/>?<sp/>from<sp/>:<sp/>&quot;&quot;);
<sp/><sp/><sp/><sp/>if<sp/>(from)<sp/>ms_free(from);

<sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;On<sp/>call<sp/>[%p]:<sp/>%s&quot;,call,temp);
<sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_display_warning(lc,temp);
<sp/><sp/>sephone_core_terminate_call(lc,call);
<sp/><sp/>sephone_core_play_named_tone(lc,SephoneToneCallLost);
}

static<sp/>void<sp/>change_ice_media_destinations(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/>const<sp/>char<sp/>*rtp_addr;
<sp/><sp/><sp/><sp/>const<sp/>char<sp/>*rtcp_addr;
<sp/><sp/><sp/><sp/>int<sp/>rtp_port;
<sp/><sp/><sp/><sp/>int<sp/>rtcp_port;
<sp/><sp/><sp/><sp/>bool_t<sp/>result;
<sp/><sp/><sp/>ms_func();

<sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>ice_session_check_list(call-&gt;ice_session,<sp/>0))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>=<sp/>ice_check_list_selected_valid_remote_candidate(ice_session_check_list(call-&gt;ice_session,<sp/>0),<sp/>&amp;rtp_addr,<sp/>&amp;rtp_port,<sp/>&amp;rtcp_addr,<sp/>&amp;rtcp_port);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(result<sp/>==<sp/>TRUE)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Change<sp/>audio<sp/>stream<sp/>destination:<sp/>RTP=%s:%d<sp/>RTCP=%s:%d&quot;,<sp/>rtp_addr,<sp/>rtp_port,<sp/>rtcp_addr,<sp/>rtcp_port);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_symmetric_rtp(call-&gt;audiostream-&gt;ms.sessions.rtp_session,<sp/>FALSE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_remote_addr_full(call-&gt;audiostream-&gt;ms.sessions.rtp_session,<sp/>rtp_addr,<sp/>rtp_port,<sp/>rtcp_addr,<sp/>rtcp_port);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/>}
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>ice_session_check_list(call-&gt;ice_session,<sp/>1))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>=<sp/>ice_check_list_selected_valid_remote_candidate(ice_session_check_list(call-&gt;ice_session,<sp/>1),<sp/>&amp;rtp_addr,<sp/>&amp;rtp_port,<sp/>&amp;rtcp_addr,<sp/>&amp;rtcp_port);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(result<sp/>==<sp/>TRUE)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Change<sp/>video<sp/>stream<sp/>destination:<sp/>RTP=%s:%d<sp/>RTCP=%s:%d&quot;,<sp/>rtp_addr,<sp/>rtp_port,<sp/>rtcp_addr,<sp/>rtcp_port);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_symmetric_rtp(call-&gt;videostream-&gt;ms.sessions.rtp_session,<sp/>FALSE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_remote_addr_full(call-&gt;videostream-&gt;ms.sessions.rtp_session,<sp/>rtp_addr,<sp/>rtp_port,<sp/>rtcp_addr,<sp/>rtcp_port);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/>}
#endif
}

static<sp/>void<sp/>handle_ice_events(SephoneCall<sp/>*call,<sp/>OrtpEvent<sp/>*ev){
<sp/><sp/>OrtpEventType<sp/>evt=ortp_event_get_type(ev);
<sp/><sp/><sp/><sp/><sp/>OrtpEventData<sp/>*evd=ortp_event_get_data(ev);
<sp/><sp/><sp/><sp/>int<sp/>ping_time;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Handle<sp/>ice<sp/>event<sp/>%d&quot;,<sp/>evt);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_SESSION_PROCESSING_FINISHED)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SephoneCallParams<sp/>*params<sp/>=<sp/>sephone_call_params_copy(call-&gt;current_params);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch<sp/>(call-&gt;params-&gt;media_encryption)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneMediaEncryptionZRTP:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneMediaEncryptionDTLS:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>preserve<sp/>media<sp/>encryption<sp/>param<sp/>because<sp/>at<sp/>that<sp/>time<sp/>ZRTP/SRTP-DTLS<sp/>negociation<sp/>may<sp/>still<sp/>be<sp/>ongoing*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;media_encryption=call-&gt;params-&gt;media_encryption;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneMediaEncryptionSRTP:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneMediaEncryptionNone:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*keep<sp/>all<sp/>values<sp/>to<sp/>make<sp/>sure<sp/>a<sp/>warning<sp/>will<sp/>be<sp/>generated<sp/>by<sp/>compiler<sp/>if<sp/>new<sp/>enum<sp/>value<sp/>is<sp/>added*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch<sp/>(ice_session_state(call-&gt;ice_session))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IS_Completed:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_select_candidates(call-&gt;ice_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_session_role(call-&gt;ice_session)<sp/>==<sp/>IR_Controlling
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>sp_config_get_int(call-&gt;core-&gt;config,<sp/>&quot;sip&quot;,<sp/>&quot;update_call_when_ice_completed&quot;,<sp/>TRUE))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;internal_call_update<sp/>=<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//XXX<sp/>xr<sp/>2015-7-22<sp/>call
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sephone_core_update_call(call-&gt;core,<sp/>call,<sp/>params)!=0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>change_ice_media_destinations(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_dtls_on_all_streams(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>IS_Failed:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_session_has_completed_check_list(call-&gt;ice_session)<sp/>==<sp/>TRUE)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_select_candidates(call-&gt;ice_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_session_role(call-&gt;ice_session)<sp/>==<sp/>IR_Controlling)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>At<sp/>least<sp/>one<sp/>ICE<sp/>session<sp/>has<sp/>succeeded,<sp/>so<sp/>perform<sp/>a<sp/>call<sp/>update.<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;internal_call_update<sp/>=<sp/>TRUE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_call(call-&gt;core,<sp/>call,<sp/>params);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>default:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_ice_state_in_call_stats(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_params_unref(params);
<sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_GATHERING_FINISHED)<sp/>{

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(evd-&gt;info.ice_processing_successful==TRUE)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_compute_candidates_foundations(call-&gt;ice_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_eliminate_redundant_candidates(call-&gt;ice_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_choose_default_candidates(call-&gt;ice_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ping_time<sp/>=<sp/>ice_session_average_gathering_round_trip_time(call-&gt;ice_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ping_time<sp/>&gt;=0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ping_time=ping_time;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
/*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;state<sp/>==<sp/>SephoneCallStreamsRunning)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>sephone_call_start_media_streams()
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>sephone_core_start_accept_call_update()
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_start_connectivity_checks(call-&gt;ice_session);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*lmd;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_message_t<sp/>*ice_msg;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*body;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;ice_session-&gt;lite)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>==<sp/>NULL<sp/>||<sp/>call-&gt;audiostream-&gt;ms.sessions.rtp_session<sp/>==<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lmd<sp/>=<sp/>sephone_call_make_media_description(call-&gt;core,<sp/>call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((lmd-&gt;ice_pwd[0]<sp/>!=<sp/>&apos;\0&apos;)<sp/>&amp;&amp;<sp/>(lmd-&gt;ice_ufrag[0]<sp/>!=<sp/>&apos;\0&apos;))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lmd-&gt;ice_lite<sp/>=<sp/>TRUE;<sp/>//<sp/>ice
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_msg<sp/>=<sp/>sal_create_sdp_from_desc(lmd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_msg<sp/>==<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;Create<sp/>sdp<sp/>for<sp/>audio<sp/>failed&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>body<sp/>=<sp/>belle_sip_message_get_body(ice_msg);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_send_sip_message(call-&gt;audiostream-&gt;ms.sessions.rtp_session,<sp/>body);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_object_unref(ice_msg);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_media_description_unref(lmd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while<sp/>(FALSE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;No<sp/>STUN<sp/>answer<sp/>from<sp/>[%s],<sp/>disabling<sp/>ICE&quot;,sephone_core_get_stun_server(call-&gt;core));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_delete_ice_session(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch<sp/>(call-&gt;state)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneCallUpdating:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_start_update_call(call-&gt;core,<sp/>call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneCallUpdatedByRemote:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_start_accept_call_update(call-&gt;core,<sp/>call,call-&gt;prevstate,sephone_call_state_to_string(call-&gt;prevstate));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneCallOutgoingInit:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_media_streams_for_ice_gathering(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_proceed_with_invite_if_ready(call-&gt;core,<sp/>call,<sp/>NULL);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneCallIdle:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_media_streams_for_ice_gathering(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_update_local_media_description_from_ice_or_upnp(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_call_set_local_media_description(call-&gt;op,call-&gt;localdesc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_incoming_call(call-&gt;core,<sp/>call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>default:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_LOSING_PAIRS_COMPLETED)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;state==SephoneCallUpdatedByRemote){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_start_accept_call_update(call-&gt;core,<sp/>call,call-&gt;prevstate,sephone_call_state_to_string(call-&gt;prevstate));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_ice_state_in_call_stats(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_RESTART_NEEDED)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_restart(call-&gt;ice_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_set_role(call-&gt;ice_session,<sp/>IR_Controlling);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_call(call-&gt;core,<sp/>call,<sp/>call-&gt;current_params);
<sp/><sp/><sp/><sp/><sp/><sp/>}
}


/*do<sp/>not<sp/>change<sp/>the<sp/>prototype<sp/>of<sp/>this<sp/>function,<sp/>it<sp/>is<sp/>also<sp/>used<sp/>internally<sp/>in<sp/>linphone-daemon.*/
void<sp/>sephone_call_stats_fill(SephoneCallStats<sp/>*stats,<sp/>MediaStream<sp/>*ms,<sp/>OrtpEvent<sp/>*ev){
<sp/><sp/>OrtpEventType<sp/>evt=ortp_event_get_type(ev);
<sp/><sp/><sp/><sp/><sp/>OrtpEventData<sp/>*evd=ortp_event_get_data(ev);

<sp/><sp/><sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_RTCP_PACKET_RECEIVED)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;round_trip_delay<sp/>=<sp/>rtp_session_get_round_trip_propagation(ms-&gt;sessions.rtp_session);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if(stats-&gt;received_rtcp<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freemsg(stats-&gt;received_rtcp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;received_rtcp<sp/>=<sp/>evd-&gt;packet;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>evd-&gt;packet<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;updated<sp/>=<sp/>SEPHONE_CALL_STATS_RECEIVED_RTCP_UPDATE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_local_stats(stats,ms);
<sp/><sp/>}<sp/>else<sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_RTCP_PACKET_EMITTED)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;stats-&gt;jitter_stats,<sp/>rtp_session_get_jitter_stats(ms-&gt;sessions.rtp_session),<sp/>sizeof(jitter_stats_t));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;sent_rtcp<sp/>!=<sp/>NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freemsg(stats-&gt;sent_rtcp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;sent_rtcp<sp/>=<sp/>evd-&gt;packet;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>evd-&gt;packet<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;updated<sp/>=<sp/>SEPHONE_CALL_STATS_SENT_RTCP_UPDATE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_local_stats(stats,ms);
<sp/><sp/>}
}

void<sp/>sephone_call_stats_uninit(SephoneCallStats<sp/>*stats){
<sp/><sp/>if<sp/>(stats-&gt;received_rtcp)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freemsg(stats-&gt;received_rtcp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;received_rtcp=NULL;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;sent_rtcp){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freemsg(stats-&gt;sent_rtcp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;sent_rtcp=NULL;
<sp/>}
}

void<sp/>sephone_call_notify_stats_updated(SephoneCall<sp/>*call,<sp/>int<sp/>stream_index){
<sp/><sp/><sp/><sp/><sp/><sp/>SephoneCallStats<sp/>*stats=&amp;call-&gt;stats[stream_index];
<sp/><sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;
<sp/><sp/><sp/><sp/>if<sp/>(stats-&gt;updated){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>switch(stats-&gt;updated)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SEPHONE_CALL_STATS_RECEIVED_RTCP_UPDATE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SEPHONE_CALL_STATS_SENT_RTCP_UPDATE:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_reporting_on_rtcp_update(call,<sp/>stream_index);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>default:break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_stats_updated(lc,<sp/>call,<sp/>stats);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;updated<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/>}
}

void<sp/>sephone_call_handle_stream_events(SephoneCall<sp/>*call,<sp/>int<sp/>stream_index){
<sp/><sp/><sp/><sp/><sp/><sp/>MediaStream<sp/>*ms=stream_index==0<sp/>?<sp/>(MediaStream<sp/>*)call-&gt;audiostream<sp/>:<sp/>(MediaStream<sp/>*)call-&gt;videostream;<sp/>/*assumption<sp/>to<sp/>remove*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEvQueue<sp/>*evq;
<sp/><sp/><sp/><sp/><sp/><sp/>OrtpEvent<sp/>*ev;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ms==NULL)<sp/>return;
<sp/><sp/>/*<sp/>Ensure<sp/>there<sp/>is<sp/>no<sp/>dangling<sp/>ICE<sp/>check<sp/>list.<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;ice_session<sp/>==<sp/>NULL)<sp/>ms-&gt;ice_check_list<sp/>=<sp/>NULL;

<sp/><sp/><sp/><sp/><sp/>switch(ms-&gt;type){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>AudioStreamType:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_iterate((AudioStream*)ms);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>VideoStreamType:
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_iterate((VideoStream*)ms);
#endif
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>default:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(&quot;sephone_call_handle_stream_events():<sp/>unsupported<sp/>stream<sp/>type.&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>/*yes<sp/>the<sp/>event<sp/>queue<sp/>has<sp/>to<sp/>be<sp/>taken<sp/>at<sp/>each<sp/>iteration,<sp/>because<sp/>ice<sp/>events<sp/>may<sp/>perform<sp/>operations<sp/>re-creating<sp/>the<sp/>streams*/
<sp/><sp/><sp/>while<sp/>((evq=stream_index==0<sp/>?<sp/>call-&gt;audiostream_app_evq<sp/>:<sp/>call-&gt;videostream_app_evq)<sp/><sp/>&amp;&amp;<sp/>(NULL<sp/>!=<sp/>(ev=ortp_ev_queue_get(evq)))){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEventType<sp/>evt=ortp_event_get_type(ev);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEventData<sp/>*evd=ortp_event_get_data(ev);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stats_fill(&amp;call-&gt;stats[stream_index],ms,ev);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_notify_stats_updated(call,stream_index);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ZRTP_ENCRYPTION_CHANGED){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ms-&gt;type==AudioStreamType)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_audiostream_encryption_changed(call,<sp/>evd-&gt;info.zrtp_stream_encrypted);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(ms-&gt;type==VideoStreamType)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>propagate_encryption_changed(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ZRTP_SAS_READY)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ms-&gt;type==AudioStreamType)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_audiostream_auth_token_ready(call,<sp/>evd-&gt;info.zrtp_sas.sas,<sp/>evd-&gt;info.zrtp_sas.verified);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_DTLS_ENCRYPTION_CHANGED)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ms-&gt;type==AudioStreamType)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_audiostream_encryption_changed(call,<sp/>evd-&gt;info.dtls_stream_encrypted);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(ms-&gt;type==VideoStreamType)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>propagate_encryption_changed(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>((evt<sp/>==<sp/>ORTP_EVENT_ICE_SESSION_PROCESSING_FINISHED)<sp/>||<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_GATHERING_FINISHED)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>||<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_LOSING_PAIRS_COMPLETED)<sp/>||<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_RESTART_NEEDED))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>handle_ice_events(call,<sp/>ev);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>(evt==ORTP_EVENT_TELEPHONE_EVENT)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_dtmf_received(call-&gt;core,evd-&gt;info.telephone_event);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>stunsip
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_STUN_SIP_COMMAND)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*rmd<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sdp_session_description_t<sp/>*sdp<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mblk_t<sp/>*m<sp/>=<sp/>ortp_event_get_data(ev)-&gt;packet;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sdp_session_name_t<sp/>*sname;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char*<sp/>value;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>check<sp/>=<sp/>0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sdp<sp/>=<sp/>sal_sdp_body_to_session((char*)m-&gt;b_rptr,<sp/>m-&gt;b_wptr-m-&gt;b_rptr);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sdp<sp/>==<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(&quot;Parse<sp/>sdp<sp/>session<sp/>description<sp/>failed&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sname<sp/>=<sp/>belle_sdp_session_description_get_session_name(sdp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value<sp/>=<sp/>belle_sdp_session_name_get_value(sname);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(value<sp/>==<sp/>NULL<sp/>||<sp/>value[0]<sp/>==<sp/>&apos;\0&apos;)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(strcmp(value,<sp/>&quot;Talk&quot;)<sp/>==<sp/>0)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char*<sp/>ice_ufrag<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char*<sp/>ice_pwd<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_ufrag<sp/>=<sp/>belle_sdp_session_description_get_attribute_value(sdp,<sp/>&quot;ice-ufrag&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_ufrag<sp/>==<sp/>NULL<sp/>||<sp/>ice_ufrag[0]<sp/>==<sp/>&apos;\0&apos;)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_pwd<sp/>=<sp/>belle_sdp_session_description_get_attribute_value(sdp,<sp/>&quot;ice-pwd&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_pwd<sp/>==<sp/>NULL<sp/>||<sp/>ice_pwd[0]<sp/>==<sp/>&apos;\0&apos;)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;ICE<sp/>session<sp/>is<sp/>already<sp/>running&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rmd<sp/>=<sp/>sal_media_description_new();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sdp_to_media_description(sdp,<sp/>rmd);

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice()/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ice_session<sp/>=<sp/>ice_session_new();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ice_session-&gt;lite<sp/>=<sp/>rmd-&gt;ice_lite;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_set_local_credentials(call-&gt;ice_session,<sp/>ice_ufrag,<sp/>ice_pwd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>For<sp/>backward<sp/>compatibility<sp/>purposes,<sp/>shall<sp/>be<sp/>enabled<sp/>by<sp/>default<sp/>in<sp/>future<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check<sp/>=<sp/>sp_config_get_int(call-&gt;core-&gt;config,&quot;net&quot;,&quot;ice_session_enable_message_integrity_check&quot;,0);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_enable_message_integrity_check(call-&gt;ice_session,<sp/>check);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_set_role(call-&gt;ice_session,<sp/>IR_Controlled);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>Handle<sp/>remote<sp/>ICE<sp/>attributes<sp/>if<sp/>any<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_update_ice_from_remote_media_description(call,<sp/>rmd,<sp/>TRUE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_prepare_ice(call,<sp/>FALSE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while<sp/>(FALSE);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(rmd<sp/>!=<sp/>NULL)<sp/>sal_media_description_unref(rmd);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sdp<sp/>!=<sp/>NULL)<sp/>belle_sip_object_unref(sdp);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>stun
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>if<sp/>(evt<sp/>==<sp/>ORTP_EVENT_STUN_USER_MESSAGE)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mblk_t*<sp/>m<sp/>=<sp/>ortp_event_get_data(ev)-&gt;packet;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>char*<sp/>msg<sp/>=<sp/>ms_strndup((const<sp/>char*)m-&gt;b_rptr,<sp/>m-&gt;b_wptr-m-&gt;b_rptr);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_umsg_received(call-&gt;core,<sp/>msg);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(msg);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_event_destroy(ev);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
}

void<sp/>sephone_call_background_tasks(SephoneCall<sp/>*call,<sp/>bool_t<sp/>one_second_elapsed){
<sp/>int<sp/>disconnect_timeout<sp/>=<sp/>sephone_core_get_nortp_timeout(call-&gt;core);
<sp/><sp/><sp/>bool_t<sp/>disconnected=FALSE;

<sp/><sp/><sp/><sp/>switch<sp/>(call-&gt;state)<sp/>{
<sp/>case<sp/>SephoneCallStreamsRunning:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneCallOutgoingEarlyMedia:
<sp/><sp/><sp/><sp/>case<sp/>SephoneCallIncomingEarlyMedia:
<sp/><sp/><sp/><sp/>case<sp/>SephoneCallPausedByRemote:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>case<sp/>SephoneCallPaused:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(one_second_elapsed){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>audio_load=0,<sp/>video_load=0;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream-&gt;ms.sessions.ticker)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_load=ms_ticker_get_average_load(call-&gt;audiostream-&gt;ms.sessions.ticker);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream-&gt;ms.sessions.ticker)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_load=ms_ticker_get_average_load(call-&gt;videostream-&gt;ms.sessions.ticker);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>report_bandwidth(call,(MediaStream*)call-&gt;audiostream,(MediaStream*)call-&gt;videostream);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Thread<sp/>processing<sp/>load:<sp/>audio=%f<sp/>video=%f&quot;,audio_load,video_load);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>default:
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*no<sp/>stats<sp/>for<sp/>other<sp/>states*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;
<sp/>}

#ifdef<sp/>BUILD_UPNP
<sp/><sp/><sp/>sephone_upnp_call_process(call);
#endif<sp/>//BUILD_UPNP

<sp/><sp/>sephone_call_handle_stream_events(call,0);
<sp/><sp/><sp/><sp/><sp/>sephone_call_handle_stream_events(call,1);
<sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;state==SephoneCallStreamsRunning<sp/>&amp;&amp;<sp/>one_second_elapsed<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ms.state==MSStreamStarted<sp/>&amp;&amp;<sp/>disconnect_timeout&gt;0<sp/>)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>disconnected=!audio_stream_alive(call-&gt;audiostream,disconnect_timeout);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(disconnected)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_disconnected(call-&gt;core,call);
}

void<sp/>sephone_call_log_completed(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/>SephoneCore<sp/>*lc=call-&gt;core;

<sp/><sp/><sp/>call-&gt;log-&gt;duration=sephone_call_get_duration(call);<sp/>/*store<sp/>duration<sp/>since<sp/>connected*/

<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;log-&gt;status==SephoneCallMissed){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>char<sp/>*info;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;missed_calls++;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>info=ortp_strdup_printf(ngettext(&quot;You<sp/>have<sp/>missed<sp/>%i<sp/>call.&quot;,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;You<sp/>have<sp/>missed<sp/>%i<sp/>calls.&quot;,<sp/>lc-&gt;missed_calls),
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;missed_calls);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_display_status(lc,info);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(info);
<sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;call_logs=ms_list_prepend(lc-&gt;call_logs,sephone_call_log_ref(call-&gt;log));
<sp/><sp/>if<sp/>(ms_list_size(lc-&gt;call_logs)&gt;lc-&gt;max_call_logs){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*elem,*prevelem=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*find<sp/>the<sp/>last<sp/>element*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>for(elem=lc-&gt;call_logs;elem!=NULL;elem=elem-&gt;next){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prevelem=elem;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elem=prevelem;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_log_unref((SephoneCallLog*)elem-&gt;data);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;call_logs=ms_list_remove_link(lc-&gt;call_logs,elem);
<sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_log_updated(lc,call-&gt;log);
<sp/><sp/><sp/><sp/>call_logs_write_to_config_file(lc);
}

/**
<sp/>*<sp/>Returns<sp/>the<sp/>current<sp/>transfer<sp/>state,<sp/>if<sp/>a<sp/>transfer<sp/>has<sp/>been<sp/>initiated<sp/>from<sp/>this<sp/>call.
<sp/>*<sp/>@see<sp/>sephone_core_transfer_call()<sp/>,<sp/>sephone_core_transfer_call_to_another()
**/
SephoneCallState<sp/>sephone_call_get_transfer_state(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/>return<sp/>call-&gt;transfer_state;
}

void<sp/>sephone_call_set_transfer_state(SephoneCall*<sp/>call,<sp/>SephoneCallState<sp/>state)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(state<sp/>!=<sp/>call-&gt;transfer_state)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SephoneCore*<sp/>lc<sp/>=<sp/>call-&gt;core;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Transfer<sp/>state<sp/>for<sp/>call<sp/>[%p]<sp/>changed<sp/><sp/>from<sp/>[%s]<sp/>to<sp/>[%s]&quot;,call
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sephone_call_state_to_string(call-&gt;transfer_state)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sephone_call_state_to_string(state));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;transfer_state<sp/>=<sp/>state;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_transfer_state_changed(lc,<sp/>call,<sp/>state);
<sp/><sp/><sp/>}
}

bool_t<sp/>sephone_call_is_in_conference(const<sp/>SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/>return<sp/>call-&gt;params-&gt;in_conference;
}

/**
<sp/>*<sp/>Perform<sp/>a<sp/>zoom<sp/>of<sp/>the<sp/>video<sp/>displayed<sp/>during<sp/>a<sp/>call.
<sp/>*<sp/>@param<sp/>call<sp/>the<sp/>call.
<sp/>*<sp/>@param<sp/>zoom_factor<sp/>a<sp/>floating<sp/>point<sp/>number<sp/>describing<sp/>the<sp/>zoom<sp/>factor.<sp/>A<sp/>value<sp/>1.0<sp/>corresponds<sp/>to<sp/>no<sp/>zoom<sp/>applied.
<sp/>*<sp/>@param<sp/>cx<sp/>a<sp/>floating<sp/>point<sp/>number<sp/>pointing<sp/>the<sp/>horizontal<sp/>center<sp/>of<sp/>the<sp/>zoom<sp/>to<sp/>be<sp/>applied.<sp/>This<sp/>value<sp/>should<sp/>be<sp/>between<sp/>0.0<sp/>and<sp/>1.0.
<sp/>*<sp/>@param<sp/>cy<sp/>a<sp/>floating<sp/>point<sp/>number<sp/>pointing<sp/>the<sp/>vertical<sp/>center<sp/>of<sp/>the<sp/>zoom<sp/>to<sp/>be<sp/>applied.<sp/>This<sp/>value<sp/>should<sp/>be<sp/>between<sp/>0.0<sp/>and<sp/>1.0.
<sp/>*
<sp/>*<sp/>cx<sp/>and<sp/>cy<sp/>are<sp/>updated<sp/>in<sp/>return<sp/>in<sp/>case<sp/>their<sp/>coordinates<sp/>were<sp/>too<sp/>excentrated<sp/>for<sp/>the<sp/>requested<sp/>zoom<sp/>factor.<sp/>The<sp/>zoom<sp/>ensures<sp/>that<sp/>all<sp/>the<sp/>screen<sp/>is<sp/>fullfilled<sp/>with<sp/>the<sp/>video.
**/
void<sp/>sephone_call_zoom_video(SephoneCall*<sp/>call,<sp/>float<sp/>zoom_factor,<sp/>float*<sp/>cx,<sp/>float*<sp/>cy)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>VideoStream*<sp/>vstream<sp/>=<sp/>call-&gt;videostream;
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(vstream<sp/>&amp;&amp;<sp/>vstream-&gt;output)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>zoom[3];
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>halfsize;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(zoom_factor<sp/>&lt;<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>zoom_factor<sp/>=<sp/>1;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>halfsize<sp/>=<sp/>0.5<sp/>*<sp/>1.0<sp/>/<sp/>zoom_factor;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((*cx<sp/>-<sp/>halfsize)<sp/>&lt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*cx<sp/>=<sp/>0<sp/>+<sp/>halfsize;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((*cx<sp/>+<sp/>halfsize)<sp/>&gt;<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*cx<sp/>=<sp/>1<sp/>-<sp/>halfsize;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((*cy<sp/>-<sp/>halfsize)<sp/>&lt;<sp/>0)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*cy<sp/>=<sp/>0<sp/>+<sp/>halfsize;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((*cy<sp/>+<sp/>halfsize)<sp/>&gt;<sp/>1)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*cy<sp/>=<sp/>1<sp/>-<sp/>halfsize;

<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>zoom[0]<sp/>=<sp/>zoom_factor;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>zoom[1]<sp/>=<sp/>*cx;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>zoom[2]<sp/>=<sp/>*cy;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(vstream-&gt;output,<sp/>MS_VIDEO_DISPLAY_ZOOM,<sp/>&amp;zoom);
<sp/><sp/>}else<sp/>ms_warning(&quot;Could<sp/>not<sp/>apply<sp/>zoom:<sp/>video<sp/>output<sp/>wasn&apos;t<sp/>activated.&quot;);
}

static<sp/>SephoneAddress<sp/>*get_fixed_contact(SephoneCore<sp/>*lc,<sp/>SephoneCall<sp/>*call<sp/>,<sp/>SephoneProxyConfig<sp/>*dest_proxy){
<sp/><sp/><sp/><sp/>SephoneAddress<sp/>*ctt=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/>SephoneAddress<sp/>*ret=NULL;
<sp/><sp/><sp/><sp/><sp/><sp/>//const<sp/>char<sp/>*localip=call-&gt;localip;

<sp/><sp/>/*<sp/>first<sp/>use<sp/>user&apos;s<sp/>supplied<sp/>ip<sp/>address<sp/>if<sp/>asked*/
<sp/><sp/><sp/><sp/><sp/>if<sp/>(sephone_core_get_firewall_policy(lc)==SephonePolicyUseNatAddress){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ctt=sephone_core_get_primary_contact_parsed(lc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_address_set_domain(ctt,sephone_core_get_nat_address_resolved(lc));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=ctt;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>(call-&gt;op<sp/>&amp;&amp;<sp/>sal_op_get_contact_address(call-&gt;op)!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>if<sp/>already<sp/>choosed,<sp/>don&apos;t<sp/>change<sp/>it<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>NULL;
<sp/><sp/><sp/>}<sp/>else<sp/>if<sp/>(call-&gt;ping_op<sp/>&amp;&amp;<sp/>sal_op_get_contact_address(call-&gt;ping_op))<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>if<sp/>the<sp/>ping<sp/>OPTIONS<sp/>request<sp/>succeeded<sp/>use<sp/>the<sp/>contact<sp/>guessed<sp/>from<sp/>the
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>received,<sp/>rport*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Contact<sp/>has<sp/>been<sp/>fixed<sp/>using<sp/>OPTIONS&quot;/*<sp/>to<sp/>%s&quot;,guessed*/);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=sephone_address_clone(sal_op_get_contact_address(call-&gt;ping_op));;
<sp/>}<sp/>else<sp/><sp/>if<sp/>(dest_proxy<sp/>&amp;&amp;<sp/>dest_proxy-&gt;op<sp/>&amp;&amp;<sp/>sal_op_get_contact_address(dest_proxy-&gt;op)){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*if<sp/>using<sp/>a<sp/>proxy,<sp/>use<sp/>the<sp/>contact<sp/>address<sp/>as<sp/>guessed<sp/>with<sp/>the<sp/>REGISTERs*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Contact<sp/>has<sp/>been<sp/>fixed<sp/>using<sp/>proxy&quot;<sp/>/*to<sp/>%s&quot;,fixed_contact*/);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=sephone_address_clone(sal_op_get_contact_address(dest_proxy-&gt;op));
<sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ctt=sephone_core_get_primary_contact_parsed(lc);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ctt!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*otherwise<sp/>use<sp/>supplied<sp/>localip*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_address_set_domain(ctt,NULL/*localip*/);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_address_set_port(ctt,-1/*sephone_core_get_sip_port(lc)*/);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(&quot;Contact<sp/>has<sp/>not<sp/>been<sp/>fixed<sp/>stack<sp/>will<sp/>do&quot;/*<sp/>to<sp/>%s&quot;,ret*/);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=ctt;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>ret;
}

void<sp/>sephone_call_set_contact_op(SephoneCall*<sp/>call)<sp/>{
<sp/><sp/><sp/>SephoneAddress<sp/>*contact;

<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;dest_proxy<sp/>==<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>Try<sp/>to<sp/>define<sp/>the<sp/>destination<sp/>proxy<sp/>if<sp/>it<sp/>has<sp/>not<sp/>already<sp/>been<sp/>done<sp/>to<sp/>have<sp/>a<sp/>correct<sp/>contact<sp/>field<sp/>in<sp/>the<sp/>SIP<sp/>messages<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dest_proxy<sp/>=<sp/>sephone_core_lookup_known_proxy(call-&gt;core,<sp/>call-&gt;log-&gt;to);
<sp/>}

<sp/><sp/><sp/><sp/><sp/>contact=get_fixed_contact(call-&gt;core,call,call-&gt;dest_proxy);
<sp/><sp/><sp/>if<sp/>(contact){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalTransport<sp/>tport=sal_address_get_transport((SalAddress*)contact);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_address_clean((SalAddress*)contact);<sp/>/*<sp/>clean<sp/>out<sp/>contact_params<sp/>that<sp/>come<sp/>from<sp/>proxy<sp/>config*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_address_set_transport((SalAddress*)contact,tport);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_set_contact_address(call-&gt;op,<sp/>contact);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_address_destroy(contact);
<sp/><sp/><sp/><sp/><sp/><sp/>}
}

SephonePlayer<sp/>*sephone_call_get_player(SephoneCall<sp/>*call){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;player==NULL)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;player=sephone_call_build_player(call);
<sp/><sp/>return<sp/>call-&gt;player;
}

void<sp/>sephone_call_set_new_params(SephoneCall<sp/>*call,<sp/>const<sp/>SephoneCallParams<sp/>*params){
<sp/><sp/>SephoneCallParams<sp/>*cp=NULL;
<sp/><sp/><sp/><sp/>if<sp/>(params)<sp/>cp=sephone_call_params_copy(params);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;params)<sp/>sephone_call_params_unref(call-&gt;params);
<sp/><sp/><sp/><sp/><sp/>call-&gt;params=cp;
}

static<sp/>int<sp/>send_dtmf_handler(void<sp/>*data,<sp/>unsigned<sp/>int<sp/>revents){
<sp/><sp/><sp/><sp/>SephoneCall<sp/>*call<sp/>=<sp/>(SephoneCall*)data;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*By<sp/>default<sp/>we<sp/>send<sp/>DTMF<sp/>RFC2833<sp/>if<sp/>we<sp/>do<sp/>not<sp/>have<sp/>enabled<sp/>SIP_INFO<sp/>but<sp/>we<sp/>can<sp/>also<sp/>send<sp/>RFC2833<sp/>and<sp/>SIP_INFO*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sephone_core_get_use_rfc2833_for_dtmf(call-&gt;core)!=0<sp/>||<sp/>sephone_core_get_use_info_for_dtmf(call-&gt;core)==0)
<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>In<sp/>Band<sp/>DTMF<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_send_dtmf(call-&gt;audiostream,*call-&gt;dtmf_sequence);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(&quot;Cannot<sp/>send<sp/>RFC2833<sp/>DTMF<sp/>when<sp/>we<sp/>are<sp/>not<sp/>in<sp/>communication.&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>FALSE;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(sephone_core_get_use_info_for_dtmf(call-&gt;core)!=0){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>Out<sp/>of<sp/>Band<sp/>DTMF<sp/>(use<sp/>INFO<sp/>method)<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_call_send_dtmf(call-&gt;op,*call-&gt;dtmf_sequence);
<sp/><sp/><sp/><sp/><sp/>}

<sp/><sp/><sp/><sp/><sp/>/*this<sp/>check<sp/>is<sp/>needed<sp/>because<sp/>sephone_call_send_dtmf<sp/>does<sp/>not<sp/>set<sp/>the<sp/>timer<sp/>since<sp/>its<sp/>a<sp/>single<sp/>character*/
<sp/><sp/><sp/><sp/>if<sp/>(call-&gt;dtmfs_timer!=NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memmove(call-&gt;dtmf_sequence,<sp/>call-&gt;dtmf_sequence+1,<sp/>strlen(call-&gt;dtmf_sequence));
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>continue<sp/>only<sp/>if<sp/>the<sp/>dtmf<sp/>sequence<sp/>is<sp/>not<sp/>empty*/
<sp/><sp/><sp/>if<sp/>(call-&gt;dtmf_sequence!=NULL&amp;&amp;*call-&gt;dtmf_sequence!=&apos;\0&apos;)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>TRUE;
<sp/><sp/><sp/>}<sp/>else<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_cancel_dtmfs(call);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>FALSE;
<sp/><sp/>}
}
int<sp/>sephone_call_send_dtmf(SephoneCall<sp/>*call,char<sp/>dtmf){
<sp/><sp/><sp/>if<sp/>(call==NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;sephone_call_send_dtmf():<sp/>invalid<sp/>call,<sp/>canceling<sp/>DTMF.&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>-1;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmf_sequence<sp/>=<sp/>&amp;dtmf;
<sp/><sp/><sp/>send_dtmf_handler(call,0);
<sp/><sp/><sp/><sp/><sp/>call-&gt;dtmf_sequence<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/>return<sp/>0;
}

int<sp/>sephone_call_send_dtmfs(SephoneCall<sp/>*call,char<sp/>*dtmfs)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call==NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;sephone_call_send_dtmfs():<sp/>invalid<sp/>call,<sp/>canceling<sp/>DTMF<sp/>sequence.&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>-1;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;dtmfs_timer!=NULL){
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;sephone_call_send_dtmfs():<sp/>a<sp/>DTMF<sp/>sequence<sp/>is<sp/>already<sp/>in<sp/>place,<sp/>canceling<sp/>DTMF<sp/>sequence.&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>-2;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(dtmfs<sp/>!=<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int<sp/>delay_ms<sp/>=<sp/>sp_config_get_int(call-&gt;core-&gt;config,&quot;net&quot;,&quot;dtmf_delay_ms&quot;,200);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmf_sequence<sp/>=<sp/>ms_strdup(dtmfs);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmfs_timer<sp/>=<sp/>sal_create_timer(call-&gt;core-&gt;sal,<sp/>send_dtmf_handler,<sp/>call,<sp/>delay_ms,<sp/>&quot;DTMF<sp/>sequence<sp/>timer&quot;);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0;
}

void<sp/>sephone_call_cancel_dtmfs(SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*nothing<sp/>to<sp/>do*/
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!call<sp/>||<sp/>!call-&gt;dtmfs_timer)<sp/>return;

<sp/><sp/><sp/><sp/><sp/><sp/>sal_cancel_timer(call-&gt;core-&gt;sal,<sp/>call-&gt;dtmfs_timer);
<sp/><sp/>belle_sip_object_unref(call-&gt;dtmfs_timer);
<sp/><sp/><sp/><sp/><sp/>call-&gt;dtmfs_timer<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;dtmf_sequence<sp/>!=<sp/>NULL)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(call-&gt;dtmf_sequence);
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmf_sequence<sp/>=<sp/>NULL;
<sp/><sp/><sp/><sp/>}
}

unsigned<sp/>long<sp/>sephone_call_get_native_video_window_id(const<sp/>SephoneCall<sp/>*call)<sp/>{
<sp/><sp/>if<sp/>(call-&gt;video_window_id)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>The<sp/>video<sp/>id<sp/>was<sp/>previously<sp/>set<sp/>by<sp/>the<sp/>app.<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>call-&gt;video_window_id;
<sp/><sp/>}
#ifdef<sp/>VIDEO_ENABLED
<sp/>else<sp/>if<sp/>(call-&gt;videostream)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/*<sp/>It<sp/>was<sp/>not<sp/>set<sp/>but<sp/>we<sp/>want<sp/>to<sp/>get<sp/>the<sp/>one<sp/>automatically<sp/>created<sp/>by<sp/>mediastreamer2<sp/>(desktop<sp/>versions<sp/>only).<sp/>*/
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>video_stream_get_native_window_id(call-&gt;videostream);
<sp/><sp/><sp/>}
#endif
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0;
}

void<sp/>sephone_call_set_native_video_window_id(SephoneCall<sp/>*call,<sp/>unsigned<sp/>long<sp/>id)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_window_id<sp/>=<sp/>id;
#ifdef<sp/>VIDEO_ENABLED
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;videostream)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_native_window_id(call-&gt;videostream,<sp/>id);
<sp/><sp/><sp/><sp/><sp/><sp/>}
#endif
}
#ifdef<sp/>VIDEO_ENABLED
MSWebCam<sp/>*sephone_call_get_video_device(const<sp/>SephoneCall<sp/>*call)<sp/>{
<sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;camera_enabled==FALSE)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>get_nowebcam_device();
<sp/><sp/>else
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>call-&gt;cam;
}
#endif
</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2016"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Switch<sp/>vsize<sp/>of<sp/>video<sp/>encoder<sp/>to<sp/>%dx%d<sp/>at<sp/>%i<sp/>bits/s<sp/>for<sp/>stream<sp/>[%p]&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vconf.vsize.width,<sp/>vconf.vsize.height,<sp/>bitrate,<sp/>stream);</highlight></codeline>
<codeline lineno="2018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1ga6faba33eef07d782cdf7bfd2c79a292a" kindref="member">sephone_core_update_call</ref>(lc,<sp/>call,<sp/>NULL);</highlight></codeline>
<codeline lineno="2019"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2020"><highlight class="normal"></highlight></codeline>
<codeline lineno="2021"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>video_stream_event_cb(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*user_pointer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSFilter<sp/>*f,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>event_id,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*args){</highlight></codeline>
<codeline lineno="2022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>*<sp/>call<sp/>=<sp/>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>*)<sp/>user_pointer;</highlight></codeline>
<codeline lineno="2023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref>*<sp/>lc<sp/>=<sp/>call-&gt;core;</highlight></codeline>
<codeline lineno="2024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(event_id)<sp/>{</highlight></codeline>
<codeline lineno="2025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_VIDEO_DECODER_DECODING_ERRORS:</highlight></codeline>
<codeline lineno="2026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;MS_VIDEO_DECODER_DECODING_ERRORS&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//@<sp/>xr<sp/>2016/4/26<sp/>51</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2028"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>(video_stream_is_decoding_error_to_be_reported(call-&gt;videostream,<sp/>1000)<sp/>==<sp/>TRUE))<sp/>{</highlight></codeline>
<codeline lineno="2029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_decoding_error_reported(call-&gt;videostream);</highlight></codeline>
<codeline lineno="2030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1ga9aee48c0a7d7c5212f9bcc4f42594340" kindref="member">sephone_call_send_vfu_request</ref>(call);</highlight></codeline>
<codeline lineno="2031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;state<sp/>==<sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref>)</highlight></codeline>
<codeline lineno="2032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_state_changed(lc,<sp/>call,<sp/>SephoneCallVideoDecodingError,<sp/></highlight><highlight class="stringliteral">&quot;Decoding<sp/>error&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2035"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_VIDEO_DECODER_RECOVERED_FROM_ERRORS:</highlight></codeline>
<codeline lineno="2036"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;MS_VIDEO_DECODER_RECOVERED_FROM_ERRORS&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream)<sp/>{</highlight></codeline>
<codeline lineno="2038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_decoding_error_recovered(call-&gt;videostream);</highlight></codeline>
<codeline lineno="2039"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;state<sp/>==<sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref>)</highlight></codeline>
<codeline lineno="2040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_state_changed(lc,<sp/>call,<sp/>SephoneCallVideoDecodingError,<sp/></highlight><highlight class="stringliteral">&quot;Recovered<sp/>from<sp/>error&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_VIDEO_DECODER_FIRST_IMAGE_DECODED:</highlight></codeline>
<codeline lineno="2044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;First<sp/>video<sp/>frame<sp/>decoded<sp/>successfully&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;nextVideoFrameDecoded._func<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="2046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;nextVideoFrameDecoded._func(call,<sp/>call-&gt;nextVideoFrameDecoded._user_data);</highlight></codeline>
<codeline lineno="2047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;state<sp/>==<sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref>)</highlight></codeline>
<codeline lineno="2048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_state_changed(lc,<sp/>call,<sp/>SephoneCallFirstImageDecoded,<sp/></highlight><highlight class="stringliteral">&quot;First<sp/>video<sp/>frame<sp/>decoded&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_VIDEO_DECODER_SEND_PLI:</highlight></codeline>
<codeline lineno="2051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_VIDEO_DECODER_SEND_SLI:</highlight></codeline>
<codeline lineno="2052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_VIDEO_DECODER_SEND_RPSI:</highlight></codeline>
<codeline lineno="2053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Handled<sp/>internally<sp/>by<sp/>mediastreamer2.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_VIDEO_ENCODER_NOTIFY_DECREASE_VSIZE:</highlight></codeline>
<codeline lineno="2056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;MS_VIDEO_ENCODER_NOTIFY_DECREASE_VSIZE&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream)<sp/>{</highlight></codeline>
<codeline lineno="2058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>new_bw<sp/>=<sp/>*((</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>*)args);</highlight></codeline>
<codeline lineno="2059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>auto_decide_vsize<sp/>=<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;video&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;auto_decide_vsize&quot;</highlight><highlight class="normal">,<sp/>0);</highlight></codeline>
<codeline lineno="2060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(auto_decide_vsize<sp/>&amp;&amp;<sp/>(video_stream_is_vsize_decreased(call-&gt;videostream,<sp/>5000)<sp/>==<sp/>TRUE))<sp/>{</highlight></codeline>
<codeline lineno="2061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_update_bitrate_limit(call,<sp/>new_bw);</highlight></codeline>
<codeline lineno="2062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="2066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Unhandled<sp/>event<sp/>%i&quot;</highlight><highlight class="normal">,<sp/>event_id);</highlight></codeline>
<codeline lineno="2067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2069"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2070"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2071"><highlight class="normal"></highlight></codeline>
<codeline lineno="2072"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_set_next_video_frame_decoded_callback(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>SephoneCallCbFunc<sp/>cb,<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal">*<sp/>user_data)<sp/>{</highlight></codeline>
<codeline lineno="2073"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;nextVideoFrameDecoded._func<sp/>=<sp/>cb;</highlight></codeline>
<codeline lineno="2074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;nextVideoFrameDecoded._user_data<sp/>=<sp/>user_data;</highlight></codeline>
<codeline lineno="2075"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;ms.decoder)</highlight></codeline>
<codeline lineno="2077"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method_noarg(call-&gt;videostream-&gt;ms.decoder,<sp/>MS_VIDEO_DECODER_RESET_FIRST_IMAGE_NOTIFICATION);</highlight></codeline>
<codeline lineno="2078"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2079"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2080"><highlight class="normal"></highlight></codeline>
<codeline lineno="2081"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>port_config_set_random_choosed(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index,<sp/>RtpSession<sp/>*session){</highlight></codeline>
<codeline lineno="2082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[stream_index].rtp_port=rtp_session_get_local_port(session);</highlight></codeline>
<codeline lineno="2083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[stream_index].rtcp_port=rtp_session_get_local_rtcp_port(session);</highlight></codeline>
<codeline lineno="2084"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2085"><highlight class="normal"></highlight></codeline>
<codeline lineno="2086"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>_sephone_call_prepare_ice_for_stream(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index,<sp/>bool_t<sp/>create_checklist){</highlight></codeline>
<codeline lineno="2087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MediaStream<sp/>*ms=stream_index<sp/>==<sp/>0<sp/>?<sp/>(MediaStream*)call-&gt;audiostream<sp/>:<sp/>(MediaStream*)call-&gt;videostream;</highlight></codeline>
<codeline lineno="2088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="comment">/*(sephone_core_get_firewall_policy(call-&gt;core)<sp/>==<sp/>SephonePolicyUseIce)<sp/>&amp;&amp;*/</highlight><highlight class="normal"><sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)){</highlight></codeline>
<codeline lineno="2089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>IceCheckList<sp/>*cl;</highlight></codeline>
<codeline lineno="2090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_pktinfo(ms-&gt;sessions.rtp_session,<sp/>TRUE);</highlight></codeline>
<codeline lineno="2091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cl=ice_session_check_list(call-&gt;ice_session,<sp/>stream_index);</highlight></codeline>
<codeline lineno="2092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cl<sp/>==<sp/>NULL<sp/>&amp;&amp;<sp/>create_checklist)<sp/>{</highlight></codeline>
<codeline lineno="2093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cl=ice_check_list_new();</highlight></codeline>
<codeline lineno="2094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_add_check_list(call-&gt;ice_session,<sp/>cl,<sp/>stream_index);</highlight></codeline>
<codeline lineno="2095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Created<sp/>new<sp/>ICE<sp/>check<sp/>list<sp/>for<sp/>stream<sp/>%i<sp/>[%p]&quot;</highlight><highlight class="normal">,stream_index,ms);</highlight></codeline>
<codeline lineno="2096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2097"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cl){</highlight></codeline>
<codeline lineno="2098"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms-&gt;ice_check_list<sp/>=<sp/>cl;</highlight></codeline>
<codeline lineno="2099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_check_list_set_rtp_session(ms-&gt;ice_check_list,<sp/>ms-&gt;sessions.rtp_session);</highlight></codeline>
<codeline lineno="2100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2102"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2103"><highlight class="normal"></highlight></codeline>
<codeline lineno="2104"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>sephone_call_prepare_ice(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>incoming_offer){</highlight></codeline>
<codeline lineno="2105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*remote<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="2106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>has_video=FALSE;</highlight></codeline>
<codeline lineno="2107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__network__parameters_1ga296fc01afedb8747fe98bd5bc7bb2fc1" kindref="member">SephoneFirewallPolicy</ref><sp/>fpol=<ref refid="group__network__parameters_1ga2ba2ed66104f0adbc83b6cd55ebb0fde" kindref="member">sephone_core_get_firewall_policy</ref>(call-&gt;core);</highlight></codeline>
<codeline lineno="2108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="2109"><highlight class="normal"></highlight></codeline>
<codeline lineno="2110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//@<sp/>xr<sp/>2016/12/28<sp/>upnpice</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((fpol<sp/>==<sp/><ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a4f5a7f79bf45f888288ab1e36b50a9ec" kindref="member">SephonePolicyUseIce</ref><sp/>||<sp/>fpol<sp/>==<sp/><ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1aeb9b0fa1682098c731096dbe806b0c8f" kindref="member">SephonePolicyUseUpnp</ref>)<sp/>&amp;&amp;<sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)){</highlight></codeline>
<codeline lineno="2112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(incoming_offer){</highlight></codeline>
<codeline lineno="2113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remote=sal_call_get_remote_media_description(call-&gt;op);</highlight></codeline>
<codeline lineno="2114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>has_video=<ref refid="group__media__parameters_1ga092e40c6c49897fdc5269d461e2c02e1" kindref="member">sephone_core_video_enabled</ref>(call-&gt;core)<sp/>&amp;&amp;<sp/>sephone_core_media_description_contains_video_stream(remote);</highlight></codeline>
<codeline lineno="2115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>has_video=call-&gt;params-&gt;has_video;</highlight></codeline>
<codeline lineno="2116"><highlight class="normal"></highlight></codeline>
<codeline lineno="2117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_sephone_call_prepare_ice_for_stream(call,0,TRUE);</highlight></codeline>
<codeline lineno="2118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(has_video)<sp/>_sephone_call_prepare_ice_for_stream(call,1,TRUE);</highlight></codeline>
<codeline lineno="2119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*start<sp/>ICE<sp/>gathering*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(incoming_offer)</highlight></codeline>
<codeline lineno="2121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_update_ice_from_remote_media_description(call,remote,FALSE);<sp/></highlight><highlight class="comment">/*this<sp/>may<sp/>delete<sp/>the<sp/>ice<sp/>session*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;ice_session<sp/>&amp;&amp;<sp/>!ice_session_candidates_gathered(call-&gt;ice_session)){</highlight></codeline>
<codeline lineno="2123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream-&gt;ms.state==MSStreamInitialized)</highlight></codeline>
<codeline lineno="2124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_prepare_sound(call-&gt;audiostream,<sp/>NULL,<sp/>NULL);</highlight></codeline>
<codeline lineno="2125"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(has_video<sp/>&amp;&amp;<sp/>call-&gt;videostream<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;ms.state==MSStreamInitialized)<sp/>{</highlight></codeline>
<codeline lineno="2127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_prepare_video(call-&gt;videostream);</highlight></codeline>
<codeline lineno="2128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2129"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sephone_core_gather_ice_candidates(call-&gt;core,call)&lt;0)<sp/>{</highlight></codeline>
<codeline lineno="2131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Ice<sp/>candidates<sp/>gathering<sp/>failed,<sp/>proceed<sp/>with<sp/>the<sp/>call<sp/>anyway.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_delete_ice_session(call);</highlight></codeline>
<codeline lineno="2133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_media_streams_for_ice_gathering(call);</highlight></codeline>
<codeline lineno="2134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="2135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1;</highlight><highlight class="comment">/*gathering<sp/>in<sp/>progress,<sp/>wait*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="2140"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2141"><highlight class="normal"></highlight></codeline>
<codeline lineno="2142"><highlight class="normal"></highlight><highlight class="comment">/*eventually<sp/>join<sp/>to<sp/>a<sp/>multicast<sp/>group<sp/>if<sp/>told<sp/>to<sp/>do<sp/>so*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2143"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_join_multicast_group(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index,<sp/>MediaStream<sp/>*ms){</highlight></codeline>
<codeline lineno="2144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;media_ports[stream_index].multicast_ip[stream_index]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>call-&gt;media_ports[stream_index].mcast_rtp_port!=0){</highlight></codeline>
<codeline lineno="2145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_join_multicast_group(ms,<sp/>call-&gt;media_ports[stream_index].multicast_ip);</highlight></codeline>
<codeline lineno="2146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2147"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2148"><highlight class="normal"></highlight></codeline>
<codeline lineno="2149"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_init_audio_stream(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="2150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="2151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AudioStream<sp/>*audiostream;</highlight></codeline>
<codeline lineno="2152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*location;</highlight></codeline>
<codeline lineno="2153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>dscp;</highlight></codeline>
<codeline lineno="2154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>rtcp_tool[128]={0};</highlight></codeline>
<codeline lineno="2155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>cname;</highlight></codeline>
<codeline lineno="2156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="2157"><highlight class="normal"></highlight></codeline>
<codeline lineno="2158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snprintf(rtcp_tool,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(rtcp_tool)-1,</highlight><highlight class="stringliteral">&quot;%s-%s&quot;</highlight><highlight class="normal">,sephone_core_get_user_agent_name(),sephone_core_get_user_agent_version());</highlight></codeline>
<codeline lineno="2159"><highlight class="normal"></highlight></codeline>
<codeline lineno="2160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>!=<sp/>NULL)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;sessions[0].rtp_session==NULL){</highlight></codeline>
<codeline lineno="2162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream=audiostream=audio_stream_new2(sephone_call_get_bind_ip_for_stream(call,0),</highlight></codeline>
<codeline lineno="2163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[0].mcast_rtp_port<sp/>?<sp/>call-&gt;media_ports[0].mcast_rtp_port<sp/>:<sp/>call-&gt;media_ports[0].rtp_port,</highlight></codeline>
<codeline lineno="2164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[0].mcast_rtcp_port<sp/>?<sp/>call-&gt;media_ports[0].mcast_rtcp_port<sp/>:<sp/>call-&gt;media_ports[0].rtcp_port);</highlight></codeline>
<codeline lineno="2165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_join_multicast_group(call,<sp/>0,<sp/>&amp;audiostream-&gt;ms);</highlight></codeline>
<codeline lineno="2166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_enable_network_simulation(call-&gt;audiostream-&gt;ms.sessions.rtp_session,<sp/>&amp;lc-&gt;net_conf.netsim_params);</highlight></codeline>
<codeline lineno="2167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cname<sp/>=<sp/><ref refid="group__sephone__address_1ga1b480f99787494378d9683dbc31dc177" kindref="member">sephone_address_as_string_uri_only</ref>(call-&gt;me);</highlight></codeline>
<codeline lineno="2168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_rtcp_information(call-&gt;audiostream,<sp/>cname,<sp/>rtcp_tool);</highlight></codeline>
<codeline lineno="2169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(cname);</highlight></codeline>
<codeline lineno="2170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_symmetric_rtp(audiostream-&gt;ms.sessions.rtp_session,sephone_core_symmetric_rtp_enabled(lc));</highlight></codeline>
<codeline lineno="2171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;media_encryption==<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba05791a117352a31299e65410334a3f91" kindref="member">SephoneMediaEncryptionDTLS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSDtlsSrtpParams<sp/>params;</highlight></codeline>
<codeline lineno="2173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*certificate,<sp/>*key;</highlight></codeline>
<codeline lineno="2174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;params,0,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(MSDtlsSrtpParams));</highlight></codeline>
<codeline lineno="2175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>TODO<sp/>:<sp/>search<sp/>for<sp/>a<sp/>certificate<sp/>with<sp/>CNAME=sip<sp/>uri(retrieved<sp/>from<sp/>variable<sp/>me)<sp/>or<sp/>default<sp/>:<sp/>sephone-dtls-default-identity<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>This<sp/>will<sp/>parse<sp/>the<sp/>directory<sp/>to<sp/>find<sp/>a<sp/>matching<sp/>fingerprint<sp/>or<sp/>generate<sp/>it<sp/>if<sp/>not<sp/>found<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>returned<sp/>string<sp/>must<sp/>be<sp/>freed<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_certificates_chain_parse_directory(&amp;certificate,<sp/>&amp;key,<sp/>&amp;call-&gt;dtls_certificate_fingerprint,<sp/>lc-&gt;user_certificates_path,<sp/></highlight><highlight class="stringliteral">&quot;sephone-dtls-default-identity&quot;</highlight><highlight class="normal">,<sp/>SAL_CERTIFICATE_RAW_FORMAT_PEM,<sp/>TRUE,<sp/>TRUE);</highlight></codeline>
<codeline lineno="2179"><highlight class="normal"></highlight></codeline>
<codeline lineno="2180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(key!=<sp/>NULL<sp/>&amp;&amp;<sp/>certificate!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="2181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.pem_certificate<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)certificate;</highlight></codeline>
<codeline lineno="2182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.pem_pkey<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)key;</highlight></codeline>
<codeline lineno="2183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.role<sp/>=<sp/>MSDtlsSrtpRoleUnset;<sp/></highlight><highlight class="comment">/*<sp/>default<sp/>is<sp/>unset,<sp/>then<sp/>check<sp/>if<sp/>we<sp/>have<sp/>a<sp/>result<sp/>SalMediaDescription<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_dtls(call-&gt;audiostream,&amp;params);</highlight></codeline>
<codeline lineno="2185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(certificate);</highlight></codeline>
<codeline lineno="2186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(key);</highlight></codeline>
<codeline lineno="2187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Unable<sp/>to<sp/>retrieve<sp/>or<sp/>generate<sp/>DTLS<sp/>certificate<sp/>and<sp/>key<sp/>-<sp/>DTLS<sp/>disabled&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>TODO<sp/>:<sp/>check<sp/>if<sp/>encryption<sp/>forced,<sp/>if<sp/>yes,<sp/>stop<sp/>call<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="2193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream=audio_stream_new_with_sessions(&amp;call-&gt;sessions[0]);</highlight></codeline>
<codeline lineno="2194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audiostream=call-&gt;audiostream;</highlight></codeline>
<codeline lineno="2196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;media_ports[0].rtp_port==-1){</highlight></codeline>
<codeline lineno="2197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>port_config_set_random_choosed(call,0,audiostream-&gt;ms.sessions.rtp_session);</highlight></codeline>
<codeline lineno="2198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dscp=<ref refid="group__network__parameters_1ga2630913c306486b82bbce3f69ed35a7a" kindref="member">sephone_core_get_audio_dscp</ref>(lc);</highlight></codeline>
<codeline lineno="2200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dscp!=-1)</highlight></codeline>
<codeline lineno="2201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_dscp(audiostream,dscp);</highlight></codeline>
<codeline lineno="2202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__media__parameters_1ga2a406d10a145e1dcbad9ccc964b9b670" kindref="member">sephone_core_echo_limiter_enabled</ref>(lc)){</highlight></codeline>
<codeline lineno="2203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*type=<ref refid="group__misc_1ga5a32540697fb696aa4f306d9dbc844c5" kindref="member">sp_config_get_string</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;el_type&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;mic&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;echo<sp/>limiter<sp/>enabled&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcasecmp(type,</highlight><highlight class="stringliteral">&quot;mic&quot;</highlight><highlight class="normal">)==0)</highlight></codeline>
<codeline lineno="2206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(audiostream,ELControlMic);</highlight></codeline>
<codeline lineno="2207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcasecmp(type,</highlight><highlight class="stringliteral">&quot;full&quot;</highlight><highlight class="normal">)==0)</highlight></codeline>
<codeline lineno="2208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(audiostream,ELControlFull);</highlight></codeline>
<codeline lineno="2209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;echo<sp/>limiter<sp/>disabled&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2212"><highlight class="normal"></highlight></codeline>
<codeline lineno="2213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>equalizer<sp/>location<sp/>in<sp/>the<sp/>graph:<sp/>&apos;mic&apos;<sp/>=<sp/>in<sp/>input<sp/>graph,<sp/>otherwise<sp/>in<sp/>output<sp/>graph.</highlight></codeline>
<codeline lineno="2214"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Any<sp/>other<sp/>value<sp/>than<sp/>mic<sp/>will<sp/>default<sp/>to<sp/>output<sp/>graph<sp/>for<sp/>compatibility<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>location<sp/>=<sp/><ref refid="group__misc_1ga5a32540697fb696aa4f306d9dbc844c5" kindref="member">sp_config_get_string</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;eq_location&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;hp&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audiostream-&gt;eq_loc<sp/>=<sp/>(strcasecmp(location,</highlight><highlight class="stringliteral">&quot;mic&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>?<sp/>MSEqualizerMic<sp/>:<sp/>MSEqualizerHP;</highlight></codeline>
<codeline lineno="2217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Equalizer<sp/>location:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>location);</highlight></codeline>
<codeline lineno="2218"><highlight class="normal"></highlight></codeline>
<codeline lineno="2219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_gain_control(audiostream,TRUE);</highlight></codeline>
<codeline lineno="2220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__media__parameters_1ga3cd3d3f56f4bf30e8b3895c8bb97c989" kindref="member">sephone_core_echo_cancellation_enabled</ref>(lc)){</highlight></codeline>
<codeline lineno="2221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>len,delay,framesize;</highlight></codeline>
<codeline lineno="2222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>len=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;ec_tail_len&quot;</highlight><highlight class="normal">,0);</highlight></codeline>
<codeline lineno="2223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>delay=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;ec_delay&quot;</highlight><highlight class="normal">,0);</highlight></codeline>
<codeline lineno="2224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>framesize=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;ec_framesize&quot;</highlight><highlight class="normal">,0);</highlight></codeline>
<codeline lineno="2225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_echo_canceller_params(audiostream,len,delay,framesize);</highlight></codeline>
<codeline lineno="2226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(audiostream-&gt;ec)<sp/>{</highlight></codeline>
<codeline lineno="2227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*statestr=ms_malloc0(EC_STATE_MAX_LEN);</highlight></codeline>
<codeline lineno="2228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sp_config_read_relative_file(lc-&gt;config,<sp/>EC_STATE_STORE,<sp/>statestr,<sp/>EC_STATE_MAX_LEN)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(audiostream-&gt;ec,<sp/>MS_ECHO_CANCELLER_SET_STATE_STRING,<sp/>statestr);</highlight></codeline>
<codeline lineno="2230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(statestr);</highlight></codeline>
<codeline lineno="2232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_automatic_gain_control(audiostream,sephone_core_agc_enabled(lc));</highlight></codeline>
<codeline lineno="2235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>enabled=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;noisegate&quot;</highlight><highlight class="normal">,0);</highlight></codeline>
<codeline lineno="2237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>stream-&gt;volsend</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_noise_gate(audiostream,enabled);</highlight></codeline>
<codeline lineno="2239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2240"><highlight class="normal"></highlight></codeline>
<codeline lineno="2241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_features(audiostream,sephone_core_get_audio_features(lc));</highlight></codeline>
<codeline lineno="2242"><highlight class="normal"></highlight></codeline>
<codeline lineno="2243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;rtptf){</highlight></codeline>
<codeline lineno="2244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpTransport<sp/>*meta_rtp;</highlight></codeline>
<codeline lineno="2245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpTransport<sp/>*meta_rtcp;</highlight></codeline>
<codeline lineno="2246"><highlight class="normal"></highlight></codeline>
<codeline lineno="2247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_get_transports(audiostream-&gt;ms.sessions.rtp_session,&amp;meta_rtp,&amp;meta_rtcp);</highlight></codeline>
<codeline lineno="2248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(meta_rtp_transport_get_endpoint(meta_rtp)<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="2249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>meta_rtp_transport_set_endpoint(meta_rtp,lc-&gt;rtptf-&gt;audio_rtp_func(lc-&gt;rtptf-&gt;audio_rtp_func_data,<sp/>call-&gt;media_ports[0].rtp_port));</highlight></codeline>
<codeline lineno="2250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(meta_rtp_transport_get_endpoint(meta_rtcp)<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="2252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>meta_rtp_transport_set_endpoint(meta_rtcp,lc-&gt;rtptf-&gt;audio_rtcp_func(lc-&gt;rtptf-&gt;audio_rtcp_func_data,<sp/>call-&gt;media_ports[0].rtcp_port));</highlight></codeline>
<codeline lineno="2253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2255"><highlight class="normal"></highlight></codeline>
<codeline lineno="2256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream_app_evq<sp/>=<sp/>ortp_ev_queue_new();</highlight></codeline>
<codeline lineno="2257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_register_event_queue(audiostream-&gt;ms.sessions.rtp_session,call-&gt;audiostream_app_evq);</highlight></codeline>
<codeline lineno="2258"><highlight class="normal"></highlight></codeline>
<codeline lineno="2259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__network__parameters_1ga2ba2ed66104f0adbc83b6cd55ebb0fde" kindref="member">sephone_core_get_firewall_policy</ref>(lc)<sp/>==<sp/><ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a4f5a7f79bf45f888288ab1e36b50a9ec" kindref="member">SephonePolicyUseIce</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_sephone_call_prepare_ice_for_stream(call,0,FALSE);</highlight></codeline>
<codeline lineno="2261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2262"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2263"><highlight class="normal"></highlight></codeline>
<codeline lineno="2264"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_init_video_stream(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="2265"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="2267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>cname;</highlight></codeline>
<codeline lineno="2268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>rtcp_tool[128];</highlight></codeline>
<codeline lineno="2269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snprintf(rtcp_tool,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(rtcp_tool)-1,</highlight><highlight class="stringliteral">&quot;%s-%s&quot;</highlight><highlight class="normal">,sephone_core_get_user_agent_name(),sephone_core_get_user_agent_version());</highlight></codeline>
<codeline lineno="2270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="2271"><highlight class="normal"></highlight></codeline>
<codeline lineno="2272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>==<sp/>NULL){</highlight></codeline>
<codeline lineno="2273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>video_recv_buf_size=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;video&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;recv_buf_size&quot;</highlight><highlight class="normal">,0);</highlight></codeline>
<codeline lineno="2274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>dscp=<ref refid="group__network__parameters_1ga673f7f338be7514c09c9595611e96c1a" kindref="member">sephone_core_get_video_dscp</ref>(lc);</highlight></codeline>
<codeline lineno="2275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*display_filter=<ref refid="group__media__parameters_1gacc8e9a0a4629c681856e7af97bdf3ffe" kindref="member">sephone_core_get_video_display_filter</ref>(lc);</highlight></codeline>
<codeline lineno="2276"><highlight class="normal"></highlight></codeline>
<codeline lineno="2277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;sessions[1].rtp_session==NULL){</highlight></codeline>
<codeline lineno="2278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream=video_stream_new2(sephone_call_get_bind_ip_for_stream(call,1),</highlight></codeline>
<codeline lineno="2279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[1].mcast_rtp_port&gt;0<sp/>?<sp/><sp/>call-&gt;media_ports[1].mcast_rtp_port<sp/>:<sp/>call-&gt;media_ports[1].rtp_port,</highlight></codeline>
<codeline lineno="2280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;media_ports[1].mcast_rtcp_port&gt;0<sp/>?<sp/>call-&gt;media_ports[1].mcast_rtcp_port<sp/>:<sp/>call-&gt;media_ports[1].rtcp_port);</highlight></codeline>
<codeline lineno="2281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_join_multicast_group(call,<sp/>1,<sp/>&amp;call-&gt;videostream-&gt;ms);</highlight></codeline>
<codeline lineno="2282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_enable_network_simulation(call-&gt;videostream-&gt;ms.sessions.rtp_session,<sp/>&amp;lc-&gt;net_conf.netsim_params);</highlight></codeline>
<codeline lineno="2283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cname<sp/>=<sp/><ref refid="group__sephone__address_1ga1b480f99787494378d9683dbc31dc177" kindref="member">sephone_address_as_string_uri_only</ref>(call-&gt;me);</highlight></codeline>
<codeline lineno="2284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_rtcp_information(call-&gt;videostream,<sp/>cname,<sp/>rtcp_tool);</highlight></codeline>
<codeline lineno="2285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(cname);</highlight></codeline>
<codeline lineno="2286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_symmetric_rtp(call-&gt;videostream-&gt;ms.sessions.rtp_session,sephone_core_symmetric_rtp_enabled(lc));</highlight></codeline>
<codeline lineno="2287"><highlight class="normal"></highlight></codeline>
<codeline lineno="2288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;media_encryption==<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba05791a117352a31299e65410334a3f91" kindref="member">SephoneMediaEncryptionDTLS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSDtlsSrtpParams<sp/>params;</highlight></codeline>
<codeline lineno="2290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*certificate,<sp/>*key;</highlight></codeline>
<codeline lineno="2291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;params,0,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(MSDtlsSrtpParams));</highlight></codeline>
<codeline lineno="2292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>TODO<sp/>:<sp/>search<sp/>for<sp/>a<sp/>certificate<sp/>with<sp/>CNAME=sip<sp/>uri(retrieved<sp/>from<sp/>variable<sp/>me)<sp/>or<sp/>default<sp/>:<sp/>sephone-dtls-default-identity<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>This<sp/>will<sp/>parse<sp/>the<sp/>directory<sp/>to<sp/>find<sp/>a<sp/>matching<sp/>fingerprint<sp/>or<sp/>generate<sp/>it<sp/>if<sp/>not<sp/>found<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>returned<sp/>string<sp/>must<sp/>be<sp/>freed<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_certificates_chain_parse_directory(&amp;certificate,<sp/>&amp;key,<sp/>&amp;call-&gt;dtls_certificate_fingerprint,<sp/>lc-&gt;user_certificates_path,<sp/></highlight><highlight class="stringliteral">&quot;sephone-dtls-default-identity&quot;</highlight><highlight class="normal">,<sp/>SAL_CERTIFICATE_RAW_FORMAT_PEM,<sp/>TRUE,<sp/>TRUE);</highlight></codeline>
<codeline lineno="2296"><highlight class="normal"></highlight></codeline>
<codeline lineno="2297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(key!=<sp/>NULL<sp/>&amp;&amp;<sp/>certificate!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="2298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.pem_certificate<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)certificate;</highlight></codeline>
<codeline lineno="2299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.pem_pkey<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)key;</highlight></codeline>
<codeline lineno="2300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.role<sp/>=<sp/>MSDtlsSrtpRoleUnset;<sp/></highlight><highlight class="comment">/*<sp/>default<sp/>is<sp/>unset,<sp/>then<sp/>check<sp/>if<sp/>we<sp/>have<sp/>a<sp/>result<sp/>SalMediaDescription<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_dtls(call-&gt;videostream,&amp;params);</highlight></codeline>
<codeline lineno="2302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(certificate);</highlight></codeline>
<codeline lineno="2303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(key);</highlight></codeline>
<codeline lineno="2304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Unable<sp/>to<sp/>retrieve<sp/>or<sp/>generate<sp/>DTLS<sp/>certificate<sp/>and<sp/>key<sp/>-<sp/>DTLS<sp/>disabled&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>TODO<sp/>:<sp/>check<sp/>if<sp/>encryption<sp/>forced,<sp/>if<sp/>yes,<sp/>stop<sp/>call<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="2310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream=video_stream_new_with_sessions(&amp;call-&gt;sessions[1]);</highlight></codeline>
<codeline lineno="2311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2312"><highlight class="normal"></highlight></codeline>
<codeline lineno="2313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;media_ports[1].rtp_port==-1){</highlight></codeline>
<codeline lineno="2314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>port_config_set_random_choosed(call,1,call-&gt;videostream-&gt;ms.sessions.rtp_session);</highlight></codeline>
<codeline lineno="2315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dscp!=-1)</highlight></codeline>
<codeline lineno="2317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_dscp(call-&gt;videostream,dscp);</highlight></codeline>
<codeline lineno="2318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_display_filter_auto_rotate(call-&gt;videostream,<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;video&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;display_filter_auto_rotate&quot;</highlight><highlight class="normal">,0));</highlight></codeline>
<codeline lineno="2319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(video_recv_buf_size&gt;0)<sp/>rtp_session_set_recv_buf_size(call-&gt;videostream-&gt;ms.sessions.rtp_session,video_recv_buf_size);</highlight></codeline>
<codeline lineno="2320"><highlight class="normal"></highlight></codeline>
<codeline lineno="2321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(display_filter<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="2322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_display_filter_name(call-&gt;videostream,display_filter);</highlight></codeline>
<codeline lineno="2323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_event_callback(call-&gt;videostream,video_stream_event_cb,<sp/>call);</highlight></codeline>
<codeline lineno="2324"><highlight class="normal"></highlight></codeline>
<codeline lineno="2325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;rtptf){</highlight></codeline>
<codeline lineno="2326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpTransport<sp/>*meta_rtp;</highlight></codeline>
<codeline lineno="2327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpTransport<sp/>*meta_rtcp;</highlight></codeline>
<codeline lineno="2328"><highlight class="normal"></highlight></codeline>
<codeline lineno="2329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_get_transports(call-&gt;videostream-&gt;ms.sessions.rtp_session,&amp;meta_rtp,&amp;meta_rtcp);</highlight></codeline>
<codeline lineno="2330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(meta_rtp_transport_get_endpoint(meta_rtp)<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="2331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>meta_rtp_transport_set_endpoint(meta_rtp,lc-&gt;rtptf-&gt;video_rtp_func(lc-&gt;rtptf-&gt;video_rtp_func_data,<sp/>call-&gt;media_ports[1].rtp_port));</highlight></codeline>
<codeline lineno="2332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(meta_rtp_transport_get_endpoint(meta_rtcp)<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="2334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>meta_rtp_transport_set_endpoint(meta_rtcp,lc-&gt;rtptf-&gt;video_rtcp_func(lc-&gt;rtptf-&gt;video_rtcp_func_data,<sp/>call-&gt;media_ports[1].rtcp_port));</highlight></codeline>
<codeline lineno="2335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream_app_evq<sp/>=<sp/>ortp_ev_queue_new();</highlight></codeline>
<codeline lineno="2338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_register_event_queue(call-&gt;videostream-&gt;ms.sessions.rtp_session,call-&gt;videostream_app_evq);</highlight></codeline>
<codeline lineno="2339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__network__parameters_1ga2ba2ed66104f0adbc83b6cd55ebb0fde" kindref="member">sephone_core_get_firewall_policy</ref>(lc)<sp/>==<sp/><ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a4f5a7f79bf45f888288ab1e36b50a9ec" kindref="member">SephonePolicyUseIce</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_sephone_call_prepare_ice_for_stream(call,1,FALSE);</highlight></codeline>
<codeline lineno="2341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2342"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>TEST_EXT_RENDERER</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_render_callback(call-&gt;videostream,rendercb,NULL);</highlight></codeline>
<codeline lineno="2344"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2346"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream=NULL;</highlight></codeline>
<codeline lineno="2348"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2349"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2350"><highlight class="normal"></highlight></codeline>
<codeline lineno="2351"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_init_media_streams(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="2352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="2353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_init_audio_stream(call);</highlight></codeline>
<codeline lineno="2354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_init_video_stream(call);</highlight></codeline>
<codeline lineno="2355"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2356"><highlight class="normal"></highlight></codeline>
<codeline lineno="2357"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_core_umsg_received(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*message){</highlight></codeline>
<codeline lineno="2358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_umsg_received(lc,<sp/><ref refid="group__call__control_1ga5ad83841292c03b00ff37037ad415498" kindref="member">sephone_core_get_current_call</ref>(lc),<sp/>message);</highlight></codeline>
<codeline lineno="2359"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2360"><highlight class="normal"></highlight></codeline>
<codeline lineno="2361"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>dtmf_tab[16]={</highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;1&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;2&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;3&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;4&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;5&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;6&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;7&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;8&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;9&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;*&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;#&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;A&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;B&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;C&apos;</highlight><highlight class="normal">,</highlight><highlight class="charliteral">&apos;D&apos;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2362"><highlight class="normal"></highlight></codeline>
<codeline lineno="2363"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_core_dtmf_received(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>dtmf){</highlight></codeline>
<codeline lineno="2364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dtmf&lt;0<sp/>||<sp/>dtmf&gt;15){</highlight></codeline>
<codeline lineno="2365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Bad<sp/>dtmf<sp/>value<sp/>%i&quot;</highlight><highlight class="normal">,dtmf);</highlight></codeline>
<codeline lineno="2366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_dtmf_received(lc,<sp/><ref refid="group__call__control_1ga5ad83841292c03b00ff37037ad415498" kindref="member">sephone_core_get_current_call</ref>(lc),<sp/>dtmf_tab[dtmf]);</highlight></codeline>
<codeline lineno="2369"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2370"><highlight class="normal"></highlight></codeline>
<codeline lineno="2371"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>parametrize_equalizer(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/>AudioStream<sp/>*st){</highlight></codeline>
<codeline lineno="2372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(st-&gt;equalizer){</highlight></codeline>
<codeline lineno="2373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSFilter<sp/>*f=st-&gt;equalizer;</highlight></codeline>
<codeline lineno="2374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>enabled=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;eq_active&quot;</highlight><highlight class="normal">,0);</highlight></codeline>
<codeline lineno="2375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*gains=<ref refid="group__misc_1ga5a32540697fb696aa4f306d9dbc844c5" kindref="member">sp_config_get_string</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;eq_gains&quot;</highlight><highlight class="normal">,NULL);</highlight></codeline>
<codeline lineno="2376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_EQUALIZER_SET_ACTIVE,&amp;enabled);</highlight></codeline>
<codeline lineno="2377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(enabled){</highlight></codeline>
<codeline lineno="2378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(gains){</highlight></codeline>
<codeline lineno="2379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="2380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bytes;</highlight></codeline>
<codeline lineno="2381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSEqualizerGain<sp/>g;</highlight></codeline>
<codeline lineno="2382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sscanf(gains,</highlight><highlight class="stringliteral">&quot;%f:%f:%f<sp/>%n&quot;</highlight><highlight class="normal">,&amp;g.frequency,&amp;g.gain,&amp;g.width,&amp;bytes)==3){</highlight></codeline>
<codeline lineno="2383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Read<sp/>equalizer<sp/>gains:<sp/>%f(~%f)<sp/>--&gt;<sp/>%f&quot;</highlight><highlight class="normal">,g.frequency,g.width,g.gain);</highlight></codeline>
<codeline lineno="2384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_EQUALIZER_SET_GAIN,&amp;g);</highlight></codeline>
<codeline lineno="2385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gains+=bytes;</highlight></codeline>
<codeline lineno="2386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(1);</highlight></codeline>
<codeline lineno="2388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2391"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2392"><highlight class="normal"></highlight></codeline>
<codeline lineno="2393"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>set_mic_gain_db(AudioStream<sp/>*st,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>gain){</highlight></codeline>
<codeline lineno="2394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_mic_gain_db(st,<sp/>gain);</highlight></codeline>
<codeline lineno="2395"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2396"><highlight class="normal"></highlight></codeline>
<codeline lineno="2397"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>set_playback_gain_db(AudioStream<sp/>*st,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>gain){</highlight></codeline>
<codeline lineno="2398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(st-&gt;volrecv){</highlight></codeline>
<codeline lineno="2399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,MS_VOLUME_SET_DB_GAIN,&amp;gain);</highlight></codeline>
<codeline lineno="2400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>apply<sp/>playback<sp/>gain:<sp/>gain<sp/>control<sp/>wasn&apos;t<sp/>activated.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2401"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2402"><highlight class="normal"></highlight></codeline>
<codeline lineno="2403"><highlight class="normal"></highlight><highlight class="comment">/*This<sp/>function<sp/>is<sp/>not<sp/>static<sp/>because<sp/>used<sp/>internally<sp/>in<sp/>linphone-daemon<sp/>project*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2404"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>_post_configure_audio_stream(AudioStream<sp/>*st,<sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/>bool_t<sp/>muted){</highlight></codeline>
<codeline lineno="2405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>mic_gain=lc-&gt;sound_conf.soft_mic_lev;</highlight></codeline>
<codeline lineno="2406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>thres<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>recv_gain;</highlight></codeline>
<codeline lineno="2408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>ng_thres=<ref refid="group__misc_1ga189a14dc1516843a8ab145e10dfbb5a5" kindref="member">sp_config_get_float</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;ng_thres&quot;</highlight><highlight class="normal">,0);<sp/></highlight><highlight class="comment">//<sp/>0.05</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>ng_floorgain=<ref refid="group__misc_1ga189a14dc1516843a8ab145e10dfbb5a5" kindref="member">sp_config_get_float</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;ng_floorgain&quot;</highlight><highlight class="normal">,0.005);<sp/></highlight><highlight class="comment">//<sp/>0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>mic_ng_thres;</highlight></codeline>
<codeline lineno="2411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ng_sustain;</highlight></codeline>
<codeline lineno="2412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>dc_removal;</highlight></codeline>
<codeline lineno="2413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>speed;</highlight></codeline>
<codeline lineno="2414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>downspeed;</highlight></codeline>
<codeline lineno="2415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>force;</highlight></codeline>
<codeline lineno="2416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>sustain;</highlight></codeline>
<codeline lineno="2417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>transmit_thres;</highlight></codeline>
<codeline lineno="2418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSFilter<sp/>*f=NULL;</highlight></codeline>
<codeline lineno="2419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>floorgain;</highlight></codeline>
<codeline lineno="2420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>spk_agc;</highlight></codeline>
<codeline lineno="2421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="2422"><highlight class="normal"></highlight></codeline>
<codeline lineno="2423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!muted)</highlight></codeline>
<codeline lineno="2424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_mic_gain_db(st,mic_gain);</highlight></codeline>
<codeline lineno="2425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_set_mic_gain(st,0);</highlight></codeline>
<codeline lineno="2427"><highlight class="normal"></highlight></codeline>
<codeline lineno="2428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recv_gain<sp/>=<sp/>lc-&gt;sound_conf.soft_play_lev;</highlight></codeline>
<codeline lineno="2429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(recv_gain<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_playback_gain_db(st,recv_gain);</highlight></codeline>
<codeline lineno="2431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2432"><highlight class="normal"></highlight></codeline>
<codeline lineno="2433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(st-&gt;volsend){</highlight></codeline>
<codeline lineno="2434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Configure<sp/>volume<sp/>[%p]<sp/>volsend<sp/>echolimiter&quot;</highlight><highlight class="normal">,<sp/>st-&gt;volsend-&gt;data);</highlight></codeline>
<codeline lineno="2435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mic_ng_thres=<ref refid="group__misc_1ga189a14dc1516843a8ab145e10dfbb5a5" kindref="member">sp_config_get_float</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;mic_ng_thres&quot;</highlight><highlight class="normal">,-1);</highlight></codeline>
<codeline lineno="2436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ng_sustain=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;ng_sustain&quot;</highlight><highlight class="normal">,-1);</highlight></codeline>
<codeline lineno="2437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dc_removal=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;dc_removal&quot;</highlight><highlight class="normal">,0);</highlight></codeline>
<codeline lineno="2438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>speed=<ref refid="group__misc_1ga189a14dc1516843a8ab145e10dfbb5a5" kindref="member">sp_config_get_float</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;el_speed&quot;</highlight><highlight class="normal">,-1);</highlight></codeline>
<codeline lineno="2439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>downspeed=<ref refid="group__misc_1ga189a14dc1516843a8ab145e10dfbb5a5" kindref="member">sp_config_get_float</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;el_downspeed&quot;</highlight><highlight class="normal">,-1);</highlight></codeline>
<codeline lineno="2440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>force=<ref refid="group__misc_1ga189a14dc1516843a8ab145e10dfbb5a5" kindref="member">sp_config_get_float</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;el_force&quot;</highlight><highlight class="normal">,-1);</highlight></codeline>
<codeline lineno="2441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>thres=<ref refid="group__misc_1ga189a14dc1516843a8ab145e10dfbb5a5" kindref="member">sp_config_get_float</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;el_thres&quot;</highlight><highlight class="normal">,-1);</highlight></codeline>
<codeline lineno="2442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sustain=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;el_sustain&quot;</highlight><highlight class="normal">,-1);</highlight></codeline>
<codeline lineno="2443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transmit_thres=<ref refid="group__misc_1ga189a14dc1516843a8ab145e10dfbb5a5" kindref="member">sp_config_get_float</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;el_transmit_thres&quot;</highlight><highlight class="normal">,-1);</highlight></codeline>
<codeline lineno="2444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f=st-&gt;volsend;</highlight></codeline>
<codeline lineno="2445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(speed&lt;0)<sp/>speed=0.4;<sp/></highlight><highlight class="comment">//<sp/>0.03</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(downspeed&lt;0)<sp/>downspeed=0.4;<sp/></highlight><highlight class="comment">//<sp/>0.05</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(force&lt;0)<sp/>force=4.0;<sp/></highlight><highlight class="comment">//<sp/>25</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_REMOVE_DC,&amp;dc_removal);</highlight></codeline>
<codeline lineno="2449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_SPEED,&amp;speed);</highlight></codeline>
<codeline lineno="2450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_DOWNSPEED,&amp;downspeed);</highlight></codeline>
<codeline lineno="2451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_FORCE,&amp;force);</highlight></codeline>
<codeline lineno="2452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(thres!=-1)</highlight></codeline>
<codeline lineno="2453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_THRESHOLD,&amp;thres);</highlight></codeline>
<codeline lineno="2454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sustain!=-1)</highlight></codeline>
<codeline lineno="2455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_SUSTAIN,&amp;sustain);</highlight></codeline>
<codeline lineno="2456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(transmit_thres!=-1)</highlight></codeline>
<codeline lineno="2457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(f,MS_VOLUME_SET_EA_TRANSMIT_THRESHOLD,&amp;transmit_thres);</highlight></codeline>
<codeline lineno="2458"><highlight class="normal"></highlight></codeline>
<codeline lineno="2459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ng_sustain<sp/>!=<sp/>-1)</highlight></codeline>
<codeline lineno="2460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_SET_NOISE_GATE_SUSTAIN,&amp;ng_sustain);</highlight></codeline>
<codeline lineno="2461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mic_ng_thresng_thres</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mic_ng_thres&gt;0)<sp/>{</highlight></codeline>
<codeline lineno="2463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_SET_NOISE_GATE_THRESHOLD,&amp;mic_ng_thres);</highlight></codeline>
<codeline lineno="2464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_SET_NOISE_GATE_THRESHOLD,&amp;ng_thres);</highlight></codeline>
<codeline lineno="2466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_SET_NOISE_GATE_FLOORGAIN,&amp;ng_floorgain);</highlight></codeline>
<codeline lineno="2468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(st-&gt;volrecv){</highlight></codeline>
<codeline lineno="2470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Configure<sp/>volume<sp/>[%p]<sp/>volrecv<sp/>speaker&quot;</highlight><highlight class="normal">,<sp/>st-&gt;volrecv-&gt;data);</highlight></codeline>
<codeline lineno="2471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>parameters<sp/>for<sp/>a<sp/>limited<sp/>noise-gate<sp/>effect,<sp/>using<sp/>echo<sp/>limiter<sp/>threshold<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>floorgain<sp/>=<sp/>1/pow(10,(mic_gain)/10);</highlight></codeline>
<codeline lineno="2473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(floorgain<sp/>&gt;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="2474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>floorgain<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="2475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spk_agc=<ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;speaker_agc_enabled&quot;</highlight><highlight class="normal">,0);</highlight></codeline>
<codeline lineno="2477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,<sp/>MS_VOLUME_ENABLE_AGC,<sp/>&amp;spk_agc);</highlight></codeline>
<codeline lineno="2478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,MS_VOLUME_SET_NOISE_GATE_THRESHOLD,&amp;ng_thres);</highlight></codeline>
<codeline lineno="2479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,MS_VOLUME_SET_NOISE_GATE_FLOORGAIN,&amp;floorgain);</highlight></codeline>
<codeline lineno="2480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>parametrize_equalizer(lc,st);</highlight></codeline>
<codeline lineno="2482"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2483"><highlight class="normal"></highlight></codeline>
<codeline lineno="2484"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>post_configure_audio_streams(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>muted){</highlight></codeline>
<codeline lineno="2485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AudioStream<sp/>*st=call-&gt;audiostream;</highlight></codeline>
<codeline lineno="2486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="2487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="2488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_post_configure_audio_stream(st,lc,muted);</highlight></codeline>
<codeline lineno="2489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sephone_core_dtmf_received_has_listener(lc)){</highlight></codeline>
<codeline lineno="2490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_play_received_dtmfs(call-&gt;audiostream,FALSE);</highlight></codeline>
<codeline lineno="2491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;record_active)</highlight></codeline>
<codeline lineno="2493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__misc_1gafe73207455c50945718abb84b3baf950" kindref="member">sephone_call_start_recording</ref>(call);</highlight></codeline>
<codeline lineno="2494"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2495"><highlight class="normal"></highlight></codeline>
<codeline lineno="2496"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>get_ideal_audio_bw(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalMediaDescription<sp/>*md,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*desc){</highlight></codeline>
<codeline lineno="2497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>remote_bw=0;</highlight></codeline>
<codeline lineno="2498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>upload_bw;</highlight></codeline>
<codeline lineno="2499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>total_upload_bw=<ref refid="group__media__parameters_1ga8ee41e9c38a10569d1287c7b6b4e35aa" kindref="member">sephone_core_get_upload_bandwidth</ref>(call-&gt;core);</highlight></codeline>
<codeline lineno="2500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params=call-&gt;params;</highlight></codeline>
<codeline lineno="2501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>will_use_video=sephone_core_media_description_contains_video_stream(md);</highlight></codeline>
<codeline lineno="2502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>forced=FALSE;</highlight></codeline>
<codeline lineno="2503"><highlight class="normal"></highlight></codeline>
<codeline lineno="2504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(desc-&gt;bandwidth&gt;0)<sp/>remote_bw=desc-&gt;bandwidth;</highlight></codeline>
<codeline lineno="2505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;bandwidth&gt;0)<sp/>{</highlight></codeline>
<codeline lineno="2506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*case<sp/>where<sp/>b=AS<sp/>is<sp/>given<sp/>globally,<sp/>not<sp/>per<sp/>stream*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remote_bw=md-&gt;bandwidth;</highlight></codeline>
<codeline lineno="2508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;up_bw&gt;0){</highlight></codeline>
<codeline lineno="2510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>forced=TRUE;</highlight></codeline>
<codeline lineno="2511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=params-&gt;up_bw;</highlight></codeline>
<codeline lineno="2512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>upload_bw=total_upload_bw;</highlight></codeline>
<codeline lineno="2513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=get_min_bandwidth(upload_bw,remote_bw);</highlight></codeline>
<codeline lineno="2514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!will_use_video<sp/>||<sp/>forced)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>upload_bw;</highlight></codeline>
<codeline lineno="2515"><highlight class="normal"></highlight></codeline>
<codeline lineno="2516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(bandwidth_is_greater(upload_bw,512)){</highlight></codeline>
<codeline lineno="2517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=100;</highlight></codeline>
<codeline lineno="2518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(bandwidth_is_greater(upload_bw,256)){</highlight></codeline>
<codeline lineno="2519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=64;</highlight></codeline>
<codeline lineno="2520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(bandwidth_is_greater(upload_bw,128)){</highlight></codeline>
<codeline lineno="2521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=40;</highlight></codeline>
<codeline lineno="2522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(bandwidth_is_greater(upload_bw,0)){</highlight></codeline>
<codeline lineno="2523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>upload_bw=24;</highlight></codeline>
<codeline lineno="2524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>upload_bw;</highlight></codeline>
<codeline lineno="2526"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2527"><highlight class="normal"></highlight></codeline>
<codeline lineno="2528"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>get_video_bw(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalMediaDescription<sp/>*md,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*desc){</highlight></codeline>
<codeline lineno="2529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>remote_bw=0;</highlight></codeline>
<codeline lineno="2530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bw;</highlight></codeline>
<codeline lineno="2531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(desc-&gt;bandwidth&gt;0)<sp/>remote_bw=desc-&gt;bandwidth;</highlight></codeline>
<codeline lineno="2532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(md-&gt;bandwidth&gt;0)<sp/>{</highlight></codeline>
<codeline lineno="2533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*case<sp/>where<sp/>b=AS<sp/>is<sp/>given<sp/>globally,<sp/>not<sp/>per<sp/>stream*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remote_bw=get_remaining_bandwidth_for_video(md-&gt;bandwidth,call-&gt;audio_bw);</highlight></codeline>
<codeline lineno="2535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remote_bw<sp/>=<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(call-&gt;core-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;net&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;default_max_bandwidth&quot;</highlight><highlight class="normal">,<sp/>1500);</highlight></codeline>
<codeline lineno="2537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bw=get_min_bandwidth(get_remaining_bandwidth_for_video(<ref refid="group__media__parameters_1ga8ee41e9c38a10569d1287c7b6b4e35aa" kindref="member">sephone_core_get_upload_bandwidth</ref>(call-&gt;core),call-&gt;audio_bw),remote_bw);</highlight></codeline>
<codeline lineno="2539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>bw;</highlight></codeline>
<codeline lineno="2540"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2541"><highlight class="normal"></highlight></codeline>
<codeline lineno="2542"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>RtpProfile<sp/>*make_profile(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalMediaDescription<sp/>*md,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*desc,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>*used_pt){</highlight></codeline>
<codeline lineno="2543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bw=0;</highlight></codeline>
<codeline lineno="2544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSList<sp/>*elem;</highlight></codeline>
<codeline lineno="2545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpProfile<sp/>*prof=rtp_profile_new(</highlight><highlight class="stringliteral">&quot;Call<sp/>profile&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>first=TRUE;</highlight></codeline>
<codeline lineno="2547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="2548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>up_ptime=0;</highlight></codeline>
<codeline lineno="2549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params=call-&gt;params;</highlight></codeline>
<codeline lineno="2550"><highlight class="normal"></highlight></codeline>
<codeline lineno="2551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*used_pt=-1;</highlight></codeline>
<codeline lineno="2552"><highlight class="normal"></highlight></codeline>
<codeline lineno="2553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(desc-&gt;type==SalAudio)</highlight></codeline>
<codeline lineno="2554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bw=get_ideal_audio_bw(call,md,desc);</highlight></codeline>
<codeline lineno="2555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(desc-&gt;type==SalVideo)</highlight></codeline>
<codeline lineno="2556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bw=get_video_bw(call,md,desc);</highlight></codeline>
<codeline lineno="2557"><highlight class="normal"></highlight></codeline>
<codeline lineno="2558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(elem=desc-&gt;payloads;elem!=NULL;elem=elem-&gt;next){</highlight></codeline>
<codeline lineno="2559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PayloadType<sp/>*pt=(PayloadType*)elem-&gt;data;</highlight></codeline>
<codeline lineno="2560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>number;</highlight></codeline>
<codeline lineno="2561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>make<sp/>a<sp/>copy<sp/>of<sp/>the<sp/>payload<sp/>type,<sp/>so<sp/>that<sp/>we<sp/>left<sp/>the<sp/>ones<sp/>from<sp/>the<sp/>SalStreamDescription<sp/>unchanged.</highlight></codeline>
<codeline lineno="2562"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>If<sp/>the<sp/>SalStreamDescription<sp/>is<sp/>freed,<sp/>this<sp/>will<sp/>have<sp/>no<sp/>impact<sp/>on<sp/>the<sp/>running<sp/>streams*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt=payload_type_clone(pt);</highlight></codeline>
<codeline lineno="2564"><highlight class="normal"></highlight></codeline>
<codeline lineno="2565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((pt-&gt;flags<sp/>&amp;<sp/>PAYLOAD_TYPE_FLAG_CAN_SEND)<sp/>&amp;&amp;<sp/>first)<sp/>{</highlight></codeline>
<codeline lineno="2566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*first<sp/>codec<sp/>in<sp/>list<sp/>is<sp/>the<sp/>selected<sp/>one*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(desc-&gt;type==SalAudio){</highlight></codeline>
<codeline lineno="2568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*this<sp/>will<sp/>update<sp/>call-&gt;audio_bw*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_allocated_audio_bandwidth_in_call(call,pt,bw);</highlight></codeline>
<codeline lineno="2571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bw=call-&gt;audio_bw;</highlight></codeline>
<codeline lineno="2572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params-&gt;up_ptime)</highlight></codeline>
<codeline lineno="2573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>up_ptime=params-&gt;up_ptime;</highlight></codeline>
<codeline lineno="2574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>up_ptime=<ref refid="group__media__parameters_1ga44a5b8010afbfd3d6f7fc242ce8837c8" kindref="member">sephone_core_get_upload_ptime</ref>(lc);</highlight></codeline>
<codeline lineno="2575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*used_pt=payload_type_get_number(pt);</highlight></codeline>
<codeline lineno="2577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>first=FALSE;</highlight></codeline>
<codeline lineno="2578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pt-&gt;flags<sp/>&amp;<sp/>PAYLOAD_TYPE_BITRATE_OVERRIDE){</highlight></codeline>
<codeline lineno="2580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Payload<sp/>type<sp/>[%s/%i]<sp/>has<sp/>explicit<sp/>bitrate<sp/>[%i]<sp/>kbit/s&quot;</highlight><highlight class="normal">,<sp/>pt-&gt;mime_type,<sp/>pt-&gt;clock_rate,<sp/>pt-&gt;normal_bitrate/1000);</highlight></codeline>
<codeline lineno="2581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt-&gt;normal_bitrate=get_min_bandwidth(pt-&gt;normal_bitrate,bw*1000);</highlight></codeline>
<codeline lineno="2582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>pt-&gt;normal_bitrate=bw*1000;</highlight></codeline>
<codeline lineno="2583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(desc-&gt;ptime&gt;0){</highlight></codeline>
<codeline lineno="2584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>up_ptime=desc-&gt;ptime;</highlight></codeline>
<codeline lineno="2585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(up_ptime&gt;0){</highlight></codeline>
<codeline lineno="2587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>tmp[40];</highlight></codeline>
<codeline lineno="2588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snprintf(tmp,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(tmp),</highlight><highlight class="stringliteral">&quot;ptime=%i&quot;</highlight><highlight class="normal">,up_ptime);</highlight></codeline>
<codeline lineno="2589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>payload_type_append_send_fmtp(pt,tmp);</highlight></codeline>
<codeline lineno="2590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>number=payload_type_get_number(pt);</highlight></codeline>
<codeline lineno="2592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rtp_profile_get_payload(prof,number)!=NULL){</highlight></codeline>
<codeline lineno="2593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;A<sp/>payload<sp/>type<sp/>with<sp/>number<sp/>%i<sp/>already<sp/>exists<sp/>in<sp/>profile<sp/>!&quot;</highlight><highlight class="normal">,number);</highlight></codeline>
<codeline lineno="2594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_profile_set_payload(prof,number,pt);</highlight></codeline>
<codeline lineno="2596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>prof;</highlight></codeline>
<codeline lineno="2598"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2599"><highlight class="normal"></highlight></codeline>
<codeline lineno="2600"><highlight class="normal"></highlight></codeline>
<codeline lineno="2601"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>setup_ring_player(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="2602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>pause_time=3000;</highlight></codeline>
<codeline lineno="2603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_play(call-&gt;audiostream,lc-&gt;sound_conf.ringback_tone);</highlight></codeline>
<codeline lineno="2604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;soundread,MS_FILE_PLAYER_LOOP,&amp;pause_time);</highlight></codeline>
<codeline lineno="2605"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2606"><highlight class="normal"></highlight></codeline>
<codeline lineno="2607"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>bool_t<sp/>sephone_call_sound_resources_available(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="2608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="2609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*current=<ref refid="group__call__control_1ga5ad83841292c03b00ff37037ad415498" kindref="member">sephone_core_get_current_call</ref>(lc);</highlight></codeline>
<codeline lineno="2610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>!<ref refid="group__conferencing_1ga23e6b8593f87ec92ca598257385130a6" kindref="member">sephone_core_is_in_conference</ref>(lc)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(current==NULL<sp/>||<sp/>current==call);</highlight></codeline>
<codeline lineno="2612"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2613"><highlight class="normal"></highlight></codeline>
<codeline lineno="2614"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>find_crypto_index_from_tag(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalSrtpCryptoAlgo<sp/>crypto[],</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>tag)<sp/>{</highlight></codeline>
<codeline lineno="2615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="2616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(i=0;<sp/>i&lt;SAL_CRYPTO_ALGO_MAX;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="2617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(crypto[i].tag<sp/>==<sp/>tag)<sp/>{</highlight></codeline>
<codeline lineno="2618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="2619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="2622"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2623"><highlight class="normal"></highlight></codeline>
<codeline lineno="2624"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>configure_rtp_session_for_rtcp_xr(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>SalStreamType<sp/>type)<sp/>{</highlight></codeline>
<codeline lineno="2625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RtpSession<sp/>*session;</highlight></codeline>
<codeline lineno="2626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>OrtpRtcpXrConfiguration<sp/>*localconfig;</highlight></codeline>
<codeline lineno="2627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>OrtpRtcpXrConfiguration<sp/>*remoteconfig;</highlight></codeline>
<codeline lineno="2628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpRtcpXrConfiguration<sp/>currentconfig;</highlight></codeline>
<codeline lineno="2629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*localstream;</highlight></codeline>
<codeline lineno="2630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*remotestream;</highlight></codeline>
<codeline lineno="2631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*remotedesc<sp/>=<sp/>sal_call_get_remote_media_description(call-&gt;op);</highlight></codeline>
<codeline lineno="2632"><highlight class="normal"></highlight></codeline>
<codeline lineno="2633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!remotedesc)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2634"><highlight class="normal"></highlight></codeline>
<codeline lineno="2635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>localstream<sp/>=<sp/>sal_media_description_find_best_stream(call-&gt;localdesc,<sp/>type);</highlight></codeline>
<codeline lineno="2636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!localstream)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>localconfig<sp/>=<sp/>&amp;localstream-&gt;rtcp_xr;</highlight></codeline>
<codeline lineno="2638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remotestream<sp/>=<sp/>sal_media_description_find_best_stream(remotedesc,<sp/>type);</highlight></codeline>
<codeline lineno="2639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!remotestream)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remoteconfig<sp/>=<sp/>&amp;remotestream-&gt;rtcp_xr;</highlight></codeline>
<codeline lineno="2641"><highlight class="normal"></highlight></codeline>
<codeline lineno="2642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(localstream-&gt;dir<sp/>==<sp/>SalStreamInactive)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(localstream-&gt;dir<sp/>==<sp/>SalStreamRecvOnly)<sp/>{</highlight></codeline>
<codeline lineno="2644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Use<sp/>local<sp/>config<sp/>for<sp/>unilateral<sp/>parameters<sp/>and<sp/>remote<sp/>config<sp/>for<sp/>collaborative<sp/>parameters.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;currentconfig,<sp/>localconfig,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(currentconfig));</highlight></codeline>
<codeline lineno="2646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>currentconfig.rcvr_rtt_mode<sp/>=<sp/>remoteconfig-&gt;rcvr_rtt_mode;</highlight></codeline>
<codeline lineno="2647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>currentconfig.rcvr_rtt_max_size<sp/>=<sp/>remoteconfig-&gt;rcvr_rtt_max_size;</highlight></codeline>
<codeline lineno="2648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;currentconfig,<sp/>remoteconfig,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(currentconfig));</highlight></codeline>
<codeline lineno="2650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(type<sp/>==<sp/>SalAudio)<sp/>{</highlight></codeline>
<codeline lineno="2652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>session<sp/>=<sp/>call-&gt;audiostream-&gt;ms.sessions.rtp_session;</highlight></codeline>
<codeline lineno="2653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>session<sp/>=<sp/>call-&gt;videostream-&gt;ms.sessions.rtp_session;</highlight></codeline>
<codeline lineno="2655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_configure_rtcp_xr(session,<sp/>&amp;currentconfig);</highlight></codeline>
<codeline lineno="2657"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2658"><highlight class="normal"></highlight></codeline>
<codeline lineno="2659"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>start_dtls(<sp/>MSMediaStreamSessions<sp/>*sessions,<sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*sd,</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*remote)<sp/>{</highlight></codeline>
<codeline lineno="2660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_stream_description_has_dtls(sd)<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="2661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*DTLS*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalDtlsRole<sp/>salRole<sp/>=<sp/>sd-&gt;dtls_role;</highlight></codeline>
<codeline lineno="2663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(salRole!=SalDtlsRoleInvalid)<sp/>{<sp/></highlight><highlight class="comment">/*<sp/>if<sp/>DTLS<sp/>is<sp/>available<sp/>at<sp/>both<sp/>end<sp/>points<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>give<sp/>the<sp/>peer<sp/>certificate<sp/>fingerprint<sp/>to<sp/>dtls<sp/>context<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_dtls_srtp_set_peer_fingerprint(sessions-&gt;dtls_context,<sp/>remote-&gt;dtls_fingerprint);</highlight></codeline>
<codeline lineno="2666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_dtls_srtp_set_role(sessions-&gt;dtls_context,<sp/>(salRole<sp/>==<sp/>SalDtlsRoleIsClient)?MSDtlsSrtpRoleIsClient:MSDtlsSrtpRoleIsServer);<sp/></highlight><highlight class="comment">/*<sp/>set<sp/>the<sp/>role<sp/>to<sp/>client<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_dtls_srtp_start(sessions-&gt;dtls_context);<sp/><sp/></highlight><highlight class="comment">/*<sp/>then<sp/>start<sp/>the<sp/>engine,<sp/>it<sp/>will<sp/>send<sp/>the<sp/>DTLS<sp/>client<sp/>Hello<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;unable<sp/>to<sp/>start<sp/>DTLS<sp/>engine<sp/>on<sp/>stream<sp/>session<sp/>[%p],<sp/>Dtls<sp/>role<sp/>in<sp/>resulting<sp/>media<sp/>description<sp/>is<sp/>invalid&quot;</highlight><highlight class="normal">,sessions);</highlight></codeline>
<codeline lineno="2670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2672"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2673"><highlight class="normal"></highlight></codeline>
<codeline lineno="2674"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>start_dtls_on_all_streams(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="2675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*remote_desc<sp/>=<sp/>sal_call_get_remote_media_description(call-&gt;op);</highlight></codeline>
<codeline lineno="2676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*result_desc<sp/>=<sp/>sal_call_get_final_media_description(call-&gt;op);</highlight></codeline>
<codeline lineno="2677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>remote_desc<sp/>==<sp/>NULL<sp/>||<sp/>result_desc<sp/>==<sp/>NULL<sp/>){</highlight></codeline>
<codeline lineno="2678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>this<sp/>can<sp/>happen<sp/>in<sp/>some<sp/>tricky<sp/>cases<sp/>(early-media<sp/>without<sp/>SDP<sp/>in<sp/>the<sp/>200).<sp/>In<sp/>that<sp/>case,<sp/>simply<sp/>skip<sp/>DTLS<sp/>code<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2681"><highlight class="normal"></highlight></codeline>
<codeline lineno="2682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>(media_stream_get_state((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MediaStream<sp/>*)call-&gt;audiostream)<sp/>==<sp/>MSStreamStarted))</highlight><highlight class="comment">/*dtls<sp/>must<sp/>start<sp/>at<sp/>the<sp/>end<sp/>of<sp/>ice*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_dtls(&amp;call-&gt;audiostream-&gt;ms.sessions</highlight></codeline>
<codeline lineno="2684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(result_desc,SalAudio)</highlight></codeline>
<codeline lineno="2685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(remote_desc,SalAudio));</highlight></codeline>
<codeline lineno="2686"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>(media_stream_get_state((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted))</highlight><highlight class="comment">/*dtls<sp/>must<sp/>start<sp/>at<sp/>the<sp/>end<sp/>of<sp/>ice*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_dtls(&amp;call-&gt;videostream-&gt;ms.sessions</highlight></codeline>
<codeline lineno="2689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(result_desc,SalVideo)</highlight></codeline>
<codeline lineno="2690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(remote_desc,SalVideo));</highlight></codeline>
<codeline lineno="2691"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2693"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2694"><highlight class="normal"></highlight></codeline>
<codeline lineno="2695"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>set_dtls_fingerprint(<sp/>MSMediaStreamSessions<sp/>*sessions,<sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*sd,</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*remote)<sp/>{</highlight></codeline>
<codeline lineno="2696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_stream_description_has_dtls(sd)<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="2697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*DTLS*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalDtlsRole<sp/>salRole<sp/>=<sp/>sd-&gt;dtls_role;</highlight></codeline>
<codeline lineno="2699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(salRole!=SalDtlsRoleInvalid)<sp/>{<sp/></highlight><highlight class="comment">/*<sp/>if<sp/>DTLS<sp/>is<sp/>available<sp/>at<sp/>both<sp/>end<sp/>points<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>give<sp/>the<sp/>peer<sp/>certificate<sp/>fingerprint<sp/>to<sp/>dtls<sp/>context<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_dtls_srtp_set_peer_fingerprint(sessions-&gt;dtls_context,<sp/>remote-&gt;dtls_fingerprint);</highlight></codeline>
<codeline lineno="2702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;unable<sp/>to<sp/>start<sp/>DTLS<sp/>engine<sp/>on<sp/>stream<sp/>session<sp/>[%p],<sp/>Dtls<sp/>role<sp/>in<sp/>resulting<sp/>media<sp/>description<sp/>is<sp/>invalid&quot;</highlight><highlight class="normal">,sessions);</highlight></codeline>
<codeline lineno="2704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2706"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2707"><highlight class="normal"></highlight></codeline>
<codeline lineno="2708"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>set_dtls_fingerprint_on_all_streams(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="2709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*remote_desc<sp/>=<sp/>sal_call_get_remote_media_description(call-&gt;op);</highlight></codeline>
<codeline lineno="2710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*result_desc<sp/>=<sp/>sal_call_get_final_media_description(call-&gt;op);</highlight></codeline>
<codeline lineno="2711"><highlight class="normal"></highlight></codeline>
<codeline lineno="2712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>remote_desc<sp/>==<sp/>NULL<sp/>||<sp/>result_desc<sp/>==<sp/>NULL<sp/>){</highlight></codeline>
<codeline lineno="2713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>this<sp/>can<sp/>happen<sp/>in<sp/>some<sp/>tricky<sp/>cases<sp/>(early-media<sp/>without<sp/>SDP<sp/>in<sp/>the<sp/>200).<sp/>In<sp/>that<sp/>case,<sp/>simply<sp/>skip<sp/>DTLS<sp/>code<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2716"><highlight class="normal"></highlight></codeline>
<codeline lineno="2717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>(media_stream_get_state((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MediaStream<sp/>*)call-&gt;audiostream)<sp/>==<sp/>MSStreamStarted))</highlight><highlight class="comment">/*dtls<sp/>must<sp/>start<sp/>at<sp/>the<sp/>end<sp/>of<sp/>ice*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_dtls_fingerprint(&amp;call-&gt;audiostream-&gt;ms.sessions</highlight></codeline>
<codeline lineno="2719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(result_desc,SalAudio)</highlight></codeline>
<codeline lineno="2720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(remote_desc,SalAudio));</highlight></codeline>
<codeline lineno="2721"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>(media_stream_get_state((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted))</highlight><highlight class="comment">/*dtls<sp/>must<sp/>start<sp/>at<sp/>the<sp/>end<sp/>of<sp/>ice*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_dtls_fingerprint(&amp;call-&gt;videostream-&gt;ms.sessions</highlight></codeline>
<codeline lineno="2724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(result_desc,SalVideo)</highlight></codeline>
<codeline lineno="2725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sal_media_description_find_best_stream(remote_desc,SalVideo));</highlight></codeline>
<codeline lineno="2726"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2728"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2729"><highlight class="normal"></highlight></codeline>
<codeline lineno="2730"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_start_audio_stream(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>muted,<sp/>bool_t<sp/>send_ringbacktone,<sp/>bool_t<sp/>use_arc){</highlight></codeline>
<codeline lineno="2731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="2732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__misc_1ga224933b87fd3d0bbcb9b61850ddfa3fb" kindref="member">SpConfig</ref>*<sp/>conf;</highlight></codeline>
<codeline lineno="2733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>used_pt=-1;</highlight></codeline>
<codeline lineno="2734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>rtcp_tool[128]={0};</highlight></codeline>
<codeline lineno="2735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*stream;</highlight></codeline>
<codeline lineno="2736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSSndCard<sp/>*playcard;</highlight></codeline>
<codeline lineno="2737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSSndCard<sp/>*captcard;</highlight></codeline>
<codeline lineno="2738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>use_ec;</highlight></codeline>
<codeline lineno="2739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>mute;</highlight></codeline>
<codeline lineno="2740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*playfile;</highlight></codeline>
<codeline lineno="2741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*recfile;</highlight></codeline>
<codeline lineno="2742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*local_st_desc;</highlight></codeline>
<codeline lineno="2743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>crypto_idx;</highlight></codeline>
<codeline lineno="2744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSStunMsg<sp/>smsg;</highlight></codeline>
<codeline lineno="2745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="2746"><highlight class="normal"></highlight></codeline>
<codeline lineno="2747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snprintf(rtcp_tool,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(rtcp_tool)-1,</highlight><highlight class="stringliteral">&quot;%s-%s&quot;</highlight><highlight class="normal">,sephone_core_get_user_agent_name(),sephone_core_get_user_agent_version());</highlight></codeline>
<codeline lineno="2748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;smsg,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(smsg));</highlight></codeline>
<codeline lineno="2749"><highlight class="normal"></highlight></codeline>
<codeline lineno="2750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stream<sp/>=<sp/>sal_media_description_find_best_stream(call-&gt;resultdesc,<sp/>SalAudio);</highlight></codeline>
<codeline lineno="2751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stream<sp/>&amp;&amp;<sp/>stream-&gt;dir!=SalStreamInactive<sp/>&amp;&amp;<sp/>stream-&gt;rtp_port!=0){</highlight></codeline>
<codeline lineno="2752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rtp_addr=stream-&gt;rtp_addr[0]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal"><sp/>?<sp/>stream-&gt;rtp_addr<sp/>:<sp/>call-&gt;resultdesc-&gt;addr;</highlight></codeline>
<codeline lineno="2753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>is_multicast=ms_is_multicast(rtp_addr);</highlight></codeline>
<codeline lineno="2754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard=lc-&gt;sound_conf.ssd_card<sp/>?</highlight></codeline>
<codeline lineno="2755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;sound_conf.ssd_card<sp/>:<sp/>lc-&gt;sound_conf.play_sndcard;</highlight></codeline>
<codeline lineno="2756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=lc-&gt;sound_conf.capt_sndcard;</highlight></codeline>
<codeline lineno="2757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playfile=lc-&gt;play_file;</highlight></codeline>
<codeline lineno="2758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recfile=lc-&gt;rec_file;</highlight></codeline>
<codeline lineno="2759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audio_profile=make_profile(call,call-&gt;resultdesc,stream,&amp;used_pt);</highlight></codeline>
<codeline lineno="2760"><highlight class="normal"></highlight></codeline>
<codeline lineno="2761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(used_pt!=-1){</highlight></codeline>
<codeline lineno="2762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;audio_codec<sp/>=<sp/>rtp_profile_get_payload(call-&gt;audio_profile,<sp/>used_pt);</highlight></codeline>
<codeline lineno="2763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(playcard==NULL)<sp/>{</highlight></codeline>
<codeline lineno="2764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;No<sp/>card<sp/>defined<sp/>for<sp/>playback<sp/>!&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(captcard==NULL)<sp/>{</highlight></codeline>
<codeline lineno="2767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;No<sp/>card<sp/>defined<sp/>for<sp/>capture<sp/>!&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*Replace<sp/>soundcard<sp/>filters<sp/>by<sp/>inactive<sp/>file<sp/>players<sp/>or<sp/>recorders</highlight></codeline>
<codeline lineno="2770"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>when<sp/>placed<sp/>in<sp/>recvonly<sp/>or<sp/>sendonly<sp/>mode*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stream-&gt;rtp_port==0</highlight></codeline>
<codeline lineno="2772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>||<sp/>stream-&gt;dir==SalStreamRecvOnly</highlight></codeline>
<codeline lineno="2773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>||<sp/>(stream-&gt;multicast_role<sp/>==<sp/>SalMulticastReceiver<sp/>&amp;&amp;<sp/>is_multicast)){</highlight></codeline>
<codeline lineno="2774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=NULL;</highlight></codeline>
<codeline lineno="2775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playfile=NULL;</highlight></codeline>
<codeline lineno="2776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stream-&gt;dir==SalStreamSendOnly){</highlight></codeline>
<codeline lineno="2777"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard=NULL;</highlight></codeline>
<codeline lineno="2778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=NULL;</highlight></codeline>
<codeline lineno="2779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recfile=NULL;</highlight></codeline>
<codeline lineno="2780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*And<sp/>we<sp/>will<sp/>eventually<sp/>play<sp/>&quot;playfile&quot;<sp/>if<sp/>set<sp/>by<sp/>the<sp/>user*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*playfile=NULL;*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(send_ringbacktone){</highlight></codeline>
<codeline lineno="2784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>conf<sp/>=<sp/><ref refid="group__misc_1ga12a1ed617f638095305de477a11dabe5" kindref="member">sephone_core_get_config</ref>(lc);</highlight></codeline>
<codeline lineno="2785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=NULL;</highlight></codeline>
<codeline lineno="2786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playfile=NULL;</highlight><highlight class="comment">/*<sp/>it<sp/>is<sp/>setup<sp/>later*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2787"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>conf<sp/>&amp;&amp;<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(conf,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;send_ringback_without_playback&quot;</highlight><highlight class="normal">,<sp/>0)<sp/>==<sp/>1){</highlight></codeline>
<codeline lineno="2788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="2789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recfile<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="2790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*if<sp/>playfile<sp/>are<sp/>supplied<sp/>don&apos;t<sp/>use<sp/>soundcards*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;use_files)<sp/>{</highlight></codeline>
<codeline lineno="2794"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=NULL;</highlight></codeline>
<codeline lineno="2795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard=NULL;</highlight></codeline>
<codeline lineno="2796"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;in_conference){</highlight></codeline>
<codeline lineno="2798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>first<sp/>create<sp/>the<sp/>graph<sp/>without<sp/>soundcard<sp/>resources*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=playcard=NULL;</highlight></codeline>
<codeline lineno="2800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sephone_call_sound_resources_available(call)){</highlight></codeline>
<codeline lineno="2802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Sound<sp/>resources<sp/>are<sp/>used<sp/>by<sp/>another<sp/>call,<sp/>not<sp/>using<sp/>soundcard.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard=playcard=NULL;</highlight></codeline>
<codeline lineno="2804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_ec=captcard==NULL<sp/>?<sp/>FALSE<sp/>:<sp/><ref refid="group__media__parameters_1ga3cd3d3f56f4bf30e8b3895c8bb97c989" kindref="member">sephone_core_echo_cancellation_enabled</ref>(lc);</highlight></codeline>
<codeline lineno="2806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(playcard<sp/>&amp;&amp;<sp/><sp/>stream-&gt;max_rate&gt;0)<sp/>ms_snd_card_set_preferred_sample_rate(playcard,<sp/>stream-&gt;max_rate);</highlight></codeline>
<codeline lineno="2807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(captcard<sp/>&amp;&amp;<sp/><sp/>stream-&gt;max_rate&gt;0)<sp/>ms_snd_card_set_preferred_sample_rate(captcard,<sp/>stream-&gt;max_rate);</highlight></codeline>
<codeline lineno="2808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_adaptive_bitrate_control(call-&gt;audiostream,use_arc);</highlight></codeline>
<codeline lineno="2809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_adaptive_bitrate_algorithm(&amp;call-&gt;audiostream-&gt;ms,</highlight></codeline>
<codeline lineno="2810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_qos_analyzer_algorithm_from_string(<ref refid="group__media__parameters_1ga9421ea9bfd7f8c6be4d0e4ed289dbd07" kindref="member">sephone_core_get_adaptive_rate_algorithm</ref>(lc)));</highlight></codeline>
<codeline lineno="2811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_adaptive_jittcomp(call-&gt;audiostream,<sp/><ref refid="group__media__parameters_1ga9a751e840cc2d090c36345f483fc1135" kindref="member">sephone_core_audio_adaptive_jittcomp_enabled</ref>(lc));</highlight></codeline>
<codeline lineno="2812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!call-&gt;params-&gt;in_conference<sp/>&amp;&amp;<sp/>call-&gt;params-&gt;record_file){</highlight></codeline>
<codeline lineno="2813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_mixed_record_open(call-&gt;audiostream,call-&gt;params-&gt;record_file);</highlight></codeline>
<codeline lineno="2814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;record_file=ms_strdup(call-&gt;params-&gt;record_file);</highlight></codeline>
<codeline lineno="2815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>valid<sp/>local<sp/>tags<sp/>are<sp/>&gt;<sp/>0<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_stream_description_has_srtp(stream)<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="2818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>local_st_desc=sal_media_description_find_stream(call-&gt;localdesc,stream-&gt;proto,SalAudio);</highlight></codeline>
<codeline lineno="2819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>crypto_idx<sp/>=<sp/>find_crypto_index_from_tag(local_st_desc-&gt;crypto,<sp/>stream-&gt;crypto_local_tag);</highlight></codeline>
<codeline lineno="2820"><highlight class="normal"></highlight></codeline>
<codeline lineno="2821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(crypto_idx<sp/>&gt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_recv_key_b64(&amp;(call-&gt;audiostream-&gt;ms.sessions),stream-&gt;crypto[0].algo,stream-&gt;crypto[0].master_key);</highlight></codeline>
<codeline lineno="2823"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_send_key_b64(&amp;(call-&gt;audiostream-&gt;ms.sessions),stream-&gt;crypto[0].algo,local_st_desc-&gt;crypto[crypto_idx].master_key);</highlight></codeline>
<codeline lineno="2824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>find<sp/>local<sp/>crypto<sp/>algo<sp/>with<sp/>tag:<sp/>%d&quot;</highlight><highlight class="normal">,<sp/>stream-&gt;crypto_local_tag);</highlight></codeline>
<codeline lineno="2826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>configure_rtp_session_for_rtcp_xr(lc,<sp/>call,<sp/>SalAudio);</highlight></codeline>
<codeline lineno="2829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_multicast)</highlight></codeline>
<codeline lineno="2830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_multicast_ttl(call-&gt;audiostream-&gt;ms.sessions.rtp_session,stream-&gt;ttl);</highlight></codeline>
<codeline lineno="2831"><highlight class="normal"></highlight></codeline>
<codeline lineno="2832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ice</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>sdpbelle_sip</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2834"><highlight class="normal"></highlight><highlight class="comment">/*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/></highlight></codeline>
<codeline lineno="2835"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2836"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((call-&gt;localdesc-&gt;ice_pwd[0]<sp/>!=<sp/>&apos;\0&apos;)<sp/>&amp;&amp;<sp/>(call-&gt;localdesc-&gt;ice_ufrag[0]<sp/>!=<sp/>&apos;\0&apos;))<sp/>{</highlight></codeline>
<codeline lineno="2837"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_message_t<sp/>*ice_msg<sp/>=<sp/>sal_create_sdp_from_desc(call-&gt;localdesc);</highlight></codeline>
<codeline lineno="2838"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*body;</highlight></codeline>
<codeline lineno="2839"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_msg<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="2840"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;Create<sp/>sdp<sp/>for<sp/>audio<sp/>failed&quot;);</highlight></codeline>
<codeline lineno="2841"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;</highlight></codeline>
<codeline lineno="2842"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2843"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>body<sp/>=<sp/>belle_sip_message_get_body(ice_msg);</highlight></codeline>
<codeline lineno="2844"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smsg.type<sp/>=<sp/>STUN_SMSG_SIP_SDP;</highlight></codeline>
<codeline lineno="2845"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smsg.sequence<sp/>=<sp/>TRUE;<sp/>//<sp/></highlight></codeline>
<codeline lineno="2846"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smsg.msg_buf<sp/>=<sp/>ms_strdup(body);</highlight></codeline>
<codeline lineno="2847"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_object_unref(ice_msg);</highlight></codeline>
<codeline lineno="2848"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2849"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while<sp/>(FALSE);*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2850"><highlight class="normal"></highlight></codeline>
<codeline lineno="2851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_start_full(</highlight></codeline>
<codeline lineno="2852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream,</highlight></codeline>
<codeline lineno="2853"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audio_profile,</highlight></codeline>
<codeline lineno="2854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_addr,</highlight></codeline>
<codeline lineno="2855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stream-&gt;rtp_port,</highlight></codeline>
<codeline lineno="2856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stream-&gt;rtcp_addr[0]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal"><sp/>?<sp/>stream-&gt;rtcp_addr<sp/>:<sp/>call-&gt;resultdesc-&gt;addr,</highlight></codeline>
<codeline lineno="2857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(sephone_core_rtcp_enabled(lc)<sp/>&amp;&amp;<sp/>!is_multicast)<sp/>?<sp/>(stream-&gt;rtcp_port<sp/>?<sp/>stream-&gt;rtcp_port<sp/>:<sp/>stream-&gt;rtp_port+1)<sp/>:<sp/>0,</highlight></codeline>
<codeline lineno="2858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>used_pt,</highlight></codeline>
<codeline lineno="2859"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__media__parameters_1ga6af6d1dfaabbcc7e58f1e21c341b2855" kindref="member">sephone_core_get_audio_jittcomp</ref>(lc),</highlight></codeline>
<codeline lineno="2860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playfile,</highlight></codeline>
<codeline lineno="2861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recfile,</highlight></codeline>
<codeline lineno="2862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>playcard,</highlight></codeline>
<codeline lineno="2863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>captcard,</highlight></codeline>
<codeline lineno="2864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_ec,</highlight></codeline>
<codeline lineno="2865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>NULL<sp/></highlight><highlight class="comment">//<sp/>&amp;smsg</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="2867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>post_configure_audio_streams(call,<sp/>muted<sp/>&amp;&amp;<sp/>!send_ringbacktone);</highlight></codeline>
<codeline lineno="2868"><highlight class="normal"></highlight></codeline>
<codeline lineno="2869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(smsg.msg_buf<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="2870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free((</highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*)smsg.msg_buf);</highlight></codeline>
<codeline lineno="2871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smsg.msg_buf<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="2872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2873"><highlight class="normal"></highlight></codeline>
<codeline lineno="2874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_session_encryption_mandatory_enable(&amp;call-&gt;audiostream-&gt;ms.sessions,<ref refid="group__media__parameters_1ga755057272841c7bf895a3c1ad1b95855" kindref="member">sephone_core_is_media_encryption_mandatory</ref>(call-&gt;core));</highlight></codeline>
<codeline lineno="2875"><highlight class="normal"></highlight></codeline>
<codeline lineno="2876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stream-&gt;dir==SalStreamSendOnly<sp/>&amp;&amp;<sp/>playfile!=NULL){</highlight></codeline>
<codeline lineno="2877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>pause_time=500;</highlight></codeline>
<codeline lineno="2878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;soundread,MS_FILE_PLAYER_LOOP,&amp;pause_time);</highlight></codeline>
<codeline lineno="2879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(send_ringbacktone){</highlight></codeline>
<codeline lineno="2881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setup_ring_player(lc,call);</highlight></codeline>
<codeline lineno="2882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2883"><highlight class="normal"></highlight></codeline>
<codeline lineno="2884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;in_conference){</highlight></codeline>
<codeline lineno="2885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*transform<sp/>the<sp/>graph<sp/>to<sp/>connect<sp/>it<sp/>to<sp/>the<sp/>conference<sp/>filter<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mute=stream-&gt;dir==SalStreamRecvOnly;</highlight></codeline>
<codeline lineno="2887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_add_to_conf(call,<sp/>mute);</highlight></codeline>
<codeline lineno="2888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;in_conference=call-&gt;params-&gt;in_conference;</highlight></codeline>
<codeline lineno="2890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;low_bandwidth=call-&gt;params-&gt;low_bandwidth;</highlight></codeline>
<codeline lineno="2891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;No<sp/>audio<sp/>stream<sp/>accepted<sp/>?&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2893"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2894"><highlight class="normal"></highlight></codeline>
<codeline lineno="2895"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_start_video_stream(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>all_inputs_muted){</highlight></codeline>
<codeline lineno="2896"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="2898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>used_pt=-1;</highlight></codeline>
<codeline lineno="2899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*vstream;</highlight></codeline>
<codeline lineno="2900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSFilter*<sp/>source<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="2901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>reused_preview<sp/>=<sp/>FALSE;</highlight></codeline>
<codeline lineno="2902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="2903"><highlight class="normal"></highlight></codeline>
<codeline lineno="2904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>shutdown<sp/>preview<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;previewstream!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="2906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>lc-&gt;video_conf.reuse_preview_source<sp/>==<sp/>FALSE)<sp/>video_preview_stop(lc-&gt;previewstream);</highlight></codeline>
<codeline lineno="2907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>source<sp/>=<sp/>video_preview_stop_reuse_source(lc-&gt;previewstream);</highlight></codeline>
<codeline lineno="2908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;previewstream=NULL;</highlight></codeline>
<codeline lineno="2909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2910"><highlight class="normal"></highlight></codeline>
<codeline lineno="2911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vstream<sp/>=<sp/>sal_media_description_find_best_stream(call-&gt;resultdesc,<sp/>SalVideo);</highlight></codeline>
<codeline lineno="2912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vstream!=NULL<sp/>&amp;&amp;<sp/>vstream-&gt;dir!=SalStreamInactive<sp/>&amp;&amp;<sp/>vstream-&gt;rtp_port!=0)<sp/>{</highlight></codeline>
<codeline lineno="2913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rtp_addr=vstream-&gt;rtp_addr[0]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal"><sp/>?<sp/>vstream-&gt;rtp_addr<sp/>:<sp/>call-&gt;resultdesc-&gt;addr;</highlight></codeline>
<codeline lineno="2914"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rtcp_addr=vstream-&gt;rtcp_addr[0]!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal"><sp/>?<sp/>vstream-&gt;rtcp_addr<sp/>:<sp/>call-&gt;resultdesc-&gt;addr;</highlight></codeline>
<codeline lineno="2915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*local_st_desc=sal_media_description_find_stream(call-&gt;localdesc,vstream-&gt;proto,SalVideo);</highlight></codeline>
<codeline lineno="2916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>is_multicast=ms_is_multicast(rtp_addr);</highlight></codeline>
<codeline lineno="2917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_profile=make_profile(call,call-&gt;resultdesc,vstream,&amp;used_pt);</highlight></codeline>
<codeline lineno="2918"><highlight class="normal"></highlight></codeline>
<codeline lineno="2919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(used_pt!=-1){</highlight></codeline>
<codeline lineno="2920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>VideoStreamDir<sp/>dir=VideoStreamSendRecv;</highlight></codeline>
<codeline lineno="2921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>is_inactive=FALSE;</highlight></codeline>
<codeline lineno="2922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSWebCam<sp/>*cam;</highlight></codeline>
<codeline lineno="2923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;video_codec<sp/>=<sp/>rtp_profile_get_payload(call-&gt;video_profile,<sp/>used_pt);</highlight></codeline>
<codeline lineno="2924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;has_video=TRUE;</highlight></codeline>
<codeline lineno="2925"><highlight class="normal"></highlight></codeline>
<codeline lineno="2926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_adaptive_bitrate_control(call-&gt;videostream,</highlight></codeline>
<codeline lineno="2927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__media__parameters_1gae855dee5ceeca72d7445cb09271a117e" kindref="member">sephone_core_adaptive_rate_control_enabled</ref>(lc));</highlight></codeline>
<codeline lineno="2928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_adaptive_bitrate_algorithm(&amp;call-&gt;videostream-&gt;ms,</highlight></codeline>
<codeline lineno="2929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_qos_analyzer_algorithm_from_string(<ref refid="group__media__parameters_1ga9421ea9bfd7f8c6be4d0e4ed289dbd07" kindref="member">sephone_core_get_adaptive_rate_algorithm</ref>(lc)));</highlight></codeline>
<codeline lineno="2930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_adaptive_jittcomp(call-&gt;videostream,<sp/><ref refid="group__media__parameters_1gafb2b3bc0bdf62da526a9bfa2f3dcb783" kindref="member">sephone_core_video_adaptive_jittcomp_enabled</ref>(lc));</highlight></codeline>
<codeline lineno="2931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;video_conf.preview_vsize.width!=0)</highlight></codeline>
<codeline lineno="2932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_preview_size(call-&gt;videostream,lc-&gt;video_conf.preview_vsize);</highlight></codeline>
<codeline lineno="2933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_fps(call-&gt;videostream,<ref refid="group__media__parameters_1gabd7dcc748ced2d76662b83fd7ff479a4" kindref="member">sephone_core_get_preferred_framerate</ref>(lc));</highlight></codeline>
<codeline lineno="2934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_sent_video_size(call-&gt;videostream,<ref refid="group__media__parameters_1ga79e0d2af181cf77b39eefaf7af5cf523" kindref="member">sephone_core_get_preferred_video_size</ref>(lc));</highlight></codeline>
<codeline lineno="2935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_self_view(call-&gt;videostream,lc-&gt;video_conf.selfview);</highlight></codeline>
<codeline lineno="2936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;video_window_id<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="2937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_native_window_id(call-&gt;videostream,call-&gt;video_window_id);</highlight></codeline>
<codeline lineno="2938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;video_window_id!=0)</highlight></codeline>
<codeline lineno="2939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_native_window_id(call-&gt;videostream,lc-&gt;video_window_id);</highlight></codeline>
<codeline lineno="2940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;preview_window_id!=0)</highlight></codeline>
<codeline lineno="2941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_native_preview_window_id<sp/>(call-&gt;videostream,lc-&gt;preview_window_id);</highlight></codeline>
<codeline lineno="2942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_use_preview_video_window<sp/>(call-&gt;videostream,lc-&gt;use_preview_window);</highlight></codeline>
<codeline lineno="2943"><highlight class="normal"></highlight></codeline>
<codeline lineno="2944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_multicast){</highlight></codeline>
<codeline lineno="2945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vstream-&gt;multicast_role<sp/>==<sp/>SalMulticastReceiver)</highlight></codeline>
<codeline lineno="2946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamRecvOnly;</highlight></codeline>
<codeline lineno="2947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamSendOnly;</highlight></codeline>
<codeline lineno="2949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vstream-&gt;dir==SalStreamSendOnly<sp/>&amp;&amp;<sp/>lc-&gt;video_conf.capture<sp/>){</highlight></codeline>
<codeline lineno="2950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamSendOnly;</highlight></codeline>
<codeline lineno="2951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vstream-&gt;dir==SalStreamRecvOnly<sp/>&amp;&amp;<sp/>lc-&gt;video_conf.display<sp/>){</highlight></codeline>
<codeline lineno="2952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamRecvOnly;</highlight></codeline>
<codeline lineno="2953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vstream-&gt;dir==SalStreamSendRecv){</highlight></codeline>
<codeline lineno="2954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;video_conf.display<sp/>&amp;&amp;<sp/>lc-&gt;video_conf.capture)</highlight></codeline>
<codeline lineno="2955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamSendRecv;</highlight></codeline>
<codeline lineno="2956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc-&gt;video_conf.display)</highlight></codeline>
<codeline lineno="2957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamRecvOnly;</highlight></codeline>
<codeline lineno="2958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir=VideoStreamSendOnly;</highlight></codeline>
<codeline lineno="2960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="2961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;video<sp/>stream<sp/>is<sp/>inactive.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*either<sp/>inactive<sp/>or<sp/>incompatible<sp/>with<sp/>local<sp/>capabilities*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>is_inactive=TRUE;</highlight></codeline>
<codeline lineno="2964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(all_inputs_muted){</highlight></codeline>
<codeline lineno="2966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cam=get_nowebcam_device();</highlight></codeline>
<codeline lineno="2967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cam<sp/>=<sp/>sephone_call_get_video_device(call);</highlight></codeline>
<codeline lineno="2969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!is_inactive){</highlight></codeline>
<codeline lineno="2971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sal_stream_description_has_srtp(vstream)<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="2972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>crypto_idx<sp/>=<sp/>find_crypto_index_from_tag(local_st_desc-&gt;crypto,<sp/>vstream-&gt;crypto_local_tag);</highlight></codeline>
<codeline lineno="2973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(crypto_idx<sp/>&gt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_recv_key_b64(&amp;(call-&gt;videostream-&gt;ms.sessions),vstream-&gt;crypto[0].algo,vstream-&gt;crypto[0].master_key);</highlight></codeline>
<codeline lineno="2975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_send_key_b64(&amp;(call-&gt;videostream-&gt;ms.sessions),vstream-&gt;crypto[0].algo,local_st_desc-&gt;crypto[crypto_idx].master_key);</highlight></codeline>
<codeline lineno="2976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2977"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>configure_rtp_session_for_rtcp_xr(lc,<sp/>call,<sp/>SalVideo);</highlight></codeline>
<codeline lineno="2979"><highlight class="normal"></highlight></codeline>
<codeline lineno="2980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;log-&gt;video_enabled<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="2982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;video<sp/>stream<sp/>direction:%d&quot;</highlight><highlight class="normal">,<sp/>dir);</highlight></codeline>
<codeline lineno="2983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_direction<sp/>(call-&gt;videostream,<sp/>dir);</highlight></codeline>
<codeline lineno="2984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;%s<sp/>lc<sp/>rotation:%d&quot;</highlight><highlight class="normal">,<sp/>__FUNCTION__,<sp/>lc-&gt;device_rotation);</highlight></codeline>
<codeline lineno="2985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_device_rotation(call-&gt;videostream,<sp/>lc-&gt;device_rotation);</highlight></codeline>
<codeline lineno="2986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_mirror(call-&gt;videostream,<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;video&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;mirror&quot;</highlight><highlight class="normal">,<sp/>0));</highlight></codeline>
<codeline lineno="2987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_freeze_on_error(call-&gt;videostream,<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;video&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;freeze_on_error&quot;</highlight><highlight class="normal">,<sp/>0));</highlight></codeline>
<codeline lineno="2988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_dynamic_framerate_control(call-&gt;videostream,<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;video&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;dynamic_framerate_control&quot;</highlight><highlight class="normal">,<sp/>0));</highlight></codeline>
<codeline lineno="2989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_record_set_video_source(call-&gt;videostream,<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(lc-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;video&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;record_local&quot;</highlight><highlight class="normal">,<sp/>0));</highlight></codeline>
<codeline lineno="2990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_multicast)</highlight></codeline>
<codeline lineno="2991"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_multicast_ttl(call-&gt;videostream-&gt;ms.sessions.rtp_session,vstream-&gt;ttl);</highlight></codeline>
<codeline lineno="2992"><highlight class="normal"></highlight></codeline>
<codeline lineno="2993"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>lc-&gt;video_conf.reuse_preview_source<sp/>&amp;&amp;<sp/>source<sp/>){</highlight></codeline>
<codeline lineno="2994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;video_stream_start_with_source<sp/>kept:<sp/>%p&quot;</highlight><highlight class="normal">,<sp/>source);</highlight></codeline>
<codeline lineno="2995"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_start_with_source(call-&gt;videostream,</highlight></codeline>
<codeline lineno="2996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_profile,<sp/>rtp_addr,<sp/>vstream-&gt;rtp_port,</highlight></codeline>
<codeline lineno="2997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtcp_addr,</highlight></codeline>
<codeline lineno="2998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_rtcp_enabled(lc)<sp/>?<sp/>(vstream-&gt;rtcp_port<sp/>?<sp/>vstream-&gt;rtcp_port<sp/>:<sp/>vstream-&gt;rtp_port+1)<sp/>:<sp/>0,</highlight></codeline>
<codeline lineno="2999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>used_pt,<sp/><ref refid="group__media__parameters_1ga695b52356bcc36e15d6cbb7c6c174527" kindref="member">sephone_core_get_video_jittcomp</ref>(lc),<sp/>cam,<sp/>source,<sp/>NULL);</highlight></codeline>
<codeline lineno="3000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reused_preview<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="3001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_start(call-&gt;videostream,</highlight></codeline>
<codeline lineno="3003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_profile,<sp/>rtp_addr,<sp/>vstream-&gt;rtp_port,</highlight></codeline>
<codeline lineno="3004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtcp_addr,</highlight></codeline>
<codeline lineno="3005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(sephone_core_rtcp_enabled(lc)<sp/>&amp;&amp;<sp/>!is_multicast)<sp/><sp/>?<sp/>(vstream-&gt;rtcp_port<sp/>?<sp/>vstream-&gt;rtcp_port<sp/>:<sp/>vstream-&gt;rtp_port+1)<sp/>:<sp/>0,</highlight></codeline>
<codeline lineno="3006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>used_pt,<sp/><ref refid="group__media__parameters_1ga695b52356bcc36e15d6cbb7c6c174527" kindref="member">sephone_core_get_video_jittcomp</ref>(lc),<sp/>cam,<sp/>NULL);</highlight></codeline>
<codeline lineno="3007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_session_encryption_mandatory_enable(&amp;call-&gt;videostream-&gt;ms.sessions,<ref refid="group__media__parameters_1ga755057272841c7bf895a3c1ad1b95855" kindref="member">sephone_core_is_media_encryption_mandatory</ref>(call-&gt;core));</highlight></codeline>
<codeline lineno="3009"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;No<sp/>video<sp/>stream<sp/>accepted.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="3012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;No<sp/>valid<sp/>video<sp/>stream<sp/>defined.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>reused_preview<sp/>==<sp/>FALSE<sp/>&amp;&amp;<sp/>source<sp/>!=<sp/>NULL<sp/>){</highlight></codeline>
<codeline lineno="3015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>destroy<sp/>not-reused<sp/>source<sp/>filter<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3016"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Video<sp/>preview<sp/>(%p)<sp/>not<sp/>reused:<sp/>destroying<sp/>it.&quot;</highlight><highlight class="normal">,<sp/>source);</highlight></codeline>
<codeline lineno="3017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_destroy(source);</highlight></codeline>
<codeline lineno="3018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3019"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3020"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3021"><highlight class="normal"></highlight></codeline>
<codeline lineno="3022"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>setZrtpCryptoTypesParameters(MSZrtpParams<sp/>*params,<sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc)</highlight></codeline>
<codeline lineno="3023"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="3025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSCryptoSuite<sp/>*srtp_suites;</highlight></codeline>
<codeline lineno="3026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MsZrtpCryptoTypesCount<sp/>ciphersCount,<sp/>authTagsCount;</highlight></codeline>
<codeline lineno="3027"><highlight class="normal"></highlight></codeline>
<codeline lineno="3028"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params<sp/>==<sp/>NULL)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lc<sp/>==<sp/>NULL)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3030"><highlight class="normal"></highlight></codeline>
<codeline lineno="3031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>srtp_suites<sp/>=<sp/>sephone_core_get_srtp_crypto_suites(lc);</highlight></codeline>
<codeline lineno="3032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(srtp_suites!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="3033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(i=0;<sp/>srtp_suites[i]!=MS_CRYPTO_SUITE_INVALID<sp/>&amp;&amp;<sp/>i&lt;SAL_CRYPTO_ALGO_MAX<sp/>&amp;&amp;<sp/>i&lt;MS_MAX_ZRTP_CRYPTO_TYPES;<sp/>++i){</highlight></codeline>
<codeline lineno="3034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(srtp_suites[i])<sp/>{</highlight></codeline>
<codeline lineno="3035"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_128_SHA1_32:</highlight></codeline>
<codeline lineno="3036"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES1;</highlight></codeline>
<codeline lineno="3037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS32;</highlight></codeline>
<codeline lineno="3038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3039"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_128_NO_AUTH:</highlight></codeline>
<codeline lineno="3040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES1;</highlight></codeline>
<codeline lineno="3041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_NO_CIPHER_SHA1_80:</highlight></codeline>
<codeline lineno="3043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS80;</highlight></codeline>
<codeline lineno="3044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_128_SHA1_80:</highlight></codeline>
<codeline lineno="3046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES1;</highlight></codeline>
<codeline lineno="3047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS80;</highlight></codeline>
<codeline lineno="3048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_256_SHA1_80:</highlight></codeline>
<codeline lineno="3050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES3;</highlight></codeline>
<codeline lineno="3051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS80;</highlight></codeline>
<codeline lineno="3052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_AES_256_SHA1_32:</highlight></codeline>
<codeline lineno="3054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphers[params-&gt;ciphersCount++]<sp/>=<sp/>MS_ZRTP_CIPHER_AES3;</highlight></codeline>
<codeline lineno="3055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTags[params-&gt;authTagsCount++]<sp/>=<sp/>MS_ZRTP_AUTHTAG_HS80;</highlight></codeline>
<codeline lineno="3056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>MS_CRYPTO_SUITE_INVALID:</highlight></codeline>
<codeline lineno="3058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3062"><highlight class="normal"></highlight></codeline>
<codeline lineno="3063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>sephone_core_get_srtp_crypto_suites<sp/>is<sp/>used<sp/>to<sp/>determine<sp/>sensible<sp/>defaults;<sp/>here<sp/>each<sp/>can<sp/>be<sp/>overridden<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ciphersCount<sp/>=<sp/>sephone_core_get_zrtp_cipher_suites(lc,<sp/>params-&gt;ciphers);<sp/></highlight><highlight class="comment">/*<sp/>if<sp/>not<sp/>present<sp/>in<sp/>config<sp/>file,<sp/>params-&gt;ciphers<sp/>is<sp/>not<sp/>modified<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ciphersCount!=0)<sp/>{<sp/></highlight><highlight class="comment">/*<sp/>use<sp/>zrtp_cipher_suites<sp/>config<sp/>only<sp/>when<sp/>present,<sp/>keep<sp/>config<sp/>from<sp/>srtp_crypto_suite<sp/>otherwise<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;ciphersCount<sp/>=<sp/>ciphersCount;</highlight></codeline>
<codeline lineno="3067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;hashesCount<sp/>=<sp/>sephone_core_get_zrtp_hash_suites(lc,<sp/>params-&gt;hashes);</highlight></codeline>
<codeline lineno="3069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>authTagsCount<sp/>=<sp/>sephone_core_get_zrtp_auth_suites(lc,<sp/>params-&gt;authTags);<sp/></highlight><highlight class="comment">/*<sp/>if<sp/>not<sp/>present<sp/>in<sp/>config<sp/>file,<sp/>params-&gt;authTags<sp/>is<sp/>not<sp/>modified<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(authTagsCount!=0)<sp/>{</highlight></codeline>
<codeline lineno="3071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;authTagsCount<sp/>=<sp/>authTagsCount;<sp/></highlight><highlight class="comment">/*<sp/>use<sp/>zrtp_auth_suites<sp/>config<sp/>only<sp/>when<sp/>present,<sp/>keep<sp/>config<sp/>from<sp/>srtp_crypto_suite<sp/>otherwise<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3073"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;sasTypesCount<sp/>=<sp/>sephone_core_get_zrtp_sas_suites(lc,<sp/>params-&gt;sasTypes);</highlight></codeline>
<codeline lineno="3074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;keyAgreementsCount<sp/>=<sp/>sephone_core_get_zrtp_key_agreement_suites(lc,<sp/>params-&gt;keyAgreements);</highlight></codeline>
<codeline lineno="3075"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3076"><highlight class="normal"></highlight></codeline>
<codeline lineno="3077"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_start_media_streams(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>all_inputs_muted,<sp/>bool_t<sp/>send_ringbacktone){</highlight></codeline>
<codeline lineno="3078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="3079"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>use_arc=<ref refid="group__media__parameters_1gae855dee5ceeca72d7445cb09271a117e" kindref="member">sephone_core_adaptive_rate_control_enabled</ref>(lc);</highlight></codeline>
<codeline lineno="3080"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*vstream=sal_media_description_find_best_stream(call-&gt;resultdesc,SalVideo);</highlight></codeline>
<codeline lineno="3082"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="3084"><highlight class="normal"></highlight></codeline>
<codeline lineno="3085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;audio_codec<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;video_codec<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3087"><highlight class="normal"></highlight></codeline>
<codeline lineno="3088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((call-&gt;audiostream<sp/>==<sp/>NULL)<sp/>&amp;&amp;<sp/>(call-&gt;videostream<sp/>==<sp/>NULL))<sp/>{</highlight></codeline>
<codeline lineno="3089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_fatal(</highlight><highlight class="stringliteral">&quot;start_media_stream()<sp/>called<sp/>without<sp/>prior<sp/>init<sp/>!&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3092"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>defined(VIDEO_ENABLED)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vstream!=NULL<sp/>&amp;&amp;<sp/>vstream-&gt;dir!=SalStreamInactive<sp/>&amp;&amp;<sp/>vstream-&gt;payloads!=NULL){</highlight></codeline>
<codeline lineno="3094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*when<sp/>video<sp/>is<sp/>used,<sp/>do<sp/>not<sp/>make<sp/>adaptive<sp/>rate<sp/>control<sp/>on<sp/>audio,<sp/>it<sp/>is<sp/>stupid.*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_arc=FALSE;</highlight></codeline>
<codeline lineno="3096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3097"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3098"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;sephone_call_start_media_streams()<sp/>call=[%p]<sp/>local<sp/>upload_bandwidth=[%i]<sp/>kbit/s;<sp/>local<sp/>download_bandwidth=[%i]<sp/>kbit/s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call,<sp/><ref refid="group__media__parameters_1ga8ee41e9c38a10569d1287c7b6b4e35aa" kindref="member">sephone_core_get_upload_bandwidth</ref>(lc),<ref refid="group__media__parameters_1gade2cedda727f11643a05c42233d7a9cd" kindref="member">sephone_core_get_download_bandwidth</ref>(lc));</highlight></codeline>
<codeline lineno="3100"><highlight class="normal"></highlight></codeline>
<codeline lineno="3101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="3102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_start_audio_stream(call,all_inputs_muted||call-&gt;audio_muted,send_ringbacktone,use_arc);</highlight></codeline>
<codeline lineno="3103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;DTLS<sp/>no<sp/>audio<sp/>stream!&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;has_video=FALSE;</highlight></codeline>
<codeline lineno="3107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="3108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream)<sp/>audio_stream_link_video(call-&gt;audiostream,call-&gt;videostream);</highlight></codeline>
<codeline lineno="3109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_start_video_stream(call,all_inputs_muted);</highlight></codeline>
<codeline lineno="3110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3111"><highlight class="normal"></highlight></codeline>
<codeline lineno="3112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;all_muted=all_inputs_muted;</highlight></codeline>
<codeline lineno="3113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;playing_ringbacktone=send_ringbacktone;</highlight></codeline>
<codeline lineno="3114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;up_bw=<ref refid="group__media__parameters_1ga8ee41e9c38a10569d1287c7b6b4e35aa" kindref="member">sephone_core_get_upload_bandwidth</ref>(lc);</highlight></codeline>
<codeline lineno="3115"><highlight class="normal"></highlight></codeline>
<codeline lineno="3116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*might<sp/>be<sp/>moved<sp/>in<sp/>audio/video<sp/>stream_start*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;media_encryption==<ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba9f05e9f7fbb66350bfa788e2aa37c25f" kindref="member">SephoneMediaEncryptionZRTP</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSZrtpParams<sp/>params;</highlight></codeline>
<codeline lineno="3119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;params,0,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(MSZrtpParams));</highlight></codeline>
<codeline lineno="3120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*call-&gt;current_params.media_encryption<sp/>will<sp/>be<sp/>set<sp/>later<sp/>when<sp/>zrtp<sp/>is<sp/>activated*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.zid_file=lc-&gt;zrtp_secrets_cache;</highlight></codeline>
<codeline lineno="3122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params.uri=<sp/><ref refid="group__sephone__address_1ga1b480f99787494378d9683dbc31dc177" kindref="member">sephone_address_as_string_uri_only</ref>((call-&gt;dir==<ref refid="group__call__logs_1ggadea5a585af32867aa212d9647d1602f4a0051dbbd4dd65b7d2a6acc96b334878c" kindref="member">SephoneCallIncoming</ref>)<sp/>?<sp/>call-&gt;log-&gt;from<sp/>:<sp/>call-&gt;log-&gt;to);</highlight></codeline>
<codeline lineno="3123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setZrtpCryptoTypesParameters(&amp;params,call-&gt;core);</highlight></codeline>
<codeline lineno="3124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_zrtp(call-&gt;audiostream,&amp;params);</highlight></codeline>
<codeline lineno="3125"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(media_stream_secured((MediaStream<sp/>*)call-&gt;audiostream)<sp/>&amp;&amp;<sp/>media_stream_get_state((MediaStream<sp/>*)call-&gt;videostream)<sp/>==<sp/>MSStreamStarted)<sp/>{</highlight></codeline>
<codeline lineno="3127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*audio<sp/>stream<sp/>is<sp/>already<sp/>encrypted<sp/>and<sp/>video<sp/>stream<sp/>is<sp/>active*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;params,0,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(MSZrtpParams));</highlight></codeline>
<codeline lineno="3129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_enable_zrtp(call-&gt;videostream,call-&gt;audiostream,&amp;params);</highlight></codeline>
<codeline lineno="3130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3131"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3133"><highlight class="normal"></highlight></codeline>
<codeline lineno="3134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set_dtls_fingerprint_on_all_streams(call);</highlight></codeline>
<codeline lineno="3135"><highlight class="normal"></highlight></codeline>
<codeline lineno="3136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((call-&gt;ice_session<sp/>!=<sp/>NULL)<sp/>&amp;&amp;<sp/>(ice_session_state(call-&gt;ice_session)<sp/>!=<sp/>IS_Completed))<sp/>{</highlight></codeline>
<codeline lineno="3137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_start_connectivity_checks(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*should<sp/>not<sp/>start<sp/>dtls<sp/>until<sp/>ice<sp/>is<sp/>completed*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_dtls_on_all_streams(call);</highlight></codeline>
<codeline lineno="3141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3142"><highlight class="normal"></highlight></codeline>
<codeline lineno="3143"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3144"><highlight class="normal"></highlight></codeline>
<codeline lineno="3145"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_stop_media_streams_for_ice_gathering(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="3147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(call-&gt;audiostream<sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ms.state==MSStreamPreparing)<sp/>audio_stream_unprepare_sound(call-&gt;audiostream);</highlight></codeline>
<codeline lineno="3148"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>call-&gt;videostream-&gt;ms.state==MSStreamPreparing)<sp/>{</highlight></codeline>
<codeline lineno="3150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_unprepare_video(call-&gt;videostream);</highlight></codeline>
<codeline lineno="3151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3152"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3153"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3154"><highlight class="normal"></highlight></codeline>
<codeline lineno="3155"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>bool_t<sp/>update_stream_crypto_params(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*local_st_desc,<sp/>SalStreamDescription<sp/>*old_stream,<sp/>SalStreamDescription<sp/>*new_stream,<sp/>MediaStream<sp/>*ms){</highlight></codeline>
<codeline lineno="3156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>crypto_idx<sp/>=<sp/>find_crypto_index_from_tag(local_st_desc-&gt;crypto,<sp/>new_stream-&gt;crypto_local_tag);</highlight></codeline>
<codeline lineno="3157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(crypto_idx<sp/>&gt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="3158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;localdesc_changed<sp/>&amp;<sp/>SAL_MEDIA_DESCRIPTION_CRYPTO_KEYS_CHANGED)</highlight></codeline>
<codeline lineno="3159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_send_key_b64(&amp;(ms-&gt;sessions),new_stream-&gt;crypto[0].algo,local_st_desc-&gt;crypto[crypto_idx].master_key);</highlight></codeline>
<codeline lineno="3160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcmp(old_stream-&gt;crypto[0].master_key,new_stream-&gt;crypto[0].master_key)!=0){</highlight></codeline>
<codeline lineno="3161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_set_srtp_recv_key_b64(&amp;(ms-&gt;sessions),new_stream-&gt;crypto[0].algo,new_stream-&gt;crypto[0].master_key);</highlight></codeline>
<codeline lineno="3162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="3164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>find<sp/>local<sp/>crypto<sp/>algo<sp/>with<sp/>tag:<sp/>%d&quot;</highlight><highlight class="normal">,<sp/>new_stream-&gt;crypto_local_tag);</highlight></codeline>
<codeline lineno="3166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="3168"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3169"><highlight class="normal"></highlight></codeline>
<codeline lineno="3170"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_update_crypto_parameters(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>SalMediaDescription<sp/>*old_md,<sp/>SalMediaDescription<sp/>*new_md)<sp/>{</highlight></codeline>
<codeline lineno="3171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalStreamDescription<sp/>*old_stream;</highlight></codeline>
<codeline lineno="3172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalStreamDescription<sp/>*new_stream;</highlight></codeline>
<codeline lineno="3173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SalStreamDescription<sp/>*local_st_desc;</highlight></codeline>
<codeline lineno="3174"><highlight class="normal"></highlight></codeline>
<codeline lineno="3175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>local_st_desc<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(call-&gt;localdesc,<sp/>SalAudio);</highlight></codeline>
<codeline lineno="3176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>old_stream<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(old_md,<sp/>SalAudio);</highlight></codeline>
<codeline lineno="3177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_stream<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(new_md,<sp/>SalAudio);</highlight></codeline>
<codeline lineno="3178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>local_st_desc<sp/>&amp;&amp;<sp/>old_stream<sp/>&amp;&amp;<sp/>new_stream<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_stream_crypto_params(call,local_st_desc,old_stream,new_stream,&amp;call-&gt;audiostream-&gt;ms)){</highlight></codeline>
<codeline lineno="3180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3181"><highlight class="normal"></highlight></codeline>
<codeline lineno="3182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_dtls_on_all_streams(call);</highlight></codeline>
<codeline lineno="3183"><highlight class="normal"></highlight></codeline>
<codeline lineno="3184"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>local_st_desc<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(call-&gt;localdesc,<sp/>SalVideo);</highlight></codeline>
<codeline lineno="3186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>old_stream<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(old_md,<sp/>SalVideo);</highlight></codeline>
<codeline lineno="3187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_stream<sp/>=<sp/>sal_media_description_find_secure_stream_of_type(new_md,<sp/>SalVideo);</highlight></codeline>
<codeline lineno="3188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>local_st_desc<sp/>&amp;&amp;<sp/>old_stream<sp/>&amp;&amp;<sp/>new_stream<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_stream_crypto_params(call,local_st_desc,old_stream,new_stream,&amp;call-&gt;videostream-&gt;ms)){</highlight></codeline>
<codeline lineno="3190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3191"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3192"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3193"><highlight class="normal"></highlight></codeline>
<codeline lineno="3194"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_update_remote_session_id_and_ver(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*remote_desc<sp/>=<sp/>sal_call_get_remote_media_description(call-&gt;op);</highlight></codeline>
<codeline lineno="3196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(remote_desc)<sp/>{</highlight></codeline>
<codeline lineno="3197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;remote_session_id<sp/>=<sp/>remote_desc-&gt;session_id;</highlight></codeline>
<codeline lineno="3198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;remote_session_ver<sp/>=<sp/>remote_desc-&gt;session_ver;</highlight></codeline>
<codeline lineno="3199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3200"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3201"><highlight class="normal"></highlight></codeline>
<codeline lineno="3202"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_delete_ice_session(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="3204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_debug(</highlight><highlight class="stringliteral">&quot;Delete<sp/>ice<sp/>session<sp/>for<sp/>audio<sp/>[%p]<sp/>video<sp/>[%p]&quot;</highlight><highlight class="normal">,<sp/>call-&gt;audiostream,<sp/>call-&gt;videostream);</highlight></codeline>
<codeline lineno="3205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_destroy(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ice_session<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>!=<sp/>NULL)<sp/>call-&gt;audiostream-&gt;ms.ice_check_list<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>!=<sp/>NULL)<sp/>call-&gt;videostream-&gt;ms.ice_check_list<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].ice_state<sp/>=<sp/><ref refid="group__initializing_1gga37b5342342456e28960d4b9780354202a781154163579149dbe257718dbdb46d9" kindref="member">SephoneIceStateNotActivated</ref>;</highlight></codeline>
<codeline lineno="3210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].ice_state<sp/>=<sp/><ref refid="group__initializing_1gga37b5342342456e28960d4b9780354202a781154163579149dbe257718dbdb46d9" kindref="member">SephoneIceStateNotActivated</ref>;</highlight></codeline>
<codeline lineno="3211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3212"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3213"><highlight class="normal"></highlight></codeline>
<codeline lineno="3214"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_delete_upnp_session(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3215"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(call-&gt;upnp_session!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="3217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_upnp_session_destroy(call-&gt;upnp_session);</highlight></codeline>
<codeline lineno="3218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;upnp_session=NULL;</highlight></codeline>
<codeline lineno="3219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3220"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3221"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3222"><highlight class="normal"></highlight></codeline>
<codeline lineno="3223"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_log_fill_stats(<ref refid="group__call__logs_1ga971dacd835550830e6ced30185f11c46" kindref="member">SephoneCallLog</ref><sp/>*log,<sp/>MediaStream<sp/>*st){</highlight></codeline>
<codeline lineno="3224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>quality=media_stream_get_average_quality_rating(st);</highlight></codeline>
<codeline lineno="3225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(quality&gt;=0){</highlight></codeline>
<codeline lineno="3226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(log-&gt;quality!=-1){</highlight></codeline>
<codeline lineno="3227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log-&gt;quality*=quality/5.0;</highlight></codeline>
<codeline lineno="3228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>log-&gt;quality=quality;</highlight></codeline>
<codeline lineno="3229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3230"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3231"><highlight class="normal"></highlight></codeline>
<codeline lineno="3232"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_stop_audio_stream(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="3234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="3235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_reporting_update_media_info(call,<sp/>SEPHONE_CALL_STATS_AUDIO);</highlight></codeline>
<codeline lineno="3236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_reclaim_sessions(&amp;call-&gt;audiostream-&gt;ms,&amp;call-&gt;sessions[0]);</highlight></codeline>
<codeline lineno="3237"><highlight class="normal"></highlight></codeline>
<codeline lineno="3238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream-&gt;ec){</highlight></codeline>
<codeline lineno="3239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*state_str=NULL;</highlight></codeline>
<codeline lineno="3240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;ec,MS_ECHO_CANCELLER_GET_STATE_STRING,&amp;state_str);</highlight></codeline>
<codeline lineno="3241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state_str){</highlight></codeline>
<codeline lineno="3242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Writing<sp/>echo<sp/>canceler<sp/>state,<sp/>%i<sp/>bytes&quot;</highlight><highlight class="normal">,(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)strlen(state_str));</highlight></codeline>
<codeline lineno="3243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sp_config_write_relative_file(call-&gt;core-&gt;config,<sp/>EC_STATE_STORE,<sp/>state_str);</highlight></codeline>
<codeline lineno="3244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_get_local_rtp_stats(call-&gt;audiostream,&amp;call-&gt;log-&gt;local_stats);</highlight></codeline>
<codeline lineno="3247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_log_fill_stats<sp/>(call-&gt;log,(MediaStream*)call-&gt;audiostream);</highlight></codeline>
<codeline lineno="3248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;endpoint){</highlight></codeline>
<codeline lineno="3249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_remove_from_conf(call);</highlight></codeline>
<codeline lineno="3250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_stop(call-&gt;audiostream);</highlight></codeline>
<codeline lineno="3252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_unregister_event_queue(call-&gt;sessions[0].rtp_session,<sp/>call-&gt;audiostream_app_evq);</highlight></codeline>
<codeline lineno="3253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_ev_queue_flush(call-&gt;audiostream_app_evq);</highlight></codeline>
<codeline lineno="3254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_ev_queue_destroy(call-&gt;audiostream_app_evq);</highlight></codeline>
<codeline lineno="3255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream_app_evq=NULL;</highlight></codeline>
<codeline lineno="3256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audiostream=NULL;</highlight></codeline>
<codeline lineno="3257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;audio_codec<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3259"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3260"><highlight class="normal"></highlight></codeline>
<codeline lineno="3261"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_stop_video_stream(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="3263"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream!=NULL){</highlight></codeline>
<codeline lineno="3265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_reporting_update_media_info(call,<sp/>SEPHONE_CALL_STATS_VIDEO);</highlight></codeline>
<codeline lineno="3266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_reclaim_sessions(&amp;call-&gt;videostream-&gt;ms,&amp;call-&gt;sessions[1]);</highlight></codeline>
<codeline lineno="3267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_log_fill_stats(call-&gt;log,(MediaStream*)call-&gt;videostream);</highlight></codeline>
<codeline lineno="3268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_stop(call-&gt;videostream);</highlight></codeline>
<codeline lineno="3269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream=NULL;</highlight></codeline>
<codeline lineno="3270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_unregister_event_queue(call-&gt;sessions[1].rtp_session,<sp/>call-&gt;videostream_app_evq);</highlight></codeline>
<codeline lineno="3271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_ev_queue_flush(call-&gt;videostream_app_evq);</highlight></codeline>
<codeline lineno="3272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_ev_queue_destroy(call-&gt;videostream_app_evq);</highlight></codeline>
<codeline lineno="3273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;videostream_app_evq=NULL;</highlight></codeline>
<codeline lineno="3274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;current_params-&gt;video_codec<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3276"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3277"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3278"><highlight class="normal"></highlight></codeline>
<codeline lineno="3279"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>unset_rtp_profile(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i){</highlight></codeline>
<codeline lineno="3280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;sessions[i].rtp_session)</highlight></codeline>
<codeline lineno="3281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_profile(call-&gt;sessions[i].rtp_session,&amp;av_profile);</highlight></codeline>
<codeline lineno="3282"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3283"><highlight class="normal"></highlight></codeline>
<codeline lineno="3284"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_stop_media_streams_ticker(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream)<sp/>{</highlight></codeline>
<codeline lineno="3286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_stop_ticker(&amp;(call-&gt;audiostream-&gt;ms));</highlight></codeline>
<codeline lineno="3287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream)<sp/>{</highlight></codeline>
<codeline lineno="3289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>media_stream_stop_ticker(&amp;(call-&gt;videostream-&gt;ms));</highlight></codeline>
<codeline lineno="3290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3291"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3292"><highlight class="normal"></highlight></codeline>
<codeline lineno="3293"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_stop_media_streams(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="3295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>||<sp/>call-&gt;videostream)<sp/>{</highlight></codeline>
<codeline lineno="3296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>call-&gt;videostream)</highlight></codeline>
<codeline lineno="3297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_unlink_video(call-&gt;audiostream,<sp/>call-&gt;videostream);</highlight></codeline>
<codeline lineno="3298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_audio_stream(call);</highlight></codeline>
<codeline lineno="3299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_video_stream(call);</highlight></codeline>
<codeline lineno="3300"><highlight class="normal"></highlight></codeline>
<codeline lineno="3301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;core-&gt;msevq<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="3302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_event_queue_skip(call-&gt;core-&gt;msevq);</highlight></codeline>
<codeline lineno="3303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3305"><highlight class="normal"></highlight></codeline>
<codeline lineno="3306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audio_profile){</highlight></codeline>
<codeline lineno="3307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_profile_destroy(call-&gt;audio_profile);</highlight></codeline>
<codeline lineno="3308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;audio_profile=NULL;</highlight></codeline>
<codeline lineno="3309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unset_rtp_profile(call,0);</highlight></codeline>
<codeline lineno="3310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;video_profile){</highlight></codeline>
<codeline lineno="3312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_profile_destroy(call-&gt;video_profile);</highlight></codeline>
<codeline lineno="3313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_profile=NULL;</highlight></codeline>
<codeline lineno="3314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unset_rtp_profile(call,1);</highlight></codeline>
<codeline lineno="3315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3316"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3317"><highlight class="normal"></highlight></codeline>
<codeline lineno="3318"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1gac75a9bd832ae1af4475d0ab43bd7ba00" kindref="member">sephone_call_enable_echo_cancellation</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>enable)<sp/>{</highlight></codeline>
<codeline lineno="3319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ec){</highlight></codeline>
<codeline lineno="3320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>bypass_mode<sp/>=<sp/>!enable;</highlight></codeline>
<codeline lineno="3321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;ec,MS_ECHO_CANCELLER_SET_BYPASS_MODE,&amp;bypass_mode);</highlight></codeline>
<codeline lineno="3322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3323"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3324"><highlight class="normal"></highlight></codeline>
<codeline lineno="3325"><highlight class="normal">bool_t<sp/><ref refid="group__media__parameters_1gaff93698b2522568eb01a3247605af621" kindref="member">sephone_call_echo_cancellation_enabled</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ec){</highlight></codeline>
<codeline lineno="3327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>val;</highlight></codeline>
<codeline lineno="3328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(call-&gt;audiostream-&gt;ec,MS_ECHO_CANCELLER_GET_BYPASS_MODE,&amp;val);</highlight></codeline>
<codeline lineno="3329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>!val;</highlight></codeline>
<codeline lineno="3330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ga3cd3d3f56f4bf30e8b3895c8bb97c989" kindref="member">sephone_core_echo_cancellation_enabled</ref>(call-&gt;core);</highlight></codeline>
<codeline lineno="3332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3333"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3334"><highlight class="normal"></highlight></codeline>
<codeline lineno="3335"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1gadbed05f8e46b3b3a4e21365e1a7eeeb3" kindref="member">sephone_call_enable_echo_limiter</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>val){</highlight></codeline>
<codeline lineno="3336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="3337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(val)<sp/>{</highlight></codeline>
<codeline lineno="3338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*type=<ref refid="group__misc_1ga5a32540697fb696aa4f306d9dbc844c5" kindref="member">sp_config_get_string</ref>(call-&gt;core-&gt;config,</highlight><highlight class="stringliteral">&quot;sound&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;el_type&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;mic&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcasecmp(type,</highlight><highlight class="stringliteral">&quot;mic&quot;</highlight><highlight class="normal">)==0)</highlight></codeline>
<codeline lineno="3340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(call-&gt;audiostream,ELControlMic);</highlight></codeline>
<codeline lineno="3341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcasecmp(type,</highlight><highlight class="stringliteral">&quot;full&quot;</highlight><highlight class="normal">)==0)</highlight></codeline>
<codeline lineno="3342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(call-&gt;audiostream,ELControlFull);</highlight></codeline>
<codeline lineno="3343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_enable_echo_limiter(call-&gt;audiostream,ELInactive);</highlight></codeline>
<codeline lineno="3345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3347"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3348"><highlight class="normal"></highlight></codeline>
<codeline lineno="3349"><highlight class="normal">bool_t<sp/><ref refid="group__media__parameters_1gadf0ecfd5f34ad96a8c721a291fbe6b6a" kindref="member">sephone_call_echo_limiter_enabled</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call!=NULL<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL<sp/>){</highlight></codeline>
<codeline lineno="3351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;audiostream-&gt;el_type<sp/>!=ELInactive<sp/>;</highlight></codeline>
<codeline lineno="3352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ga2a406d10a145e1dcbad9ccc964b9b670" kindref="member">sephone_core_echo_limiter_enabled</ref>(call-&gt;core);</highlight></codeline>
<codeline lineno="3354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3355"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3356"><highlight class="normal"></highlight></codeline>
<codeline lineno="3366"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga8c9584250ee9cf8fc3455d9745a6f44d" kindref="member">sephone_call_get_play_volume</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AudioStream<sp/>*st=call-&gt;audiostream;</highlight></codeline>
<codeline lineno="3368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(st<sp/>&amp;&amp;<sp/>st-&gt;volrecv){</highlight></codeline>
<codeline lineno="3369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>vol=0;</highlight></codeline>
<codeline lineno="3370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volrecv,MS_VOLUME_GET,&amp;vol);</highlight></codeline>
<codeline lineno="3371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>vol;</highlight></codeline>
<codeline lineno="3372"><highlight class="normal"></highlight></codeline>
<codeline lineno="3373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga0409d681c2faf6df054a45e53b013462" kindref="member">SEPHONE_VOLUME_DB_LOWEST</ref>;</highlight></codeline>
<codeline lineno="3375"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3376"><highlight class="normal"></highlight></codeline>
<codeline lineno="3381"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga3cbfb0fe9e97b1defa6a752602ee9d38" kindref="member">sephone_call_get_record_volume</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AudioStream<sp/>*st=call-&gt;audiostream;</highlight></codeline>
<codeline lineno="3383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(st<sp/>&amp;&amp;<sp/>st-&gt;volsend<sp/>&amp;&amp;<sp/>!call-&gt;audio_muted<sp/>&amp;&amp;<sp/>call-&gt;state==<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref>){</highlight></codeline>
<codeline lineno="3384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>vol=0;</highlight></codeline>
<codeline lineno="3385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(st-&gt;volsend,MS_VOLUME_GET,&amp;vol);</highlight></codeline>
<codeline lineno="3386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>vol;</highlight></codeline>
<codeline lineno="3387"><highlight class="normal"></highlight></codeline>
<codeline lineno="3388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga0409d681c2faf6df054a45e53b013462" kindref="member">SEPHONE_VOLUME_DB_LOWEST</ref>;</highlight></codeline>
<codeline lineno="3390"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3391"><highlight class="normal"></highlight></codeline>
<codeline lineno="3409"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga71ce4befa08f9c633bee39948a5432f1" kindref="member">sephone_call_get_current_quality</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>audio_rating=-1;</highlight></codeline>
<codeline lineno="3411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>video_rating=-1;</highlight></codeline>
<codeline lineno="3412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="3413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream){</highlight></codeline>
<codeline lineno="3414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_rating=media_stream_get_quality_rating((MediaStream*)call-&gt;audiostream)/5.0;</highlight></codeline>
<codeline lineno="3415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream){</highlight></codeline>
<codeline lineno="3417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_rating=media_stream_get_quality_rating((MediaStream*)call-&gt;videostream)/5.0;</highlight></codeline>
<codeline lineno="3418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(audio_rating&lt;0<sp/>&amp;&amp;<sp/>video_rating&lt;0)<sp/>result=-1;</highlight></codeline>
<codeline lineno="3420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(audio_rating&lt;0)<sp/>result=video_rating*5.0;</highlight></codeline>
<codeline lineno="3421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(video_rating&lt;0)<sp/>result=audio_rating*5.0;</highlight></codeline>
<codeline lineno="3422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>result=audio_rating*video_rating*5.0;</highlight></codeline>
<codeline lineno="3423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="3424"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3425"><highlight class="normal"></highlight></codeline>
<codeline lineno="3431"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga4a31fe4535dc6be79245f957dc39c205" kindref="member">sephone_call_get_average_quality</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream){</highlight></codeline>
<codeline lineno="3433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>audio_stream_get_average_quality_rating(call-&gt;audiostream);</highlight></codeline>
<codeline lineno="3434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="3436"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3437"><highlight class="normal"></highlight></codeline>
<codeline lineno="3438"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>update_local_stats(<ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats,<sp/>MediaStream<sp/>*stream){</highlight></codeline>
<codeline lineno="3439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MSQualityIndicator<sp/>*qi=media_stream_get_quality_indicator(stream);</highlight></codeline>
<codeline lineno="3440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(qi)<sp/>{</highlight></codeline>
<codeline lineno="3441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a22231971aaa61c8af76eca6bd779ab51" kindref="member">local_late_rate</ref>=ms_quality_indicator_get_local_late_rate(qi);</highlight></codeline>
<codeline lineno="3442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1ac7f6097c5f0c407c99f7735775a90698" kindref="member">local_loss_rate</ref>=ms_quality_indicator_get_local_loss_rate(qi);</highlight></codeline>
<codeline lineno="3443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3444"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3445"><highlight class="normal"></highlight></codeline>
<codeline lineno="3449"><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*<ref refid="group__call__misc_1gab1cb34cfb1213f0b4eac212dcd699153" kindref="member">sephone_call_get_audio_stats</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats=&amp;call-&gt;stats[SEPHONE_CALL_STATS_AUDIO];</highlight></codeline>
<codeline lineno="3451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream){</highlight></codeline>
<codeline lineno="3452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_local_stats(stats,(MediaStream*)call-&gt;audiostream);</highlight></codeline>
<codeline lineno="3453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>stats;</highlight></codeline>
<codeline lineno="3455"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3456"><highlight class="normal"></highlight></codeline>
<codeline lineno="3460"><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*<ref refid="group__call__misc_1ga20854944741052bcca9734614271968a" kindref="member">sephone_call_get_video_stats</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats=&amp;call-&gt;stats[SEPHONE_CALL_STATS_VIDEO];</highlight></codeline>
<codeline lineno="3462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream){</highlight></codeline>
<codeline lineno="3463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_local_stats(stats,(MediaStream*)call-&gt;videostream);</highlight></codeline>
<codeline lineno="3464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>stats;</highlight></codeline>
<codeline lineno="3466"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3467"><highlight class="normal"></highlight></codeline>
<codeline lineno="3468"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>bool_t<sp/>ice_in_progress(<ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats){</highlight></codeline>
<codeline lineno="3469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a22f16194b979cca4dce9179873818f54" kindref="member">ice_state</ref>==<ref refid="group__initializing_1gga37b5342342456e28960d4b9780354202a43e97d6ce59dafe67fa0095780f9aa11" kindref="member">SephoneIceStateInProgress</ref>;</highlight></codeline>
<codeline lineno="3470"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3471"><highlight class="normal"></highlight></codeline>
<codeline lineno="3481"><highlight class="normal">bool_t<sp/><ref refid="group__call__misc_1gaf694bfd45a9dae9d3c6c08020a374c7b" kindref="member">sephone_call_media_in_progress</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>ret=FALSE;</highlight></codeline>
<codeline lineno="3483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ice_in_progress(&amp;call-&gt;stats[SEPHONE_CALL_STATS_AUDIO])<sp/>||<sp/>ice_in_progress(&amp;call-&gt;stats[SEPHONE_CALL_STATS_VIDEO]))</highlight></codeline>
<codeline lineno="3484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=TRUE;</highlight></codeline>
<codeline lineno="3485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*TODO:<sp/>could<sp/>check<sp/>zrtp<sp/>state,<sp/>upnp<sp/>state*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ret;</highlight></codeline>
<codeline lineno="3487"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3488"><highlight class="normal"></highlight></codeline>
<codeline lineno="3493"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga4b787d24f1e05e0bff2365c4a47e0352" kindref="member">sephone_call_stats_get_sender_loss_rate</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats)<sp/>{</highlight></codeline>
<codeline lineno="3494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>report_block_t<sp/>*srb<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3495"><highlight class="normal"></highlight></codeline>
<codeline lineno="3496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!stats<sp/>||<sp/>!stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>)</highlight></codeline>
<codeline lineno="3497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Perform<sp/>msgpullup()<sp/>to<sp/>prevent<sp/>crashes<sp/>in<sp/>rtcp_is_SR()<sp/>or<sp/>rtcp_is_RR()<sp/>if<sp/>the<sp/>RTCP<sp/>packet<sp/>is<sp/>composed<sp/>of<sp/>several<sp/>mblk_t<sp/>structure<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>-&gt;b_cont<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="3500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msgpullup(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>,<sp/>-1);</highlight></codeline>
<codeline lineno="3501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rtcp_is_SR(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>))</highlight></codeline>
<codeline lineno="3502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>srb<sp/>=<sp/>rtcp_SR_get_report_block(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>,<sp/>0);</highlight></codeline>
<codeline lineno="3503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rtcp_is_RR(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>))</highlight></codeline>
<codeline lineno="3504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>srb<sp/>=<sp/>rtcp_RR_get_report_block(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>,<sp/>0);</highlight></codeline>
<codeline lineno="3505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!srb)</highlight></codeline>
<codeline lineno="3506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>100.0<sp/>*<sp/>report_block_get_fraction_lost(srb)<sp/>/<sp/>256.0;</highlight></codeline>
<codeline lineno="3508"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3509"><highlight class="normal"></highlight></codeline>
<codeline lineno="3514"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga008ba2a56aed340943fea60a8032a245" kindref="member">sephone_call_stats_get_receiver_loss_rate</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats)<sp/>{</highlight></codeline>
<codeline lineno="3515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>report_block_t<sp/>*rrb<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3516"><highlight class="normal"></highlight></codeline>
<codeline lineno="3517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!stats<sp/>||<sp/>!stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>)</highlight></codeline>
<codeline lineno="3518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Perform<sp/>msgpullup()<sp/>to<sp/>prevent<sp/>crashes<sp/>in<sp/>rtcp_is_SR()<sp/>or<sp/>rtcp_is_RR()<sp/>if<sp/>the<sp/>RTCP<sp/>packet<sp/>is<sp/>composed<sp/>of<sp/>several<sp/>mblk_t<sp/>structure<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>-&gt;b_cont<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="3521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msgpullup(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>,<sp/>-1);</highlight></codeline>
<codeline lineno="3522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rtcp_is_RR(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>))</highlight></codeline>
<codeline lineno="3523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rrb<sp/>=<sp/>rtcp_RR_get_report_block(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>,<sp/>0);</highlight></codeline>
<codeline lineno="3524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rtcp_is_SR(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>))</highlight></codeline>
<codeline lineno="3525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rrb<sp/>=<sp/>rtcp_SR_get_report_block(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>,<sp/>0);</highlight></codeline>
<codeline lineno="3526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!rrb)</highlight></codeline>
<codeline lineno="3527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>100.0<sp/>*<sp/>report_block_get_fraction_lost(rrb)<sp/>/<sp/>256.0;</highlight></codeline>
<codeline lineno="3529"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3530"><highlight class="normal"></highlight></codeline>
<codeline lineno="3535"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1gaf2ee06344acd6a4ba2993fd41c8b9c52" kindref="member">sephone_call_stats_get_sender_interarrival_jitter</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params;</highlight></codeline>
<codeline lineno="3537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType<sp/>*pt;</highlight></codeline>
<codeline lineno="3538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>report_block_t<sp/>*srb<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3539"><highlight class="normal"></highlight></codeline>
<codeline lineno="3540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!stats<sp/>||<sp/>!call<sp/>||<sp/>!stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>)</highlight></codeline>
<codeline lineno="3541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params<sp/>=<sp/><ref refid="group__call__control_1ga3440e61504e058274ecc74dd435938e4" kindref="member">sephone_call_get_current_params</ref>(call);</highlight></codeline>
<codeline lineno="3543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!params)</highlight></codeline>
<codeline lineno="3544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Perform<sp/>msgpullup()<sp/>to<sp/>prevent<sp/>crashes<sp/>in<sp/>rtcp_is_SR()<sp/>or<sp/>rtcp_is_RR()<sp/>if<sp/>the<sp/>RTCP<sp/>packet<sp/>is<sp/>composed<sp/>of<sp/>several<sp/>mblk_t<sp/>structure<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>-&gt;b_cont<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="3547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msgpullup(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>,<sp/>-1);</highlight></codeline>
<codeline lineno="3548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rtcp_is_SR(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>))</highlight></codeline>
<codeline lineno="3549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>srb<sp/>=<sp/>rtcp_SR_get_report_block(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>,<sp/>0);</highlight></codeline>
<codeline lineno="3550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rtcp_is_RR(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>))</highlight></codeline>
<codeline lineno="3551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>srb<sp/>=<sp/>rtcp_RR_get_report_block(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>,<sp/>0);</highlight></codeline>
<codeline lineno="3552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!srb)</highlight></codeline>
<codeline lineno="3553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1aa5c5d770646b5b1c32fad81932d0a986" kindref="member">type</ref><sp/>==<sp/>SEPHONE_CALL_STATS_AUDIO)</highlight></codeline>
<codeline lineno="3555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/><ref refid="group__call__control_1ga6275caff2e47901202c44241f794fd29" kindref="member">sephone_call_params_get_used_audio_codec</ref>(params);</highlight></codeline>
<codeline lineno="3556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/><ref refid="group__call__control_1gaad71d75460ced446ad60cbaaac218888" kindref="member">sephone_call_params_get_used_video_codec</ref>(params);</highlight></codeline>
<codeline lineno="3558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pt<sp/>||<sp/>(pt-&gt;clock_rate<sp/>==<sp/>0))</highlight></codeline>
<codeline lineno="3559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">)report_block_get_interarrival_jitter(srb)<sp/>/<sp/>(float)pt-&gt;clock_rate;</highlight></codeline>
<codeline lineno="3561"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3562"><highlight class="normal"></highlight></codeline>
<codeline lineno="3567"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga8e3c36ede5ed6d6be0b6aa3fdfe84b1d" kindref="member">sephone_call_stats_get_receiver_interarrival_jitter</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params;</highlight></codeline>
<codeline lineno="3569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PayloadType<sp/>*pt;</highlight></codeline>
<codeline lineno="3570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>report_block_t<sp/>*rrb<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3571"><highlight class="normal"></highlight></codeline>
<codeline lineno="3572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!stats<sp/>||<sp/>!call<sp/>||<sp/>!stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>)</highlight></codeline>
<codeline lineno="3573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params<sp/>=<sp/><ref refid="group__call__control_1ga3440e61504e058274ecc74dd435938e4" kindref="member">sephone_call_get_current_params</ref>(call);</highlight></codeline>
<codeline lineno="3575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!params)</highlight></codeline>
<codeline lineno="3576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Perform<sp/>msgpullup()<sp/>to<sp/>prevent<sp/>crashes<sp/>in<sp/>rtcp_is_SR()<sp/>or<sp/>rtcp_is_RR()<sp/>if<sp/>the<sp/>RTCP<sp/>packet<sp/>is<sp/>composed<sp/>of<sp/>several<sp/>mblk_t<sp/>structure<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>-&gt;b_cont<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="3579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msgpullup(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>,<sp/>-1);</highlight></codeline>
<codeline lineno="3580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rtcp_is_SR(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>))</highlight></codeline>
<codeline lineno="3581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rrb<sp/>=<sp/>rtcp_SR_get_report_block(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>,<sp/>0);</highlight></codeline>
<codeline lineno="3582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rtcp_is_RR(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>))</highlight></codeline>
<codeline lineno="3583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rrb<sp/>=<sp/>rtcp_RR_get_report_block(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>,<sp/>0);</highlight></codeline>
<codeline lineno="3584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!rrb)</highlight></codeline>
<codeline lineno="3585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1aa5c5d770646b5b1c32fad81932d0a986" kindref="member">type</ref><sp/>==<sp/>SEPHONE_CALL_STATS_AUDIO)</highlight></codeline>
<codeline lineno="3587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/><ref refid="group__call__control_1ga6275caff2e47901202c44241f794fd29" kindref="member">sephone_call_params_get_used_audio_codec</ref>(params);</highlight></codeline>
<codeline lineno="3588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pt<sp/>=<sp/><ref refid="group__call__control_1gaad71d75460ced446ad60cbaaac218888" kindref="member">sephone_call_params_get_used_video_codec</ref>(params);</highlight></codeline>
<codeline lineno="3590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pt<sp/>||<sp/>(pt-&gt;clock_rate<sp/>==<sp/>0))</highlight></codeline>
<codeline lineno="3591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="3592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">)report_block_get_interarrival_jitter(rrb)<sp/>/<sp/>(float)pt-&gt;clock_rate;</highlight></codeline>
<codeline lineno="3593"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3594"><highlight class="normal"></highlight></codeline>
<codeline lineno="3599"><highlight class="normal">uint64_t<sp/><ref refid="group__call__misc_1gad099503cff9440055cab5cafdca098d0" kindref="member">sephone_call_stats_get_late_packets_cumulative_number</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_stats_t<sp/>rtp_stats;</highlight></codeline>
<codeline lineno="3601"><highlight class="normal"></highlight></codeline>
<codeline lineno="3602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!stats<sp/>||<sp/>!call)</highlight></codeline>
<codeline lineno="3603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="3604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;rtp_stats,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(rtp_stats));</highlight></codeline>
<codeline lineno="3605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1aa5c5d770646b5b1c32fad81932d0a986" kindref="member">type</ref><sp/>==<sp/>SEPHONE_CALL_STATS_AUDIO<sp/>&amp;&amp;<sp/>call-&gt;audiostream<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="3606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_get_local_rtp_stats(call-&gt;audiostream,<sp/>&amp;rtp_stats);</highlight></codeline>
<codeline lineno="3607"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="3609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_get_local_rtp_stats(call-&gt;videostream,<sp/>&amp;rtp_stats);</highlight></codeline>
<codeline lineno="3610"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rtp_stats.outoftime;</highlight></codeline>
<codeline lineno="3612"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3613"><highlight class="normal"></highlight></codeline>
<codeline lineno="3619"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga23c6de3b426b485773195c7ea55c5b84" kindref="member">sephone_call_stats_get_download_bandwidth</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats)<sp/>{</highlight></codeline>
<codeline lineno="3620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a12375a1d55bb991e8fed9a1cd8f90c7d" kindref="member">download_bandwidth</ref>;</highlight></codeline>
<codeline lineno="3621"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3622"><highlight class="normal"></highlight></codeline>
<codeline lineno="3628"><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1gae2755463428f50d9e4a393297205b847" kindref="member">sephone_call_stats_get_upload_bandwidth</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats)<sp/>{</highlight></codeline>
<codeline lineno="3629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1ac62020558b20670ace7387f47532d2fa" kindref="member">upload_bandwidth</ref>;</highlight></codeline>
<codeline lineno="3630"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3631"><highlight class="normal"></highlight></codeline>
<codeline lineno="3637"><highlight class="normal"><ref refid="group__initializing_1ga532b825cacd9626b10dae44daa01e6cd" kindref="member">SephoneIceState</ref><sp/><ref refid="group__call__misc_1ga2f9dacf093fb6befa87d8ecacaf5ff8a" kindref="member">sephone_call_stats_get_ice_state</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats)<sp/>{</highlight></codeline>
<codeline lineno="3638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a22f16194b979cca4dce9179873818f54" kindref="member">ice_state</ref>;</highlight></codeline>
<codeline lineno="3639"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3640"><highlight class="normal"></highlight></codeline>
<codeline lineno="3646"><highlight class="normal"><ref refid="group__initializing_1gaa8e9e1a6c47e4489119f978b7f3ebc11" kindref="member">SephoneUpnpState</ref><sp/><ref refid="group__call__misc_1gaf02069935224979852714dd63caa8988" kindref="member">sephone_call_stats_get_upnp_state</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats)<sp/>{</highlight></codeline>
<codeline lineno="3647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a677ecfae9c3544c0a1fb50bcb18646c8" kindref="member">upnp_state</ref>;</highlight></codeline>
<codeline lineno="3648"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3649"><highlight class="normal"></highlight></codeline>
<codeline lineno="3654"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1gafe73207455c50945718abb84b3baf950" kindref="member">sephone_call_start_recording</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!call-&gt;params-&gt;record_file){</highlight></codeline>
<codeline lineno="3656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;sephone_call_start_recording():<sp/>no<sp/>output<sp/>file<sp/>specified.<sp/>Use<sp/>sephone_call_params_set_record_file().&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>.wav/.mkv</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>!call-&gt;params-&gt;in_conference){</highlight></codeline>
<codeline lineno="3661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_mixed_record_start(call-&gt;audiostream);</highlight></codeline>
<codeline lineno="3662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>.h264</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>!call-&gt;params-&gt;in_conference){</highlight></codeline>
<codeline lineno="3665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_record_start(call-&gt;videostream,<sp/>call-&gt;params-&gt;record_file);</highlight></codeline>
<codeline lineno="3666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;record_active=TRUE;</highlight></codeline>
<codeline lineno="3668"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3669"><highlight class="normal"></highlight></codeline>
<codeline lineno="3673"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga82c91bb0ba077758f818657a783de41d" kindref="member">sephone_call_stop_recording</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>!call-&gt;params-&gt;in_conference){</highlight></codeline>
<codeline lineno="3675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_mixed_record_stop(call-&gt;audiostream);</highlight></codeline>
<codeline lineno="3676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>!call-&gt;params-&gt;in_conference){</highlight></codeline>
<codeline lineno="3678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_record_stop(call-&gt;videostream);</highlight></codeline>
<codeline lineno="3679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;record_active=FALSE;</highlight></codeline>
<codeline lineno="3681"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3682"><highlight class="normal"></highlight></codeline>
<codeline lineno="3687"><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>report_bandwidth(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>MediaStream<sp/>*as,<sp/>MediaStream<sp/>*vs){</highlight></codeline>
<codeline lineno="3688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>as_active<sp/>=<sp/>as<sp/>?<sp/>(media_stream_get_state(as)<sp/>==<sp/>MSStreamStarted)<sp/>:<sp/>FALSE;</highlight></codeline>
<codeline lineno="3689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>vs_active<sp/>=<sp/>vs<sp/>?<sp/>(media_stream_get_state(vs)<sp/>==<sp/>MSStreamStarted)<sp/>:<sp/>FALSE;</highlight></codeline>
<codeline lineno="3690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>rtp_stats_t<sp/>*as_stats<sp/>=<sp/>as_active<sp/>?<sp/>rtp_session_get_stats(as-&gt;sessions.rtp_session)<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="3691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>rtp_stats_t<sp/>*vs_stats<sp/>=<sp/>vs_active<sp/>?<sp/>rtp_session_get_stats(vs-&gt;sessions.rtp_session)<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="3692"><highlight class="normal"></highlight></codeline>
<codeline lineno="3693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_sent=(as_active)<sp/>?<sp/>as_stats-&gt;packet_sent<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_recv=(as_active)<sp/>?<sp/>as_stats-&gt;packet_recv<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].download_bandwidth=(as_active)<sp/>?<sp/>(media_stream_get_down_bw(as)*1e-3)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].upload_bandwidth=(as_active)<sp/>?<sp/>(media_stream_get_up_bw(as)*1e-3)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_download_bandwidth=(as_active)<sp/>?<sp/>(media_stream_get_rtcp_down_bw(as)*1e-3)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_upload_bandwidth=(as_active)<sp/>?<sp/>(media_stream_get_rtcp_up_bw(as)*1e-3)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(as_active)<sp/>{</highlight></codeline>
<codeline lineno="3700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].updated|=<ref refid="group__call__misc_1ga1fd997506e4bfa599f0c3af44cf7e835" kindref="member">SEPHONE_CALL_STATS_PERIODICAL_UPDATE</ref>;</highlight></codeline>
<codeline lineno="3701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_stats_updated(call-&gt;core,<sp/>call,<sp/>&amp;call-&gt;stats[SEPHONE_CALL_STATS_AUDIO]);</highlight></codeline>
<codeline lineno="3702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].updated=0;</highlight></codeline>
<codeline lineno="3703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_sent=(vs_active)<sp/>?<sp/>vs_stats-&gt;packet_sent<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_recv=(vs_active)<sp/>?<sp/>vs_stats-&gt;packet_recv<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].download_bandwidth=(vs_active)<sp/>?<sp/>(media_stream_get_down_bw(vs)*1e-3)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].upload_bandwidth=(vs_active)<sp/>?<sp/>(media_stream_get_up_bw(vs)*1e-3)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_download_bandwidth=(vs_active)<sp/>?<sp/>(media_stream_get_rtcp_down_bw(vs)*1e-3)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_upload_bandwidth=(vs_active)<sp/>?<sp/>(media_stream_get_rtcp_up_bw(vs)*1e-3)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="3710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vs_active)<sp/>{</highlight></codeline>
<codeline lineno="3711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].updated|=<ref refid="group__call__misc_1ga1fd997506e4bfa599f0c3af44cf7e835" kindref="member">SEPHONE_CALL_STATS_PERIODICAL_UPDATE</ref>;</highlight></codeline>
<codeline lineno="3712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_stats_updated(call-&gt;core,<sp/>call,<sp/>&amp;call-&gt;stats[SEPHONE_CALL_STATS_VIDEO]);</highlight></codeline>
<codeline lineno="3713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].updated=0;</highlight></codeline>
<codeline lineno="3714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3715"><highlight class="normal"></highlight></codeline>
<codeline lineno="3716"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>_WIN32</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(<sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Bandwidth<sp/>usage<sp/>for<sp/>call<sp/>[%p]:\r\n&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;\tRTP<sp/><sp/>audio=[r=%8&quot;</highlight><highlight class="normal">PRId64</highlight><highlight class="stringliteral">&quot;,s=%8&quot;</highlight><highlight class="normal">PRId64</highlight><highlight class="stringliteral">&quot;],<sp/>video=[r=%8&quot;</highlight><highlight class="normal">PRId64</highlight><highlight class="stringliteral">&quot;,s=%8&quot;</highlight><highlight class="normal">PRId64</highlight><highlight class="stringliteral">&quot;]<sp/>packets\r\n&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;\tRTP<sp/><sp/>audio=[d=%8.1f,u=%8.1f],<sp/>video=[d=%8.1f,u=%8.1f]<sp/>kbits/sec&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3720"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;\tRTCP<sp/>audio=[d=%8.1f,u=%8.1f],<sp/>video=[d=%8.1f,u=%8.1f]<sp/>kbits/sec&quot;,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call,</highlight></codeline>
<codeline lineno="3722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_recv,</highlight></codeline>
<codeline lineno="3723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_sent,</highlight></codeline>
<codeline lineno="3724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_recv,</highlight></codeline>
<codeline lineno="3725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_sent,</highlight></codeline>
<codeline lineno="3726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].download_bandwidth,</highlight></codeline>
<codeline lineno="3727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].upload_bandwidth,</highlight></codeline>
<codeline lineno="3728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].download_bandwidth,</highlight></codeline>
<codeline lineno="3729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].upload_bandwidth</highlight></codeline>
<codeline lineno="3730"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_download_bandwidth,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3731"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_upload_bandwidth,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3732"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_download_bandwidth,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3733"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_upload_bandwidth</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="3735"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(<sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Bandwidth<sp/>usage<sp/>for<sp/>call<sp/>[%p]:\n&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;\tRTP<sp/><sp/>audio=[r=%8&quot;</highlight><highlight class="normal">PRId64</highlight><highlight class="stringliteral">&quot;,s=%8&quot;</highlight><highlight class="normal">PRId64</highlight><highlight class="stringliteral">&quot;],<sp/>video=[r=%8&quot;</highlight><highlight class="normal">PRId64</highlight><highlight class="stringliteral">&quot;,s=%8&quot;</highlight><highlight class="normal">PRId64</highlight><highlight class="stringliteral">&quot;]<sp/>packets\n&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;\tRTP<sp/><sp/>audio=[d=%8.1f,u=%8.1f],<sp/>video=[d=%8.1f,u=%8.1f]<sp/>kbits/sec&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3739"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;\tRTCP<sp/>audio=[d=%8.1f,u=%8.1f],<sp/>video=[d=%8.1f,u=%8.1f]<sp/>kbits/sec&quot;,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call,</highlight></codeline>
<codeline lineno="3741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_recv,</highlight></codeline>
<codeline lineno="3742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].packet_sent,</highlight></codeline>
<codeline lineno="3743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_recv,</highlight></codeline>
<codeline lineno="3744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].packet_sent,</highlight></codeline>
<codeline lineno="3745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].download_bandwidth,</highlight></codeline>
<codeline lineno="3746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].upload_bandwidth,</highlight></codeline>
<codeline lineno="3747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].download_bandwidth,</highlight></codeline>
<codeline lineno="3748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].upload_bandwidth</highlight></codeline>
<codeline lineno="3749"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_download_bandwidth,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3750"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_AUDIO].rtcp_upload_bandwidth,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3751"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_download_bandwidth,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3752"><highlight class="normal"></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;stats[SEPHONE_CALL_STATS_VIDEO].rtcp_upload_bandwidth</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="3754"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3755"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3756"><highlight class="normal"></highlight></codeline>
<codeline lineno="3757"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_core_disconnected(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="3758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>temp[256]={0};</highlight></codeline>
<codeline lineno="3759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*from=NULL;</highlight></codeline>
<codeline lineno="3760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="3761"><highlight class="normal"></highlight></codeline>
<codeline lineno="3762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>from<sp/>=<sp/><ref refid="group__call__control_1gaf2510ee219d96ab8c195c913f1ad7d71" kindref="member">sephone_call_get_remote_address_as_string</ref>(call);</highlight></codeline>
<codeline lineno="3763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snprintf(temp,</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(temp)-1,</highlight><highlight class="stringliteral">&quot;Remote<sp/>end<sp/>%s<sp/>seems<sp/>to<sp/>have<sp/>disconnected,<sp/>the<sp/>call<sp/>is<sp/>going<sp/>to<sp/>be<sp/>closed.&quot;</highlight><highlight class="normal">,from<sp/>?<sp/>from<sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(from)<sp/>ms_free(from);</highlight></codeline>
<codeline lineno="3765"><highlight class="normal"></highlight></codeline>
<codeline lineno="3766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;On<sp/>call<sp/>[%p]:<sp/>%s&quot;</highlight><highlight class="normal">,call,temp);</highlight></codeline>
<codeline lineno="3767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_display_warning(lc,temp);</highlight></codeline>
<codeline lineno="3768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gab35235f6b8c98ccf7ae74a8b74216e6e" kindref="member">sephone_core_terminate_call</ref>(lc,call);</highlight></codeline>
<codeline lineno="3769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_play_named_tone(lc,SephoneToneCallLost);</highlight></codeline>
<codeline lineno="3770"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3771"><highlight class="normal"></highlight></codeline>
<codeline lineno="3772"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>change_ice_media_destinations(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="3773"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rtp_addr;</highlight></codeline>
<codeline lineno="3774"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rtcp_addr;</highlight></codeline>
<codeline lineno="3775"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rtp_port;</highlight></codeline>
<codeline lineno="3776"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rtcp_port;</highlight></codeline>
<codeline lineno="3777"><highlight class="normal"><sp/><sp/><sp/><sp/>bool_t<sp/>result;</highlight></codeline>
<codeline lineno="3778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_func();</highlight></codeline>
<codeline lineno="3779"><highlight class="normal"></highlight></codeline>
<codeline lineno="3780"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream<sp/>&amp;&amp;<sp/>ice_session_check_list(call-&gt;ice_session,<sp/>0))<sp/>{</highlight></codeline>
<codeline lineno="3781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>=<sp/>ice_check_list_selected_valid_remote_candidate(ice_session_check_list(call-&gt;ice_session,<sp/>0),<sp/>&amp;rtp_addr,<sp/>&amp;rtp_port,<sp/>&amp;rtcp_addr,<sp/>&amp;rtcp_port);</highlight></codeline>
<codeline lineno="3782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="3783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Change<sp/>audio<sp/>stream<sp/>destination:<sp/>RTP=%s:%d<sp/>RTCP=%s:%d&quot;</highlight><highlight class="normal">,<sp/>rtp_addr,<sp/>rtp_port,<sp/>rtcp_addr,<sp/>rtcp_port);</highlight></codeline>
<codeline lineno="3784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_symmetric_rtp(call-&gt;audiostream-&gt;ms.sessions.rtp_session,<sp/>FALSE);</highlight></codeline>
<codeline lineno="3785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_remote_addr_full(call-&gt;audiostream-&gt;ms.sessions.rtp_session,<sp/>rtp_addr,<sp/>rtp_port,<sp/>rtcp_addr,<sp/>rtcp_port);</highlight></codeline>
<codeline lineno="3786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3787"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3788"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3789"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream<sp/>&amp;&amp;<sp/>ice_session_check_list(call-&gt;ice_session,<sp/>1))<sp/>{</highlight></codeline>
<codeline lineno="3790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>=<sp/>ice_check_list_selected_valid_remote_candidate(ice_session_check_list(call-&gt;ice_session,<sp/>1),<sp/>&amp;rtp_addr,<sp/>&amp;rtp_port,<sp/>&amp;rtcp_addr,<sp/>&amp;rtcp_port);</highlight></codeline>
<codeline lineno="3791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="3792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Change<sp/>video<sp/>stream<sp/>destination:<sp/>RTP=%s:%d<sp/>RTCP=%s:%d&quot;</highlight><highlight class="normal">,<sp/>rtp_addr,<sp/>rtp_port,<sp/>rtcp_addr,<sp/>rtcp_port);</highlight></codeline>
<codeline lineno="3793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_symmetric_rtp(call-&gt;videostream-&gt;ms.sessions.rtp_session,<sp/>FALSE);</highlight></codeline>
<codeline lineno="3794"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rtp_session_set_remote_addr_full(call-&gt;videostream-&gt;ms.sessions.rtp_session,<sp/>rtp_addr,<sp/>rtp_port,<sp/>rtcp_addr,<sp/>rtcp_port);</highlight></codeline>
<codeline lineno="3795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3796"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3797"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3798"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3799"><highlight class="normal"></highlight></codeline>
<codeline lineno="3800"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>handle_ice_events(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>OrtpEvent<sp/>*ev){</highlight></codeline>
<codeline lineno="3801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEventType<sp/>evt=ortp_event_get_type(ev);</highlight></codeline>
<codeline lineno="3802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEventData<sp/>*evd=ortp_event_get_data(ev);</highlight></codeline>
<codeline lineno="3803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ping_time;</highlight></codeline>
<codeline lineno="3804"><highlight class="normal"></highlight></codeline>
<codeline lineno="3805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Handle<sp/>ice<sp/>event<sp/>%d&quot;</highlight><highlight class="normal">,<sp/>evt);</highlight></codeline>
<codeline lineno="3806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_SESSION_PROCESSING_FINISHED)<sp/>{</highlight></codeline>
<codeline lineno="3807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params<sp/>=<sp/><ref refid="group__call__control_1ga8f3f8f15b6e812d03bf416e09576910a" kindref="member">sephone_call_params_copy</ref>(call-&gt;current_params);</highlight></codeline>
<codeline lineno="3808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(call-&gt;params-&gt;media_encryption)<sp/>{</highlight></codeline>
<codeline lineno="3809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba9f05e9f7fbb66350bfa788e2aa37c25f" kindref="member">SephoneMediaEncryptionZRTP</ref>:</highlight></codeline>
<codeline lineno="3810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba05791a117352a31299e65410334a3f91" kindref="member">SephoneMediaEncryptionDTLS</ref>:</highlight></codeline>
<codeline lineno="3811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>preserve<sp/>media<sp/>encryption<sp/>param<sp/>because<sp/>at<sp/>that<sp/>time<sp/>ZRTP/SRTP-DTLS<sp/>negociation<sp/>may<sp/>still<sp/>be<sp/>ongoing*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;media_encryption=call-&gt;params-&gt;media_encryption;</highlight></codeline>
<codeline lineno="3813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba3e6e0aa653408fda1d63962ebbc0e351" kindref="member">SephoneMediaEncryptionSRTP</ref>:</highlight></codeline>
<codeline lineno="3815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ggaceb87800787a86916f9ab6a857f4a55ba04d462c1944b5e5d4dfed2154751df25" kindref="member">SephoneMediaEncryptionNone</ref>:</highlight></codeline>
<codeline lineno="3816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*keep<sp/>all<sp/>values<sp/>to<sp/>make<sp/>sure<sp/>a<sp/>warning<sp/>will<sp/>be<sp/>generated<sp/>by<sp/>compiler<sp/>if<sp/>new<sp/>enum<sp/>value<sp/>is<sp/>added*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3819"><highlight class="normal"></highlight></codeline>
<codeline lineno="3820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(ice_session_state(call-&gt;ice_session))<sp/>{</highlight></codeline>
<codeline lineno="3821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>IS_Completed:</highlight></codeline>
<codeline lineno="3822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_select_candidates(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3823"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ice_session_role(call-&gt;ice_session)<sp/>==<sp/>IR_Controlling</highlight></codeline>
<codeline lineno="3824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(call-&gt;core-&gt;config,<sp/></highlight><highlight class="stringliteral">&quot;sip&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;update_call_when_ice_completed&quot;</highlight><highlight class="normal">,<sp/>TRUE))<sp/>{</highlight></codeline>
<codeline lineno="3825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;internal_call_update<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="3826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//XXX<sp/>xr<sp/>2015-7-22<sp/>call</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__call__control_1ga6faba33eef07d782cdf7bfd2c79a292a" kindref="member">sephone_core_update_call</ref>(call-&gt;core,<sp/>call,<sp/>params)!=0)<sp/>{</highlight></codeline>
<codeline lineno="3828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>change_ice_media_destinations(call);</highlight></codeline>
<codeline lineno="3832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_dtls_on_all_streams(call);</highlight></codeline>
<codeline lineno="3833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>IS_Failed:</highlight></codeline>
<codeline lineno="3835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ice_session_has_completed_check_list(call-&gt;ice_session)<sp/>==<sp/>TRUE)<sp/>{</highlight></codeline>
<codeline lineno="3836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_select_candidates(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ice_session_role(call-&gt;ice_session)<sp/>==<sp/>IR_Controlling)<sp/>{</highlight></codeline>
<codeline lineno="3838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>At<sp/>least<sp/>one<sp/>ICE<sp/>session<sp/>has<sp/>succeeded,<sp/>so<sp/>perform<sp/>a<sp/>call<sp/>update.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>params-&gt;internal_call_update<sp/>=<sp/>TRUE;</highlight></codeline>
<codeline lineno="3840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1ga6faba33eef07d782cdf7bfd2c79a292a" kindref="member">sephone_core_update_call</ref>(call-&gt;core,<sp/>call,<sp/>params);</highlight></codeline>
<codeline lineno="3841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="3845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_ice_state_in_call_stats(call);</highlight></codeline>
<codeline lineno="3848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gae7c8fa8ba8eee61e979e87727004457d" kindref="member">sephone_call_params_unref</ref>(params);</highlight></codeline>
<codeline lineno="3849"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_GATHERING_FINISHED)<sp/>{</highlight></codeline>
<codeline lineno="3850"><highlight class="normal"></highlight></codeline>
<codeline lineno="3851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evd-&gt;info.ice_processing_successful==TRUE)<sp/>{</highlight></codeline>
<codeline lineno="3852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_compute_candidates_foundations(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3853"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_eliminate_redundant_candidates(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_choose_default_candidates(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ping_time<sp/>=<sp/>ice_session_average_gathering_round_trip_time(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ping_time<sp/>&gt;=0)<sp/>{</highlight></codeline>
<codeline lineno="3857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ping_time=ping_time;</highlight></codeline>
<codeline lineno="3858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3859"><highlight class="normal"></highlight><highlight class="comment">/*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice</highlight></codeline>
<codeline lineno="3860"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;state<sp/>==<sp/>SephoneCallStreamsRunning)<sp/>{</highlight></codeline>
<codeline lineno="3861"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>sephone_call_start_media_streams()</highlight></codeline>
<codeline lineno="3862"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>sephone_core_start_accept_call_update()</highlight></codeline>
<codeline lineno="3863"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_start_connectivity_checks(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3864"><highlight class="comment"></highlight></codeline>
<codeline lineno="3865"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice</highlight></codeline>
<codeline lineno="3866"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>do<sp/></highlight></codeline>
<codeline lineno="3867"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3868"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*lmd;</highlight></codeline>
<codeline lineno="3869"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_message_t<sp/>*ice_msg;</highlight></codeline>
<codeline lineno="3870"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>char<sp/>*body;</highlight></codeline>
<codeline lineno="3871"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ice</highlight></codeline>
<codeline lineno="3872"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;ice_session-&gt;lite)<sp/>{</highlight></codeline>
<codeline lineno="3873"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;</highlight></codeline>
<codeline lineno="3874"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3875"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(call-&gt;audiostream<sp/>==<sp/>NULL<sp/>||<sp/>call-&gt;audiostream-&gt;ms.sessions.rtp_session<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="3876"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;</highlight></codeline>
<codeline lineno="3877"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3878"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lmd<sp/>=<sp/>sephone_call_make_media_description(call-&gt;core,<sp/>call);</highlight></codeline>
<codeline lineno="3879"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((lmd-&gt;ice_pwd[0]<sp/>!=<sp/>&apos;\0&apos;)<sp/>&amp;&amp;<sp/>(lmd-&gt;ice_ufrag[0]<sp/>!=<sp/>&apos;\0&apos;))<sp/>{</highlight></codeline>
<codeline lineno="3880"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lmd-&gt;ice_lite<sp/>=<sp/>TRUE;<sp/>//<sp/>ice</highlight></codeline>
<codeline lineno="3881"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_msg<sp/>=<sp/>sal_create_sdp_from_desc(lmd);</highlight></codeline>
<codeline lineno="3882"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(ice_msg<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="3883"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(&quot;Create<sp/>sdp<sp/>for<sp/>audio<sp/>failed&quot;);</highlight></codeline>
<codeline lineno="3884"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;</highlight></codeline>
<codeline lineno="3885"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3886"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>body<sp/>=<sp/>belle_sip_message_get_body(ice_msg);</highlight></codeline>
<codeline lineno="3887"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_send_sip_message(call-&gt;audiostream-&gt;ms.sessions.rtp_session,<sp/>body);</highlight></codeline>
<codeline lineno="3888"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_object_unref(ice_msg);</highlight></codeline>
<codeline lineno="3889"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3890"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_media_description_unref(lmd);</highlight></codeline>
<codeline lineno="3891"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/>while<sp/>(FALSE);</highlight></codeline>
<codeline lineno="3892"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;No<sp/>STUN<sp/>answer<sp/>from<sp/>[%s],<sp/>disabling<sp/>ICE&quot;</highlight><highlight class="normal">,<ref refid="group__network__parameters_1gab27a8be2472c08995d71ebae8b1705c5" kindref="member">sephone_core_get_stun_server</ref>(call-&gt;core));</highlight></codeline>
<codeline lineno="3895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_delete_ice_session(call);</highlight></codeline>
<codeline lineno="3896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(call-&gt;state)<sp/>{</highlight></codeline>
<codeline lineno="3898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bac7b639e36102e8947d2fa2933db7359e" kindref="member">SephoneCallUpdating</ref>:</highlight></codeline>
<codeline lineno="3899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_start_update_call(call-&gt;core,<sp/>call);</highlight></codeline>
<codeline lineno="3900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bad0ba6055a04fc211f82413ecae9672ab" kindref="member">SephoneCallUpdatedByRemote</ref>:</highlight></codeline>
<codeline lineno="3902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_start_accept_call_update(call-&gt;core,<sp/>call,call-&gt;prevstate,sephone_call_state_to_string(call-&gt;prevstate));</highlight></codeline>
<codeline lineno="3903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba575309df965824fcf53c5b7e488ab8a9" kindref="member">SephoneCallOutgoingInit</ref>:</highlight></codeline>
<codeline lineno="3905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_media_streams_for_ice_gathering(call);</highlight></codeline>
<codeline lineno="3906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_proceed_with_invite_if_ready(call-&gt;core,<sp/>call,<sp/>NULL);</highlight></codeline>
<codeline lineno="3907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba3b67f93ffe1944fd21d018bbc369efd8" kindref="member">SephoneCallIdle</ref>:</highlight></codeline>
<codeline lineno="3909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stop_media_streams_for_ice_gathering(call);</highlight></codeline>
<codeline lineno="3910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_update_local_media_description_from_ice_or_upnp(call);</highlight></codeline>
<codeline lineno="3911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_call_set_local_media_description(call-&gt;op,call-&gt;localdesc);</highlight></codeline>
<codeline lineno="3912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_incoming_call(call-&gt;core,<sp/>call);</highlight></codeline>
<codeline lineno="3913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3914"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="3915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_LOSING_PAIRS_COMPLETED)<sp/>{</highlight></codeline>
<codeline lineno="3918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;state==<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bad0ba6055a04fc211f82413ecae9672ab" kindref="member">SephoneCallUpdatedByRemote</ref>){</highlight></codeline>
<codeline lineno="3919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_start_accept_call_update(call-&gt;core,<sp/>call,call-&gt;prevstate,sephone_call_state_to_string(call-&gt;prevstate));</highlight></codeline>
<codeline lineno="3920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_update_ice_state_in_call_stats(call);</highlight></codeline>
<codeline lineno="3921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_RESTART_NEEDED)<sp/>{</highlight></codeline>
<codeline lineno="3923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_restart(call-&gt;ice_session);</highlight></codeline>
<codeline lineno="3924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_set_role(call-&gt;ice_session,<sp/>IR_Controlling);</highlight></codeline>
<codeline lineno="3925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1ga6faba33eef07d782cdf7bfd2c79a292a" kindref="member">sephone_core_update_call</ref>(call-&gt;core,<sp/>call,<sp/>call-&gt;current_params);</highlight></codeline>
<codeline lineno="3926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3927"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3928"><highlight class="normal"></highlight></codeline>
<codeline lineno="3929"><highlight class="normal"></highlight></codeline>
<codeline lineno="3930"><highlight class="normal"></highlight><highlight class="comment">/*do<sp/>not<sp/>change<sp/>the<sp/>prototype<sp/>of<sp/>this<sp/>function,<sp/>it<sp/>is<sp/>also<sp/>used<sp/>internally<sp/>in<sp/>linphone-daemon.*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3931"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_stats_fill(<ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats,<sp/>MediaStream<sp/>*ms,<sp/>OrtpEvent<sp/>*ev){</highlight></codeline>
<codeline lineno="3932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEventType<sp/>evt=ortp_event_get_type(ev);</highlight></codeline>
<codeline lineno="3933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEventData<sp/>*evd=ortp_event_get_data(ev);</highlight></codeline>
<codeline lineno="3934"><highlight class="normal"></highlight></codeline>
<codeline lineno="3935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_RTCP_PACKET_RECEIVED)<sp/>{</highlight></codeline>
<codeline lineno="3936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1ad900067c63a65fa361309933f59a6b37" kindref="member">round_trip_delay</ref><sp/>=<sp/>rtp_session_get_round_trip_propagation(ms-&gt;sessions.rtp_session);</highlight></codeline>
<codeline lineno="3937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref><sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="3938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freemsg(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>);</highlight></codeline>
<codeline lineno="3939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref><sp/>=<sp/>evd-&gt;packet;</highlight></codeline>
<codeline lineno="3940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>evd-&gt;packet<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a211f454fe8de769bf8fbe92a883c378c" kindref="member">updated</ref><sp/>=<sp/><ref refid="group__call__misc_1ga73be6d6b35118e48cc62075e23b95786" kindref="member">SEPHONE_CALL_STATS_RECEIVED_RTCP_UPDATE</ref>;</highlight></codeline>
<codeline lineno="3942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_local_stats(stats,ms);</highlight></codeline>
<codeline lineno="3943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_RTCP_PACKET_EMITTED)<sp/>{</highlight></codeline>
<codeline lineno="3944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;stats-&gt;<ref refid="struct__SephoneCallStats_1ac5e70c2b5421d5c3c6ab73a7a57675d0" kindref="member">jitter_stats</ref>,<sp/>rtp_session_get_jitter_stats(ms-&gt;sessions.rtp_session),<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(jitter_stats_t));</highlight></codeline>
<codeline lineno="3945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref><sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="3946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freemsg(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>);</highlight></codeline>
<codeline lineno="3947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref><sp/>=<sp/>evd-&gt;packet;</highlight></codeline>
<codeline lineno="3948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>evd-&gt;packet<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a211f454fe8de769bf8fbe92a883c378c" kindref="member">updated</ref><sp/>=<sp/><ref refid="group__call__misc_1ga0be7de111a6474f0ea050adeaf48dcf9" kindref="member">SEPHONE_CALL_STATS_SENT_RTCP_UPDATE</ref>;</highlight></codeline>
<codeline lineno="3950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>update_local_stats(stats,ms);</highlight></codeline>
<codeline lineno="3951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3952"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3953"><highlight class="normal"></highlight></codeline>
<codeline lineno="3954"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_stats_uninit(<ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats){</highlight></codeline>
<codeline lineno="3955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freemsg(stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>);</highlight></codeline>
<codeline lineno="3957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a5c72f230ac3e96e8dcb2f959c0eb260d" kindref="member">received_rtcp</ref>=NULL;</highlight></codeline>
<codeline lineno="3958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>){</highlight></codeline>
<codeline lineno="3960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freemsg(stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>);</highlight></codeline>
<codeline lineno="3961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1aa3fc9f87f6a54d5065ce94e41f3cce59" kindref="member">sent_rtcp</ref>=NULL;</highlight></codeline>
<codeline lineno="3962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3963"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3964"><highlight class="normal"></highlight></codeline>
<codeline lineno="3965"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_notify_stats_updated(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index){</highlight></codeline>
<codeline lineno="3966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct__SephoneCallStats" kindref="compound">SephoneCallStats</ref><sp/>*stats=&amp;call-&gt;stats[stream_index];</highlight></codeline>
<codeline lineno="3967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="3968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats-&gt;<ref refid="struct__SephoneCallStats_1a211f454fe8de769bf8fbe92a883c378c" kindref="member">updated</ref>){</highlight></codeline>
<codeline lineno="3969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(stats-&gt;<ref refid="struct__SephoneCallStats_1a211f454fe8de769bf8fbe92a883c378c" kindref="member">updated</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga73be6d6b35118e48cc62075e23b95786" kindref="member">SEPHONE_CALL_STATS_RECEIVED_RTCP_UPDATE</ref>:</highlight></codeline>
<codeline lineno="3971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__misc_1ga0be7de111a6474f0ea050adeaf48dcf9" kindref="member">SEPHONE_CALL_STATS_SENT_RTCP_UPDATE</ref>:</highlight></codeline>
<codeline lineno="3972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_reporting_on_rtcp_update(call,<sp/>stream_index);</highlight></codeline>
<codeline lineno="3973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_stats_updated(lc,<sp/>call,<sp/>stats);</highlight></codeline>
<codeline lineno="3977"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats-&gt;<ref refid="struct__SephoneCallStats_1a211f454fe8de769bf8fbe92a883c378c" kindref="member">updated</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="3978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3979"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3980"><highlight class="normal"></highlight></codeline>
<codeline lineno="3981"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_handle_stream_events(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>stream_index){</highlight></codeline>
<codeline lineno="3982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MediaStream<sp/>*ms=stream_index==0<sp/>?<sp/>(MediaStream<sp/>*)call-&gt;audiostream<sp/>:<sp/>(MediaStream<sp/>*)call-&gt;videostream;<sp/></highlight><highlight class="comment">/*assumption<sp/>to<sp/>remove*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEvQueue<sp/>*evq;</highlight></codeline>
<codeline lineno="3984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEvent<sp/>*ev;</highlight></codeline>
<codeline lineno="3985"><highlight class="normal"></highlight></codeline>
<codeline lineno="3986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ms==NULL)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Ensure<sp/>there<sp/>is<sp/>no<sp/>dangling<sp/>ICE<sp/>check<sp/>list.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;ice_session<sp/>==<sp/>NULL)<sp/>ms-&gt;ice_check_list<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="3989"><highlight class="normal"></highlight></codeline>
<codeline lineno="3990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(ms-&gt;type){</highlight></codeline>
<codeline lineno="3991"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>AudioStreamType:</highlight></codeline>
<codeline lineno="3992"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_iterate((AudioStream*)ms);</highlight></codeline>
<codeline lineno="3993"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>VideoStreamType:</highlight></codeline>
<codeline lineno="3995"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_iterate((VideoStream*)ms);</highlight></codeline>
<codeline lineno="3997"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="4000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;sephone_call_handle_stream_events():<sp/>unsupported<sp/>stream<sp/>type.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*yes<sp/>the<sp/>event<sp/>queue<sp/>has<sp/>to<sp/>be<sp/>taken<sp/>at<sp/>each<sp/>iteration,<sp/>because<sp/>ice<sp/>events<sp/>may<sp/>perform<sp/>operations<sp/>re-creating<sp/>the<sp/>streams*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>((evq=stream_index==0<sp/>?<sp/>call-&gt;audiostream_app_evq<sp/>:<sp/>call-&gt;videostream_app_evq)<sp/><sp/>&amp;&amp;<sp/>(NULL<sp/>!=<sp/>(ev=ortp_ev_queue_get(evq)))){</highlight></codeline>
<codeline lineno="4006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEventType<sp/>evt=ortp_event_get_type(ev);</highlight></codeline>
<codeline lineno="4007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OrtpEventData<sp/>*evd=ortp_event_get_data(ev);</highlight></codeline>
<codeline lineno="4008"><highlight class="normal"></highlight></codeline>
<codeline lineno="4009"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_stats_fill(&amp;call-&gt;stats[stream_index],ms,ev);</highlight></codeline>
<codeline lineno="4010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_notify_stats_updated(call,stream_index);</highlight></codeline>
<codeline lineno="4011"><highlight class="normal"></highlight></codeline>
<codeline lineno="4012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_ZRTP_ENCRYPTION_CHANGED){</highlight></codeline>
<codeline lineno="4013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ms-&gt;type==AudioStreamType)</highlight></codeline>
<codeline lineno="4014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_audiostream_encryption_changed(call,<sp/>evd-&gt;info.zrtp_stream_encrypted);</highlight></codeline>
<codeline lineno="4015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ms-&gt;type==VideoStreamType)</highlight></codeline>
<codeline lineno="4016"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>propagate_encryption_changed(call);</highlight></codeline>
<codeline lineno="4017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_ZRTP_SAS_READY)<sp/>{</highlight></codeline>
<codeline lineno="4018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ms-&gt;type==AudioStreamType)</highlight></codeline>
<codeline lineno="4019"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_audiostream_auth_token_ready(call,<sp/>evd-&gt;info.zrtp_sas.sas,<sp/>evd-&gt;info.zrtp_sas.verified);</highlight></codeline>
<codeline lineno="4020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_DTLS_ENCRYPTION_CHANGED)<sp/>{</highlight></codeline>
<codeline lineno="4021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ms-&gt;type==AudioStreamType)</highlight></codeline>
<codeline lineno="4022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_audiostream_encryption_changed(call,<sp/>evd-&gt;info.dtls_stream_encrypted);</highlight></codeline>
<codeline lineno="4023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ms-&gt;type==VideoStreamType)</highlight></codeline>
<codeline lineno="4024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>propagate_encryption_changed(call);</highlight></codeline>
<codeline lineno="4025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((evt<sp/>==<sp/>ORTP_EVENT_ICE_SESSION_PROCESSING_FINISHED)<sp/>||<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_GATHERING_FINISHED)</highlight></codeline>
<codeline lineno="4026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>||<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_LOSING_PAIRS_COMPLETED)<sp/>||<sp/>(evt<sp/>==<sp/>ORTP_EVENT_ICE_RESTART_NEEDED))<sp/>{</highlight></codeline>
<codeline lineno="4027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>handle_ice_events(call,<sp/>ev);</highlight></codeline>
<codeline lineno="4028"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt==ORTP_EVENT_TELEPHONE_EVENT)<sp/>{</highlight></codeline>
<codeline lineno="4029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_dtmf_received(call-&gt;core,evd-&gt;info.telephone_event);</highlight></codeline>
<codeline lineno="4030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>stunsip</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_STUN_SIP_COMMAND)<sp/>{</highlight></codeline>
<codeline lineno="4033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalMediaDescription<sp/>*rmd<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="4034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sdp_session_description_t<sp/>*sdp<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="4035"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mblk_t<sp/>*m<sp/>=<sp/>ortp_event_get_data(ev)-&gt;packet;</highlight></codeline>
<codeline lineno="4036"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/></highlight></codeline>
<codeline lineno="4037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sdp_session_name_t<sp/>*sname;</highlight></codeline>
<codeline lineno="4039"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>value;</highlight></codeline>
<codeline lineno="4040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>check<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sdp<sp/>=<sp/>sal_sdp_body_to_session((</highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*)m-&gt;b_rptr,<sp/>m-&gt;b_wptr-m-&gt;b_rptr);</highlight></codeline>
<codeline lineno="4042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sdp<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="4043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Parse<sp/>sdp<sp/>session<sp/>description<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4046"><highlight class="normal"></highlight></codeline>
<codeline lineno="4047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sname<sp/>=<sp/>belle_sdp_session_description_get_session_name(sdp);</highlight></codeline>
<codeline lineno="4049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value<sp/>=<sp/>belle_sdp_session_name_get_value(sname);</highlight></codeline>
<codeline lineno="4050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(value<sp/>==<sp/>NULL<sp/>||<sp/>value[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcmp(value,<sp/></highlight><highlight class="stringliteral">&quot;Talk&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="4055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>ice_ufrag<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="4056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>ice_pwd<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="4057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ice</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_ufrag<sp/>=<sp/>belle_sdp_session_description_get_attribute_value(sdp,<sp/></highlight><highlight class="stringliteral">&quot;ice-ufrag&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ice_ufrag<sp/>==<sp/>NULL<sp/>||<sp/>ice_ufrag[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_pwd<sp/>=<sp/>belle_sdp_session_description_get_attribute_value(sdp,<sp/></highlight><highlight class="stringliteral">&quot;ice-pwd&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ice_pwd<sp/>==<sp/>NULL<sp/>||<sp/>ice_pwd[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ice</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;ice_session<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="4068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;ICE<sp/>session<sp/>is<sp/>already<sp/>running&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rmd<sp/>=<sp/>sal_media_description_new();</highlight></codeline>
<codeline lineno="4072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sdp_to_media_description(sdp,<sp/>rmd);</highlight></codeline>
<codeline lineno="4073"><highlight class="normal"></highlight></codeline>
<codeline lineno="4074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ice</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4075"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ice()/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ice_session<sp/>=<sp/>ice_session_new();</highlight></codeline>
<codeline lineno="4077"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;ice_session-&gt;lite<sp/>=<sp/>rmd-&gt;ice_lite;</highlight></codeline>
<codeline lineno="4078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_set_local_credentials(call-&gt;ice_session,<sp/>ice_ufrag,<sp/>ice_pwd);</highlight></codeline>
<codeline lineno="4079"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>For<sp/>backward<sp/>compatibility<sp/>purposes,<sp/>shall<sp/>be<sp/>enabled<sp/>by<sp/>default<sp/>in<sp/>future<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>check<sp/>=<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(call-&gt;core-&gt;config,</highlight><highlight class="stringliteral">&quot;net&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;ice_session_enable_message_integrity_check&quot;</highlight><highlight class="normal">,0);</highlight></codeline>
<codeline lineno="4081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_enable_message_integrity_check(call-&gt;ice_session,<sp/>check);</highlight></codeline>
<codeline lineno="4082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ice_session_set_role(call-&gt;ice_session,<sp/>IR_Controlled);</highlight></codeline>
<codeline lineno="4083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Handle<sp/>remote<sp/>ICE<sp/>attributes<sp/>if<sp/>any<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_update_ice_from_remote_media_description(call,<sp/>rmd,<sp/>TRUE);</highlight></codeline>
<codeline lineno="4085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_prepare_ice(call,<sp/>FALSE);</highlight></codeline>
<codeline lineno="4086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(FALSE);</highlight></codeline>
<codeline lineno="4088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rmd<sp/>!=<sp/>NULL)<sp/>sal_media_description_unref(rmd);</highlight></codeline>
<codeline lineno="4089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sdp<sp/>!=<sp/>NULL)<sp/>belle_sip_object_unref(sdp);</highlight></codeline>
<codeline lineno="4090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>stun</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(evt<sp/>==<sp/>ORTP_EVENT_STUN_USER_MESSAGE)<sp/>{</highlight></codeline>
<codeline lineno="4093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mblk_t*<sp/>m<sp/>=<sp/>ortp_event_get_data(ev)-&gt;packet;</highlight></codeline>
<codeline lineno="4094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>msg<sp/>=<sp/>ms_strndup((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*)m-&gt;b_rptr,<sp/>m-&gt;b_wptr-m-&gt;b_rptr);</highlight></codeline>
<codeline lineno="4095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_umsg_received(call-&gt;core,<sp/>msg);</highlight></codeline>
<codeline lineno="4096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(msg);</highlight></codeline>
<codeline lineno="4097"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4098"><highlight class="normal"></highlight></codeline>
<codeline lineno="4099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ortp_event_destroy(ev);</highlight></codeline>
<codeline lineno="4100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4101"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4102"><highlight class="normal"></highlight></codeline>
<codeline lineno="4103"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_background_tasks(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/>bool_t<sp/>one_second_elapsed){</highlight></codeline>
<codeline lineno="4104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>disconnect_timeout<sp/>=<sp/><ref refid="group__media__parameters_1ga091c8e3edcfd615db301c66d1e0b3914" kindref="member">sephone_core_get_nortp_timeout</ref>(call-&gt;core);</highlight></codeline>
<codeline lineno="4105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bool_t<sp/>disconnected=FALSE;</highlight></codeline>
<codeline lineno="4106"><highlight class="normal"></highlight></codeline>
<codeline lineno="4107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(call-&gt;state)<sp/>{</highlight></codeline>
<codeline lineno="4108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref>:</highlight></codeline>
<codeline lineno="4109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3bac9f834703e7fc0a5bec2c86d18f56e1e" kindref="member">SephoneCallOutgoingEarlyMedia</ref>:</highlight></codeline>
<codeline lineno="4110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba83ca7112a1058f9a7bfd8a59c5b22e74" kindref="member">SephoneCallIncomingEarlyMedia</ref>:</highlight></codeline>
<codeline lineno="4111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba52fb438226d381d630ca5ff5447d740e" kindref="member">SephoneCallPausedByRemote</ref>:</highlight></codeline>
<codeline lineno="4112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3ba6f1e7b0f913ec60c5402ff67dc7e4903" kindref="member">SephoneCallPaused</ref>:</highlight></codeline>
<codeline lineno="4113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(one_second_elapsed){</highlight></codeline>
<codeline lineno="4114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>audio_load=0,<sp/>video_load=0;</highlight></codeline>
<codeline lineno="4115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream!=NULL){</highlight></codeline>
<codeline lineno="4116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream-&gt;ms.sessions.ticker)</highlight></codeline>
<codeline lineno="4117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_load=ms_ticker_get_average_load(call-&gt;audiostream-&gt;ms.sessions.ticker);</highlight></codeline>
<codeline lineno="4118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream!=NULL){</highlight></codeline>
<codeline lineno="4120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream-&gt;ms.sessions.ticker)</highlight></codeline>
<codeline lineno="4121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_load=ms_ticker_get_average_load(call-&gt;videostream-&gt;ms.sessions.ticker);</highlight></codeline>
<codeline lineno="4122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>report_bandwidth(call,(MediaStream*)call-&gt;audiostream,(MediaStream*)call-&gt;videostream);</highlight></codeline>
<codeline lineno="4124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Thread<sp/>processing<sp/>load:<sp/>audio=%f<sp/>video=%f&quot;</highlight><highlight class="normal">,audio_load,video_load);</highlight></codeline>
<codeline lineno="4125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="4128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*no<sp/>stats<sp/>for<sp/>other<sp/>states*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4131"><highlight class="normal"></highlight></codeline>
<codeline lineno="4132"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_upnp_call_process(call);</highlight></codeline>
<codeline lineno="4134"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//BUILD_UPNP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4135"><highlight class="normal"></highlight></codeline>
<codeline lineno="4136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_handle_stream_events(call,0);</highlight></codeline>
<codeline lineno="4137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_handle_stream_events(call,1);</highlight></codeline>
<codeline lineno="4138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;state==<ref refid="group__call__control_1gga02e926dd293c3054ec3b1b145d09de3babe4153e12b21deab2f58f80df92ee40a" kindref="member">SephoneCallStreamsRunning</ref><sp/>&amp;&amp;<sp/>one_second_elapsed<sp/>&amp;&amp;<sp/>call-&gt;audiostream!=NULL</highlight></codeline>
<codeline lineno="4139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>call-&gt;audiostream-&gt;ms.state==MSStreamStarted<sp/>&amp;&amp;<sp/>disconnect_timeout&gt;0<sp/>)</highlight></codeline>
<codeline lineno="4140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>disconnected=!audio_stream_alive(call-&gt;audiostream,disconnect_timeout);</highlight></codeline>
<codeline lineno="4141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(disconnected)</highlight></codeline>
<codeline lineno="4142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_disconnected(call-&gt;core,call);</highlight></codeline>
<codeline lineno="4143"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4144"><highlight class="normal"></highlight></codeline>
<codeline lineno="4145"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_log_completed(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="4146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc=call-&gt;core;</highlight></codeline>
<codeline lineno="4147"><highlight class="normal"></highlight></codeline>
<codeline lineno="4148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;log-&gt;duration=<ref refid="group__call__control_1ga9fe28bbe62f3a7bab33b500d5171e343" kindref="member">sephone_call_get_duration</ref>(call);<sp/></highlight><highlight class="comment">/*store<sp/>duration<sp/>since<sp/>connected*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4149"><highlight class="normal"></highlight></codeline>
<codeline lineno="4150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;log-&gt;status==<ref refid="group__call__logs_1ggab3a24983dbb17007538702063fc99605a055cfc069041ea4b9d954b8fcbbaa798" kindref="member">SephoneCallMissed</ref>){</highlight></codeline>
<codeline lineno="4151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*info;</highlight></codeline>
<codeline lineno="4152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;missed_calls++;</highlight></codeline>
<codeline lineno="4153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>info=ortp_strdup_printf(ngettext(</highlight><highlight class="stringliteral">&quot;You<sp/>have<sp/>missed<sp/>%i<sp/>call.&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="4154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;You<sp/>have<sp/>missed<sp/>%i<sp/>calls.&quot;</highlight><highlight class="normal">,<sp/>lc-&gt;missed_calls),</highlight></codeline>
<codeline lineno="4155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;missed_calls);</highlight></codeline>
<codeline lineno="4156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_display_status(lc,info);</highlight></codeline>
<codeline lineno="4157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(info);</highlight></codeline>
<codeline lineno="4158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;call_logs=ms_list_prepend(lc-&gt;call_logs,<ref refid="group__call__logs_1ga2d61bc5a07b29cf8889958da66f73230" kindref="member">sephone_call_log_ref</ref>(call-&gt;log));</highlight></codeline>
<codeline lineno="4160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ms_list_size(lc-&gt;call_logs)&gt;lc-&gt;max_call_logs){</highlight></codeline>
<codeline lineno="4161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MSList<sp/>*elem,*prevelem=NULL;</highlight></codeline>
<codeline lineno="4162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*find<sp/>the<sp/>last<sp/>element*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(elem=lc-&gt;call_logs;elem!=NULL;elem=elem-&gt;next){</highlight></codeline>
<codeline lineno="4164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prevelem=elem;</highlight></codeline>
<codeline lineno="4165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elem=prevelem;</highlight></codeline>
<codeline lineno="4167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__logs_1ga0d9a7e7e2acc07acf85e2aac5874b26e" kindref="member">sephone_call_log_unref</ref>((<ref refid="group__call__logs_1ga971dacd835550830e6ced30185f11c46" kindref="member">SephoneCallLog</ref>*)elem-&gt;data);</highlight></codeline>
<codeline lineno="4168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lc-&gt;call_logs=ms_list_remove_link(lc-&gt;call_logs,elem);</highlight></codeline>
<codeline lineno="4169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_call_log_updated(lc,call-&gt;log);</highlight></codeline>
<codeline lineno="4171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call_logs_write_to_config_file(lc);</highlight></codeline>
<codeline lineno="4172"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4173"><highlight class="normal"></highlight></codeline>
<codeline lineno="4178"><highlight class="normal"><ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref><sp/>sephone_call_get_transfer_state(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="4179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;transfer_state;</highlight></codeline>
<codeline lineno="4180"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4181"><highlight class="normal"></highlight></codeline>
<codeline lineno="4182"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_set_transfer_state(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>*<sp/>call,<sp/><ref refid="group__call__control_1ga28a2545c7d1d828763bd648e023f9777" kindref="member">SephoneCallState</ref><sp/>state)<sp/>{</highlight></codeline>
<codeline lineno="4183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state<sp/>!=<sp/>call-&gt;transfer_state)<sp/>{</highlight></codeline>
<codeline lineno="4184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref>*<sp/>lc<sp/>=<sp/>call-&gt;core;</highlight></codeline>
<codeline lineno="4185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Transfer<sp/>state<sp/>for<sp/>call<sp/>[%p]<sp/>changed<sp/><sp/>from<sp/>[%s]<sp/>to<sp/>[%s]&quot;</highlight><highlight class="normal">,call</highlight></codeline>
<codeline lineno="4186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sephone_call_state_to_string(call-&gt;transfer_state)</highlight></codeline>
<codeline lineno="4187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,sephone_call_state_to_string(state));</highlight></codeline>
<codeline lineno="4188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;transfer_state<sp/>=<sp/>state;</highlight></codeline>
<codeline lineno="4189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_core_notify_transfer_state_changed(lc,<sp/>call,<sp/>state);</highlight></codeline>
<codeline lineno="4190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4191"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4192"><highlight class="normal"></highlight></codeline>
<codeline lineno="4193"><highlight class="normal">bool_t<sp/><ref refid="group__call__control_1gae5b397daf3c42da3d67b41111cb17d7b" kindref="member">sephone_call_is_in_conference</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="4194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;params-&gt;in_conference;</highlight></codeline>
<codeline lineno="4195"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4196"><highlight class="normal"></highlight></codeline>
<codeline lineno="4206"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_zoom_video(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>*<sp/>call,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>zoom_factor,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal">*<sp/>cx,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal">*<sp/>cy)<sp/>{</highlight></codeline>
<codeline lineno="4207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>VideoStream*<sp/>vstream<sp/>=<sp/>call-&gt;videostream;</highlight></codeline>
<codeline lineno="4208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vstream<sp/>&amp;&amp;<sp/>vstream-&gt;output)<sp/>{</highlight></codeline>
<codeline lineno="4209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>zoom[3];</highlight></codeline>
<codeline lineno="4210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>halfsize;</highlight></codeline>
<codeline lineno="4211"><highlight class="normal"></highlight></codeline>
<codeline lineno="4212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(zoom_factor<sp/>&lt;<sp/>1)</highlight></codeline>
<codeline lineno="4213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>zoom_factor<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="4214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>halfsize<sp/>=<sp/>0.5<sp/>*<sp/>1.0<sp/>/<sp/>zoom_factor;</highlight></codeline>
<codeline lineno="4215"><highlight class="normal"></highlight></codeline>
<codeline lineno="4216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((*cx<sp/>-<sp/>halfsize)<sp/>&lt;<sp/>0)</highlight></codeline>
<codeline lineno="4217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*cx<sp/>=<sp/>0<sp/>+<sp/>halfsize;</highlight></codeline>
<codeline lineno="4218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((*cx<sp/>+<sp/>halfsize)<sp/>&gt;<sp/>1)</highlight></codeline>
<codeline lineno="4219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*cx<sp/>=<sp/>1<sp/>-<sp/>halfsize;</highlight></codeline>
<codeline lineno="4220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((*cy<sp/>-<sp/>halfsize)<sp/>&lt;<sp/>0)</highlight></codeline>
<codeline lineno="4221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*cy<sp/>=<sp/>0<sp/>+<sp/>halfsize;</highlight></codeline>
<codeline lineno="4222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((*cy<sp/>+<sp/>halfsize)<sp/>&gt;<sp/>1)</highlight></codeline>
<codeline lineno="4223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*cy<sp/>=<sp/>1<sp/>-<sp/>halfsize;</highlight></codeline>
<codeline lineno="4224"><highlight class="normal"></highlight></codeline>
<codeline lineno="4225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>zoom[0]<sp/>=<sp/>zoom_factor;</highlight></codeline>
<codeline lineno="4226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>zoom[1]<sp/>=<sp/>*cx;</highlight></codeline>
<codeline lineno="4227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>zoom[2]<sp/>=<sp/>*cy;</highlight></codeline>
<codeline lineno="4228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_filter_call_method(vstream-&gt;output,<sp/>MS_VIDEO_DISPLAY_ZOOM,<sp/>&amp;zoom);</highlight></codeline>
<codeline lineno="4229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;Could<sp/>not<sp/>apply<sp/>zoom:<sp/>video<sp/>output<sp/>wasn&apos;t<sp/>activated.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4230"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4231"><highlight class="normal"></highlight></codeline>
<codeline lineno="4232"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*get_fixed_contact(<ref refid="group__initializing_1ga1c39f5ce369d188892c11e63b93d66ca" kindref="member">SephoneCore</ref><sp/>*lc,<sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call<sp/>,<sp/><ref refid="group__proxies_1ga6de67319de408cf5e0994375df31f431" kindref="member">SephoneProxyConfig</ref><sp/>*dest_proxy){</highlight></codeline>
<codeline lineno="4233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*ctt=NULL;</highlight></codeline>
<codeline lineno="4234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*ret=NULL;</highlight></codeline>
<codeline lineno="4235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//const<sp/>char<sp/>*localip=call-&gt;localip;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4236"><highlight class="normal"></highlight></codeline>
<codeline lineno="4237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>first<sp/>use<sp/>user&apos;s<sp/>supplied<sp/>ip<sp/>address<sp/>if<sp/>asked*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__network__parameters_1ga2ba2ed66104f0adbc83b6cd55ebb0fde" kindref="member">sephone_core_get_firewall_policy</ref>(lc)==<ref refid="group__network__parameters_1gga40fe96375c5d4f2a55df475eff0462d1a846b5c5ddba91b7f9d919402f574c020" kindref="member">SephonePolicyUseNatAddress</ref>){</highlight></codeline>
<codeline lineno="4239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ctt=<ref refid="group__proxies_1ga2f39e8d47e5a64861fa42654e216a4fd" kindref="member">sephone_core_get_primary_contact_parsed</ref>(lc);</highlight></codeline>
<codeline lineno="4240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga6325d1aec36ec1737713f5a8eb9897aa" kindref="member">sephone_address_set_domain</ref>(ctt,sephone_core_get_nat_address_resolved(lc));</highlight></codeline>
<codeline lineno="4241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=ctt;</highlight></codeline>
<codeline lineno="4242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;op<sp/>&amp;&amp;<sp/>sal_op_get_contact_address(call-&gt;op)!=NULL){</highlight></codeline>
<codeline lineno="4243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>if<sp/>already<sp/>choosed,<sp/>don&apos;t<sp/>change<sp/>it<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="4245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;ping_op<sp/>&amp;&amp;<sp/>sal_op_get_contact_address(call-&gt;ping_op))<sp/>{</highlight></codeline>
<codeline lineno="4246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>if<sp/>the<sp/>ping<sp/>OPTIONS<sp/>request<sp/>succeeded<sp/>use<sp/>the<sp/>contact<sp/>guessed<sp/>from<sp/>the</highlight></codeline>
<codeline lineno="4247"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>received,<sp/>rport*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Contact<sp/>has<sp/>been<sp/>fixed<sp/>using<sp/>OPTIONS&quot;</highlight><highlight class="comment">/*<sp/>to<sp/>%s&quot;,guessed*/</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=<ref refid="group__sephone__address_1gafce3008c5d8a2ee529a5e69b1ae28723" kindref="member">sephone_address_clone</ref>(sal_op_get_contact_address(call-&gt;ping_op));;</highlight></codeline>
<codeline lineno="4250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dest_proxy<sp/>&amp;&amp;<sp/>dest_proxy-&gt;op<sp/>&amp;&amp;<sp/>sal_op_get_contact_address(dest_proxy-&gt;op)){</highlight></codeline>
<codeline lineno="4251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*if<sp/>using<sp/>a<sp/>proxy,<sp/>use<sp/>the<sp/>contact<sp/>address<sp/>as<sp/>guessed<sp/>with<sp/>the<sp/>REGISTERs*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Contact<sp/>has<sp/>been<sp/>fixed<sp/>using<sp/>proxy&quot;</highlight><highlight class="normal"><sp/></highlight><highlight class="comment">/*to<sp/>%s&quot;,fixed_contact*/</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=<ref refid="group__sephone__address_1gafce3008c5d8a2ee529a5e69b1ae28723" kindref="member">sephone_address_clone</ref>(sal_op_get_contact_address(dest_proxy-&gt;op));</highlight></codeline>
<codeline lineno="4254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ctt=<ref refid="group__proxies_1ga2f39e8d47e5a64861fa42654e216a4fd" kindref="member">sephone_core_get_primary_contact_parsed</ref>(lc);</highlight></codeline>
<codeline lineno="4256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ctt!=NULL){</highlight></codeline>
<codeline lineno="4257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*otherwise<sp/>use<sp/>supplied<sp/>localip*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga6325d1aec36ec1737713f5a8eb9897aa" kindref="member">sephone_address_set_domain</ref>(ctt,NULL</highlight><highlight class="comment">/*localip*/</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga09541ef93b4fd5f9252fe1efd79681d3" kindref="member">sephone_address_set_port</ref>(ctt,-1</highlight><highlight class="comment">/*sephone_core_get_sip_port(lc)*/</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_message(</highlight><highlight class="stringliteral">&quot;Contact<sp/>has<sp/>not<sp/>been<sp/>fixed<sp/>stack<sp/>will<sp/>do&quot;</highlight><highlight class="comment">/*<sp/>to<sp/>%s&quot;,ret*/</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ret=ctt;</highlight></codeline>
<codeline lineno="4262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ret;</highlight></codeline>
<codeline lineno="4265"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4266"><highlight class="normal"></highlight></codeline>
<codeline lineno="4267"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_set_contact_op(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>*<sp/>call)<sp/>{</highlight></codeline>
<codeline lineno="4268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga55f07568eee2ed418e36ed9781cf2e23" kindref="member">SephoneAddress</ref><sp/>*contact;</highlight></codeline>
<codeline lineno="4269"><highlight class="normal"></highlight></codeline>
<codeline lineno="4270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dest_proxy<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="4271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Try<sp/>to<sp/>define<sp/>the<sp/>destination<sp/>proxy<sp/>if<sp/>it<sp/>has<sp/>not<sp/>already<sp/>been<sp/>done<sp/>to<sp/>have<sp/>a<sp/>correct<sp/>contact<sp/>field<sp/>in<sp/>the<sp/>SIP<sp/>messages<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dest_proxy<sp/>=<sp/>sephone_core_lookup_known_proxy(call-&gt;core,<sp/>call-&gt;log-&gt;to);</highlight></codeline>
<codeline lineno="4273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4274"><highlight class="normal"></highlight></codeline>
<codeline lineno="4275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>contact=get_fixed_contact(call-&gt;core,call,call-&gt;dest_proxy);</highlight></codeline>
<codeline lineno="4276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(contact){</highlight></codeline>
<codeline lineno="4277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SalTransport<sp/>tport=sal_address_get_transport((SalAddress*)contact);</highlight></codeline>
<codeline lineno="4278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_address_clean((SalAddress*)contact);<sp/></highlight><highlight class="comment">/*<sp/>clean<sp/>out<sp/>contact_params<sp/>that<sp/>come<sp/>from<sp/>proxy<sp/>config*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_address_set_transport((SalAddress*)contact,tport);</highlight></codeline>
<codeline lineno="4280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_op_set_contact_address(call-&gt;op,<sp/>contact);</highlight></codeline>
<codeline lineno="4281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__sephone__address_1ga3fe5d8eb9c373045efe9ae9e15458459" kindref="member">sephone_address_destroy</ref>(contact);</highlight></codeline>
<codeline lineno="4282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4283"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4284"><highlight class="normal"></highlight></codeline>
<codeline lineno="4285"><highlight class="normal"><ref refid="group__call__control_1gaf8c8a5e36ff3047d29df670f36005a30" kindref="member">SephonePlayer</ref><sp/>*sephone_call_get_player(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call){</highlight></codeline>
<codeline lineno="4286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;player==NULL)</highlight></codeline>
<codeline lineno="4287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;player=sephone_call_build_player(call);</highlight></codeline>
<codeline lineno="4288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;player;</highlight></codeline>
<codeline lineno="4289"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4290"><highlight class="normal"></highlight></codeline>
<codeline lineno="4291"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_set_new_params(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*params){</highlight></codeline>
<codeline lineno="4292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gaa1f74ac09492bb829b243ea1d0f356b7" kindref="member">SephoneCallParams</ref><sp/>*cp=NULL;</highlight></codeline>
<codeline lineno="4293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(params)<sp/>cp=<ref refid="group__call__control_1ga8f3f8f15b6e812d03bf416e09576910a" kindref="member">sephone_call_params_copy</ref>(params);</highlight></codeline>
<codeline lineno="4294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;params)<sp/><ref refid="group__call__control_1gae7c8fa8ba8eee61e979e87727004457d" kindref="member">sephone_call_params_unref</ref>(call-&gt;params);</highlight></codeline>
<codeline lineno="4295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;params=cp;</highlight></codeline>
<codeline lineno="4296"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4297"><highlight class="normal"></highlight></codeline>
<codeline lineno="4298"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>send_dtmf_handler(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*data,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>revents){</highlight></codeline>
<codeline lineno="4299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call<sp/>=<sp/>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref>*)data;</highlight></codeline>
<codeline lineno="4300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*By<sp/>default<sp/>we<sp/>send<sp/>DTMF<sp/>RFC2833<sp/>if<sp/>we<sp/>do<sp/>not<sp/>have<sp/>enabled<sp/>SIP_INFO<sp/>but<sp/>we<sp/>can<sp/>also<sp/>send<sp/>RFC2833<sp/>and<sp/>SIP_INFO*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__media__parameters_1ga4d8d482cca504ce22f8e810e3e9d731f" kindref="member">sephone_core_get_use_rfc2833_for_dtmf</ref>(call-&gt;core)!=0<sp/>||<sp/><ref refid="group__media__parameters_1gaf2de0bb47f9329d37f70182e8ffb980f" kindref="member">sephone_core_get_use_info_for_dtmf</ref>(call-&gt;core)==0)</highlight></codeline>
<codeline lineno="4302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>In<sp/>Band<sp/>DTMF<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;audiostream!=NULL){</highlight></codeline>
<codeline lineno="4305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>audio_stream_send_dtmf(call-&gt;audiostream,*call-&gt;dtmf_sequence);</highlight></codeline>
<codeline lineno="4306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_error(</highlight><highlight class="stringliteral">&quot;Cannot<sp/>send<sp/>RFC2833<sp/>DTMF<sp/>when<sp/>we<sp/>are<sp/>not<sp/>in<sp/>communication.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="4311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="group__media__parameters_1gaf2de0bb47f9329d37f70182e8ffb980f" kindref="member">sephone_core_get_use_info_for_dtmf</ref>(call-&gt;core)!=0){</highlight></codeline>
<codeline lineno="4314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Out<sp/>of<sp/>Band<sp/>DTMF<sp/>(use<sp/>INFO<sp/>method)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_call_send_dtmf(call-&gt;op,*call-&gt;dtmf_sequence);</highlight></codeline>
<codeline lineno="4316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4317"><highlight class="normal"></highlight></codeline>
<codeline lineno="4318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*this<sp/>check<sp/>is<sp/>needed<sp/>because<sp/>sephone_call_send_dtmf<sp/>does<sp/>not<sp/>set<sp/>the<sp/>timer<sp/>since<sp/>its<sp/>a<sp/>single<sp/>character*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dtmfs_timer!=NULL)<sp/>{</highlight></codeline>
<codeline lineno="4320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memmove(call-&gt;dtmf_sequence,<sp/>call-&gt;dtmf_sequence+1,<sp/>strlen(call-&gt;dtmf_sequence));</highlight></codeline>
<codeline lineno="4321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>continue<sp/>only<sp/>if<sp/>the<sp/>dtmf<sp/>sequence<sp/>is<sp/>not<sp/>empty*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dtmf_sequence!=NULL&amp;&amp;*call-&gt;dtmf_sequence!=</highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>TRUE;</highlight></codeline>
<codeline lineno="4325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sephone_call_cancel_dtmfs(call);</highlight></codeline>
<codeline lineno="4327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FALSE;</highlight></codeline>
<codeline lineno="4328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4329"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4330"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>sephone_call_send_dtmf(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>dtmf){</highlight></codeline>
<codeline lineno="4331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call==NULL){</highlight></codeline>
<codeline lineno="4332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;sephone_call_send_dtmf():<sp/>invalid<sp/>call,<sp/>canceling<sp/>DTMF.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="4334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmf_sequence<sp/>=<sp/>&amp;dtmf;</highlight></codeline>
<codeline lineno="4336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>send_dtmf_handler(call,0);</highlight></codeline>
<codeline lineno="4337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmf_sequence<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="4338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="4339"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4340"><highlight class="normal"></highlight></codeline>
<codeline lineno="4341"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>sephone_call_send_dtmfs(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*dtmfs)<sp/>{</highlight></codeline>
<codeline lineno="4342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call==NULL){</highlight></codeline>
<codeline lineno="4343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;sephone_call_send_dtmfs():<sp/>invalid<sp/>call,<sp/>canceling<sp/>DTMF<sp/>sequence.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="4345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dtmfs_timer!=NULL){</highlight></codeline>
<codeline lineno="4347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_warning(</highlight><highlight class="stringliteral">&quot;sephone_call_send_dtmfs():<sp/>a<sp/>DTMF<sp/>sequence<sp/>is<sp/>already<sp/>in<sp/>place,<sp/>canceling<sp/>DTMF<sp/>sequence.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="4349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dtmfs<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="4351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>delay_ms<sp/>=<sp/><ref refid="group__misc_1ga3d31ae0b188509173833ba6216499759" kindref="member">sp_config_get_int</ref>(call-&gt;core-&gt;config,</highlight><highlight class="stringliteral">&quot;net&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;dtmf_delay_ms&quot;</highlight><highlight class="normal">,200);</highlight></codeline>
<codeline lineno="4352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmf_sequence<sp/>=<sp/>ms_strdup(dtmfs);</highlight></codeline>
<codeline lineno="4353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmfs_timer<sp/>=<sp/>sal_create_timer(call-&gt;core-&gt;sal,<sp/>send_dtmf_handler,<sp/>call,<sp/>delay_ms,<sp/></highlight><highlight class="stringliteral">&quot;DTMF<sp/>sequence<sp/>timer&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="4356"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4357"><highlight class="normal"></highlight></codeline>
<codeline lineno="4358"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>sephone_call_cancel_dtmfs(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="4359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*nothing<sp/>to<sp/>do*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!call<sp/>||<sp/>!call-&gt;dtmfs_timer)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4361"><highlight class="normal"></highlight></codeline>
<codeline lineno="4362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sal_cancel_timer(call-&gt;core-&gt;sal,<sp/>call-&gt;dtmfs_timer);</highlight></codeline>
<codeline lineno="4363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>belle_sip_object_unref(call-&gt;dtmfs_timer);</highlight></codeline>
<codeline lineno="4364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmfs_timer<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="4365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;dtmf_sequence<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="4366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ms_free(call-&gt;dtmf_sequence);</highlight></codeline>
<codeline lineno="4367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;dtmf_sequence<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="4368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4369"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4370"><highlight class="normal"></highlight></codeline>
<codeline lineno="4371"><highlight class="normal"></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1gab30a6b7917180f3c59cb8b72d15a1a1c" kindref="member">sephone_call_get_native_video_window_id</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="4372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;video_window_id)<sp/>{</highlight></codeline>
<codeline lineno="4373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>The<sp/>video<sp/>id<sp/>was<sp/>previously<sp/>set<sp/>by<sp/>the<sp/>app.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;video_window_id;</highlight></codeline>
<codeline lineno="4375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4376"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream)<sp/>{</highlight></codeline>
<codeline lineno="4378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>It<sp/>was<sp/>not<sp/>set<sp/>but<sp/>we<sp/>want<sp/>to<sp/>get<sp/>the<sp/>one<sp/>automatically<sp/>created<sp/>by<sp/>mediastreamer2<sp/>(desktop<sp/>versions<sp/>only).<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>video_stream_get_native_window_id(call-&gt;videostream);</highlight></codeline>
<codeline lineno="4380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4381"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="4383"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4384"><highlight class="normal"></highlight></codeline>
<codeline lineno="4385"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="group__media__parameters_1ga58335d34928eb7b997ae59abeb1ee280" kindref="member">sephone_call_set_native_video_window_id</ref>(<ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>call-&gt;video_window_id<sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="4387"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;videostream)<sp/>{</highlight></codeline>
<codeline lineno="4389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>video_stream_set_native_window_id(call-&gt;videostream,<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4391"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4392"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4393"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>VIDEO_ENABLED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4394"><highlight class="normal">MSWebCam<sp/>*sephone_call_get_video_device(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="group__call__control_1gac08107239d1cb38f1d07e515a1d9f98a" kindref="member">SephoneCall</ref><sp/>*call)<sp/>{</highlight></codeline>
<codeline lineno="4395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(call-&gt;camera_enabled==FALSE)</highlight></codeline>
<codeline lineno="4396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>get_nowebcam_device();</highlight></codeline>
<codeline lineno="4397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>call-&gt;cam;</highlight></codeline>
<codeline lineno="4399"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4400"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight></codeline>
    </programlisting>
    <location file="/users/andrew/workspaces/linphone/submodules/sephone/coreapi/sephonecall.c"/>
  </compounddef>
</doxygen>
